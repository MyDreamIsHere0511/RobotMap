<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Robot Map Interface</title>
  <style>
    :root {
      --primary-color: #3498db;
      --secondary-color: #2ecc71;
      --accent-color: #f39c12;
      --danger-color: #e74c3c;
      --light-bg: #f5f5f5;
      --dark-bg: #2c3e50;
      --text-dark: #333;
      --text-light: #f5f5f5;
      --border-color: #ddd;
      --shadow: 0 2px 5px rgba(0,0,0,0.1);
      --theme-transition: background-color 0.3s, color 0.3s;
      
      /* Màu cho các command block */
      --move-up-bg: #d1e7dd;
      --move-down-bg: #f8d7da;
      --move-left-bg: #cfe2ff;
      --move-right-bg: #fff3cd;
      --move-upleft-bg: #d8f3dc;
      --move-upright-bg: #e9ecef;
      --move-downleft-bg: #e0e1ff;
      --move-downright-bg: #ffe8d9;
      --spin-bg: #d8d8ff;
      --rotate-left-bg: #ffccd5;
      --rotate-right-bg: #c9f7f5;
    }
    
    body.dark-mode {
      --light-bg: #1a1a2e;
      --border-color: #444;
      --text-dark: #f5f5f5;
      
      /* Màu tối cho các command block */
      --move-up-bg: #1e4d3d;
      --move-down-bg: #4d2828;
      --move-left-bg: #1e294d;
      --move-right-bg: #4d412e;
      --move-upleft-bg: #1e3e2e;
      --move-upright-bg: #2e2e2e;
      --move-downleft-bg: #252540;
      --move-downright-bg: #40332a;
      --spin-bg: #2e2e4d;
      --rotate-left-bg: #4d2a38;
      --rotate-right-bg: #2a4d49;
    }
    
    body {
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
      background-color: var(--light-bg);
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    #header-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      z-index: 1000;
      box-shadow: var(--shadow);
    }
    
    #header-bar .title {
      font-weight: bold;
      font-size: 1.2em;
    }
    
    #header-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .header-button {
      padding: 5px 10px;
      background-color: rgba(255,255,255,0.2);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .header-button:hover {
      background-color: rgba(255,255,255,0.3);
    }

    /* Settings dropdown menu */
    #settings-dropdown {
      position: absolute;
      top: 45px;
      right: 120px;
      background-color: white;
      border-radius: 4px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      z-index: 1001;
      overflow: hidden;
      display: none;
      min-width: 200px;
    }

    .dark-mode #settings-dropdown {
      background-color: var(--dark-bg);
      color: var(--text-light);
    }

    #settings-dropdown .settings-header {
      padding: 10px 15px;
      border-bottom: 1px solid var(--border-color);
      font-weight: 500;
    }

    #settings-dropdown .settings-option {
      padding: 10px 15px;
      cursor: pointer;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #settings-dropdown .settings-option:hover {
      background-color: rgba(0,0,0,0.05);
    }

    .dark-mode #settings-dropdown .settings-option:hover {
      background-color: rgba(255,255,255,0.05);
    }

    .settings-option i {
      width: 16px;
      text-align: center;
    }
    
    .theme-toggle {
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    
    .theme-toggle span {
      margin-right: 5px;
    }
    
    .toggle-switch {
      position: relative;
      width: 40px;
      height: 20px;
      background-color: rgba(0,0,0,0.3);
      border-radius: 10px;
      transition: background-color 0.3s;
    }
    
    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: white;
      top: 2px;
      left: 2px;
      transition: transform 0.3s;
    }
    
    .dark-mode .toggle-switch {
      background-color: var(--accent-color);
    }
    
    .dark-mode .toggle-switch::after {
      transform: translateX(20px);
    }
    
    #main-container {
      display: flex;
      width: 100%;
      height: 100%;
      padding-top: 40px; /* Để tránh bị header che */
    }
    
    #sidebar {
      width: 320px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border-color);
      background-color: var(--light-bg);
      overflow-y: auto;
      resize: horizontal;
      min-width: 250px;
      max-width: 500px;
      transition: var(--theme-transition);
    }
    
    #sidebar-resizer {
      position: absolute;
      width: 8px;
      height: calc(100% - 40px); /* Trừ đi height của header */
      left: 320px;
      top: 40px; /* Bắt đầu từ dưới header */
      background-color: var(--border-color);
      cursor: ew-resize;
      z-index: 100;
      transition: background-color 0.2s;
    }
    
    #sidebar-resizer:hover {
      background-color: var(--primary-color);
    }
    
    #sidebar-resizer::after {
      content: "⫴";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--text-dark);
      font-size: 12px;
    }
    
    #display-area {
      flex: 1;
      position: relative;
      overflow: hidden;
      background-color: var(--light-bg);
      transition: var(--theme-transition);
    }
    
    #map-container {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      overflow: hidden;
    }
    
    #map {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      position: relative;
      z-index: 1; /* Đảm bảo map nằm dưới robot */
      user-select: none;
    }
    
    /* Grid overlay */
    #grid-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      opacity: 0.5;
      display: none;
      z-index: 2; /* Lưới hiển thị trên map */
    }
    
    .grid-line {
      position: absolute;
      background-color: rgba(0, 0, 255, 0.3);
    }
    
    /* Coordinate display */
    #coordinates-display {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 14px;
      z-index: 10;
      display: flex;
      flex-direction: column;
      cursor: default;
    }
    
    #coordinates-display.draggable {
      cursor: move;
      box-shadow: 0 0 0 2px var(--accent-color);
    }
    
    #coordinates-display div {
      margin: 2px 0;
    }
    
    /* Mini-map display */
    #mini-map-container {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 150px;
      height: 150px;
      background-color: rgba(0, 0, 0, 0.7);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      z-index: 10;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      cursor: default;
    }

    #mini-map-container.draggable {
      cursor: move;
      box-shadow: 0 0 0 2px var(--accent-color);
    }
    
    #mini-map {
      width: 100%;
      height: 100%;
      position: relative;
    }
    
    #mini-map-indicator {
      position: absolute;
      width: 8px;
      height: 8px;
      background-color: #ff0000;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: 2;
    }
    
    #mouse-position-indicator {
      position: absolute;
      width: 6px;
      height: 6px;
      background-color: #ffff00;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: 1;
    }
    
    #mini-map-robot {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: var(--accent-color);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: 3;
    }
    
    /* Robot styling */
    #robot-container {
      position: absolute;
      z-index: 5; /* Đảm bảo robot hiển thị trên map */
      cursor: grab;
      transition: transform 0.3s ease;
    }
    
    #robot-container.dragging {
      cursor: grabbing;
      z-index: 10;
      filter: drop-shadow(0 5px 15px rgba(0,0,0,0.6));
    }
    
    #robot {
      position: absolute;
      width: 50px; /* Kích thước mặc định */
      transform-origin: center center; /* Đảm bảo robot quay từ tâm */
      transition: transform 0.1s linear, left 0.1s linear, top 0.1s linear;
      filter: drop-shadow(0 3px 5px rgba(0,0,0,0.3));
      user-select: none;
      transform: translate(-50%, -50%); /* Canh chỉnh để robot nằm đúng tâm */
    }

    /* Robot center point (red dot) */
    #robot-center {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: red;
      border: 2px solid white;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: 6;
      cursor: nwse-resize;
      box-shadow: 0 0 5px rgba(0,0,0,0.5);
    }
    
    /* Waypoint markers */
    .waypoint-marker {
      position: absolute;
      width: 15px;
      height: 15px;
      background-color: var(--accent-color);
      border: 2px solid white;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: 5;
      cursor: pointer;
      box-shadow: 0 0 5px rgba(0,0,0,0.5);
    }
    
    .waypoint-marker:hover {
      background-color: #e67e22;
    }
    
    .waypoint-label {
      position: absolute;
      background-color: rgba(0,0,0,0.7);
      color: white;
      padding: 2px 5px;
      border-radius: 3px;
      font-size: 12px;
      white-space: nowrap;
      transform: translateY(-120%);
      user-select: none;
    }
    
    /* Phân khu 1: Điều khiển */
    .panel-section {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
      transition: var(--theme-transition);
    }
    
    .panel-section-title {
      margin: 0 0 10px 0;
      color: var(--primary-color);
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .controls-title {
      margin: 8px 0;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: var(--theme-transition);
    }
    
    .history-controls {
      display: flex;
      gap: 5px;
    }
    
    .history-controls button {
      padding: 4px 8px;
      background-color: var(--light-bg);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .history-controls button:hover:not(:disabled) {
      background-color: var(--primary-color);
      color: white;
    }
    
    .history-controls button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .movement-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 5px;
      margin-bottom: 10px;
    }
    
    .movement-grid button {
      padding: 10px 0;
      background-color: var(--light-bg);
      border: 1px solid var(--border-color);
      cursor: pointer;
      border-radius: 4px;
      color: var(--text-dark);
      font-weight: 500;
      transition: background-color 0.2s, var(--theme-transition);
    }
    .movement-grid button:hover {
      filter: brightness(0.9);
    }
    
    /* Styling cho các nút di chuyển */
    #move-up { background-color: var(--move-up-bg); }
    #move-down { background-color: var(--move-down-bg); }
    #move-left { background-color: var(--move-left-bg); }
    #move-right { background-color: var(--move-right-bg); }
    #move-upleft { background-color: var(--move-upleft-bg); }
    #move-upright { background-color: var(--move-upright-bg); }
    #move-downleft { background-color: var(--move-downleft-bg); }
    #move-downright { background-color: var(--move-downright-bg); }
    #rotate-left { background-color: var(--rotate-left-bg); }
    #rotate-right { background-color: var(--rotate-right-bg); }
    
    .rotate-controls {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
    }
    
    .rotate-controls button {
      flex: 1;
      padding: 10px 0;
      border: 1px solid var(--border-color);
      cursor: pointer;
      border-radius: 4px;
      color: var(--text-dark);
      font-weight: 500;
      transition: background-color 0.2s, var(--theme-transition);
    }
    
    .rotate-controls button:hover {
      filter: brightness(0.9);
    }
    
    .settings-group {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .settings-group label {
      display: flex;
      flex-direction: column;
      gap: 5px;
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .settings-group input {
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--light-bg);
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    /* Phân khu 2: Lệnh di chuyển */
    .command-list {
      list-style-type: none;
      padding: 0;
      margin: 0;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--light-bg);
      transition: var(--theme-transition);
    }
    
    .command-list li {
      padding: 8px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border-color);
      cursor: default;
      transition: background-color 0.2s;
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .command-list li:last-child {
      border-bottom: none;
    }
    
    .command-list li:hover {
      background-color: rgba(0,0,0,0.05);
    }
    
    .command-move-up { background-color: var(--move-up-bg); }
    .command-move-down { background-color: var(--move-down-bg); }
    .command-move-left { background-color: var(--move-left-bg); }
    .command-move-right { background-color: var(--move-right-bg); }
    .command-move-upleft { background-color: var(--move-upleft-bg); }
    .command-move-upright { background-color: var(--move-upright-bg); }
    .command-move-downleft { background-color: var(--move-downleft-bg); }
    .command-move-downright { background-color: var(--move-downright-bg); }
    .command-spin { background-color: var(--spin-bg); }
    .command-rotate-left { background-color: var(--rotate-left-bg); }
    .command-rotate-right { background-color: var(--rotate-right-bg); }
    
    .command-actions {
      display: flex;
      gap: 5px;
    }
    
    .command-actions button {
      padding: 2px 5px;
      background-color: transparent;
      border: none;
      cursor: pointer;
      border-radius: 2px;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    
    .command-actions button:hover {
      opacity: 1;
    }
    
    .command-edit {
      color: var(--accent-color);
    }
    
    .command-delete {
      color: var(--danger-color);
    }
    
    /* Phân khu 3: Đường đi */
    .waypoints-list {
      list-style-type: none;
      padding: 0;
      margin: 0;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--light-bg);
      transition: var(--theme-transition);
    }
    
    .waypoints-list li {
      padding: 8px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border-color);
      cursor: default;
      transition: background-color 0.2s;
      color: var(--text-dark);
    }
    
    .waypoints-list li:last-child {
      border-bottom: none;
    }
    
    .waypoints-list li:hover {
      background-color: rgba(0,0,0,0.05);
    }
    
    .waypoint-actions {
      display: flex;
      gap: 5px;
    }
    
    .waypoint-actions button {
      padding: 2px 5px;
      background-color: transparent;
      border: none;
      cursor: pointer;
      border-radius: 2px;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    
    .waypoint-actions button:hover {
      opacity: 1;
    }
    
    .waypoint-goto {
      color: var(--secondary-color);
    }
    
    .waypoint-edit {
      color: var(--accent-color);
    }
    
    .waypoint-delete {
      color: var(--danger-color);
    }
    
    /* Phân khu 4: Thông tin */
    .info-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .info-label {
      font-weight: 500;
    }
    
    .info-value {
      font-family: monospace;
      padding: 2px 5px;
      background-color: rgba(0,0,0,0.05);
      border-radius: 2px;
    }
    
    /* Dialog styling */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      visibility: hidden;
      opacity: 0;
      transition: visibility 0s linear 0.25s, opacity 0.25s;
    }
    
    .modal-overlay.active {
      visibility: visible;
      opacity: 1;
      transition-delay: 0s;
    }
    
    .modal-dialog {
      background-color: var(--light-bg);
      border-radius: 6px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
      padding: 20px;
      width: 400px;
      max-width: 90%;
      transform: scale(0.8);
      opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .modal-overlay.active .modal-dialog {
      transform: scale(1);
      opacity: 1;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .modal-title {
      font-size: 1.2em;
      font-weight: bold;
      color: var(--primary-color);
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5em;
      cursor: pointer;
      color: var(--text-dark);
      transition: color 0.2s;
    }
    
    .modal-close:hover {
      color: var(--danger-color);
    }
    
    .modal-body {
      margin-bottom: 15px;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .modal-form-group {
      margin-bottom: 15px;
    }
    
    .modal-form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .modal-form-group input,
    .modal-form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--light-bg);
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .modal-btn {
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s;
    }
    
    .modal-btn-primary {
      background-color: var(--primary-color);
      color: white;
    }
    
    .modal-btn-primary:hover {
      background-color: #2980b9;
    }
    
    .modal-btn-secondary {
      background-color: #95a5a6;
      color: white;
    }
    
    .modal-btn-secondary:hover {
      background-color: #7f8c8d;
    }
    
    /* Toast notification */
    #toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
    }
    
    .toast {
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 20px;
      border-radius: 4px;
      margin-top: 10px;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      transform: translateX(120%);
      transition: transform 0.3s ease-out;
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast-success {
      border-left: 4px solid var(--secondary-color);
    }
    
    .toast-error {
      border-left: 4px solid var(--danger-color);
    }
    
    .toast-info {
      border-left: 4px solid var(--primary-color);
    }
    
    .toast-warning {
      border-left: 4px solid var(--accent-color);
    }
    
    /* Tooltip styling */
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltip-text {
      visibility: hidden;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      text-align: center;
      padding: 5px 10px;
      border-radius: 4px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
      pointer-events: none;
    }
    
    .tooltip .tooltip-text::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
    }
    
    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    /* Style for mobile */
    @media (max-width: 768px) {
      #sidebar {
        width: 100%;
        position: absolute;
        height: 50%;
        bottom: 0;
        z-index: 900;
        border-top: 1px solid var(--border-color);
        border-right: none;
        resize: none;
      }
      
      #display-area {
        height: 50%;
      }
      
      #sidebar-resizer {
        display: none;
      }
    }
  </style>
</head>
<body>
  <!-- Thanh header -->
  <div id="header-bar">
    <div class="title">Robot Map Interface</div>
    <div id="header-controls">
      <button id="grid-toggle" class="header-button">
        <i class="fas fa-th"></i> Hiện/Ẩn lưới
      </button>
      <button id="settings-button" class="header-button">
        <i class="fas fa-cog"></i> Cài đặt
      </button>
      <div class="theme-toggle" id="theme-toggle">
        <span>Chế độ tối</span>
        <div class="toggle-switch"></div>
      </div>
    </div>
  </div>

  <!-- Settings dropdown menu -->
  <div id="settings-dropdown">
    <div class="settings-header">Cài đặt</div>
    <div class="settings-option" id="adjust-positions">
      <i class="fas fa-arrows-alt"></i>
      <span>Điều chỉnh vị trí</span>
    </div>
    <div class="settings-option" id="toggle-mini-map">
      <i class="fas fa-map"></i>
      <span>Ẩn/Hiện Mini Map</span>
    </div>
  </div>

  <!-- Container chính -->
  <div id="main-container">
    <!-- Thanh bên trái - Khu vực điều khiển -->
    <div id="sidebar">
      <!-- Phân khu 1: Điều khiển -->
      <div class="panel-section">
        <h3 class="panel-section-title">Điều khiển Robot</h3>
        
        <!-- Lịch sử di chuyển -->
        <div class="controls-title">
          <span>Lịch sử</span>
          <div class="history-controls">
            <button id="undo-btn" title="Hoàn tác" disabled><i class="fas fa-undo"></i></button>
            <button id="redo-btn" title="Làm lại" disabled><i class="fas fa-redo"></i></button>
            <button id="clear-history-btn" title="Xóa lịch sử" disabled><i class="fas fa-trash-alt"></i></button>
          </div>
        </div>
        
        <!-- Lưới di chuyển -->
        <div class="controls-title">
          <span>Di chuyển</span>
        </div>
        
        <div class="movement-grid">
          <button id="move-upleft" title="Di chuyển lên trái">
            <i class="fas fa-arrow-up" style="transform: rotate(-45deg)"></i>
          </button>
          <button id="move-up" title="Di chuyển lên">
            <i class="fas fa-arrow-up"></i>
          </button>
          <button id="move-upright" title="Di chuyển lên phải">
            <i class="fas fa-arrow-up" style="transform: rotate(45deg)"></i>
          </button>
          <button id="move-left" title="Di chuyển sang trái">
            <i class="fas fa-arrow-left"></i>
          </button>
          <button id="center-robot" title="Trở về vị trí ban đầu">
            <i class="fas fa-dot-circle"></i>
          </button>
          <button id="move-right" title="Di chuyển sang phải">
            <i class="fas fa-arrow-right"></i>
          </button>
          <button id="move-downleft" title="Di chuyển xuống trái">
            <i class="fas fa-arrow-down" style="transform: rotate(45deg)"></i>
          </button>
          <button id="move-down" title="Di chuyển xuống">
            <i class="fas fa-arrow-down"></i>
          </button>
          <button id="move-downright" title="Di chuyển xuống phải">
            <i class="fas fa-arrow-down" style="transform: rotate(-45deg)"></i>
          </button>
        </div>
        
        <!-- Điều khiển quay -->
        <div class="controls-title">
          <span>Quay</span>
        </div>
        
        <div class="rotate-controls">
          <button id="rotate-left" title="Quay trái">
            <i class="fas fa-undo"></i>
          </button>
          <button id="rotate-right" title="Quay phải">
            <i class="fas fa-redo"></i>
          </button>
        </div>
        
        <!-- Cài đặt di chuyển -->
        <div class="settings-group">
          <label>
            Bước di chuyển
            <input type="number" id="move-step-input" min="1" max="100" value="10">
          </label>
          
          <label>
            Góc quay (độ)
            <input type="number" id="rotation-angle-input" min="1" max="180" value="45">
          </label>
        </div>
      </div>
      
      <!-- Phân khu 2: Danh sách lệnh -->
      <div class="panel-section">
        <h3 class="panel-section-title">
          Lệnh di chuyển
          <button id="clear-commands-btn" class="header-button" style="padding: 2px 5px; font-size: 0.8em;">
            <i class="fas fa-trash-alt"></i> Xóa tất cả
          </button>
        </h3>
        
        <ul id="command-list" class="command-list">
          <!-- Các lệnh sẽ được thêm bằng JavaScript -->
        </ul>
        
        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
          <button id="execute-commands-btn" class="header-button" style="flex: 1; margin-right: 5px;">
            <i class="fas fa-play"></i> Thực thi
          </button>
          <button id="save-commands-btn" class="header-button" style="flex: 1; margin-left: 5px;">
            <i class="fas fa-save"></i> Lưu
          </button>
        </div>
      </div>
      
      <!-- Phân khu 3: Đường đi -->
      <div class="panel-section">
        <h3 class="panel-section-title">
          Đường đi
          <button id="add-waypoint-btn" class="header-button" style="padding: 2px 5px; font-size: 0.8em;">
            <i class="fas fa-plus"></i> Thêm mới
          </button>
        </h3>
        
        <ul id="waypoints-list" class="waypoints-list">
          <!-- Các điểm đường đi sẽ được thêm bằng JavaScript -->
        </ul>
        
        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
          <button id="navigate-waypoints-btn" class="header-button" style="flex: 1; margin-right: 5px;">
            <i class="fas fa-route"></i> Điều hướng
          </button>
          <button id="clear-waypoints-btn" class="header-button" style="flex: 1; margin-left: 5px;">
            <i class="fas fa-trash-alt"></i> Xóa tất cả
          </button>
        </div>
      </div>
      
      <!-- Phân khu 4: Thông tin -->
      <div class="panel-section">
        <h3 class="panel-section-title">Thông tin</h3>
        
        <div class="info-item">
          <span class="info-label">Tọa độ X:</span>
          <span class="info-value" id="info-x">0</span>
        </div>
        
        <div class="info-item">
          <span class="info-label">Tọa độ Y:</span>
          <span class="info-value" id="info-y">0</span>
        </div>
        
        <div class="info-item">
          <span class="info-label">Góc quay:</span>
          <span class="info-value" id="info-angle">0°</span>
        </div>
        
        <div class="info-item">
          <span class="info-label">Khoảng cách di chuyển:</span>
          <span class="info-value" id="info-distance">0</span>
        </div>
        
        <div class="info-item">
          <span class="info-label">Số lệnh:</span>
          <span class="info-value" id="info-command-count">0</span>
        </div>
      </div>
    </div>
    
    <!-- Thanh điều chỉnh độ rộng sidebar -->
    <div id="sidebar-resizer"></div>
    
    <!-- Khu vực hiển thị bản đồ -->
    <div id="display-area">
      <div id="map-container">
        <div id="grid-overlay">
          <!-- Lưới sẽ được tạo bằng JavaScript -->
        </div>
        
        <img id="map" src="https://via.placeholder.com/800x600/f5f5f5/333?text=Loading+Map..." alt="Map">
        
        <div id="robot-container">
          <img id="robot" src="https://cdn-icons-png.flaticon.com/512/2216/2216052.png" alt="Robot">
          <div id="robot-center"></div>
        </div>
        
        <!-- Các marker điểm đường đi sẽ được thêm bằng JavaScript -->
      </div>
      
      <!-- Hiển thị tọa độ -->
      <div id="coordinates-display">
        <div id="map-coordinates">Map: X: 0, Y: 0</div>
        <div id="robot-coordinates">Robot: X: 0, Y: 0</div>
        <div id="distance-display">Khoảng cách: 0px</div>
        <div id="angle-display">Góc: 0°</div>
      </div>
      
      <!-- Mini map -->
      <div id="mini-map-container">
        <div id="mini-map">
          <div id="mini-map-indicator"></div>
          <div id="mouse-position-indicator"></div>
          <div id="mini-map-robot"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dialog modal -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal-dialog">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-title">Dialog Title</h3>
        <button class="modal-close" id="modal-close">&times;</button>
      </div>
      <div class="modal-body" id="modal-body">
        <!-- Nội dung sẽ được thêm bằng JavaScript -->
      </div>
      <div class="modal-footer" id="modal-footer">
        <!-- Nút sẽ được thêm bằng JavaScript -->
      </div>
    </div>
  </div>

  <!-- Container cho toast notifications -->
  <div id="toast-container"></div>

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <script>
    // Khai báo các biến toàn cục
    const mapContainer = document.getElementById('map-container');
    const map = document.getElementById('map');
    const robot = document.getElementById('robot');
    const robotContainer = document.getElementById('robot-container');
    const robotCenter = document.getElementById('robot-center');
    const gridOverlay = document.getElementById('grid-overlay');
    const gridToggleButton = document.getElementById('grid-toggle');
    const themeToggle = document.getElementById('theme-toggle');
    const sidebarResizer = document.getElementById('sidebar-resizer');
    const sidebar = document.getElementById('sidebar');
    const mapCoordinates = document.getElementById('map-coordinates');
    const robotCoordinates = document.getElementById('robot-coordinates');
    const distanceDisplay = document.getElementById('distance-display');
    const angleDisplay = document.getElementById('angle-display');
    const miniMapContainer = document.getElementById('mini-map-container');
    const miniMap = document.getElementById('mini-map');
    const miniMapIndicator = document.getElementById('mini-map-indicator');
    const mousePositionIndicator = document.getElementById('mouse-position-indicator');
    const miniMapRobot = document.getElementById('mini-map-robot');
    const coordinatesDisplay = document.getElementById('coordinates-display');
    const settingsButton = document.getElementById('settings-button');
    const settingsDropdown = document.getElementById('settings-dropdown');
    const adjustPositionsOption = document.getElementById('adjust-positions');
    const toggleMiniMapOption = document.getElementById('toggle-mini-map');
    
    // Biến lưu trạng thái robot
    let robotState = {
      x: 0, // Tọa độ x hiện tại
      y: 0, // Tọa độ y hiện tại
      angle: 0, // Góc quay hiện tại
      scale: 1, // Tỉ lệ phóng to / thu nhỏ
      history: [], // Lịch sử trạng thái
      historyIndex: -1, // Chỉ số lịch sử hiện tại
      commands: [], // Danh sách lệnh di chuyển
      waypoints: [], // Danh sách điểm đường đi
      // Các giá trị mặc định
      mapWidth: 0,
      mapHeight: 0,
      mapCenterX: 0,
      mapCenterY: 0,
      gridSize: 50,
      isGridVisible: false,
      isDraggingRobot: false,
      isDraggingMiniMap: false,
      isDraggingCoordinates: false,
      adjustPositionsMode: false,
      isMiniMapVisible: true,
      // Cài đặt di chuyển
      moveStep: 10,
      rotationAngle: 45
    };
    
    // Lưu các phím tắt
    const hotkeys = {
      'ArrowUp': 'move-up',
      'ArrowDown': 'move-down',
      'ArrowLeft': 'move-left',
      'ArrowRight': 'move-right',
      'KeyA': 'rotate-left',
      'KeyD': 'rotate-right',
      'KeyW': 'move-up',
      'KeyS': 'move-down',
      'KeyQ': 'rotate-left',
      'KeyE': 'rotate-right',
      'KeyZ': 'undo-btn',
      'KeyY': 'redo-btn',
      'KeyG': 'grid-toggle'
    };
    
    // Khởi tạo map
    map.onload = function() {
      initMap();
    };
    
    // Tải một map mẫu nếu không load được map từ URL
    map.onerror = function() {
      map.src = "https://i.imgur.com/DRVfXUF.png"; // Map mẫu
    };
    
    function initMap() {
      // Lấy kích thước thực của map
      robotState.mapWidth = map.naturalWidth;
      robotState.mapHeight = map.naturalHeight;
      
      // Tính toán tọa độ center
      robotState.mapCenterX = robotState.mapWidth / 2;
      robotState.mapCenterY = robotState.mapHeight / 2;
      
      // Đặt robot vào giữa map
      robotState.x = robotState.mapCenterX;
      robotState.y = robotState.mapCenterY;
      
      // Cập nhật vị trí robot
      updateRobotPosition();
      
      // Tạo lưới
      createGrid();
      
      // Cập nhật thông tin
      updateInfoPanel();
      
      // Lưu trạng thái ban đầu vào lịch sử
      saveStateToHistory();
      
      // Cập nhật nút undo/redo
      updateHistoryButtons();
      
      // Cập nhật mini-map
      updateMiniMap();
    }
    
    // Cập nhật vị trí robot
    function updateRobotPosition() {
      // Canh chỉnh vị trí robot container để robot nằm đúng tọa độ
      robotContainer.style.left = `${robotState.x}px`;
      robotContainer.style.top = `${robotState.y}px`;
      
      // Cập nhật góc xoay và tỉ lệ của robot
      robot.style.transform = `translate(-50%, -50%) rotate(${robotState.angle}deg) scale(${robotState.scale})`;
      
      // Cập nhật vị trí điểm trung tâm
      robotCenter.style.left = '0px';  // Luôn ở trung tâm
      robotCenter.style.top = '0px';   // Luôn ở trung tâm
      
      // Cập nhật hiển thị tọa độ
      mapCoordinates.textContent = `Map: X: ${Math.round(robotState.x)}, Y: ${Math.round(robotState.y)}`;
      robotCoordinates.textContent = `Robot: X: ${Math.round(robotState.x - robotState.mapCenterX)}, Y: ${Math.round(robotState.mapCenterY - robotState.y)}`;
      
      // Cập nhật góc
      angleDisplay.textContent = `Góc: ${Math.round(robotState.angle)}°`;
      
      // Cập nhật khoảng cách từ tâm
      const distance = Math.sqrt(
        Math.pow(robotState.x - robotState.mapCenterX, 2) + 
        Math.pow(robotState.y - robotState.mapCenterY, 2)
      );
      distanceDisplay.textContent = `Khoảng cách: ${Math.round(distance)}px`;
      
      // Cập nhật vị trí robot trên mini-map
      updateMiniMapRobot();
    }
    
    // Tạo lưới
    function createGrid() {
      gridOverlay.innerHTML = '';
      
      const gridSize = robotState.gridSize;
      
      // Tạo các đường dọc
      for (let x = 0; x < robotState.mapWidth; x += gridSize) {
        const verticalLine = document.createElement('div');
        verticalLine.className = 'grid-line';
        verticalLine.style.left = `${x}px`;
        verticalLine.style.top = '0';
        verticalLine.style.width = '1px';
        verticalLine.style.height = '100%';
        gridOverlay.appendChild(verticalLine);
      }
      
      // Tạo các đường ngang
      for (let y = 0; y < robotState.mapHeight; y += gridSize) {
        const horizontalLine = document.createElement('div');
        horizontalLine.className = 'grid-line';
        horizontalLine.style.left = '0';
        horizontalLine.style.top = `${y}px`;
        horizontalLine.style.width = '100%';
        horizontalLine.style.height = '1px';
        gridOverlay.appendChild(horizontalLine);
      }
    }
    
    // Cập nhật panel thông tin
    function updateInfoPanel() {
      document.getElementById('info-x').textContent = Math.round(robotState.x - robotState.mapCenterX);
      document.getElementById('info-y').textContent = Math.round(robotState.mapCenterY - robotState.y);
      document.getElementById('info-angle').textContent = `${Math.round(robotState.angle)}°`;
      
      // Tính khoảng cách từ tâm
      const distance = Math.sqrt(
        Math.pow(robotState.x - robotState.mapCenterX, 2) + 
        Math.pow(robotState.y - robotState.mapCenterY, 2)
      );
      document.getElementById('info-distance').textContent = Math.round(distance);
      
      // Cập nhật số lệnh
      document.getElementById('info-command-count').textContent = robotState.commands.length;
    }
    
    // Hàm lưu trạng thái hiện tại vào lịch sử
    function saveStateToHistory() {
      // Nếu đang ở giữa lịch sử, xóa các trạng thái phía sau
      if (robotState.historyIndex < robotState.history.length - 1) {
        robotState.history = robotState.history.slice(0, robotState.historyIndex + 1);
      }
      
      // Sao chép trạng thái hiện tại
      const currentState = {
        x: robotState.x,
        y: robotState.y,
        angle: robotState.angle,
        scale: robotState.scale
      };
      
      // Thêm vào lịch sử
      robotState.history.push(currentState);
      robotState.historyIndex++;
      
      // Giới hạn kích thước lịch sử
      if (robotState.history.length > 50) {
        robotState.history.shift();
        robotState.historyIndex--;
      }
      
      // Cập nhật trạng thái các nút undo/redo
      updateHistoryButtons();
    }
    
    // Cập nhật trạng thái các nút undo/redo
    function updateHistoryButtons() {
      const undoBtn = document.getElementById('undo-btn');
      const redoBtn = document.getElementById('redo-btn');
      const clearHistoryBtn = document.getElementById('clear-history-btn');
      
      undoBtn.disabled = robotState.historyIndex <= 0;
      redoBtn.disabled = robotState.historyIndex >= robotState.history.length - 1;
      clearHistoryBtn.disabled = robotState.history.length <= 1;
    }
    
    // Undo - Hoàn tác
    function undo() {
      if (robotState.historyIndex > 0) {
        robotState.historyIndex--;
        const prevState = robotState.history[robotState.historyIndex];
        
        // Khôi phục trạng thái
        robotState.x = prevState.x;
        robotState.y = prevState.y;
        robotState.angle = prevState.angle;
        robotState.scale = prevState.scale;
        
        // Cập nhật vị trí
        updateRobotPosition();
        updateInfoPanel();
        updateHistoryButtons();
      }
    }
    
    // Redo - Làm lại
    function redo() {
      if (robotState.historyIndex < robotState.history.length - 1) {
        robotState.historyIndex++;
        const nextState = robotState.history[robotState.historyIndex];
        
        // Khôi phục trạng thái
        robotState.x = nextState.x;
        robotState.y = nextState.y;
        robotState.angle = nextState.angle;
        robotState.scale = nextState.scale;
        
        // Cập nhật vị trí
        updateRobotPosition();
        updateInfoPanel();
        updateHistoryButtons();
      }
    }
    
    // Xóa lịch sử
    function clearHistory() {
      // Lưu trạng thái hiện tại
      const currentState = {
        x: robotState.x,
        y: robotState.y,
        angle: robotState.angle,
        scale: robotState.scale
      };
      
      // Khởi tạo lại lịch sử
      robotState.history = [currentState];
      robotState.historyIndex = 0;
      
      // Cập nhật UI
      updateHistoryButtons();
      showToast('Đã xóa lịch sử thao tác', 'success');
    }
    
    // Di chuyển robot theo hướng chỉ định
    function moveRobot(direction) {
      // Lấy bước di chuyển từ input
      const step = parseInt(document.getElementById('move-step-input').value) || 10;
      
      // Góc di chuyển (theo radian)
      let moveAngle = 0;
      
      switch (direction) {
        case 'up':
          moveAngle = -Math.PI / 2; // 270 độ hoặc -90 độ
          break;
        case 'down':
          moveAngle = Math.PI / 2; // 90 độ
          break;
        case 'left':
          moveAngle = Math.PI; // 180 độ
          break;
        case 'right':
          moveAngle = 0; // 0 độ
          break;
        case 'upleft':
          moveAngle = -3 * Math.PI / 4; // 315 độ hoặc -45 độ
          break;
        case 'upright':
          moveAngle = -Math.PI / 4; // 315 độ hoặc -45 độ
          break;
        case 'downleft':
          moveAngle = 3 * Math.PI / 4; // 135 độ
          break;
        case 'downright':
          moveAngle = Math.PI / 4; // 45 độ
          break;
      }
      
      // Tính toán di chuyển
      const robotAngleRad = robotState.angle * Math.PI / 180; // Chuyển đổi sang radian
      const dx = Math.cos(moveAngle) * step;
      const dy = Math.sin(moveAngle) * step;
      
      // Cập nhật vị trí robot
      robotState.x += dx;
      robotState.y += dy;
      
      // Đảm bảo robot không đi ra ngoài map
      robotState.x = Math.max(0, Math.min(robotState.x, robotState.mapWidth));
      robotState.y = Math.max(0, Math.min(robotState.y, robotState.mapHeight));
      
      // Cập nhật vị trí
      updateRobotPosition();
      updateInfoPanel();
      
      // Lưu trạng thái vào lịch sử
      saveStateToHistory();
      
      // Thêm lệnh vào danh sách
      addCommand(`Move ${direction}`, `move-${direction}`);
    }
    
    // Xoay robot
    function rotateRobot(direction) {
      // Lấy góc xoay từ input
      const angle = parseInt(document.getElementById('rotation-angle-input').value) || 45;
      
      // Xoay robot
      if (direction === 'left') {
        robotState.angle -= angle;
      } else if (direction === 'right') {
        robotState.angle += angle;
      }
      
      // Chuẩn hóa góc về khoảng [0, 360)
      robotState.angle = (robotState.angle + 360) % 360;
      
      // Cập nhật vị trí
      updateRobotPosition();
      updateInfoPanel();
      
      // Lưu trạng thái vào lịch sử
      saveStateToHistory();
      
      // Thêm lệnh vào danh sách
      addCommand(`Rotate ${direction}`, `rotate-${direction}`);
    }
    
    // Thay đổi kích thước robot
    function resizeRobot(deltaScale) {
      // Thay đổi tỉ lệ
      robotState.scale += deltaScale;
      
      // Giới hạn tỉ lệ trong khoảng [0.5, 3]
      robotState.scale = Math.max(0.5, Math.min(robotState.scale, 3));
      
      // Cập nhật vị trí
      updateRobotPosition();
      
      // Lưu trạng thái vào lịch sử
      saveStateToHistory();
    }
    
    // Đưa robot về vị trí ban đầu
    function centerRobot() {
      robotState.x = robotState.mapCenterX;
      robotState.y = robotState.mapCenterY;
      robotState.angle = 0;
      
      // Cập nhật vị trí
      updateRobotPosition();
      updateInfoPanel();
      
      // Lưu trạng thái vào lịch sử
      saveStateToHistory();
      
      // Thêm lệnh vào danh sách
      addCommand('Center robot', 'center');
      
      showToast('Đã đưa robot về vị trí ban đầu', 'success');
    }
    
    // Thêm lệnh vào danh sách
    function addCommand(text, type) {
      const command = {
        text: text,
        type: type,
        x: robotState.x,
        y: robotState.y,
        angle: robotState.angle,
        scale: robotState.scale
      };
      
      robotState.commands.push(command);
      updateCommandList();
    }
    
    // Cập nhật danh sách lệnh
    function updateCommandList() {
      const commandList = document.getElementById('command-list');
      commandList.innerHTML = '';
      
      robotState.commands.forEach((command, index) => {
        const li = document.createElement('li');
        li.className = `command-${command.type}`;
        
        li.innerHTML = `
          <span>${index + 1}. ${command.text}</span>
          <div class="command-actions">
            <button class="command-edit" data-index="${index}" title="Chỉnh sửa">
              <i class="fas fa-edit"></i>
            </button>
            <button class="command-delete" data-index="${index}" title="Xóa">
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
        `;
        
        commandList.appendChild(li);
      });
      
      // Kéo xuống dưới cùng để hiển thị lệnh mới nhất
      commandList.scrollTop = commandList.scrollHeight;
      
      // Cập nhật số lệnh trong panel thông tin
      document.getElementById('info-command-count').textContent = robotState.commands.length;
      
      // Cập nhật trạng thái nút xóa tất cả
      document.getElementById('clear-commands-btn').disabled = robotState.commands.length === 0;
      document.getElementById('execute-commands-btn').disabled = robotState.commands.length === 0;
      document.getElementById('save-commands-btn').disabled = robotState.commands.length === 0;
      
      // Thêm event listener cho các nút
      document.querySelectorAll('.command-delete').forEach(button => {
        button.addEventListener('click', function() {
          const index = parseInt(this.dataset.index);
          deleteCommand(index);
        });
      });
      
      document.querySelectorAll('.command-edit').forEach(button => {
        button.addEventListener('click', function() {
          const index = parseInt(this.dataset.index);
          editCommand(index);
        });
      });
    }
    
    // Xóa lệnh
    function deleteCommand(index) {
      robotState.commands.splice(index, 1);
      updateCommandList();
      showToast('Đã xóa lệnh', 'success');
    }
    
    // Chỉnh sửa lệnh
    function editCommand(index) {
      showToast('Chức năng chỉnh sửa lệnh đang được phát triển', 'info');
    }
    
    // Xóa tất cả lệnh
    function clearCommands() {
      robotState.commands = [];
      updateCommandList();
      showToast('Đã xóa tất cả lệnh', 'success');
    }
    
    // Thực thi danh sách lệnh
    function executeCommands() {
      if (robotState.commands.length === 0) return;
      
      showToast('Bắt đầu thực thi lệnh', 'info');
      
      // Biến để theo dõi lệnh đang thực thi
      let currentIndex = 0;
      
      // Khôi phục robot về vị trí ban đầu
      centerRobot();
      
      // Hàm thực thi từng lệnh
      function executeNext() {
        if (currentIndex >= robotState.commands.length) {
          showToast('Đã thực thi xong tất cả lệnh', 'success');
          return;
        }
        
        const command = robotState.commands[currentIndex];
        
        // Tô sáng lệnh đang thực thi
        const commandItems = document.querySelectorAll('#command-list li');
        commandItems.forEach((item, i) => {
          if (i === currentIndex) {
            item.style.backgroundColor = 'rgba(255, 193, 7, 0.3)';
          } else {
            item.style.backgroundColor = '';
          }
        });
        
        // Cuộn danh sách để hiển thị lệnh đang thực thi
        const commandList = document.getElementById('command-list');
        const li = commandItems[currentIndex];
        if (li) {
          li.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // Cập nhật robot theo lệnh
        const type = command.type;
        
        switch (type) {
          case 'move-up':
            moveRobot('up');
            break;
          case 'move-down':
            moveRobot('down');
            break;
          case 'move-left':
            moveRobot('left');
            break;
          case 'move-right':
            moveRobot('right');
            break;
          case 'move-upleft':
            moveRobot('upleft');
            break;
          case 'move-upright':
            moveRobot('upright');
            break;
          case 'move-downleft':
            moveRobot('downleft');
            break;
          case 'move-downright':
            moveRobot('downright');
            break;
          case 'rotate-left':
            rotateRobot('left');
            break;
          case 'rotate-right':
            rotateRobot('right');
            break;
          case 'center':
            centerRobot();
            break;
        }
        
        // Chuyển sang lệnh tiếp theo
        currentIndex++;
        
        // Tạm dừng một chút trước khi thực thi lệnh tiếp theo
        setTimeout(executeNext, 500);
      }
      
      // Bắt đầu thực thi
      executeNext();
    }
    
    // Cập nhật vị trí robot trên mini-map
    function updateMiniMapRobot() {
      // Tỉ lệ thu nhỏ
      const scaleX = miniMap.clientWidth / robotState.mapWidth;
      const scaleY = miniMap.clientHeight / robotState.mapHeight;
      
      // Vị trí robot trên mini-map
      const miniX = robotState.x * scaleX;
      const miniY = robotState.y * scaleY;
      
      // Cập nhật vị trí
      miniMapRobot.style.left = `${miniX}px`;
      miniMapRobot.style.top = `${miniY}px`;
    }
    
    // Cập nhật mini-map
    function updateMiniMap() {
      // Tạo hình ảnh thu nhỏ cho mini-map
      const miniMapImage = document.createElement('img');
      miniMapImage.src = map.src;
      miniMapImage.style.width = '100%';
      miniMapImage.style.height = '100%';
      miniMapImage.style.position = 'absolute';
      miniMapImage.style.top = '0';
      miniMapImage.style.left = '0';
      miniMapImage.style.objectFit = 'cover';
      
      // Xóa hình ảnh cũ (nếu có)
      const oldImage = miniMap.querySelector('img');
      if (oldImage) {
        miniMap.removeChild(oldImage);
      }
      
      // Thêm hình ảnh mới
      miniMap.insertBefore(miniMapImage, miniMap.firstChild);
      
      // Cập nhật vị trí robot trên mini-map
      updateMiniMapRobot();
    }
    
    // Hiển thị thông báo toast
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = message;
      
      const toastContainer = document.getElementById('toast-container');
      toastContainer.appendChild(toast);
      
      // Hiển thị toast sau 10ms để có animation
      setTimeout(() => {
        toast.classList.add('show');
      }, 10);
      
      // Tự động ẩn sau 3 giây
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          toastContainer.removeChild(toast);
        }, 300);
      }, 3000);
    }
    
    // Bật/tắt chế độ tối
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      showToast(`Đã ${document.body.classList.contains('dark-mode') ? 'bật' : 'tắt'} chế độ tối`, 'info');
    }
    
    // Bật/tắt hiển thị lưới
    function toggleGrid() {
      robotState.isGridVisible = !robotState.isGridVisible;
      gridOverlay.style.display = robotState.isGridVisible ? 'block' : 'none';
      showToast(`Đã ${robotState.isGridVisible ? 'hiện' : 'ẩn'} lưới`, 'info');
    }

    // Bật/tắt hiển thị mini-map
    function toggleMiniMap() {
      robotState.isMiniMapVisible = !robotState.isMiniMapVisible;
      miniMapContainer.style.display = robotState.isMiniMapVisible ? 'block' : 'none';
      showToast(`Đã ${robotState.isMiniMapVisible ? 'hiện' : 'ẩn'} mini-map`, 'info');
    }

    // Bật/tắt chế độ điều chỉnh vị trí
    function toggleAdjustPositionsMode() {
      robotState.adjustPositionsMode = !robotState.adjustPositionsMode;
      
      if (robotState.adjustPositionsMode) {
        // Bật chế độ di chuyển
        coordinatesDisplay.classList.add('draggable');
        miniMapContainer.classList.add('draggable');
        showToast('Đã bật chế độ điều chỉnh vị trí. Bạn có thể kéo các thành phần để di chuyển.', 'info');
      } else {
        // Tắt chế độ di chuyển
        coordinatesDisplay.classList.remove('draggable');
        miniMapContainer.classList.remove('draggable');
        showToast('Đã tắt chế độ điều chỉnh vị trí', 'info');
      }
    }
    
    // Xử lý kéo di chuyển mini-map
    function handleMiniMapDrag(e) {
      if (!robotState.adjustPositionsMode) return;
      
      if (e.type === 'mousedown') {
        robotState.isDraggingMiniMap = true;
        robotState.dragStartX = e.clientX;
        robotState.dragStartY = e.clientY;
        robotState.miniMapStartLeft = parseInt(window.getComputedStyle(miniMapContainer).left);
        robotState.miniMapStartTop = parseInt(window.getComputedStyle(miniMapContainer).top);
      } else if (e.type === 'mousemove' && robotState.isDraggingMiniMap) {
        const dx = e.clientX - robotState.dragStartX;
        const dy = e.clientY - robotState.dragStartY;
        
        miniMapContainer.style.left = `${robotState.miniMapStartLeft + dx}px`;
        miniMapContainer.style.top = `${robotState.miniMapStartTop + dy}px`;
      } else if (e.type === 'mouseup') {
        robotState.isDraggingMiniMap = false;
      }
    }
    
    // Xử lý kéo di chuyển hiển thị tọa độ
    function handleCoordinatesDrag(e) {
      if (!robotState.adjustPositionsMode) return;
      
      if (e.type === 'mousedown') {
        robotState.isDraggingCoordinates = true;
        robotState.dragStartX = e.clientX;
        robotState.dragStartY = e.clientY;
        robotState.coordStartLeft = parseInt(window.getComputedStyle(coordinatesDisplay).left);
        robotState.coordStartTop = parseInt(window.getComputedStyle(coordinatesDisplay).top);
      } else if (e.type === 'mousemove' && robotState.isDraggingCoordinates) {
        const dx = e.clientX - robotState.dragStartX;
        const dy = e.clientY - robotState.dragStartY;
        
        coordinatesDisplay.style.left = `${robotState.coordStartLeft + dx}px`;
        coordinatesDisplay.style.top = `${robotState.coordStartTop + dy}px`;
      } else if (e.type === 'mouseup') {
        robotState.isDraggingCoordinates = false;
      }
    }
    
    // Event Listeners
    
    // Đăng ký sự kiện cho phím tắt
    document.addEventListener('keydown', function(e) {
      // Bỏ qua nếu đang nhập vào input
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      
      // Kiểm tra xem phím có trong danh sách không
      const buttonId = hotkeys[e.code];
      if (buttonId) {
        e.preventDefault(); // Ngăn hành động mặc định của phím
        
        // Bấm nút tương ứng
        const button = document.getElementById(buttonId);
        if (button && !button.disabled) {
          button.click();
        }
      }
    });
    
    // Sự kiện kéo thả robot
    robotContainer.addEventListener('mousedown', function(e) {
      e.preventDefault();
      
      // Bỏ qua nếu nhấp vào điểm center
      if (e.target === robotCenter) return;
      
      robotState.isDraggingRobot = true;
      robotContainer.classList.add('dragging');
      
      // Lưu vị trí ban đầu
      robotState.dragStartX = e.clientX;
      robotState.dragStartY = e.clientY;
      robotState.robotStartX = robotState.x;
      robotState.robotStartY = robotState.y;
    });
    
    document.addEventListener('mousemove', function(e) {
      // Xử lý khi kéo robot
      if (robotState.isDraggingRobot) {
        const dx = e.clientX - robotState.dragStartX;
        const dy = e.clientY - robotState.dragStartY;
        
        robotState.x = robotState.robotStartX + dx;
        robotState.y = robotState.robotStartY + dy;
        
        // Giới hạn robot trong map
        robotState.x = Math.max(0, Math.min(robotState.x, robotState.mapWidth));
        robotState.y = Math.max(0, Math.min(robotState.y, robotState.mapHeight));
        
        updateRobotPosition();
        updateInfoPanel();
      }
      
      // Hiển thị vị trí chuột
      const rect = mapContainer.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;
      
      if (mouseX >= 0 && mouseX <= rect.width && mouseY >= 0 && mouseY <= rect.height) {
        // Tỉ lệ thu nhỏ cho mini-map
        const scaleX = miniMap.clientWidth / rect.width;
        const scaleY = miniMap.clientHeight / rect.height;
        
        // Vị trí chuột trên mini-map
        const miniX = mouseX * scaleX;
        const miniY = mouseY * scaleY;
        
        // Cập nhật vị trí
        mousePositionIndicator.style.left = `${miniX}px`;
        mousePositionIndicator.style.top = `${miniY}px`;
        mousePositionIndicator.style.display = 'block';
      } else {
        mousePositionIndicator.style.display = 'none';
      }
      
      // Xử lý kéo mini-map
      handleMiniMapDrag(e);
      
      // Xử lý kéo hiển thị tọa độ
      handleCoordinatesDrag(e);
    });
    
    document.addEventListener('mouseup', function() {
      // Kết thúc kéo robot
      if (robotState.isDraggingRobot) {
        robotState.isDraggingRobot = false;
        robotContainer.classList.remove('dragging');
        
        // Lưu trạng thái vào lịch sử
        saveStateToHistory();
      }
      
      // Kết thúc kéo mini-map
      handleMiniMapDrag({ type: 'mouseup' });
      
      // Kết thúc kéo hiển thị tọa độ
      handleCoordinatesDrag({ type: 'mouseup' });
    });
    
    // Sự kiện thay đổi kích thước robot
    robotCenter.addEventListener('mousedown', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      robotState.isResizing = true;
      robotState.resizeStartX = e.clientX;
      robotState.resizeStartY = e.clientY;
      robotState.startScale = robotState.scale;
    });
    
    document.addEventListener('mousemove', function(e) {
      if (robotState.isResizing) {
        const dx = e.clientX - robotState.resizeStartX;
        const dy = e.clientY - robotState.resizeStartY;
        
        // Dùng khoảng cách để tính tỉ lệ phóng to/thu nhỏ
        const distance = Math.sqrt(dx * dx + dy * dy);
        const sign = (dx + dy) > 0 ? 1 : -1;
        
        // Điều chỉnh tỉ lệ
        robotState.scale = robotState.startScale + sign * distance / 100;
        
        // Giới hạn tỉ lệ trong khoảng [0.5, 3]
        robotState.scale = Math.max(0.5, Math.min(robotState.scale, 3));
        
        // Cập nhật vị trí
        updateRobotPosition();
      }
    });
    
    document.addEventListener('mouseup', function() {
      if (robotState.isResizing) {
        robotState.isResizing = false;
        
        // Lưu trạng thái vào lịch sử
        saveStateToHistory();
      }
    });
    
    // Xử lý setting dropdown
    settingsButton.addEventListener('click', function(e) {
      e.stopPropagation();
      settingsDropdown.style.display = settingsDropdown.style.display === 'block' ? 'none' : 'block';
    });
    
    document.addEventListener('click', function(e) {
      if (e.target !== settingsButton && !settingsDropdown.contains(e.target)) {
        settingsDropdown.style.display = 'none';
      }
    });
    
    // Di chuyển mini-map
    miniMapContainer.addEventListener('mousedown', function(e) {
      if (robotState.adjustPositionsMode) {
        handleMiniMapDrag(e);
      }
    });
    
    // Di chuyển hiển thị tọa độ
    coordinatesDisplay.addEventListener('mousedown', function(e) {
      if (robotState.adjustPositionsMode) {
        handleCoordinatesDrag(e);
      }
    });
    
    // Các nút điều khiển
    
    // Ẩn/hiện lưới
    gridToggleButton.addEventListener('click', toggleGrid);
    
    // Chế độ tối
    themeToggle.addEventListener('click', toggleDarkMode);
    
    // Các nút lịch sử
    document.getElementById('undo-btn').addEventListener('click', undo);
    document.getElementById('redo-btn').addEventListener('click', redo);
    document.getElementById('clear-history-btn').addEventListener('click', clearHistory);
    
    // Các nút di chuyển
    document.getElementById('move-up').addEventListener('click', () => moveRobot('up'));
    document.getElementById('move-down').addEventListener('click', () => moveRobot('down'));
    document.getElementById('move-left').addEventListener('click', () => moveRobot('left'));
    document.getElementById('move-right').addEventListener('click', () => moveRobot('right'));
    document.getElementById('move-upleft').addEventListener('click', () => moveRobot('upleft'));
    document.getElementById('move-upright').addEventListener('click', () => moveRobot('upright'));
    document.getElementById('move-downleft').addEventListener('click', () => moveRobot('downleft'));
    document.getElementById('move-downright').addEventListener('click', () => moveRobot('downright'));
    
    // Nút đưa robot về vị trí ban đầu
    document.getElementById('center-robot').addEventListener('click', centerRobot);
    
    // Các nút xoay
    document.getElementById('rotate-left').addEventListener('click', () => rotateRobot('left'));
    document.getElementById('rotate-right').addEventListener('click', () => rotateRobot('right'));
    
    // Nút xóa tất cả lệnh
    document.getElementById('clear-commands-btn').addEventListener('click', clearCommands);
    
    // Nút thực thi lệnh
    document.getElementById('execute-commands-btn').addEventListener('click', executeCommands);
    
    // Nút lưu lệnh
    document.getElementById('save-commands-btn').addEventListener('click', function() {
      showToast('Chức năng lưu lệnh đang được phát triển', 'info');
    });
    
    // Điều chỉnh vị trí
    adjustPositionsOption.addEventListener('click', function() {
      toggleAdjustPositionsMode();
      settingsDropdown.style.display = 'none';
    });
    
    // Ẩn/hiện mini-map
    toggleMiniMapOption.addEventListener('click', function() {
      toggleMiniMap();
      settingsDropdown.style.display = 'none';
    });
  </script>
</body>
</html>
