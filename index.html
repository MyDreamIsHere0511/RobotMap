<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Robot Map Interface</title>
  <style>
    :root {
      --primary-color: #3498db;
      --secondary-color: #2ecc71;
      --accent-color: #f39c12;
      --danger-color: #e74c3c;
      --light-bg: #f5f5f5;
      --dark-bg: #2c3e50;
      --text-dark: #333;
      --text-light: #f5f5f5;
      --border-color: #ddd;
      --shadow: 0 2px 5px rgba(0,0,0,0.1);
      --theme-transition: background-color 0.3s, color 0.3s;
      
      /* M√†u cho c√°c command block */
      --move-up-bg: #d1e7dd;
      --move-down-bg: #f8d7da;
      --move-left-bg: #cfe2ff;
      --move-right-bg: #fff3cd;
      --move-upleft-bg: #d8f3dc;
      --move-upright-bg: #e9ecef;
      --move-downleft-bg: #e0e1ff;
      --move-downright-bg: #ffe8d9;
      --spin-bg: #d8d8ff;
      --rotate-left-bg: #ffccd5;
      --rotate-right-bg: #c9f7f5;
    }
    
    body.dark-mode {
      --light-bg: #1a1a2e;
      --border-color: #444;
      --text-dark: #f5f5f5;
      
      /* M√†u t·ªëi cho c√°c command block */
      --move-up-bg: #1e4d3d;
      --move-down-bg: #4d2828;
      --move-left-bg: #1e294d;
      --move-right-bg: #4d412e;
      --move-upleft-bg: #1e3e2e;
      --move-upright-bg: #2e2e2e;
      --move-downleft-bg: #252540;
      --move-downright-bg: #40332a;
      --spin-bg: #2e2e4d;
      --rotate-left-bg: #4d2a38;
      --rotate-right-bg: #2a4d49;
    }
    
    body {
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
      background-color: var(--light-bg);
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    #header-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      z-index: 1000;
      box-shadow: var(--shadow);
    }
    
    #header-bar .title {
      font-weight: bold;
      font-size: 1.2em;
    }
    
    #header-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .header-button {
      padding: 5px 10px;
      background-color: rgba(255,255,255,0.2);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .header-button:hover {
      background-color: rgba(255,255,255,0.3);
    }
    
    .theme-toggle {
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    
    .theme-toggle span {
      margin-right: 5px;
    }
    
    .toggle-switch {
      position: relative;
      width: 40px;
      height: 20px;
      background-color: rgba(0,0,0,0.3);
      border-radius: 10px;
      transition: background-color 0.3s;
    }
    
    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: white;
      top: 2px;
      left: 2px;
      transition: transform 0.3s;
    }
    
    .dark-mode .toggle-switch {
      background-color: var(--accent-color);
    }
    
    .dark-mode .toggle-switch::after {
      transform: translateX(20px);
    }
    
    #main-container {
      display: flex;
      width: 100%;
      height: 100%;
      padding-top: 40px; /* ƒê·ªÉ tr√°nh b·ªã header che */
    }
    
    #sidebar {
      width: 320px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border-color);
      background-color: var(--light-bg);
      overflow-y: auto;
      resize: horizontal;
      min-width: 250px;
      max-width: 500px;
      transition: var(--theme-transition);
    }
    
    #sidebar-resizer {
      position: absolute;
      width: 8px;
      height: calc(100% - 40px); /* Tr·ª´ ƒëi height c·ªßa header */
      left: 320px;
      top: 40px; /* B·∫Øt ƒë·∫ßu t·ª´ d∆∞·ªõi header */
      background-color: var(--border-color);
      cursor: ew-resize;
      z-index: 100;
      transition: background-color 0.2s;
    }
    
    #sidebar-resizer:hover {
      background-color: var(--primary-color);
    }
    
    #sidebar-resizer::after {
      content: "‚´¥";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--text-dark);
      font-size: 12px;
    }
    
    #display-area {
      flex: 1;
      position: relative;
      overflow: hidden;
      background-color: var(--light-bg);
      transition: var(--theme-transition);
    }
    
    #map-container {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      overflow: hidden;
    }
    
    #map {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      position: relative;
      z-index: 1; /* ƒê·∫£m b·∫£o map n·∫±m d∆∞·ªõi robot */
      user-select: none;
    }
    
    /* Grid overlay */
    #grid-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      opacity: 0.5;
      display: none;
      z-index: 2; /* L∆∞·ªõi hi·ªÉn th·ªã tr√™n map */
    }
    
    .grid-line {
      position: absolute;
      background-color: rgba(0, 0, 255, 0.3);
    }
    
    /* Coordinate display */
    #coordinates-display {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 14px;
      z-index: 10;
      display: flex;
      flex-direction: column;
    }
    
    #coordinates-display div {
      margin: 2px 0;
    }
    
    /* Mini-map display */
    #mini-map-container {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 150px;
      height: 150px;
      background-color: rgba(0, 0, 0, 0.7);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      z-index: 10;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }
    
    #mini-map {
      width: 100%;
      height: 100%;
      position: relative;
    }
    
    #mini-map-indicator {
      position: absolute;
      width: 8px;
      height: 8px;
      background-color: #ff0000;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: 2;
    }
    
    #mouse-position-indicator {
      position: absolute;
      width: 6px;
      height: 6px;
      background-color: #ffff00;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: 1;
    }
    
    #mini-map-robot {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: var(--accent-color);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: 3;
    }
    
    /* Robot styling */
    #robot-container {
      position: absolute;
      z-index: 5; /* ƒê·∫£m b·∫£o robot hi·ªÉn th·ªã tr√™n map */
      cursor: grab;
      transition: transform 0.3s ease;
    }
    
    #robot-container.dragging {
      cursor: grabbing;
      z-index: 10;
      filter: drop-shadow(0 5px 15px rgba(0,0,0,0.6));
    }
    
    #robot {
      position: absolute;
      width: 50px; /* K√≠ch th∆∞·ªõc m·∫∑c ƒë·ªãnh */
      transform-origin: center center;
      transition: transform 0.1s linear, left 0.1s linear, top 0.1s linear;
      filter: drop-shadow(0 3px 5px rgba(0,0,0,0.3));
      user-select: none;
    }
    
    /* Waypoint markers */
    .waypoint-marker {
      position: absolute;
      width: 15px;
      height: 15px;
      background-color: var(--accent-color);
      border: 2px solid white;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: 5;
      cursor: pointer;
      box-shadow: 0 0 5px rgba(0,0,0,0.5);
    }
    
    .waypoint-marker:hover {
      background-color: #e67e22;
    }
    
    .waypoint-label {
      position: absolute;
      background-color: rgba(0,0,0,0.7);
      color: white;
      padding: 2px 5px;
      border-radius: 3px;
      font-size: 12px;
      white-space: nowrap;
      transform: translateY(-120%);
      user-select: none;
    }
    
    /* Ph√¢n khu 1: ƒêi·ªÅu khi·ªÉn */
    .panel-section {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
      transition: var(--theme-transition);
    }
    
    .panel-section-title {
      margin: 0 0 10px 0;
      color: var(--primary-color);
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .controls-title {
      margin: 8px 0;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: var(--theme-transition);
    }
    
    .history-controls {
      display: flex;
      gap: 5px;
    }
    
    .history-controls button {
      padding: 4px 8px;
      background-color: var(--light-bg);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .history-controls button:hover:not(:disabled) {
      background-color: var(--primary-color);
      color: white;
    }
    
    .history-controls button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .movement-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 5px;
      margin-bottom: 10px;
    }
    
    .movement-grid button {
      padding: 10px 0;
      background-color: var(--light-bg);
      border: 1px solid var(--border-color);
      cursor: pointer;
      border-radius: 4px;
      color: var(--text-dark);
      font-weight: 500;
      transition: background-color 0.2s, var(--theme-transition);
    }
    
    .movement-grid button:hover {
      background-color: var(--primary-color);
      color: white;
    }
    
    .rotation-controls {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
    }
    
    .rotation-controls button {
      flex: 1;
      padding: 10px 0;
      background-color: var(--light-bg);
      border: 1px solid var(--border-color);
      cursor: pointer;
      border-radius: 4px;
      color: var(--text-dark);
      font-weight: 500;
      transition: background-color 0.2s, var(--theme-transition);
    }
    
    .rotation-controls button:hover {
      background-color: var(--primary-color);
      color: white;
    }
    
    /* Position control panel */
    .position-control-panel {
      background-color: rgba(52, 152, 219, 0.1);
      border: 1px solid rgba(52, 152, 219, 0.3);
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 15px;
    }
    
    .position-control-panel h5 {
      margin-top: 0;
      margin-bottom: 8px;
      color: var(--primary-color);
    }
    
    .coordinate-inputs {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .coordinate-input {
      flex: 1;
    }
    
    .coordinate-input label {
      display: block;
      font-size: 0.9em;
      margin-bottom: 3px;
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .coordinate-input input {
      width: 100%;
      padding: 6px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--light-bg);
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .move-to-coords-btn {
      width: 100%;
      padding: 8px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .move-to-coords-btn:hover {
      background-color: #2980b9;
    }
    
    .toggle-controls {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .control-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .control-toggle input[type="checkbox"] {
      margin: 0;
      width: 16px;
      height: 16px;
    }
    
    .step-size-control {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 5px;
      padding: 8px;
      background-color: rgba(250, 250, 250, 0.5);
      border-radius: 4px;
      border: 1px solid var(--border-color);
      transition: var(--theme-transition);
    }
    
    .dark-mode .step-size-control {
      background-color: rgba(30, 30, 30, 0.5);
    }
    
    .step-size-control label {
      white-space: nowrap;
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .step-size-control input {
      width: 60px;
      text-align: center;
      padding: 5px;
      border: 1px solid var(--border-color);
      border-radius: 3px;
      background-color: var(--light-bg);
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .step-size-control .unit {
      color: var(--text-dark);
      font-size: 0.9em;
      transition: var(--theme-transition);
    }
    
    .direction-toggle-container {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-top: 8px;
    }
    
    .direction-toggle-btn {
      padding: 8px;
      background-color: rgba(250, 250, 250, 0.5);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--theme-transition);
    }
    
    .dark-mode .direction-toggle-btn {
      background-color: rgba(30, 30, 30, 0.5);
    }
    
    .direction-toggle {
      display: flex;
      gap: 5px;
    }
    
    .direction-toggle button {
      padding: 5px 10px;
      background-color: var(--light-bg);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .direction-toggle button.active {
      background-color: var(--accent-color);
      color: white;
      font-weight: bold;
    }
    
    .unit-display {
      margin-top: 8px;
      margin-bottom: 12px;
      padding: 8px;
      background-color: rgba(250, 250, 250, 0.5);
      border-radius: 4px;
      border: 1px solid var(--border-color);
      font-size: 0.9em;
      display: flex;
      flex-direction: column;
      gap: 5px;
      transition: var(--theme-transition);
    }
    
    .dark-mode .unit-display {
      background-color: rgba(30, 30, 30, 0.5);
    }
    
    .unit-display strong {
      color: var(--primary-color);
    }
    
    .robot-resize-controls {
      margin: 15px 0;
    }
    
    .resize-controls-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .resize-slider {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .resize-slider input[type="range"] {
      flex: 1;
      height: 5px;
      appearance: none;
      background: linear-gradient(to right, var(--primary-color) 0%, var(--primary-color) 50%, #ddd 50%, #ddd 100%);
      border-radius: 2px;
      outline: none;
    }
    
    .resize-slider input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 15px;
      height: 15px;
      background: white;
      border: 2px solid var(--primary-color);
      border-radius: 50%;
      cursor: pointer;
    }
    
    .resize-slider .size-value {
      width: 40px;
      text-align: right;
      font-weight: 500;
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    /* Map position controls */
    .map-position-control {
      margin: 15px 0;
    }
    
    .map-position-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .map-position-toggle input[type="checkbox"] {
      margin: 0;
      width: 16px;
      height: 16px;
    }
    
    .save-controls {
      margin-top: 15px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .save-controls button {
      padding: 10px 0;
      border: 1px solid var(--border-color);
      cursor: pointer;
      border-radius: 4px;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: background-color 0.2s;
    }
    
    .save-controls button.save-position {
      background-color: rgba(46, 204, 113, 0.15);
      color: #27ae60;
    }
    
    .save-controls button.save-position:hover {
      background-color: rgba(46, 204, 113, 0.3);
    }
    
    .save-controls button.save-size {
      background-color: rgba(52, 152, 219, 0.15);
      color: #2980b9;
    }
    
    .save-controls button.save-size:hover {
      background-color: rgba(52, 152, 219, 0.3);
    }
    
    .save-controls button.save-program {
      background-color: rgba(243, 156, 18, 0.15);
      color: #d35400;
    }
    
    .save-controls button.save-program:hover {
      background-color: rgba(243, 156, 18, 0.3);
    }
    
    .save-controls button.export-data {
      background-color: rgba(156, 39, 176, 0.15);
      color: #8e44ad;
    }
    
    .save-controls button.export-data:hover {
      background-color: rgba(156, 39, 176, 0.3);
    }
    
    .saved-items-heading {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 12px 0 5px 0;
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .saved-items {
      margin-top: 5px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      max-height: 120px;
      overflow-y: auto;
      background-color: var(--light-bg);
      transition: var(--theme-transition);
    }
    
    .saved-item {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .saved-item:hover {
      background-color: rgba(52, 152, 219, 0.1);
    }
    
    .saved-item:last-child {
      border-bottom: none;
    }
    
    .saved-item button {
      background: none;
      border: none;
      color: var(--danger-color);
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      transition: transform 0.1s;
    }
    
    .saved-item button:hover {
      transform: scale(1.2);
    }
    
    /* Ph√¢n khu 2: L·∫≠p tr√¨nh kh·ªëi */
    .block-container {
      display: flex;
      margin-bottom: 10px;
      max-height: 250px; /* Gi·ªõi h·∫°n chi·ªÅu cao ƒë·ªÉ v·ª´a m√†n h√¨nh */
      gap: 10px;
    }
    
    .block-library {
      flex: 1;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 10px;
      background-color: var(--light-bg);
      overflow-y: auto;
      transition: var(--theme-transition);
    }
    
    .program-area {
      flex: 1;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 10px;
      background-color: var(--light-bg);
      overflow-y: auto;
      transition: var(--theme-transition);
    }
    
    .command-block {
      margin: 5px 0;
      padding: 8px;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 4px;
      cursor: move;
      display: flex;
      align-items: center;
      font-size: 0.9em;
      position: relative;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: transform 0.1s, box-shadow 0.1s;
    }
    
    .command-block:hover {
      transform: translateY(-2px);
      box-shadow: 0 3px 5px rgba(0,0,0,0.2);
    }
    
    .command-block input {
      width: 60px;
      margin-left: 5px;
      text-align: center;
      padding: 4px;
      border: 1px solid var(--border-color);
      border-radius: 3px;
      background-color: var(--light-bg);
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .unit-label {
      font-size: 0.8em;
      margin-left: 2px;
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .command-block .block-controls {
      margin-left: auto;
      display: flex;
      gap: 5px;
    }
    
    .command-block .block-controls button {
      background: none;
      border: none;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      padding: 2px 5px;
    }
    
    .command-block .block-controls .delete-block {
      color: var(--danger-color);
    }
    
    .command-block .block-controls .toggle-block {
      color: var(--primary-color);
    }
    
    .command-block.selected-block {
      box-shadow: 0 0 0 2px var(--primary-color);
    }
    
    .command-block.dragging {
      opacity: 0.7;
      z-index: 1000;
    }
    
    .command-block.disabled {
      opacity: 0.5;
      text-decoration: line-through;
      background-color: rgba(240,240,240,0.5) !important;
    }
    
    .dark-mode .command-block.disabled {
      background-color: rgba(40,40,40,0.5) !important;
    }
    
    .drag-indicator {
      height: 3px;
      background-color: var(--primary-color);
      margin: 2px 0;
      display: none;
      border-radius: 1.5px;
    }
    
    .drag-indicator.active {
      display: block;
    }
    
    .command-block.move-up { background-color: var(--move-up-bg); }
    .command-block.move-down { background-color: var(--move-down-bg); }
    .command-block.move-left { background-color: var(--move-left-bg); }
    .command-block.move-right { background-color: var(--move-right-bg); }
    .command-block.move-upleft { background-color: var(--move-upleft-bg); }
    .command-block.move-upright { background-color: var(--move-upright-bg); }
    .command-block.move-downleft { background-color: var(--move-downleft-bg); }
    .command-block.move-downright { background-color: var(--move-downright-bg); }
    .command-block.spin { background-color: var(--spin-bg); }
    .command-block.rotate-left { background-color: var(--rotate-left-bg); }
    .command-block.rotate-right { background-color: var(--rotate-right-bg); }
    
    .run-program {
      display: block;
      width: 100%;
      padding: 12px;
      margin-top: 12px;
      background-color: var(--secondary-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: background-color 0.2s;
    }
    
    .run-program:hover {
      background-color: #27ae60;
    }
    
    .run-program.running {
      background-color: var(--danger-color);
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    
    /* ƒêi·ªÉm resize cho robot */
    .resize-handle {
      position: absolute;
      width: 12px;
      height: 12px;
      background-color: var(--danger-color);
      border: 2px solid white;
      border-radius: 50%;
      bottom: -6px;
      right: -6px;
      cursor: nwse-resize;
      z-index: 10;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    
    /* Input t√™n l∆∞u */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .modal-dialog {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      width: 300px;
      transform: translateY(-20px);
      transition: transform 0.3s;
    }
    
    .modal-overlay.active .modal-dialog {
      transform: translateY(0);
    }
    
    .dark-mode .modal-dialog {
      background-color: #2c3e50;
      color: white;
    }
    
    .modal-dialog h4 {
      margin-top: 0;
      color: var(--primary-color);
    }
    
    .modal-dialog input {
      width: 100%;
      padding: 10px;
      margin: 10px 0 15px 0;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 14px;
      background-color: var(--light-bg);
      color: var(--text-dark);
    }
    
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .modal-dialog button {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .modal-dialog button.primary {
      background-color: var(--primary-color);
      color: white;
    }
    
    .modal-dialog button.secondary {
      background-color: #e0e0e0;
      color: #333;
    }
    
    /* Import/Export Modal */
    .import-export-textarea {
      width: 100%;
      min-height: 150px;
      padding: 10px;
      font-family: monospace;
      margin: 10px 0;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      resize: vertical;
      background-color: var(--light-bg);
      color: var(--text-dark);
    }
    
    /* Tooltip */
    .tooltip {
      position: absolute;
      background-color: rgba(0,0,0,0.8);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      white-space: nowrap;
    }
    
    /* Notification */
    .notification {
      position: fixed;
      top: 60px;
      right: 20px;
      background-color: var(--primary-color);
      color: white;
      padding: 12px 20px;
      border-radius: 4px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      transform: translateX(120%);
      transition: transform 0.3s;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.success {
      background-color: var(--secondary-color);
    }
    
    .notification.error {
      background-color: var(--danger-color);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      #sidebar {
        width: 100%;
        max-width: none;
        position: absolute;
        height: 50%;
        bottom: 0;
        z-index: 100;
        border-top: 1px solid var(--border-color);
        border-right: none;
        resize: none;
      }
      
      #sidebar-resizer {
        display: none;
      }
      
      #display-area {
        height: 50%;
      }
      
      .block-container {
        flex-direction: column;
        max-height: none;
      }
      
      .block-library, .program-area {
        max-height: 150px;
      }
    }
  </style>
</head>
<body>
  <!-- Header Bar -->
  <div id="header-bar">
    <div class="title">Robot Map Interface</div>
    <div id="header-controls">
      <button id="toggle-grid-btn" class="header-button">Hi·ªán/·∫®n L∆∞·ªõi</button>
      <button id="add-waypoint-btn" class="header-button">ƒê√°nh D·∫•u ƒêi·ªÉm</button>
      <div class="theme-toggle" onclick="toggleTheme()">
        <span id="theme-text">Ch·∫ø ƒë·ªô t·ªëi</span>
        <div class="toggle-switch"></div>
      </div>
    </div>
  </div>
  
  <div id="main-container">
    <div id="sidebar">
      <!-- Ph√¢n khu 1: ƒêi·ªÅu khi·ªÉn tr·ª±c ti·∫øp -->
      <div id="control-panel" class="panel-section">
        <h3 class="panel-section-title">ƒêi·ªÅu Khi·ªÉn Robot</h3>
        
        <div class="unit-display">
          <div>T·ª∑ l·ªá hi·ªán t·∫°i: <strong><span id="scale-ratio">1</span> cm/pixel</strong></div>
          <div>T·ªça ƒë·ªô hi·ªán t·∫°i: <strong>X: <span id="current-x">0</span> cm, Y: <span id="current-y">0</span> cm</strong></div>
          <div>G√≥c quay: <strong><span id="current-angle">0</span>¬∞</strong></div>
        </div>
        
        <h4 class="controls-title">
          ƒêi·ªÅu khi·ªÉn di chuy·ªÉn
          <div class="history-controls">
            <button id="undo-button-1" onclick="undoAction()" title="Quay l·∫°i b∆∞·ªõc tr∆∞·ªõc (Ctrl+Z)">‚Ü©</button>
            <button id="redo-button-1" onclick="redoAction()" title="Ti·∫øn l·∫°i b∆∞·ªõc sau (Ctrl+Y)">‚Ü™</button>
          </div>
        </h4>
        
        <div class="movement-grid">
          <button onclick="moveRobotInDirection(-1, -1)" title="Di chuy·ªÉn ch√©o tr√°i l√™n (U)">‚Üñ</button>
          <button onclick="moveRobotInDirection(0, -1)" title="Di chuy·ªÉn l√™n (W)">‚Üë</button>
          <button onclick="moveRobotInDirection(1, -1)" title="Di chuy·ªÉn ch√©o ph·∫£i l√™n (I)">‚Üó</button>
          <button onclick="moveRobotInDirection(-1, 0)" title="Di chuy·ªÉn sang tr√°i (A)">‚Üê</button>
          <button onclick="spinRobot()" title="Xoay tr√≤n (Space)">‚ü≥</button>
          <button onclick="moveRobotInDirection(1, 0)" title="Di chuy·ªÉn sang ph·∫£i (D)">‚Üí</button>
          <button onclick="moveRobotInDirection(-1, 1)" title="Di chuy·ªÉn ch√©o tr√°i xu·ªëng (J)">‚Üô</button>
          <button onclick="moveRobotInDirection(0, 1)" title="Di chuy·ªÉn xu·ªëng (S)">‚Üì</button>
          <button onclick="moveRobotInDirection(1, 1)" title="Di chuy·ªÉn ch√©o ph·∫£i xu·ªëng (K)">‚Üò</button>
        </div>
        
        <div class="rotation-controls">
          <button onclick="rotate(-5)" title="Quay tr√°i 5 ƒë·ªô (Q)">‚ü≤ Quay tr√°i</button>
          <button onclick="rotate(5)" title="Quay ph·∫£i 5 ƒë·ªô (E)">‚ü≥ Quay ph·∫£i</button>
          <button onclick="centerRobot()" title="ƒê·∫∑t robot v·ªÅ v·ªã tr√≠ trung t√¢m (R)">‚ü¥ V·ªÅ gi·ªØa</button>
        </div>
        
        <!-- Position Control Panel -->
        <div class="position-control-panel">
          <h5>Di chuy·ªÉn ƒë·∫øn t·ªça ƒë·ªô ch√≠nh x√°c</h5>
          <div class="coordinate-inputs">
            <div class="coordinate-input">
              <label for="target-x">T·ªça ƒë·ªô X (cm)</label>
              <input type="number" id="target-x" step="0.1" placeholder="X (cm)">
            </div>
            <div class="coordinate-input">
              <label for="target-y">T·ªça ƒë·ªô Y (cm)</label>
              <input type="number" id="target-y" step="0.1" placeholder="Y (cm)">
            </div>
          </div>
          <button class="move-to-coords-btn" onclick="moveToCoordinates()">Di chuy·ªÉn ƒë·∫øn t·ªça ƒë·ªô</button>
        </div>
        
        <div class="toggle-controls">
          <div class="control-toggle">
            <input type="checkbox" id="toggle-robot" checked onchange="toggleRobot()">
            <label for="toggle-robot">·∫®n/Hi·ªán Robot</label>
          </div>
          
          <div class="control-toggle">
            <input type="checkbox" id="show-path" onchange="toggleShowPath()">
            <label for="show-path">Hi·ªán qu√£ng ƒë∆∞·ªùng di chuy·ªÉn</label>
          </div>
          
          <div class="control-toggle">
            <input type="checkbox" id="show-mini-map" checked onchange="toggleMiniMap()">
            <label for="show-mini-map">Hi·ªán Mini-Map</label>
          </div>
        </div>
        
        <!-- ƒêi·ªÅu khi·ªÉn b∆∞·ªõc di chuy·ªÉn -->
        <div class="step-size-control">
          <label for="step-size">B∆∞·ªõc di chuy·ªÉn:</label>
          <input type="number" id="step-size" value="1" min="0.1" step="0.1" onchange="updateStepSize(this.value)">
          <span class="unit">cm</span>
        </div>
        
        <!-- N√∫t ƒë·∫£o chi·ªÅu -->
        <div class="direction-toggle-container">
          <div class="direction-toggle-btn">
            <span>ƒê·∫£o chi·ªÅu robot:</span>
            <div class="direction-toggle">
              <button id="toggle-vertical" onclick="toggleVerticalDirection()">Tr√™n/D∆∞·ªõi</button>
              <button id="toggle-horizontal" onclick="toggleHorizontalDirection()">Tr√°i/Ph·∫£i</button>
            </div>
          </div>
        </div>
        
        <!-- ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc robot -->
        <div class="robot-resize-controls">
          <label class="resize-controls-label" for="robot-size">K√≠ch th∆∞·ªõc robot:</label>
          <div class="resize-slider">
            <input type="range" id="robot-size" min="20" max="150" value="50" oninput="resizeRobot(this.value)">
            <span class="size-value" id="size-display">50px</span>
          </div>
        </div>
        
        <!-- ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc map (M·ªõi) -->
        <div class="robot-resize-controls">
          <label class="resize-controls-label" for="map-size">K√≠ch th∆∞·ªõc map:</label>
          <div class="resize-slider">
            <input type="range" id="map-size" min="50" max="150" value="100" oninput="resizeMap(this.value)">
            <span class="size-value" id="map-size-display">100%</span>
          </div>
        </div>
        
        <!-- ƒêi·ªÅu ch·ªânh v·ªã tr√≠ map (M·ªõi) -->
        <div class="map-position-control">
          <div class="map-position-toggle">
            <input type="checkbox" id="map-vertical-move" onchange="toggleMapVerticalMovement()">
            <label for="map-vertical-move">Cho ph√©p di chuy·ªÉn map l√™n/xu·ªëng</label>
          </div>
          
          <label class="resize-controls-label" for="map-position-x">V·ªã tr√≠ map (tr√°i/ph·∫£i):</label>
          <div class="resize-slider">
            <input type="range" id="map-position-x" min="-50" max="50" value="0" oninput="adjustMapPosition('x', this.value)">
            <span class="size-value" id="map-position-x-display">0</span>
          </div>
          
          <div id="map-y-position-control" style="margin-top: 10px; display: none;">
            <label class="resize-controls-label" for="map-position-y">V·ªã tr√≠ map (l√™n/xu·ªëng):</label>
            <div class="resize-slider">
              <input type="range" id="map-position-y" min="-50" max="50" value="0" oninput="adjustMapPosition('y', this.value)">
              <span class="size-value" id="map-position-y-display">0</span>
            </div>
          </div>
        </div>
        
        <div class="save-controls">
          <button class="save-position" onclick="showSaveDialog('position')">
            <i>üíæ</i> L∆∞u v·ªã tr√≠ hi·ªán t·∫°i
          </button>
          <button class="save-size" onclick="showSaveDialog('size')">
            <i>üìè</i> L∆∞u k√≠ch th∆∞·ªõc robot
          </button>
          <button class="save-program" onclick="showSaveDialog('program')">
            <i>üìã</i> L∆∞u ch∆∞∆°ng tr√¨nh
          </button>
          <button class="export-data" onclick="showExportDialog()">
            <i>üì§</i> Xu·∫•t/Nh·∫≠p d·ªØ li·ªáu
          </button>
        </div>
        
        <h5 class="saved-items-heading">
          V·ªã tr√≠ ƒë√£ l∆∞u
          <button id="clear-positions" onclick="clearSavedItems('position')" title="X√≥a t·∫•t c·∫£ v·ªã tr√≠" style="background: none; border: none; color: var(--danger-color); cursor: pointer; font-size: 16px;">üóëÔ∏è</button>
        </h5>
        <div class="saved-items" id="saved-positions">
          <!-- C√°c v·ªã tr√≠ ƒë√£ l∆∞u s·∫Ω ƒë∆∞·ª£c th√™m ·ªü ƒë√¢y -->
        </div>
        
        <h5 class="saved-items-heading">
          K√≠ch th∆∞·ªõc ƒë√£ l∆∞u
          <button id="clear-sizes" onclick="clearSavedItems('size')" title="X√≥a t·∫•t c·∫£ k√≠ch th∆∞·ªõc" style="background: none; border: none; color: var(--danger-color); cursor: pointer; font-size: 16px;">üóëÔ∏è</button>
        </h5>
        <div class="saved-items" id="saved-sizes">
          <!-- C√°c k√≠ch th∆∞·ªõc ƒë√£ l∆∞u s·∫Ω ƒë∆∞·ª£c th√™m ·ªü ƒë√¢y -->
        </div>
        
        <h5 class="saved-items-heading">
          Ch∆∞∆°ng tr√¨nh ƒë√£ l∆∞u
          <button id="clear-programs" onclick="clearSavedItems('program')" title="X√≥a t·∫•t c·∫£ ch∆∞∆°ng tr√¨nh" style="background: none; border: none; color: var(--danger-color); cursor: pointer; font-size: 16px;">üóëÔ∏è</button>
        </h5>
        <div class="saved-items" id="saved-programs">
          <!-- C√°c ch∆∞∆°ng tr√¨nh ƒë√£ l∆∞u s·∫Ω ƒë∆∞·ª£c th√™m ·ªü ƒë√¢y -->
        </div>
      </div>
      <!-- Ph√¢n khu 2: L·∫≠p tr√¨nh kh·ªëi -->
      <div id="programming-panel" class="panel-section">
        <h3 class="panel-section-title">
          L·∫≠p Tr√¨nh Robot
          <div class="history-controls">
            <button id="undo-button-2" onclick="undoAction()" title="Quay l·∫°i b∆∞·ªõc tr∆∞·ªõc (Ctrl+Z)">‚Ü©</button>
            <button id="redo-button-2" onclick="redoAction()" title="Ti·∫øn l·∫°i b∆∞·ªõc sau (Ctrl+Y)">‚Ü™</button>
          </div>
        </h3>
        
        <div class="block-container">
          <div class="block-library">
            <div class="command-block move-up" draggable="true" data-command="move-up">
              Di chuy·ªÉn l√™n
              <input type="number" value="1" min="0.1" step="0.1">
              <span class="unit-label">cm</span>
            </div>
            <div class="command-block move-down" draggable="true" data-command="move-down">
              Di chuy·ªÉn xu·ªëng
              <input type="number" value="1" min="0.1" step="0.1">
              <span class="unit-label">cm</span>
            </div>
            <div class="command-block move-left" draggable="true" data-command="move-left">
              Di chuy·ªÉn tr√°i
              <input type="number" value="1" min="0.1" step="0.1">
              <span class="unit-label">cm</span>
            </div>
            <div class="command-block move-right" draggable="true" data-command="move-right">
              Di chuy·ªÉn ph·∫£i
              <input type="number" value="1" min="0.1" step="0.1">
              <span class="unit-label">cm</span>
            </div>
            <div class="command-block move-upleft" draggable="true" data-command="move-upleft">
              Di chuy·ªÉn ch√©o tr√°i l√™n
              <input type="number" value="1" min="0.1" step="0.1">
              <span class="unit-label">cm</span>
            </div>
            <div class="command-block move-upright" draggable="true" data-command="move-upright">
              Di chuy·ªÉn ch√©o ph·∫£i l√™n
              <input type="number" value="1" min="0.1" step="0.1">
              <span class="unit-label">cm</span>
            </div>
            <div class="command-block move-downleft" draggable="true" data-command="move-downleft">
              Di chuy·ªÉn ch√©o tr√°i xu·ªëng
              <input type="number" value="1" min="0.1" step="0.1">
              <span class="unit-label">cm</span>
            </div>
            <div class="command-block move-downright" draggable="true" data-command="move-downright">
              Di chuy·ªÉn ch√©o ph·∫£i xu·ªëng
              <input type="number" value="1" min="0.1" step="0.1">
              <span class="unit-label">cm</span>
            </div>
            <div class="command-block rotate-left" draggable="true" data-command="rotate-left">
              Quay tr√°i
              <input type="number" value="5" min="1" step="1">
              <span class="unit-label">¬∞</span>
            </div>
            <div class="command-block rotate-right" draggable="true" data-command="rotate-right">
              Quay ph·∫£i
              <input type="number" value="5" min="1" step="1">
              <span class="unit-label">¬∞</span>
            </div>
            <div class="command-block spin" draggable="true" data-command="spin">
              Xoay tr√≤n
            </div>
          </div>
          
          <div class="program-area" id="program-area">
            <!-- Khu v·ª±c c√°c l·ªánh ƒë∆∞·ª£c th√™m v√†o -->
            <div class="drag-indicator"></div>
          </div>
        </div>
        
        <button id="run-program-btn" class="run-program">
          <i>‚ñ∂</i> Ch·∫°y ch∆∞∆°ng tr√¨nh
        </button>
      </div>
    </div>
    
    <div id="display-area">
      <div id="map-container">
        <img id="map" src="map.png" alt="Robot Map">
        <div id="grid-overlay"></div>
        
        <div id="robot-container">
          <img id="robot" src="robot.png" alt="Robot">
          <div class="resize-handle" id="robot-resize-handle"></div>
        </div>
        
        <!-- T·ªça ƒë·ªô chu·ªôt hi·ªán t·∫°i -->
        <div id="coordinates-display">
          <div>V·ªã tr√≠ chu·ªôt: <span id="mouse-x">0</span>, <span id="mouse-y">0</span></div>
          <div>V·ªã tr√≠ th·ª±c (cm): <span id="real-x">0</span>, <span id="real-y">0</span></div>
        </div>
        
        <!-- Mini map -->
        <div id="mini-map-container">
          <div id="mini-map">
            <div id="mini-map-indicator"></div>
            <div id="mouse-position-indicator"></div>
            <div id="mini-map-robot"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal l∆∞u ch∆∞∆°ng tr√¨nh -->
  <div class="modal-overlay" id="save-modal">
    <div class="modal-dialog">
      <h4 id="save-modal-title">L∆∞u v·ªã tr√≠</h4>
      <input type="text" id="save-name" placeholder="Nh·∫≠p t√™n ƒë·ªÉ l∆∞u">
      <div class="modal-buttons">
        <button class="secondary" onclick="closeModal()">H·ªßy</button>
        <button class="primary" onclick="saveItem()">L∆∞u</button>
      </div>
    </div>
  </div>
  
  <!-- Modal xu·∫•t/nh·∫≠p d·ªØ li·ªáu -->
  <div class="modal-overlay" id="export-modal">
    <div class="modal-dialog" style="width: 500px;">
      <h4>Xu·∫•t/Nh·∫≠p d·ªØ li·ªáu</h4>
      <textarea id="export-data" class="import-export-textarea" placeholder="D·ªØ li·ªáu JSON s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y"></textarea>
      <div class="modal-buttons">
        <button class="secondary" onclick="closeModal()">ƒê√≥ng</button>
        <button class="primary" onclick="importData()">Nh·∫≠p</button>
        <button class="primary" onclick="generateExportData()">Xu·∫•t</button>
      </div>
    </div>
  </div>
  
  <!-- Tooltip -->
  <div class="tooltip" id="tooltip"></div>
  
  <!-- Notification -->
  <div class="notification" id="notification"></div>

  <script>
    // Kh·ªüi t·∫°o bi·∫øn to√†n c·ª•c
    let robotSize = 50; // K√≠ch th∆∞·ªõc robot (px)
    let robotX = 0; // V·ªã tr√≠ X hi·ªán t·∫°i (px)
    let robotY = 0; // V·ªã tr√≠ Y hi·ªán t·∫°i (px)
    let robotAngle = 0; // G√≥c quay hi·ªán t·∫°i (ƒë·ªô)
    let stepSize = 1; // B∆∞·ªõc di chuy·ªÉn (cm)
    let cmPerPixel = 1; // T·ª∑ l·ªá cm/pixel
    let invertVertical = false; // ƒê·∫£o chi·ªÅu tr√™n/d∆∞·ªõi
    let invertHorizontal = false; // ƒê·∫£o chi·ªÅu tr√°i/ph·∫£i
    let isDragging = false; // ƒêang k√©o robot
    let isDraggingBlock = false; // ƒêang k√©o kh·ªëi l·ªánh
    let selectedBlock = null; // Kh·ªëi l·ªánh ƒëang ƒë∆∞·ª£c ch·ªçn
    let dragSource = null; // Ngu·ªìn k√©o
    let insertIndex = -1; // V·ªã tr√≠ ch√®n
    let showRobot = true; // Hi·ªÉn th·ªã robot
    let showPath = false; // Hi·ªÉn th·ªã ƒë∆∞·ªùng ƒëi
    let currentSaveType = ""; // Lo·∫°i l∆∞u hi·ªán t·∫°i
    let isDraggable = false; // Tr·∫°ng th√°i c√≥ th·ªÉ k√©o robot hay kh√¥ng
    let isAddingWaypoint = false; // ƒêang th√™m ƒëi·ªÉm ƒë√°nh d·∫•u
    let mapBoundary = { // Gi·ªõi h·∫°n c·ªßa map
      left: 0,
      top: 0,
      right: 0,
      bottom: 0
    };
    let mapSize = 100; // K√≠ch th∆∞·ªõc map (%)
    let mapPositionX = 0; // V·ªã tr√≠ X c·ªßa map
    let mapPositionY = 0; // V·ªã tr√≠ Y c·ªßa map
    let verticalMapMoveAllowed = false; // Cho ph√©p di chuy·ªÉn map l√™n/xu·ªëng
    
    // L∆∞u tr·ªØ l·ªãch s·ª≠
    const historyStack = [];
    const redoStack = [];
    
    // L∆∞u tr·ªØ d·ªØ li·ªáu
    const savedData = {
      positions: JSON.parse(localStorage.getItem('savedPositions')) || {},
      sizes: JSON.parse(localStorage.getItem('savedSizes')) || {},
      programs: JSON.parse(localStorage.getItem('savedPrograms')) || {}
    };
    
    // Tham chi·∫øu ƒë·∫øn c√°c ph·∫ßn t·ª≠ DOM
    const robot = document.getElementById('robot');
    const robotContainer = document.getElementById('robot-container');
    const mapContainer = document.getElementById('map-container');
    const map = document.getElementById('map');
    const programArea = document.getElementById('program-area');
    const saveModal = document.getElementById('save-modal');
    const saveModalTitle = document.getElementById('save-modal-title');
    const saveName = document.getElementById('save-name');
    const exportModal = document.getElementById('export-modal');
    const exportData = document.getElementById('export-data');
    const gridOverlay = document.getElementById('grid-overlay');
    const miniMapContainer = document.getElementById('mini-map-container');
    const miniMap = document.getElementById('mini-map');
    const miniMapIndicator = document.getElementById('mini-map-indicator');
    const miniMapRobot = document.getElementById('mini-map-robot');
    const mousePositionIndicator = document.getElementById('mouse-position-indicator');
    const coordinatesDisplay = document.getElementById('coordinates-display');
    const tooltip = document.getElementById('tooltip');
    const notification = document.getElementById('notification');
    const runProgramBtn = document.getElementById('run-program-btn');
    const robotSizeSlider = document.getElementById('robot-size');
    const sizeDisplay = document.getElementById('size-display');
    const stepSizeInput = document.getElementById('step-size');
    const mapSizeSlider = document.getElementById('map-size');
    const mapSizeDisplay = document.getElementById('map-size-display');
    const mapPositionXSlider = document.getElementById('map-position-x');
    const mapPositionXDisplay = document.getElementById('map-position-x-display');
    const mapPositionYSlider = document.getElementById('map-position-y');
    const mapPositionYDisplay = document.getElementById('map-position-y-display');
    const mapYPositionControl = document.getElementById('map-y-position-control');
    
    // Kh·ªüi t·∫°o khi trang ƒë∆∞·ª£c t·∫£i
    window.onload = function() {
      // ƒê·∫∑t v·ªã tr√≠ ban ƒë·∫ßu cho robot ·ªü gi·ªØa map
      centerRobot();
      
      // Kh·ªüi t·∫°o s·ª± ki·ªán k√©o th·∫£
      initDragEvents();
      
      // Kh·ªüi t·∫°o s·ª± ki·ªán b√†n ph√≠m
      initKeyboardEvents();
      
      // Kh·ªüi t·∫°o s·ª± ki·ªán chu·ªôt
      initMouseEvents();
      
      // T·∫£i d·ªØ li·ªáu ƒë√£ l∆∞u
      loadSavedItems();
      
      // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
      updateDisplay();
      
      // Kh·ªüi t·∫°o l∆∞·ªõi
      initGrid();
      
      // Kh·ªüi t·∫°o mini-map
      initMiniMap();
      
      // ƒê·∫∑t gi·ªõi h·∫°n cho robot
      updateMapBoundary();
      
      // Th√™m x·ª≠ l√Ω resize c·ª≠a s·ªï
      window.addEventListener('resize', function() {
        updateMapBoundary();
        initGrid();
        initMiniMap();
      });
      
      // T·∫£i h√¨nh ·∫£nh robot
      const robotImg = new Image();
      robotImg.onload = function() {
        // C·∫≠p nh·∫≠t hi·ªÉn th·ªã sau khi t·∫£i xong h√¨nh ·∫£nh robot
        updateRobotPosition();
      };
      robotImg.src = robot.src;
      
      // T·∫£i h√¨nh ·∫£nh map
      const mapImg = new Image();
      mapImg.onload = function() {
        // C·∫≠p nh·∫≠t gi·ªõi h·∫°n map sau khi t·∫£i xong h√¨nh ·∫£nh
        updateMapBoundary();
      };
      mapImg.src = map.src;
      
      // Kh·ªüi ph·ª•c d·ªØ li·ªáu t·ª´ localStorage
      restoreDataFromLocalStorage();
      
      // Th√™m menu tr·ª£ gi√∫p
      addHelpMenu();
      
      // Hi·ªÉn th·ªã th√¥ng b√°o ch√†o m·ª´ng
      setTimeout(() => {
        showNotification('Ch√†o m·ª´ng ƒë·∫øn v·ªõi Robot Map Interface!', 'success');
      }, 1000);
    };
    
    // C·∫≠p nh·∫≠t gi·ªõi h·∫°n map ƒë·ªÉ robot kh√¥ng v∆∞·ª£t ra ngo√†i
    function updateMapBoundary() {
      const mapRect = map.getBoundingClientRect();
      const containerRect = mapContainer.getBoundingClientRect();
      
      mapBoundary = {
        left: mapRect.left - containerRect.left,
        top: mapRect.top - containerRect.top,
        right: mapRect.right - containerRect.left,
        bottom: mapRect.bottom - containerRect.top,
        width: mapRect.width,
        height: mapRect.height
      };
    }
    
    // Kh·ªüi t·∫°o l∆∞·ªõi
    function initGrid() {
      // ...existing code...
    }
    
    // Kh·ªüi t·∫°o mini-map
    function initMiniMap() {
      // ...existing code...
    }
    
    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã mini-map
    function updateMiniMap() {
      // ...existing code...
    }
    
    // Kh·ªüi t·∫°o s·ª± ki·ªán k√©o th·∫£
    function initDragEvents() {
      // ...existing code...
    }
    
    // Th√™m s·ª± ki·ªán b√†n ph√≠m
    function initKeyboardEvents() {
      document.addEventListener('keydown', function(e) {
        if (e.target.tagName === 'INPUT') return; // B·ªè qua khi focus v√†o input
        
        switch(e.key) {
          case 'w': // Di chuy·ªÉn l√™n
            moveRobotInDirection(0, -1);
            break;
          case 'a': // Di chuy·ªÉn tr√°i
            moveRobotInDirection(-1, 0);
            break;
          case 's': // Di chuy·ªÉn xu·ªëng
            moveRobotInDirection(0, 1);
            break;
          case 'd': // Di chuy·ªÉn ph·∫£i
            moveRobotInDirection(1, 0);
            break;
          case 'u': // Di chuy·ªÉn ch√©o tr√°i l√™n
            moveRobotInDirection(-1, -1);
            break;
          case 'i': // Di chuy·ªÉn ch√©o ph·∫£i l√™n
            moveRobotInDirection(1, -1);
            break;
          case 'j': // Di chuy·ªÉn ch√©o tr√°i xu·ªëng
            moveRobotInDirection(-1, 1);
            break;
          case 'k': // Di chuy·ªÉn ch√©o ph·∫£i xu·ªëng
            moveRobotInDirection(1, 1);
            break;
          case 'q': // Quay tr√°i
            rotate(-5);
            break;
          case 'e': // Quay ph·∫£i
            rotate(5);
            break;
          case 'r': // V·ªÅ gi·ªØa
            centerRobot();
            break;
          case ' ': // Xoay tr√≤n
            spinRobot();
            break;
          case 'z': // Undo
            if (e.ctrlKey) {
              undoAction();
              e.preventDefault();
            }
            break;
          case 'y': // Redo
            if (e.ctrlKey) {
              redoAction();
              e.preventDefault();
            }
            break;
          case 'Delete': // X√≥a block ƒëang ch·ªçn
            if (selectedBlock) {
              removeBlock(selectedBlock);
            }
            break;
          case 'F1': // Hi·ªÉn th·ªã tr·ª£ gi√∫p ph√≠m t·∫Øt
            e.preventDefault();
            showKeyboardShortcutsHelp();
            break;
        }
      });
    }
    
    // Kh·ªüi t·∫°o s·ª± ki·ªán chu·ªôt
    function initMouseEvents() {
      // ...existing code...
    }
    
    // ƒêi·ªÅu khi·ªÉn robot
    function moveRobotInDirection(dx, dy) {
      // ...existing code...
    }
    
    // Ki·ªÉm tra robot c√≥ n·∫±m trong gi·ªõi h·∫°n map hay kh√¥ng
    function isRobotWithinBounds(x, y) {
      // ...existing code...
    }
    
    // Xoay robot
    function rotate(angle) {
      // ...existing code...
    }
    
    // Xoay tr√≤n robot
    function spinRobot() {
      // ...existing code...
    }
    
    // ƒê·∫∑t robot v·ªÅ trung t√¢m
    function centerRobot() {
      // ...existing code...
    }
    
    // Di chuy·ªÉn ƒë·∫øn t·ªça ƒë·ªô c·ª• th·ªÉ
    function moveToCoordinates() {
      // ...existing code...
    }
    
    // C·∫≠p nh·∫≠t v·ªã tr√≠ robot tr√™n giao di·ªán
    function updateRobotPosition() {
      // ...existing code...
    }
    
    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã t·ªïng th·ªÉ
    function updateDisplay() {
      // ...existing code...
    }
    
    // B·∫Øt ƒë·∫ßu k√©o robot
    function startDraggingRobot(e) {
      // ...existing code...
    }
    
    // Double-click ƒë·ªÉ b·∫≠t/t·∫Øt ch·∫ø ƒë·ªô k√©o robot
    function toggleRobotDrag() {
      // ...existing code...
    }
    
    // Resize robot b·∫±ng chu·ªôt
    function onRobotResize(e) {
      // ...existing code...
    }
    
    // D·ª´ng resize robot
    function stopRobotResize() {
      // ...existing code...
    }
    
    // D·ª´ng k√©o
    function stopDragging() {
      // ...existing code...
    }
    
    // B·∫Øt ƒë·∫ßu k√©o kh·ªëi l·ªánh
    function onDragStart(e) {
      // ...existing code...
    }
    
    // K·∫øt th√∫c k√©o kh·ªëi l·ªánh
    function onDragEnd() {
      // ...existing code...
    }
    
    // Trong qu√° tr√¨nh k√©o qua area
    function onDragOver(e) {
      // ...existing code...
    }
    
    // Khi k√©o v√†o area
    function onDragEnter(e) {
      // ...existing code...
    }
    
    // Khi k√©o ra kh·ªèi area
    function onDragLeave(e) {
      // ...existing code...
    }
    
    // Khi th·∫£ kh·ªëi v√†o area
    function onDrop(e) {
      // ...existing code...
    }
    
    // T·∫Øt/b·∫≠t l·ªánh
    function toggleBlock(block) {
      // ...existing code...
    }
    
    // X√≥a l·ªánh
    function removeBlock(block) {
      // ...existing code...
    }
    
    // Ch·∫°y ch∆∞∆°ng tr√¨nh
    function runProgram() {
      // ...existing code...
    }
    
    // Resize robot
    function resizeRobot(size) {
      // ...existing code...
    }
    
    // Resize map
    function resizeMap(size) {
      // ...existing code...
    }
    
    // ƒêi·ªÅu ch·ªânh v·ªã tr√≠ map
    function adjustMapPosition(axis, value) {
      // ...existing code...
    }
    
    // B·∫≠t/t·∫Øt di chuy·ªÉn map theo chi·ªÅu d·ªçc
    function toggleMapVerticalMovement() {
      // ...existing code...
    }
    
    // X·ª≠ l√Ω s·ª± ki·ªán di chuy·ªÉn chu·ªôt
    function onMouseMove(e) {
      // ...existing code...
    }
    
    // Th√™m ƒëi·ªÉm ƒë√°nh d·∫•u
    function addWaypoint(e) {
      // ...existing code...
    }
    
    // C·∫≠p nh·∫≠t k√≠ch th∆∞·ªõc b∆∞·ªõc di chuy·ªÉn
    function updateStepSize(value) {
      // ...existing code...
    }
    
    // ƒê·∫£o chi·ªÅu d·ªçc (tr√™n/d∆∞·ªõi)
    function toggleVerticalDirection() {
      // ...existing code...
    }
    
    // ƒê·∫£o chi·ªÅu ngang (tr√°i/ph·∫£i)
    function toggleHorizontalDirection() {
      // ...existing code...
    }
    
    // ·∫®n/hi·ªán robot
    function toggleRobot() {
      // ...existing code...
    }
    
    // ·∫®n/hi·ªán ƒë∆∞·ªùng ƒëi
    function toggleShowPath() {
      // ...existing code...
    }
    
    // ·∫®n/hi·ªán mini-map
    function toggleMiniMap() {
      // ...existing code...
    }
    
    // Toggle ch·∫ø ƒë·ªô t·ªëi
    function toggleTheme() {
      // ...existing code...
    }
    
    // Hi·ªÉn th·ªã th√¥ng b√°o
    function showNotification(message, type = 'info') {
      // ...existing code...
    }
    
    // Hi·ªÉn th·ªã tooltip
    function showTooltip(text) {
      // ...existing code...
    }
    
    // ·∫®n tooltip
    function hideTooltip() {
      // ...existing code...
    }
    
    // L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i ƒë·ªÉ undo
    function saveToHistory() {
      // ...existing code...
    }
    
    // Quay l·∫°i b∆∞·ªõc tr∆∞·ªõc
    function undoAction() {
      // ...existing code...
    }
    
    // Ti·∫øn l·∫°i b∆∞·ªõc sau
    function redoAction() {
      // ...existing code...
    }
    
    // Kh√¥i ph·ª•c ch∆∞∆°ng tr√¨nh t·ª´ state
    function restoreProgram(blocks) {
      // ...existing code...
    }
    
    // Hi·ªÉn th·ªã modal l∆∞u
    function showSaveDialog(type) {
      // ...existing code...
    }
    
    // Hi·ªÉn th·ªã modal xu·∫•t/nh·∫≠p d·ªØ li·ªáu
    function showExportDialog() {
      // ...existing code...
    }
    
    // T·∫°o d·ªØ li·ªáu xu·∫•t
    function generateExportData() {
      // ...existing code...
    }
    
    // Nh·∫≠p d·ªØ li·ªáu
    function importData() {
      // ...existing code...
    }
    
    // ƒê√≥ng modal
    function closeModal() {
      // ...existing code...
    }
    
    // L∆∞u m·ª•c
    function saveItem() {
      // ...existing code...
    }
    
    // T·∫£i c√°c m·ª•c ƒë√£ l∆∞u
    function loadSavedItems() {
      // ...existing code...
    }
    
    // T·∫£i v·ªã tr√≠ ƒë√£ l∆∞u
    function loadPosition(name) {
      // ...existing code...
    }
    
    // T·∫£i k√≠ch th∆∞·ªõc ƒë√£ l∆∞u
    function loadSize(name) {
      // ...existing code...
    }
    
    // T·∫£i ch∆∞∆°ng tr√¨nh ƒë√£ l∆∞u
    function loadProgram(name) {
      // ...existing code...
    }
    
    // X√≥a m·ª•c ƒë√£ l∆∞u
    function deleteSavedItem(type, name) {
      // ...existing code...
    }
    
    // X√≥a t·∫•t c·∫£ c√°c m·ª•c ƒë√£ l∆∞u
    function clearSavedItems(type) {
      // ...existing code...
    }
    
    // Hi·ªÉn th·ªã h·ªôp tho·∫°i tr·ª£ gi√∫p ph√≠m t·∫Øt
    function showKeyboardShortcutsHelp() {
      // T·∫°o modal hi·ªÉn th·ªã ph√≠m t·∫Øt
      const helpModal = document.createElement('div');
      helpModal.className = 'modal-overlay active';
      helpModal.innerHTML = `
        <div class="modal-dialog" style="width: 600px; max-height: 80vh; overflow-y: auto;">
          <h4 style="color: var(--primary-color);">Ph√≠m t·∫Øt</h4>
          
          <div style="margin-bottom: 20px;">
            <h5 style="color: var(--secondary-color);">Di chuy·ªÉn</h5>
            <ul style="list-style-type: none; padding-left: 10px;">
              <li><strong>W</strong> - Di chuy·ªÉn l√™n</li>
              <li><strong>A</strong> - Di chuy·ªÉn tr√°i</li>
              <li><strong>S</strong> - Di chuy·ªÉn xu·ªëng</li>
              <li><strong>D</strong> - Di chuy·ªÉn ph·∫£i</li>
              <li><strong>U</strong> - Di chuy·ªÉn ch√©o tr√°i l√™n</li>
              <li><strong>I</strong> - Di chuy·ªÉn ch√©o ph·∫£i l√™n</li>
              <li><strong>J</strong> - Di chuy·ªÉn ch√©o tr√°i xu·ªëng</li>
              <li><strong>K</strong> - Di chuy·ªÉn ch√©o ph·∫£i xu·ªëng</li>
            </ul>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h5 style="color: var(--secondary-color);">Xoay</h5>
            <ul style="list-style-type: none; padding-left: 10px;">
              <li><strong>Q</strong> - Quay tr√°i</li>
              <li><strong>E</strong> - Quay ph·∫£i</li>
              <li><strong>Space</strong> - Xoay tr√≤n</li>
              <li><strong>R</strong> - ƒê·∫∑t robot v·ªÅ gi·ªØa</li>
            </ul>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h5 style="color: var(--secondary-color);">Kh√°c</h5>
            <ul style="list-style-type: none; padding-left: 10px;">
              <li><strong>Ctrl+Z</strong> - Quay l·∫°i b∆∞·ªõc tr∆∞·ªõc</li>
              <li><strong>Ctrl+Y</strong> - Ti·∫øn l·∫°i b∆∞·ªõc sau</li>
              <li><strong>Double-click v√†o robot</strong> - B·∫≠t/t·∫Øt ch·∫ø ƒë·ªô k√©o robot</li>
              <li><strong>Delete</strong> - X√≥a kh·ªëi l·ªánh ƒëang ch·ªçn</li>
              <li><strong>F1</strong> - Hi·ªÉn th·ªã tr·ª£ gi√∫p n√†y</li>
            </ul>
          </div>
          
          <div class="modal-buttons">
            <button class="primary" onclick="this.parentNode.parentNode.parentNode.remove()">ƒê√≥ng</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(helpModal);
    }
    
    // Th√™m x·ª≠ l√Ω chu·ªôt ph·∫£i tr√™n robot
    robotContainer.addEventListener('contextmenu', function(e) {
      e.preventDefault();
      
      // Hi·ªÉn th·ªã menu ng·ªØ c·∫£nh
      showRobotContextMenu(e.clientX, e.clientY);
    });
    
    // Hi·ªÉn th·ªã menu ng·ªØ c·∫£nh tr√™n robot
    function showRobotContextMenu(x, y) {
      // X√≥a menu c≈© n·∫øu c√≥
      const oldMenu = document.getElementById('robot-context-menu');
      if (oldMenu) oldMenu.remove();
      
      // T·∫°o menu m·ªõi
      const menu = document.createElement('div');
      menu.id = 'robot-context-menu';
      menu.style.position = 'fixed';
      menu.style.left = x + 'px';
      menu.style.top = y + 'px';
      menu.style.backgroundColor = 'white';
      menu.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
      menu.style.borderRadius = '4px';
      menu.style.padding = '5px 0';
      menu.style.zIndex = '1000';
      
      // T·∫°o c√°c menu item
      const items = [
        { text: 'Thay ƒë·ªïi h√¨nh ·∫£nh robot', action: changeRobotImage },
        { text: 'V·ªÅ v·ªã tr√≠ trung t√¢m', action: centerRobot },
        { text: 'ƒê·∫∑t l·∫°i g√≥c quay', action: resetRobotAngle },
        { text: 'B·∫≠t/t·∫Øt ch·∫ø ƒë·ªô k√©o', action: toggleRobotDrag }
      ];
      
      items.forEach(item => {
        const menuItem = document.createElement('div');
        menuItem.textContent = item.text;
        menuItem.style.padding = '8px 15px';
        menuItem.style.cursor = 'pointer';
        
        // Hover effect
        menuItem.addEventListener('mouseover', function() {
          this.style.backgroundColor = '#f0f0f0';
        });
        
        menuItem.addEventListener('mouseout', function() {
          this.style.backgroundColor = 'transparent';
        });
        
        // Click action
        menuItem.addEventListener('click', function() {
          document.getElementById('robot-context-menu').remove();
          item.action();
        });
        
        menu.appendChild(menuItem);
      });
      
      // Th√™m menu v√†o body
      document.body.appendChild(menu);
      
      // ƒê√≥ng menu khi nh·∫•p ra ngo√†i
      setTimeout(() => {
        document.addEventListener('click', function closeMenu(e) {
          if (!menu.contains(e.target)) {
            menu.remove();
            document.removeEventListener('click', closeMenu);
          }
        });
      }, 0);
    }
    
    // Thay ƒë·ªïi h√¨nh ·∫£nh robot
    function changeRobotImage() {
      // T·∫°o input file ·∫©n
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      
      // X·ª≠ l√Ω khi ch·ªçn file
      input.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(event) {
          // C·∫≠p nh·∫≠t h√¨nh ·∫£nh robot
          robot.src = event.target.result;
          
          // L∆∞u h√¨nh ·∫£nh v√†o localStorage
          try {
            localStorage.setItem('robotImage', event.target.result);
          } catch (e) {
            console.error('Kh√¥ng th·ªÉ l∆∞u h√¨nh ·∫£nh (qu√° l·ªõn):', e);
          }
          
          showNotification('ƒê√£ thay ƒë·ªïi h√¨nh ·∫£nh robot', 'success');
        };
        
        reader.readAsDataURL(file);
      };
      
      // Trigger click ƒë·ªÉ m·ªü dialog ch·ªçn file
      input.click();
    }
    
    // ƒê·∫∑t l·∫°i g√≥c quay
    function resetRobotAngle() {
      saveToHistory();
      robotAngle = 0;
      updateRobotPosition();
      showNotification('ƒê√£ ƒë·∫∑t l·∫°i g√≥c quay v·ªÅ 0¬∞', 'success');
    }
    
    // Kh·ªüi ph·ª•c d·ªØ li·ªáu t·ª´ localStorage
    function restoreDataFromLocalStorage() {
      // Kh√¥i ph·ª•c theme
      const darkMode = localStorage.getItem('darkMode') === 'true';
      if (darkMode) {
        document.body.classList.add('dark-mode');
        document.getElementById('theme-text').textContent = 'Ch·∫ø ƒë·ªô s√°ng';
      }
      
      // Kh√¥i ph·ª•c h√¨nh ·∫£nh robot
      const robotImage = localStorage.getItem('robotImage');
      if (robotImage) {
        robot.src = robotImage;
      }
      
      // Kh√¥i ph·ª•c t·ª∑ l·ªá
      const savedScale = localStorage.getItem('cmPerPixel');
      if (savedScale) {
        cmPerPixel = parseFloat(savedScale);
      }
      
      // Kh√¥i ph·ª•c k√≠ch th∆∞·ªõc robot
      const savedRobotSize = localStorage.getItem('robotSize');
      if (savedRobotSize) {
        robotSize = parseInt(savedRobotSize);
        robotSizeSlider.value = robotSize;
        robot.style.width = robotSize + 'px';
        sizeDisplay.textContent = robotSize + 'px';
      }
      
      // Kh√¥i ph·ª•c k√≠ch th∆∞·ªõc map
      const savedMapSize = localStorage.getItem('mapSize');
      if (savedMapSize) {
        mapSize = parseInt(savedMapSize);
        mapSizeSlider.value = mapSize;
        map.style.width = mapSize + '%';
        map.style.height = 'auto';
        mapSizeDisplay.textContent = mapSize + '%';
      }
      
      // Kh√¥i ph·ª•c v·ªã tr√≠ map
      const savedMapX = localStorage.getItem('mapPositionX');
      const savedMapY = localStorage.getItem('mapPositionY');
      
      if (savedMapX) {
        mapPositionX = parseInt(savedMapX);
        mapPositionXSlider.value = mapPositionX;
        mapPositionXDisplay.textContent = mapPositionX;
      }
      
      if (savedMapY) {
        mapPositionY = parseInt(savedMapY);
        mapPositionYSlider.value = mapPositionY;
        mapPositionYDisplay.textContent = mapPositionY;
      }
      
      if (savedMapX || savedMapY) {
        map.style.transform = `translateX(${mapPositionX}%) translateY(${mapPositionY}%)`;
      }
      
      // Kh√¥i ph·ª•c ph√©p ƒë·∫£o
      const savedInvertVertical = localStorage.getItem('invertVertical') === 'true';
      const savedInvertHorizontal = localStorage.getItem('invertHorizontal') === 'true';
      
      if (savedInvertVertical) {
        invertVertical = true;
        document.getElementById('toggle-vertical').classList.add('active');
      }
      
      if (savedInvertHorizontal) {
        invertHorizontal = true;
        document.getElementById('toggle-horizontal').classList.add('active');
      }
    }
    
    // L∆∞u c√°c thi·∫øt l·∫≠p khi window unload
    window.addEventListener('beforeunload', function() {
      localStorage.setItem('robotSize', robotSize);
      localStorage.setItem('cmPerPixel', cmPerPixel);
      localStorage.setItem('mapSize', mapSize);
      localStorage.setItem('mapPositionX', mapPositionX);
      localStorage.setItem('mapPositionY', mapPositionY);
      localStorage.setItem('invertVertical', invertVertical);
      localStorage.setItem('invertHorizontal', invertHorizontal);
    });
    
    // T·∫°o h√¨nh ·∫£nh path tracing khi robot di chuy·ªÉn
    function traceRobotPath(fromX, fromY, toX, toY) {
      if (!showPath) return;
      
      // T·∫°o ƒë∆∞·ªùng d·∫´n
      const pathTrace = document.createElement('div');
      pathTrace.className = 'path-trace';
      pathTrace.style.position = 'absolute';
      
      // T√≠nh to√°n ƒë·ªô d√†i v√† g√≥c c·ªßa ƒë∆∞·ªùng
      const dx = toX - fromX;
      const dy = toY - fromY;
      const length = Math.sqrt(dx * dx + dy * dy);
      const angle = Math.atan2(dy, dx) * 180 / Math.PI;
      
      // Thi·∫øt l·∫≠p style cho ƒë∆∞·ªùng d·∫´n
      pathTrace.style.width = length + 'px';
      pathTrace.style.height = '2px';
      pathTrace.style.backgroundColor = 'rgba(255, 0, 0, 0.5)';
      pathTrace.style.transformOrigin = '0 0';
      pathTrace.style.transform = `translate(${fromX}px, ${fromY}px) rotate(${angle}deg)`;
      
      // Th√™m v√†o map container
      mapContainer.appendChild(pathTrace);
      
      // T·ª± ƒë·ªông x√≥a sau m·ªôt kho·∫£ng th·ªùi gian
      setTimeout(() => {
        if (pathTrace.parentNode) {
          pathTrace.style.opacity = '0';
          setTimeout(() => {
            if (pathTrace.parentNode) {
              pathTrace.parentNode.removeChild(pathTrace);
            }
          }, 500);
        }
      }, 3000);
    }
    
    // Th√™m hi·ªáu ·ª©ng khi di chuy·ªÉn robot
    function animateRobotMovement(fromX, fromY, toX, toY, callback) {
      const startTime = Date.now();
      const duration = 300; // Th·ªùi gian di chuy·ªÉn (ms)
      
      function animate() {
        const currentTime = Date.now();
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // S·ª≠ d·ª•ng h√†m easing ƒë·ªÉ t·∫°o hi·ªáu ·ª©ng m∆∞·ª£t m√†
        const easeProgress = 1 - Math.pow(1 - progress, 3); // Cubic ease-out
        
        // T√≠nh to√°n v·ªã tr√≠ m·ªõi
        robotX = fromX + (toX - fromX) * easeProgress;
        robotY = fromY + (toY - fromY) * easeProgress;
        
        // C·∫≠p nh·∫≠t v·ªã tr√≠
        updateRobotPosition();
        
        // Ti·∫øp t·ª•c animation n·∫øu ch∆∞a ho√†n th√†nh
        if (progress < 1) {
          requestAnimationFrame(animate);
        } else {
          // G·ªçi callback khi ho√†n th√†nh
          if (callback) callback();
        }
      }
      
      animate();
    }
    
    // Chuy·ªÉn ƒë·ªïi t·ªça ƒë·ªô pixel sang cm v√† ng∆∞·ª£c l·∫°i
    function pixelToCm(pixels) {
      return pixels * cmPerPixel;
    }
    
    function cmToPixel(cm) {
      return cm / cmPerPixel;
    }
    
    // C·∫≠p nh·∫≠t t·ª∑ l·ªá cm/pixel
    function updateScale(newScale) {
      // L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i ƒë·ªÉ undo
      saveToHistory();
      
      // L∆∞u v·ªã tr√≠ hi·ªán t·∫°i theo cm
      const currentXcm = robotX * cmPerPixel;
      const currentYcm = robotY * cmPerPixel;
      
      // C·∫≠p nh·∫≠t t·ª∑ l·ªá m·ªõi
      cmPerPixel = newScale;
      
      // C·∫≠p nh·∫≠t v·ªã tr√≠ robot theo t·ª∑ l·ªá m·ªõi
      robotX = currentXcm / cmPerPixel;
      robotY = currentYcm / cmPerPixel;
      
      // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
      updateRobotPosition();
      updateDisplay();
      
      showNotification(`ƒê√£ thay ƒë·ªïi t·ª∑ l·ªá th√†nh ${cmPerPixel.toFixed(2)} cm/pixel`, 'success');
    }
    
    // Th√™m dialog ƒë·∫∑t t·ª∑ l·ªá
    function showScaleDialog() {
      // T·∫°o modal
      const scaleModal = document.createElement('div');
      scaleModal.className = 'modal-overlay active';
      scaleModal.innerHTML = `
        <div class="modal-dialog">
          <h4 style="color: var(--primary-color);">ƒê·∫∑t t·ª∑ l·ªá cm/pixel</h4>
          <p>T·ª∑ l·ªá hi·ªán t·∫°i: <strong>${cmPerPixel.toFixed(2)} cm/pixel</strong></p>
          
          <div style="margin: 15px 0;">
            <label for="scale-input" style="display: block; margin-bottom: 5px;">T·ª∑ l·ªá m·ªõi:</label>
            <input type="number" id="scale-input" step="0.1" min="0.1" value="${cmPerPixel.toFixed(1)}" style="width: 100%; padding: 8px;">
          </div>
          
          <div class="modal-buttons">
            <button class="secondary" onclick="this.closest('.modal-overlay').remove()">H·ªßy</button>
            <button class="primary" onclick="updateScaleFromDialog(this)">√Åp d·ª•ng</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(scaleModal);
      setTimeout(() => document.getElementById('scale-input').focus(), 100);
    }
    
    // C·∫≠p nh·∫≠t t·ª∑ l·ªá t·ª´ dialog
    function updateScaleFromDialog(button) {
      const input = button.closest('.modal-dialog').querySelector('#scale-input');
      const newScale = parseFloat(input.value);
      
      if (isNaN(newScale) || newScale <= 0) {
        showNotification('Vui l√≤ng nh·∫≠p gi√° tr·ªã h·ª£p l·ªá', 'error');
        return;
      }
      
      updateScale(newScale);
      button.closest('.modal-overlay').remove();
    }
    
    // T√≠nh to√°n v√πng nh√¨n th·∫•y hi·ªán t·∫°i
    function calculateViewport() {
      const mapRect = map.getBoundingClientRect();
      const containerRect = mapContainer.getBoundingClientRect();
      
      return {
        left: (containerRect.left - mapRect.left) / cmPerPixel,
        top: (containerRect.top - mapRect.top) / cmPerPixel,
        right: (containerRect.right - mapRect.left) / cmPerPixel,
        bottom: (containerRect.bottom - mapRect.top) / cmPerPixel,
        width: containerRect.width / cmPerPixel,
        height: containerRect.height / cmPerPixel
      };
    }
    
    // Ch·ª©c nƒÉng export ·∫£nh ch·ª•p m√†n h√¨nh
    function captureScreenshot() {
      // S·ª≠ d·ª•ng html2canvas ƒë·ªÉ ch·ª•p map container
      html2canvas(mapContainer).then(canvas => {
        // T·∫°o link t·∫£i xu·ªëng
        const link = document.createElement('a');
        link.download = 'robot-map-screenshot.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        showNotification('ƒê√£ t·∫°o ·∫£nh ch·ª•p m√†n h√¨nh', 'success');
      }).catch(err => {
        console.error('L·ªói khi ch·ª•p m√†n h√¨nh:', err);
        showNotification('C√≥ l·ªói khi t·∫°o ·∫£nh ch·ª•p m√†n h√¨nh', 'error');
      });
    }
    
    // Ch·ª©c nƒÉng b√°o c√°o th√¥ng tin h·ªá th·ªëng
    function showSystemInfo() {
      const infoModal = document.createElement('div');
      infoModal.className = 'modal-overlay active';
      infoModal.innerHTML = `
        <div class="modal-dialog" style="width: 500px;">
          <h4 style="color: var(--primary-color);">Th√¥ng tin h·ªá th·ªëng</h4>
          
          <div style="margin: 10px 0; max-height: 300px; overflow-y: auto;">
            <table style="width: 100%; border-collapse: collapse;">
              <tr>
                <td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold;">Tr√¨nh duy·ªát:</td>
                <td style="padding: 8px; border-bottom: 1px solid #ddd;">${navigator.userAgent}</td>
              </tr>
              <tr>
                <td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold;">ƒê·ªô ph√¢n gi·∫£i m√†n h√¨nh:</td>
                <td style="padding: 8px; border-bottom: 1px solid #ddd;">${window.screen.width} x ${window.screen.height}</td>
              </tr>
              <tr>
                <td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold;">K√≠ch th∆∞·ªõc c·ª≠a s·ªï:</td>
                <td style="padding: 8px; border-bottom: 1px solid #ddd;">${window.innerWidth} x ${window.innerHeight}</td>
              </tr>
              <tr>
                <td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold;">K√≠ch th∆∞·ªõc map:</td>
                <td style="padding: 8px; border-bottom: 1px solid #ddd;">${map.offsetWidth} x ${map.offsetHeight} px</td>
              </tr>
              <tr>
                <td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold;">T·ª∑ l·ªá hi·ªán t·∫°i:</td>
                <td style="padding: 8px; border-bottom: 1px solid #ddd;">${cmPerPixel.toFixed(2)} cm/pixel</td>
              </tr>
              <tr>
                <td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold;">V·ªã tr√≠ robot:</td>
                <td style="padding: 8px; border-bottom: 1px solid #ddd;">X: ${(robotX * cmPerPixel).toFixed(1)} cm, Y: ${(robotY * cmPerPixel).toFixed(1)} cm</td>
              </tr>
              <tr>
                <td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold;">G√≥c quay:</td>
                <td style="padding: 8px; border-bottom: 1px solid #ddd;">${robotAngle.toFixed(1)}¬∞</td>
              </tr>
              <tr>
                <td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold;">K√≠ch th∆∞·ªõc robot:</td>
                <td style="padding: 8px; border-bottom: 1px solid #ddd;">${robotSize} px</td>
              </tr>
              <tr>
                <td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold;">V·ªã tr√≠ map:</td>
                <td style="padding: 8px; border-bottom: 1px solid #ddd;">X: ${mapPositionX}%, Y: ${mapPositionY}%</td>
              </tr>
              <tr>
                <td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold;">LocalStorage:</td>
                <td style="padding: 8px; border-bottom: 1px solid #ddd;">${(JSON.stringify(localStorage).length / 1024).toFixed(2)} KB</td>
              </tr>
            </table>
          </div>
          
          <div class="modal-buttons">
            <button class="primary" onclick="this.closest('.modal-overlay').remove()">ƒê√≥ng</button>
            <button class="secondary" onclick="copySystemInfo(this)">Sao ch√©p</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(infoModal);
    }
    
    // Sao ch√©p th√¥ng tin h·ªá th·ªëng
    function copySystemInfo(button) {
      const tableRows = button.closest('.modal-dialog').querySelectorAll('table tr');
      let text = '';
      
      tableRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        text += `${cells[0].textContent.replace(':', '')} ${cells[1].textContent}\n`;
      });
      
      navigator.clipboard.writeText(text).then(() => {
        showNotification('ƒê√£ sao ch√©p th√¥ng tin h·ªá th·ªëng v√†o clipboard', 'success');
      }).catch(err => {
        console.error('L·ªói khi sao ch√©p:', err);
        showNotification('C√≥ l·ªói khi sao ch√©p th√¥ng tin', 'error');
      });
    }
    
    // Th√™m menu "Tr·ª£ gi√∫p" v√†o header
    function addHelpMenu() {
      const headerControls = document.getElementById('header-controls');
      
      const helpButton = document.createElement('div');
      helpButton.className = 'header-button';
      helpButton.textContent = 'Tr·ª£ gi√∫p';
      helpButton.style.position = 'relative';
      helpButton.style.cursor = 'pointer';
      
      const helpMenu = document.createElement('div');
      helpMenu.style.position = 'absolute';
      helpMenu.style.top = '100%';
      helpMenu.style.right = '0';
      helpMenu.style.backgroundColor = 'white';
      helpMenu.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
      helpMenu.style.borderRadius = '4px';
      helpMenu.style.padding = '5px 0';
      helpMenu.style.display = 'none';
      helpMenu.style.zIndex = '1000';
      helpMenu.style.minWidth = '180px';
      
      // C√°c m·ª•c trong menu
      const menuItems = [
        { text: 'Ph√≠m t·∫Øt (F1)', action: showKeyboardShortcutsHelp },
        { text: 'ƒê·∫∑t t·ª∑ l·ªá cm/pixel', action: showScaleDialog },
        { text: 'Ch·ª•p m√†n h√¨nh', action: captureScreenshot },
        { text: 'Th√¥ng tin h·ªá th·ªëng', action: showSystemInfo },
        { text: 'V·ªÅ ·ª©ng d·ª•ng', action: showAboutDialog }
      ];
      
      menuItems.forEach(item => {
        const menuItem = document.createElement('div');
        menuItem.textContent = item.text;
        menuItem.style.padding = '8px 15px';
        menuItem.style.cursor = 'pointer';
        
        // Hover effect
        menuItem.addEventListener('mouseover', function() {
          this.style.backgroundColor = '#f0f0f0';
        });
        
        menuItem.addEventListener('mouseout', function() {
          this.style.backgroundColor = 'transparent';
        });
        
        // Click action
        menuItem.addEventListener('click', function() {
          helpMenu.style.display = 'none';
          item.action();
        });
        
        helpMenu.appendChild(menuItem);
      });
      
      // Toggle menu khi click
      helpButton.addEventListener('click', function(e) {
        e.stopPropagation();
        helpMenu.style.display = helpMenu.style.display === 'none' ? 'block' : 'none';
      });
      
      // ƒê√≥ng menu khi click ra ngo√†i
      document.addEventListener('click', function() {
        helpMenu.style.display = 'none';
      });
      
      helpButton.appendChild(helpMenu);
      headerControls.appendChild(helpButton);
    }
    
    // Hi·ªÉn th·ªã dialog About
    function showAboutDialog() {
      const aboutModal = document.createElement('div');
      aboutModal.className = 'modal-overlay active';
      aboutModal.innerHTML = `
        <div class="modal-dialog">
          <h4 style="color: var(--primary-color);">V·ªÅ ·ª©ng d·ª•ng</h4>
          <p style="text-align: center; margin: 20px 0;">Robot Map Interface</p>
          <p style="text-align: center; margin: 10px 0;">Phi√™n b·∫£n 1.0</p>
          <p style="text-align: center; margin: 10px 0;">¬© 2025 - B·∫£n quy·ªÅn thu·ªôc v·ªÅ t√°c gi·∫£</p>
          
          <div class="modal-buttons">
            <button class="primary" onclick="this.closest('.modal-overlay').remove()">ƒê√≥ng</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(aboutModal);
    }
  </script>
</body>
</html>
