<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Robot Map Interface</title>
  <style>
    :root {
      --primary-color: #3498db;
      --secondary-color: #2ecc71;
      --accent-color: #f39c12;
      --danger-color: #e74c3c;
      --light-bg: #f5f5f5;
      --dark-bg: #2c3e50;
      --text-dark: #333;
      --text-light: #f5f5f5;
      --border-color: #ddd;
      --shadow: 0 2px 5px rgba(0,0,0,0.1);
      --theme-transition: background-color 0.3s, color 0.3s;
      
      /* M√†u cho c√°c command block */
      --move-up-bg: #d1e7dd;
      --move-down-bg: #f8d7da;
      --move-left-bg: #cfe2ff;
      --move-right-bg: #fff3cd;
      --move-upleft-bg: #d8f3dc;
      --move-upright-bg: #e9ecef;
      --move-downleft-bg: #e0e1ff;
      --move-downright-bg: #ffe8d9;
      --spin-bg: #d8d8ff;
      --rotate-left-bg: #ffccd5;
      --rotate-right-bg: #c9f7f5;
    }
    
    body.dark-mode {
      --light-bg: #1a1a2e;
      --border-color: #444;
      --text-dark: #f5f5f5;
      
      /* M√†u t·ªëi cho c√°c command block */
      --move-up-bg: #1e4d3d;
      --move-down-bg: #4d2828;
      --move-left-bg: #1e294d;
      --move-right-bg: #4d412e;
      --move-upleft-bg: #1e3e2e;
      --move-upright-bg: #2e2e2e;
      --move-downleft-bg: #252540;
      --move-downright-bg: #40332a;
      --spin-bg: #2e2e4d;
      --rotate-left-bg: #4d2a38;
      --rotate-right-bg: #2a4d49;
    }
    
    body {
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
      background-color: var(--light-bg);
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    #header-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      z-index: 1000;
      box-shadow: var(--shadow);
    }
    
    #header-bar .title {
      font-weight: bold;
      font-size: 1.2em;
    }
    
    #header-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .header-button {
      padding: 5px 10px;
      background-color: rgba(255,255,255,0.2);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .header-button:hover {
      background-color: rgba(255,255,255,0.3);
    }
    
    .theme-toggle {
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    
    .theme-toggle span {
      margin-right: 5px;
    }
    
    .toggle-switch {
      position: relative;
      width: 40px;
      height: 20px;
      background-color: rgba(0,0,0,0.3);
      border-radius: 10px;
      transition: background-color 0.3s;
    }
    
    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: white;
      top: 2px;
      left: 2px;
      transition: transform 0.3s;
    }
    
    .dark-mode .toggle-switch {
      background-color: var(--accent-color);
    }
    
    .dark-mode .toggle-switch::after {
      transform: translateX(20px);
    }
    
    #main-container {
      display: flex;
      width: 100%;
      height: 100%;
      padding-top: 40px; /* ƒê·ªÉ tr√°nh b·ªã header che */
    }
    
    #sidebar {
      width: 320px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border-color);
      background-color: var(--light-bg);
      overflow-y: auto;
      resize: horizontal;
      min-width: 250px;
      max-width: 500px;
      transition: var(--theme-transition);
    }
    
    #sidebar-resizer {
      position: absolute;
      width: 8px;
      height: calc(100% - 40px); /* Tr·ª´ ƒëi height c·ªßa header */
      left: 320px;
      top: 40px; /* B·∫Øt ƒë·∫ßu t·ª´ d∆∞·ªõi header */
      background-color: var(--border-color);
      cursor: ew-resize;
      z-index: 100;
      transition: background-color 0.2s;
    }
    
    #sidebar-resizer:hover {
      background-color: var(--primary-color);
    }
    
    #sidebar-resizer::after {
      content: "‚´¥";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--text-dark);
      font-size: 12px;
    }
    
    #display-area {
      flex: 1;
      position: relative;
      overflow: hidden;
      background-color: var(--light-bg);
      transition: var(--theme-transition);
    }
    
    #map-container {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      overflow: hidden;
    }
    
    #map {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    
    /* Grid overlay */
    #grid-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      opacity: 0.5;
      display: none;
    }
    
    .grid-line {
      position: absolute;
      background-color: rgba(0, 0, 255, 0.3);
    }
    
    /* Coordinate display */
    #coordinates-display {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 14px;
      z-index: 10;
      display: flex;
      flex-direction: column;
    }
    
    #coordinates-display div {
      margin: 2px 0;
    }
    
    /* Robot styling */
    #robot-container {
      position: absolute;
    }
    
    #robot {
      position: absolute;
      width: 50px; /* K√≠ch th∆∞·ªõc m·∫∑c ƒë·ªãnh */
      transform-origin: center center;
      transition: transform 0.1s linear, left 0.1s linear, top 0.1s linear;
      filter: drop-shadow(0 3px 5px rgba(0,0,0,0.3));
    }
    
    /* Waypoint markers */
    .waypoint-marker {
      position: absolute;
      width: 15px;
      height: 15px;
      background-color: var(--accent-color);
      border: 2px solid white;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: 5;
      cursor: pointer;
      box-shadow: 0 0 5px rgba(0,0,0,0.5);
    }
    
    .waypoint-marker:hover {
      background-color: #e67e22;
    }
    
    .waypoint-label {
      position: absolute;
      background-color: rgba(0,0,0,0.7);
      color: white;
      padding: 2px 5px;
      border-radius: 3px;
      font-size: 12px;
      white-space: nowrap;
      transform: translateY(-120%);
      user-select: none;
    }
    
    /* Ph√¢n khu 1: ƒêi·ªÅu khi·ªÉn */
    .panel-section {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
      transition: var(--theme-transition);
    }
    
    .panel-section-title {
      margin: 0 0 10px 0;
      color: var(--primary-color);
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .controls-title {
      margin: 8px 0;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: var(--theme-transition);
    }
    
    .history-controls {
      display: flex;
      gap: 5px;
    }
    
    .history-controls button {
      padding: 4px 8px;
      background-color: var(--light-bg);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .history-controls button:hover:not(:disabled) {
      background-color: var(--primary-color);
      color: white;
    }
    
    .history-controls button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .movement-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 5px;
      margin-bottom: 10px;
    }
    
    .movement-grid button {
      padding: 10px 0;
      background-color: var(--light-bg);
      border: 1px solid var(--border-color);
      cursor: pointer;
      border-radius: 4px;
      color: var(--text-dark);
      font-weight: 500;
      transition: background-color 0.2s, var(--theme-transition);
    }
    
    .movement-grid button:hover {
      background-color: var(--primary-color);
      color: white;
    }
    
    .rotation-controls {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
    }
    
    .rotation-controls button {
      flex: 1;
      padding: 10px 0;
      background-color: var(--light-bg);
      border: 1px solid var(--border-color);
      cursor: pointer;
      border-radius: 4px;
      color: var(--text-dark);
      font-weight: 500;
      transition: background-color 0.2s, var(--theme-transition);
    }
    
    .rotation-controls button:hover {
      background-color: var(--primary-color);
      color: white;
    }
    
    /* Position control panel */
    .position-control-panel {
      background-color: rgba(52, 152, 219, 0.1);
      border: 1px solid rgba(52, 152, 219, 0.3);
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 15px;
    }
    
    .position-control-panel h5 {
      margin-top: 0;
      margin-bottom: 8px;
      color: var(--primary-color);
    }
    
    .coordinate-inputs {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .coordinate-input {
      flex: 1;
    }
    
    .coordinate-input label {
      display: block;
      font-size: 0.9em;
      margin-bottom: 3px;
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .coordinate-input input {
      width: 100%;
      padding: 6px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--light-bg);
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .move-to-coords-btn {
      width: 100%;
      padding: 8px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .move-to-coords-btn:hover {
      background-color: #2980b9;
    }
    
    .toggle-controls {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .control-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .control-toggle input[type="checkbox"] {
      margin: 0;
      width: 16px;
      height: 16px;
    }
    
    .step-size-control {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 5px;
      padding: 8px;
      background-color: rgba(250, 250, 250, 0.5);
      border-radius: 4px;
      border: 1px solid var(--border-color);
      transition: var(--theme-transition);
    }
    
    .dark-mode .step-size-control {
      background-color: rgba(30, 30, 30, 0.5);
    }
    
    .step-size-control label {
      white-space: nowrap;
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .step-size-control input {
      width: 60px;
      text-align: center;
      padding: 5px;
      border: 1px solid var(--border-color);
      border-radius: 3px;
      background-color: var(--light-bg);
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .step-size-control .unit {
      color: var(--text-dark);
      font-size: 0.9em;
      transition: var(--theme-transition);
    }
    
    .direction-toggle-container {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-top: 8px;
    }
    
    .direction-toggle-btn {
      padding: 8px;
      background-color: rgba(250, 250, 250, 0.5);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--theme-transition);
    }
    
    .dark-mode .direction-toggle-btn {
      background-color: rgba(30, 30, 30, 0.5);
    }
    
    .direction-toggle {
      display: flex;
      gap: 5px;
    }
    
    .direction-toggle button {
      padding: 5px 10px;
      background-color: var(--light-bg);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .direction-toggle button.active {
      background-color: var(--accent-color);
      color: white;
      font-weight: bold;
    }
    
    .unit-display {
      margin-top: 8px;
      margin-bottom: 12px;
      padding: 8px;
      background-color: rgba(250, 250, 250, 0.5);
      border-radius: 4px;
      border: 1px solid var(--border-color);
      font-size: 0.9em;
      display: flex;
      flex-direction: column;
      gap: 5px;
      transition: var(--theme-transition);
    }
    
    .dark-mode .unit-display {
      background-color: rgba(30, 30, 30, 0.5);
    }
    
    .unit-display strong {
      color: var(--primary-color);
    }
    
    .robot-resize-controls {
      margin: 15px 0;
    }
    
    .robot-resize-controls label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .robot-resize-slider {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .robot-resize-slider input[type="range"] {
      flex: 1;
      height: 5px;
      appearance: none;
      background: linear-gradient(to right, var(--primary-color) 0%, var(--primary-color) 50%, #ddd 50%, #ddd 100%);
      border-radius: 2px;
      outline: none;
    }
    
    .robot-resize-slider input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 15px;
      height: 15px;
      background: white;
      border: 2px solid var(--primary-color);
      border-radius: 50%;
      cursor: pointer;
    }
    
    .robot-resize-slider .size-value {
      width: 40px;
      text-align: right;
      font-weight: 500;
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .save-controls {
      margin-top: 15px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .save-controls button {
      padding: 10px 0;
      border: 1px solid var(--border-color);
      cursor: pointer;
      border-radius: 4px;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: background-color 0.2s;
    }
    
    .save-controls button.save-position {
      background-color: rgba(46, 204, 113, 0.15);
      color: #27ae60;
    }
    
    .save-controls button.save-position:hover {
      background-color: rgba(46, 204, 113, 0.3);
    }
    
    .save-controls button.save-size {
      background-color: rgba(52, 152, 219, 0.15);
      color: #2980b9;
    }
    
    .save-controls button.save-size:hover {
      background-color: rgba(52, 152, 219, 0.3);
    }
    
    .save-controls button.save-program {
      background-color: rgba(243, 156, 18, 0.15);
      color: #d35400;
    }
    
    .save-controls button.save-program:hover {
      background-color: rgba(243, 156, 18, 0.3);
    }
    
    .save-controls button.export-data {
      background-color: rgba(156, 39, 176, 0.15);
      color: #8e44ad;
    }
    
    .save-controls button.export-data:hover {
      background-color: rgba(156, 39, 176, 0.3);
    }
    
    .saved-items-heading {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 12px 0 5px 0;
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .saved-items {
      margin-top: 5px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      max-height: 120px;
      overflow-y: auto;
      background-color: var(--light-bg);
      transition: var(--theme-transition);
    }
    
    .saved-item {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .saved-item:hover {
      background-color: rgba(52, 152, 219, 0.1);
    }
    
    .saved-item:last-child {
      border-bottom: none;
    }
    
    .saved-item button {
      background: none;
      border: none;
      color: var(--danger-color);
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      transition: transform 0.1s;
    }
    
    .saved-item button:hover {
      transform: scale(1.2);
    }
    
    /* Ph√¢n khu 2: L·∫≠p tr√¨nh kh·ªëi */
    .block-container {
      display: flex;
      margin-bottom: 10px;
      max-height: 250px; /* Gi·ªõi h·∫°n chi·ªÅu cao ƒë·ªÉ v·ª´a m√†n h√¨nh */
      gap: 10px;
    }
    
    .block-library {
      flex: 1;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 10px;
      background-color: var(--light-bg);
      overflow-y: auto;
      transition: var(--theme-transition);
    }
    
    .program-area {
      flex: 1;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 10px;
      background-color: var(--light-bg);
      overflow-y: auto;
      transition: var(--theme-transition);
    }
    
    .command-block {
      margin: 5px 0;
      padding: 8px;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 4px;
      cursor: move;
      display: flex;
      align-items: center;
      font-size: 0.9em;
      position: relative;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: transform 0.1s, box-shadow 0.1s;
    }
    
    .command-block:hover {
      transform: translateY(-2px);
      box-shadow: 0 3px 5px rgba(0,0,0,0.2);
    }
    
    .command-block input {
      width: 60px;
      margin-left: 5px;
      text-align: center;
      padding: 4px;
      border: 1px solid var(--border-color);
      border-radius: 3px;
      background-color: var(--light-bg);
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .unit-label {
      font-size: 0.8em;
      margin-left: 2px;
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    .command-block .block-controls {
      margin-left: auto;
      display: flex;
      gap: 5px;
    }
    
    .command-block .block-controls button {
      background: none;
      border: none;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      padding: 2px 5px;
    }
    
    .command-block .block-controls .delete-block {
      color: var(--danger-color);
    }
    
    .command-block .block-controls .toggle-block {
      color: var(--primary-color);
    }
    
    .command-block.selected-block {
      box-shadow: 0 0 0 2px var(--primary-color);
    }
    
    .command-block.dragging {
      opacity: 0.7;
      z-index: 1000;
    }
    
    .command-block.disabled {
      opacity: 0.5;
      text-decoration: line-through;
      background-color: rgba(240,240,240,0.5) !important;
    }
    
    .dark-mode .command-block.disabled {
      background-color: rgba(40,40,40,0.5) !important;
    }
    
    .drag-indicator {
      height: 3px;
      background-color: var(--primary-color);
      margin: 2px 0;
      display: none;
      border-radius: 1.5px;
    }
    
    .drag-indicator.active {
      display: block;
    }
    
    .command-block.move-up { background-color: var(--move-up-bg); }
    .command-block.move-down { background-color: var(--move-down-bg); }
    .command-block.move-left { background-color: var(--move-left-bg); }
    .command-block.move-right { background-color: var(--move-right-bg); }
    .command-block.move-upleft { background-color: var(--move-upleft-bg); }
    .command-block.move-upright { background-color: var(--move-upright-bg); }
    .command-block.move-downleft { background-color: var(--move-downleft-bg); }
    .command-block.move-downright { background-color: var(--move-downright-bg); }
    .command-block.spin { background-color: var(--spin-bg); }
    .command-block.rotate-left { background-color: var(--rotate-left-bg); }
    .command-block.rotate-right { background-color: var(--rotate-right-bg); }
    
    .run-program {
      display: block;
      width: 100%;
      padding: 12px;
      margin-top: 12px;
      background-color: var(--secondary-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: background-color 0.2s;
    }
    
    .run-program:hover {
      background-color: #27ae60;
    }
    
    .run-program.running {
      background-color: var(--danger-color);
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    
    /* ƒêi·ªÉm resize cho robot */
    .resize-handle {
      position: absolute;
      width: 12px;
      height: 12px;
      background-color: var(--danger-color);
      border: 2px solid white;
      border-radius: 50%;
      bottom: -6px;
      right: -6px;
      cursor: nwse-resize;
      z-index: 10;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    
    /* Input t√™n l∆∞u */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .modal-dialog {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      width: 300px;
      transform: translateY(-20px);
      transition: transform 0.3s;
    }
    
    .modal-overlay.active .modal-dialog {
      transform: translateY(0);
    }
    
    .dark-mode .modal-dialog {
      background-color: #2c3e50;
      color: white;
    }
    
    .modal-dialog h4 {
      margin-top: 0;
      color: var(--primary-color);
    }
    
    .modal-dialog input {
      width: 100%;
      padding: 10px;
      margin: 10px 0 15px 0;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 14px;
      background-color: var(--light-bg);
      color: var(--text-dark);
    }
    
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .modal-dialog button {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .modal-dialog button.primary {
      background-color: var(--primary-color);
      color: white;
    }
    
    .modal-dialog button.secondary {
      background-color: #e0e0e0;
      color: #333;
    }
    
    /* Import/Export Modal */
    .import-export-textarea {
      width: 100%;
      min-height: 150px;
      padding: 10px;
      font-family: monospace;
      margin: 10px 0;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      resize: vertical;
      background-color: var(--light-bg);
      color: var(--text-dark);
    }
    
    /* Tooltip */
    .tooltip {
      position: absolute;
      background-color: rgba(0,0,0,0.8);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      white-space: nowrap;
    }
    
    /* Notification */
    .notification {
      position: fixed;
      top: 60px;
      right: 20px;
      background-color: var(--primary-color);
      color: white;
      padding: 12px 20px;
      border-radius: 4px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      transform: translateX(120%);
      transition: transform 0.3s;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.success {
      background-color: var(--secondary-color);
    }
    
    .notification.error {
      background-color: var(--danger-color);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      #sidebar {
        width: 100%;
        max-width: none;
        position: absolute;
        height: 50%;
        bottom: 0;
        z-index: 100;
        border-top: 1px solid var(--border-color);
        border-right: none;
        resize: none;
      }
      
      #sidebar-resizer {
        display: none;
      }
      
      #display-area {
        height: 50%;
      }
      
      .block-container {
        flex-direction: column;
        max-height: none;
      }
      
      .block-library, .program-area {
        max-height: 150px;
      }
    }
  </style>
</head>
<body>
  <!-- Header Bar -->
  <div id="header-bar">
    <div class="title">Robot Map Interface</div>
    <div id="header-controls">
      <button id="toggle-grid-btn" class="header-button">Hi·ªán/·∫®n L∆∞·ªõi</button>
      <button id="add-waypoint-btn" class="header-button">ƒê√°nh D·∫•u ƒêi·ªÉm</button>
      <div class="theme-toggle" onclick="toggleTheme()">
        <span id="theme-text">Ch·∫ø ƒë·ªô t·ªëi</span>
        <div class="toggle-switch"></div>
      </div>
    </div>
  </div>
  
  <div id="main-container">
    <div id="sidebar">
      <!-- Ph√¢n khu 1: ƒêi·ªÅu khi·ªÉn tr·ª±c ti·∫øp -->
      <div id="control-panel" class="panel-section">
        <h3 class="panel-section-title">ƒêi·ªÅu Khi·ªÉn Robot</h3>
        
        <div class="unit-display">
          <div>T·ª∑ l·ªá hi·ªán t·∫°i: <strong><span id="scale-ratio">1</span> cm/pixel</strong></div>
          <div>T·ªça ƒë·ªô hi·ªán t·∫°i: <strong>X: <span id="current-x">0</span> cm, Y: <span id="current-y">0</span> cm</strong></div>
          <div>G√≥c quay: <strong><span id="current-angle">0</span>¬∞</strong></div>
        </div>
        
        <h4 class="controls-title">
          ƒêi·ªÅu khi·ªÉn di chuy·ªÉn
          <div class="history-controls">
            <button id="undo-button-1" onclick="undoAction()" title="Quay l·∫°i b∆∞·ªõc tr∆∞·ªõc (Ctrl+Z)">‚Ü©</button>
            <button id="redo-button-1" onclick="redoAction()" title="Ti·∫øn l·∫°i b∆∞·ªõc sau (Ctrl+Y)">‚Ü™</button>
          </div>
        </h4>
        
        <div class="movement-grid">
          <button onclick="moveRobotInDirection(-1, -1)" title="Di chuy·ªÉn ch√©o tr√°i l√™n (U)">‚Üñ</button>
          <button onclick="moveRobotInDirection(0, -1)" title="Di chuy·ªÉn l√™n (W)">‚Üë</button>
          <button onclick="moveRobotInDirection(1, -1)" title="Di chuy·ªÉn ch√©o ph·∫£i l√™n (I)">‚Üó</button>
          <button onclick="moveRobotInDirection(-1, 0)" title="Di chuy·ªÉn sang tr√°i (A)">‚Üê</button>
          <button onclick="spinRobot()" title="Xoay tr√≤n (Space)">‚ü≥</button>
          <button onclick="moveRobotInDirection(1, 0)" title="Di chuy·ªÉn sang ph·∫£i (D)">‚Üí</button>
          <button onclick="moveRobotInDirection(-1, 1)" title="Di chuy·ªÉn ch√©o tr√°i xu·ªëng (J)">‚Üô</button>
          <button onclick="moveRobotInDirection(0, 1)" title="Di chuy·ªÉn xu·ªëng (S)">‚Üì</button>
          <button onclick="moveRobotInDirection(1, 1)" title="Di chuy·ªÉn ch√©o ph·∫£i xu·ªëng (K)">‚Üò</button>
        </div>
        
        <div class="rotation-controls">
          <button onclick="rotate(-5)" title="Quay tr√°i 5 ƒë·ªô (Q)">‚ü≤ Quay tr√°i</button>
          <button onclick="rotate(5)" title="Quay ph·∫£i 5 ƒë·ªô (E)">‚ü≥ Quay ph·∫£i</button>
          <button onclick="centerRobot()" title="ƒê·∫∑t robot v·ªÅ v·ªã tr√≠ trung t√¢m (R)">‚ü¥ V·ªÅ gi·ªØa</button>
        </div>
        
        <!-- Position Control Panel - M·ªõi -->
        <div class="position-control-panel">
          <h5>Di chuy·ªÉn ƒë·∫øn t·ªça ƒë·ªô ch√≠nh x√°c</h5>
          <div class="coordinate-inputs">
            <div class="coordinate-input">
              <label for="target-x">T·ªça ƒë·ªô X (cm)</label>
              <input type="number" id="target-x" step="0.1" placeholder="X (cm)">
            </div>
            <div class="coordinate-input">
              <label for="target-y">T·ªça ƒë·ªô Y (cm)</label>
              <input type="number" id="target-y" step="0.1" placeholder="Y (cm)">
            </div>
          </div>
          <button class="move-to-coords-btn" onclick="moveToCoordinates()">Di chuy·ªÉn ƒë·∫øn t·ªça ƒë·ªô</button>
        </div>
        
        <div class="toggle-controls">
          <div class="control-toggle">
            <input type="checkbox" id="toggle-robot" checked onchange="toggleRobot()">
            <label for="toggle-robot">·∫®n/Hi·ªán Robot</label>
          </div>
          
          <div class="control-toggle">
            <input type="checkbox" id="show-path" onchange="toggleShowPath()">
            <label for="show-path">Hi·ªán qu√£ng ƒë∆∞·ªùng di chuy·ªÉn</label>
          </div>
        </div>
        
        <!-- Th√™m ƒëi·ªÅu khi·ªÉn b∆∞·ªõc di chuy·ªÉn -->
        <div class="step-size-control">
          <label for="step-size">B∆∞·ªõc di chuy·ªÉn:</label>
          <input type="number" id="step-size" value="1" min="0.1" step="0.1" onchange="updateStepSize(this.value)">
          <span class="unit">cm</span>
        </div>
        
        <!-- N√∫t ƒë·∫£o chi·ªÅu -->
        <div class="direction-toggle-container">
          <div class="direction-toggle-btn">
            <span>ƒê·∫£o chi·ªÅu robot:</span>
            <div class="direction-toggle">
              <button id="toggle-vertical" onclick="toggleVerticalDirection()">Tr√™n/D∆∞·ªõi</button>
              <button id="toggle-horizontal" onclick="toggleHorizontalDirection()">Tr√°i/Ph·∫£i</button>
            </div>
          </div>
        </div>
        
        <div class="robot-resize-controls">
          <label for="robot-size">K√≠ch th∆∞·ªõc robot:</label>
          <div class="robot-resize-slider">
            <input type="range" id="robot-size" min="20" max="150" value="50" oninput="resizeRobot(this.value)">
            <span class="size-value" id="size-display">50px</span>
          </div>
        </div>
        
        <div class="save-controls">
          <button class="save-position" onclick="showSaveDialog('position')">
            <i>üíæ</i> L∆∞u v·ªã tr√≠ hi·ªán t·∫°i
          </button>
          <button class="save-size" onclick="showSaveDialog('size')">
            <i>üìè</i> L∆∞u k√≠ch th∆∞·ªõc robot
          </button>
          <button class="save-program" onclick="showSaveDialog('program')">
            <i>üìã</i> L∆∞u ch∆∞∆°ng tr√¨nh
          </button>
          <button class="export-data" onclick="showExportDialog()">
            <i>üì§</i> Xu·∫•t/Nh·∫≠p d·ªØ li·ªáu
          </button>
        </div>
        
        <h5 class="saved-items-heading">
          V·ªã tr√≠ ƒë√£ l∆∞u
          <button id="clear-positions" onclick="clearSavedItems('position')" title="X√≥a t·∫•t c·∫£ v·ªã tr√≠" style="background: none; border: none; color: var(--danger-color); cursor: pointer; font-size: 16px;">üóëÔ∏è</button>
        </h5>
        <div class="saved-items" id="saved-positions">
          <!-- C√°c v·ªã tr√≠ ƒë√£ l∆∞u s·∫Ω ƒë∆∞·ª£c th√™m ·ªü ƒë√¢y -->
        </div>
        
        <h5 class="saved-items-heading">
          K√≠ch th∆∞·ªõc ƒë√£ l∆∞u
          <button id="clear-sizes" onclick="clearSavedItems('size')" title="X√≥a t·∫•t c·∫£ k√≠ch th∆∞·ªõc" style="background: none; border: none; color: var(--danger-color); cursor: pointer; font-size: 16px;">üóëÔ∏è</button>
        </h5>
        <div class="saved-items" id="saved-sizes">
          <!-- C√°c k√≠ch th∆∞·ªõc ƒë√£ l∆∞u s·∫Ω ƒë∆∞·ª£c th√™m ·ªü ƒë√¢y -->
        </div>
        
        <h5 class="saved-items-heading">
          Ch∆∞∆°ng tr√¨nh ƒë√£ l∆∞u
          <button id="clear-programs" onclick="clearSavedItems('program')" title="X√≥a t·∫•t c·∫£ ch∆∞∆°ng tr√¨nh" style="background: none; border: none; color: var(--danger-color); cursor: pointer; font-size: 16px;">üóëÔ∏è</button>
        </h5>
        <div class="saved-items" id="saved-programs">
          <!-- C√°c ch∆∞∆°ng tr√¨nh ƒë√£ l∆∞u s·∫Ω ƒë∆∞·ª£c th√™m ·ªü ƒë√¢y -->
        </div>
      </div>
      
      <!-- Ph√¢n khu 2: L·∫≠p tr√¨nh kh·ªëi -->
      <div id="block-programming" class="panel-section">
        <h3 class="panel-section-title">L·∫≠p tr√¨nh kh·ªëi</h3>
        
        <h4 class="controls-title">
          Ch∆∞∆°ng tr√¨nh
          <div class="history-controls">
            <button id="undo-button-2" onclick="undoAction()" title="Quay l·∫°i b∆∞·ªõc tr∆∞·ªõc (Ctrl+Z)">‚Ü©</button>
            <button id="redo-button-2" onclick="redoAction()" title="Ti·∫øn l·∫°i b∆∞·ªõc sau (Ctrl+Y)">‚Ü™</button>
          </div>
        </h4>
        
        <div class="block-container">
          <div class="block-library" id="block-library">
            <div class="command-block move-up" draggable="true" data-command="up">
              L√™n <input type="number" value="1" min="0.1" step="0.1"><span class="unit-label">cm</span>
            </div>
            <div class="command-block move-down" draggable="true" data-command="down">
              Xu·ªëng <input type="number" value="1" min="0.1" step="0.1"><span class="unit-label">cm</span>
            </div>
            <div class="command-block move-left" draggable="true" data-command="left">
              Tr√°i <input type="number" value="1" min="0.1" step="0.1"><span class="unit-label">cm</span>
            </div>
            <div class="command-block move-right" draggable="true" data-command="right">
              Ph·∫£i <input type="number" value="1" min="0.1" step="0.1"><span class="unit-label">cm</span>
            </div>
            <div class="command-block move-upleft" draggable="true" data-command="upleft">
              Ch√©o tr√°i l√™n <input type="number" value="1" min="0.1" step="0.1"><span class="unit-label">cm</span>
            </div>
            <div class="command-block move-upright" draggable="true" data-command="upright">
              Ch√©o ph·∫£i l√™n <input type="number" value="1" min="0.1" step="0.1"><span class="unit-label">cm</span>
            </div>
            <div class="command-block move-downleft" draggable="true" data-command="downleft">
              Ch√©o tr√°i xu·ªëng <input type="number" value="1" min="0.1" step="0.1"><span class="unit-label">cm</span>
            </div>
            <div class="command-block move-downright" draggable="true" data-command="downright">
              Ch√©o ph·∫£i xu·ªëng <input type="number" value="1" min="0.1" step="0.1"><span class="unit-label">cm</span>
            </div>
            <div class="command-block spin" draggable="true" data-command="spin">
              Xoay tr√≤n <input type="number" value="1" min="0.1" step="0.1"><span class="unit-label">v√≤ng</span>
            </div>
            <div class="command-block rotate-left" draggable="true" data-command="rotateleft">
              Quay tr√°i <input type="number" value="45" min="0.1" step="0.1"><span class="unit-label">ƒë·ªô</span>
            </div>
            <div class="command-block rotate-right" draggable="true" data-command="rotateright">
              Quay ph·∫£i <input type="number" value="45" min="0.1" step="0.1"><span class="unit-label">ƒë·ªô</span>
            </div>
          </div>
          
          <div class="program-area" id="program-area">
            <!-- Khu v·ª±c nh·∫≠n c√°c kh·ªëi l·ªánh -->
            <div class="drag-indicator" id="drag-indicator"></div>
          </div>
        </div>
        
        <button class="run-program" onclick="runProgram()" id="run-program-btn">
          <i>‚ñ∂Ô∏è</i> Ch·∫°y ch∆∞∆°ng tr√¨nh (Enter)
        </button>
      </div>
    </div>
    
    <div id="sidebar-resizer"></div>
    
    <!-- Ph√¢n khu 3: Hi·ªÉn th·ªã map v√† robot -->
    <div id="display-area">
      <div id="map-container">
        <div id="grid-overlay"></div>
        <img id="map" src="map.png" alt="Map" />
        <div id="path-container"></div>
        <div id="waypoints-container"></div>
      </div>
      <div id="robot-container">
        <img id="robot" src="robot.png" alt="Robot" />
        <div class="resize-handle" id="resize-handle"></div>
      </div>
      
      <div id="coordinates-display">
        <div>X: <span id="display-x">0</span> cm</div>
        <div>Y: <span id="display-y">0</span> cm</div>
        <div>G√≥c: <span id="display-angle">0</span>¬∞</div>
        <div>Qu√£ng ƒë∆∞·ªùng: <span id="total-distance">0</span> cm</div>
      </div>
    </div>
  </div>
  
  <!-- Tooltip -->
  <div class="tooltip" id="tooltip"></div>
  
  <!-- Notification -->
  <div class="notification" id="notification"></div>
  
  <!-- H·ªôp tho·∫°i nh·∫≠p t√™n l∆∞u -->
  <div class="modal-overlay" id="save-dialog-overlay">
    <div class="modal-dialog" id="save-dialog">
      <h4 id="save-dialog-title">L∆∞u v·ªã tr√≠</h4>
      <input type="text" id="save-name" placeholder="Nh·∫≠p t√™n">
      <div class="modal-buttons">
        <button class="secondary" onclick="hideSaveDialog()">H·ªßy</button>
        <button class="primary" onclick="saveItem()">L∆∞u</button>
      </div>
    </div>
  </div>
  
  <!-- H·ªôp tho·∫°i xu·∫•t/nh·∫≠p d·ªØ li·ªáu -->
  <div class="modal-overlay" id="import-export-overlay">
    <div class="modal-dialog" style="width: 400px;">
      <h4>Xu·∫•t/Nh·∫≠p d·ªØ li·ªáu</h4>
      <p style="margin-top: 0; font-size: 14px;">Copy ƒëo·∫°n m√£ b√™n d∆∞·ªõi ƒë·ªÉ l∆∞u ho·∫∑c d√°n m√£ s·∫µn c√≥ ƒë·ªÉ nh·∫≠p</p>
      <textarea id="import-export-data" class="import-export-textarea" placeholder="D√°n d·ªØ li·ªáu JSON v√†o ƒë√¢y ƒë·ªÉ nh·∫≠p..."></textarea>
      <div class="modal-buttons">
        <button class="secondary" onclick="hideImportExportDialog()">ƒê√≥ng</button>
        <button class="primary" onclick="importData()">Nh·∫≠p d·ªØ li·ªáu</button>
        <button class="primary" onclick="copyExportData()">Copy</button>
      </div>
    </div>
  </div>
  <script>
    const robot = document.getElementById("robot");
    const mapImg = document.getElementById("map");
    const resizeHandle = document.getElementById("resize-handle");
    const sidebar = document.getElementById("sidebar");
    const sidebarResizer = document.getElementById("sidebar-resizer");
    const programArea = document.getElementById("program-area");
    const blockLibrary = document.getElementById("block-library");
    const dragIndicator = document.getElementById("drag-indicator");
    const gridOverlay = document.getElementById("grid-overlay");
    const toggleGridBtn = document.getElementById("toggle-grid-btn");
    const addWaypointBtn = document.getElementById("add-waypoint-btn");
    const waypointsContainer = document.getElementById("waypoints-container");
    const pathContainer = document.getElementById("path-container");
    const coordinatesDisplay = document.getElementById("coordinates-display");
    const tooltip = document.getElementById("tooltip");
    const notification = document.getElementById("notification");
    const runProgramBtn = document.getElementById("run-program-btn");
    const saveDialogOverlay = document.getElementById("save-dialog-overlay");
    const importExportOverlay = document.getElementById("import-export-overlay");
    
    // Kh·ªüi t·∫°o bi·∫øn tr·∫°ng th√°i ch√≠nh
    let x = 0, y = 0;                       // T·ªça ƒë·ªô pixel hi·ªán t·∫°i c·ªßa robot
    let realX = 0, realY = 0;               // T·ªça ƒë·ªô th·ª±c t·∫ø (cm) hi·ªán t·∫°i c·ªßa robot
    let angle = 0;                          // G√≥c quay hi·ªán t·∫°i (ƒë·ªô)
    let robotSize = 50;                     // K√≠ch th∆∞·ªõc m·∫∑c ƒë·ªãnh c·ªßa robot (px)
    let robotRealSize = 16;                 // K√≠ch th∆∞·ªõc th·ª±c t·∫ø c·ªßa robot (cm)
    let isProgramRunning = false;           // Tr·∫°ng th√°i ƒëang ch·∫°y ch∆∞∆°ng tr√¨nh
    let programQueue = [];                  // H√†ng ƒë·ª£i l·ªánh ƒëang ch·∫°y
    let invertedVertical = false;           // Tr·∫°ng th√°i ƒë·∫£o chi·ªÅu d·ªçc
    let invertedHorizontal = false;         // Tr·∫°ng th√°i ƒë·∫£o chi·ªÅu ngang
    let stepSize = 1.0;                     // K√≠ch th∆∞·ªõc b∆∞·ªõc di chuy·ªÉn m·∫∑c ƒë·ªãnh (cm)
    let isWaypointMode = false;             // ƒêang ·ªü ch·∫ø ƒë·ªô ƒë√°nh d·∫•u ƒëi·ªÉm
    let showingPath = false;                // Tr·∫°ng th√°i hi·ªÉn th·ªã ƒë∆∞·ªùng ƒëi
    let isDarkMode = false;                 // Tr·∫°ng th√°i ch·∫ø ƒë·ªô t·ªëi
    
    // D·ªØ li·ªáu qu√£ng ƒë∆∞·ªùng v√† l·ªãch tr√¨nh di chuy·ªÉn
    let totalDistance = 0;                  // T·ªïng qu√£ng ƒë∆∞·ªùng ƒë√£ di chuy·ªÉn (cm)
    let movementHistory = [];               // L·ªãch s·ª≠ di chuy·ªÉn ƒë·ªÉ v·∫Ω ƒë∆∞·ªùng ƒëi
    let waypoints = [];                     // Danh s√°ch ƒëi·ªÉm ƒë√°nh d·∫•u
    let nextWaypointId = 1;                 // ID ti·∫øp theo cho ƒëi·ªÉm ƒë√°nh d·∫•u
    
    // L·ªãch s·ª≠ thao t√°c cho Undo/Redo
    let history = [];
    let historyIndex = -1;
    let ignoreNextUpdate = false;
    
    // Bi·∫øn cho h·ªôp tho·∫°i l∆∞u
    let savingType = '';
    
    // Bi·∫øn tr·∫°ng th√°i k√©o th·∫£
    let isDragging = false;
    let currentDragTarget = null;
    let dragSourceParent = null;
    let dragStartIndex = -1;
    
    // Bi·∫øn tr·∫°ng th√°i resize
    let isResizing = false;
    let isResizingSidebar = false;
    let lastX = 0;
    
    // Th√¥ng s·ªë chuy·ªÉn ƒë·ªïi t·ª∑ l·ªá
    const MAP_REAL_WIDTH = 120;             // K√≠ch th∆∞·ªõc th·ª±c t·∫ø c·ªßa map (cm)
    const MAP_REAL_HEIGHT = 120;            // K√≠ch th∆∞·ªõc th·ª±c t·∫ø c·ªßa map (cm)
    const ROBOT_REAL_WIDTH = 16;            // K√≠ch th∆∞·ªõc th·ª±c t·∫ø c·ªßa robot (cm)
    let pixelToCmRatio = 1;                 // T·ª∑ l·ªá pixel/cm, s·∫Ω ƒë∆∞·ª£c t√≠nh l·∫°i khi load ·∫£nh
    
    // Kh·ªüi t·∫°o danh s√°ch v·ªã tr√≠, k√≠ch th∆∞·ªõc v√† ch∆∞∆°ng tr√¨nh ƒë√£ l∆∞u
    let savedPositions = JSON.parse(localStorage.getItem('robotPositions')) || [];
    let savedSizes = JSON.parse(localStorage.getItem('robotSizes')) || [];
    let savedPrograms = JSON.parse(localStorage.getItem('robotPrograms')) || [];
    
    // Kh·ªüi t·∫°o khi trang t·∫£i xong
    window.addEventListener('load', function() {
      initializeApp();
    });
    
    // Kh·ªüi t·∫°o ·ª©ng d·ª•ng
    function initializeApp() {
      calculateScale();
      centerRobot();
      positionResizeHandle();
      updateCoordinateDisplay();
      createGridOverlay();
      updateSavedPositionsList();
      updateSavedSizesList();
      updateSavedProgramsList();
      setupTooltips();
      
      // Ki·ªÉm tra n·∫øu c√≥ theme ƒë√£ l∆∞u
      const savedTheme = localStorage.getItem('robotTheme');
      if (savedTheme === 'dark') {
        toggleTheme();
      }
      
      // C√†i ƒë·∫∑t s·ª± ki·ªán cho b∆∞·ªõc di chuy·ªÉn
      document.getElementById('step-size').value = stepSize;
      document.getElementById('size-display').textContent = `${robotSize}px`;
      
      // Setup s·ª± ki·ªán k√©o th·∫£
      setupDragDrop();
      
      // Hi·ªÉn th·ªã th√¥ng b√°o ch√†o m·ª´ng
      showNotification('Ch√†o m·ª´ng ƒë·∫øn v·ªõi Robot Map Interface!', 'info');
    }
    
    // T√≠nh to√°n t·ª∑ l·ªá khi ·∫£nh ƒë∆∞·ª£c t·∫£i
    mapImg.addEventListener('load', calculateScale);
    
    // T√≠nh l·∫°i t·ª∑ l·ªá khi c·ª≠a s·ªï thay ƒë·ªïi k√≠ch th∆∞·ªõc
    window.addEventListener('resize', function() {
      calculateScale();
      updateCoordinateDisplay();
      positionResizeHandle();
      if (showingPath) updatePathDisplay();
    });
    
    // T·∫°o l∆∞·ªõi t·ªça ƒë·ªô
    function createGridOverlay() {
      // X√≥a l∆∞·ªõi c≈© n·∫øu c√≥
      gridOverlay.innerHTML = '';
      
      // T·∫°o l∆∞·ªõi v·ªõi c√°c ƒë∆∞·ªùng c√°ch nhau 10cm th·ª±c t·∫ø
      const gridSpacingCm = 10; // Kho·∫£ng c√°ch th·ª±c t·∫ø gi·ªØa c√°c ƒë∆∞·ªùng l∆∞·ªõi (cm)
      
      // ƒê·ª£i cho map load xong ƒë·ªÉ t√≠nh to√°n k√≠ch th∆∞·ªõc
      const mapRect = mapImg.getBoundingClientRect();
      const gridSpacingPx = cmToPixel(gridSpacingCm);
      
      // V·∫Ω ƒë∆∞·ªùng d·ªçc
      for (let i = gridSpacingPx; i < mapRect.width; i += gridSpacingPx) {
        const line = document.createElement('div');
        line.className = 'grid-line';
        line.style.width = '1px';
        line.style.height = '100%';
        line.style.left = `${i}px`;
        gridOverlay.appendChild(line);
      }
      
      // V·∫Ω ƒë∆∞·ªùng ngang
      for (let i = gridSpacingPx; i < mapRect.height; i += gridSpacingPx) {
        const line = document.createElement('div');
        line.className = 'grid-line';
        line.style.height = '1px';
        line.style.width = '100%';
        line.style.top = `${i}px`;
        gridOverlay.appendChild(line);
      }
    }
    
    // Toggle hi·ªÉn th·ªã l∆∞·ªõi
    toggleGridBtn.addEventListener('click', function() {
      if (gridOverlay.style.display === 'block') {
        gridOverlay.style.display = 'none';
        toggleGridBtn.textContent = 'Hi·ªán L∆∞·ªõi';
      } else {
        gridOverlay.style.display = 'block';
        toggleGridBtn.textContent = '·∫®n L∆∞·ªõi';
      }
    });
    
    // Toggle ch·∫ø ƒë·ªô ƒë√°nh d·∫•u ƒëi·ªÉm
    addWaypointBtn.addEventListener('click', function() {
      isWaypointMode = !isWaypointMode;
      
      if (isWaypointMode) {
        addWaypointBtn.style.backgroundColor = 'rgba(255,255,255,0.4)';
        addWaypointBtn.textContent = 'ƒêang ƒë√°nh d·∫•u...';
        document.body.style.cursor = 'crosshair';
        showNotification('Nh·∫•p ƒë·ªÉ ƒë√°nh d·∫•u ƒëi·ªÉm tr√™n b·∫£n ƒë·ªì', 'info');
      } else {
        addWaypointBtn.style.backgroundColor = '';
        addWaypointBtn.textContent = 'ƒê√°nh D·∫•u ƒêi·ªÉm';
        document.body.style.cursor = '';
      }
    });
    
    // X·ª≠ l√Ω nh·∫•p chu·ªôt l√™n map ƒë·ªÉ ƒë√°nh d·∫•u ƒëi·ªÉm
    mapImg.addEventListener('click', function(e) {
      if (!isWaypointMode) return;
      
      const mapRect = mapImg.getBoundingClientRect();
      const clickX = e.clientX - mapRect.left;
      const clickY = e.clientY - mapRect.top;
      
      // Chuy·ªÉn ƒë·ªïi pixel sang cm
      const cmX = pixelToCmRatio * clickX;
      const cmY = pixelToCmRatio * clickY;
      
      // T·∫°o waypoint
      const waypoint = {
        id: nextWaypointId++,
        x: clickX,
        y: clickY,
        realX: cmX,
        realY: cmY,
        label: `ƒêi·ªÉm ${nextWaypointId - 1}`
      };
      
      waypoints.push(waypoint);
      renderWaypoint(waypoint);
      showNotification(`ƒê√£ ƒë√°nh d·∫•u ƒëi·ªÉm t·∫°i X:${cmX.toFixed(1)}cm, Y:${cmY.toFixed(1)}cm`, 'success');
    });
    
    // V·∫Ω waypoint l√™n map
    function renderWaypoint(waypoint) {
      const marker = document.createElement('div');
      marker.className = 'waypoint-marker';
      marker.style.left = `${waypoint.x}px`;
      marker.style.top = `${waypoint.y}px`;
      marker.dataset.id = waypoint.id;
      
      const label = document.createElement('div');
      label.className = 'waypoint-label';
      label.textContent = `${waypoint.label} (${waypoint.realX.toFixed(1)}, ${waypoint.realY.toFixed(1)})`;
      
      marker.appendChild(label);
      
      // Th√™m s·ª± ki·ªán di chuy·ªÉn ƒë·∫øn waypoint khi nh·∫•p ƒë√∫p
      marker.addEventListener('dblclick', function() {
        moveToWaypoint(waypoint);
      });
      
      // Th√™m s·ª± ki·ªán x√≥a waypoint khi nh·∫•p chu·ªôt ph·∫£i
      marker.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        removeWaypoint(waypoint.id);
      });
      
      // Th√™m tooltip
      marker.addEventListener('mouseenter', function() {
        showTooltip(`${waypoint.label} (${waypoint.realX.toFixed(1)}, ${waypoint.realY.toFixed(1)}) - Nh·∫•p ƒë√∫p ƒë·ªÉ di chuy·ªÉn ƒë·∫øn ƒëi·ªÉm n√†y - Chu·ªôt ph·∫£i ƒë·ªÉ x√≥a`, e);
      });
      
      marker.addEventListener('mouseleave', function() {
        hideTooltip();
      });
      
      waypointsContainer.appendChild(marker);
    }
    
    // Di chuy·ªÉn robot ƒë·∫øn waypoint
    function moveToWaypoint(waypoint) {
      // Chuy·ªÉn waypoint t·ª´ t·ªça ƒë·ªô th·ª±c t·∫ø (cm) sang pixel
      moveToCoordinates(waypoint.realX, waypoint.realY);
    }
    
    // X√≥a waypoint
    function removeWaypoint(id) {
      // T√¨m v√† x√≥a waypoint t·ª´ m·∫£ng
      const index = waypoints.findIndex(wp => wp.id === id);
      if (index !== -1) {
        waypoints.splice(index, 1);
      }
      
      // X√≥a marker t∆∞∆°ng ·ª©ng
      const marker = waypointsContainer.querySelector(`.waypoint-marker[data-id="${id}"]`);
      if (marker) {
        waypointsContainer.removeChild(marker);
      }
      
      showNotification('ƒê√£ x√≥a ƒëi·ªÉm ƒë√°nh d·∫•u', 'info');
    }
    
    // Toggle hi·ªÉn th·ªã ƒë∆∞·ªùng ƒëi
    function toggleShowPath() {
      showingPath = document.getElementById('show-path').checked;
      
      if (showingPath) {
        updatePathDisplay();
      } else {
        pathContainer.innerHTML = '';
      }
    }
    
    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã ƒë∆∞·ªùng ƒëi
    function updatePathDisplay() {
      if (!showingPath) return;
      
      pathContainer.innerHTML = '';
      
      if (movementHistory.length < 2) return;
      
      // T·∫°o SVG ƒë·ªÉ v·∫Ω ƒë∆∞·ªùng
      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.style.position = 'absolute';
      svg.style.top = '0';
      svg.style.left = '0';
      svg.style.width = '100%';
      svg.style.height = '100%';
      svg.style.pointerEvents = 'none';
      
      // T·∫°o ƒë∆∞·ªùng ƒëi
      const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
      
      // Generate ƒë∆∞·ªùng ƒëi t·ª´ l·ªãch s·ª≠ di chuy·ªÉn
      let pathD = `M ${movementHistory[0].x} ${movementHistory[0].y}`;
      
      for (let i = 1; i < movementHistory.length; i++) {
        pathD += ` L ${movementHistory[i].x} ${movementHistory[i].y}`;
      }
      
      path.setAttribute('d', pathD);
      path.style.fill = 'none';
      path.style.stroke = isDarkMode ? 'rgba(52, 152, 219, 0.8)' : 'rgba(41, 128, 185, 0.8)';
      path.style.strokeWidth = '2';
      path.style.strokeDasharray = '5,3';
      
      svg.appendChild(path);
      pathContainer.appendChild(svg);
    }
    
    // C·∫≠p nh·∫≠t k√≠ch th∆∞·ªõc b∆∞·ªõc di chuy·ªÉn
    function updateStepSize(value) {
      stepSize = parseFloat(value) || 1;
      // ƒê·∫£m b·∫£o gi√° tr·ªã n·∫±m trong ph·∫°m vi h·ª£p l·ªá
      if (stepSize < 0.1) stepSize = 0.1;
      document.getElementById('step-size').value = stepSize;
    }
    
    // T√≠nh to√°n t·ª∑ l·ªá pixel/cm
    function calculateScale() {
      const mapRect = mapImg.getBoundingClientRect();
      pixelToCmRatio = MAP_REAL_WIDTH / mapRect.width;
      
      // C·∫≠p nh·∫≠t hi·ªÉn th·ªã t·ª∑ l·ªá
      document.getElementById('scale-ratio').textContent = pixelToCmRatio.toFixed(3);
      
      // T√≠nh to√°n k√≠ch th∆∞·ªõc robot ph√π h·ª£p v·ªõi t·ª∑ l·ªá m·ªõi
      const idealRobotWidth = ROBOT_REAL_WIDTH / pixelToCmRatio;
      robotSize = Math.max(20, Math.min(150, idealRobotWidth));
      robot.style.width = `${robotSize}px`;
      document.getElementById('robot-size').value = robotSize;
      document.getElementById('size-display').textContent = `${Math.round(robotSize)}px`;
      
      // T√≠nh l·∫°i v·ªã tr√≠ th·ª±c t·∫ø
      updateRealCoordinates();
      
      // C·∫≠p nh·∫≠t l∆∞·ªõi n·∫øu c·∫ßn
      createGridOverlay();
    }
    
    // Chuy·ªÉn ƒë·ªïi t·ª´ cm sang pixel
    function cmToPixel(cm) {
      return cm / pixelToCmRatio;
    }
    
    // Chuy·ªÉn ƒë·ªïi t·ª´ pixel sang cm
    function pixelToCm(pixel) {
      return pixel * pixelToCmRatio;
    }
    
    // L∆∞u m·ªôt tr·∫°ng th√°i v√†o l·ªãch s·ª≠
    function saveToHistory() {
      if (ignoreNextUpdate) {
        ignoreNextUpdate = false;
        return;
      }
      
      // C·∫Øt b·ªè l·ªãch s·ª≠ ph√≠a tr∆∞·ªõc n·∫øu ƒëang ·ªü gi·ªØa
      if (historyIndex < history.length - 1) {
        history = history.slice(0, historyIndex + 1);
      }
      
      // L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i
      history.push({
        x: x,
        y: y,
        realX: realX,
        realY: realY,
        angle: angle,
        robotSize: robotSize,
        invertedVertical: invertedVertical,
        invertedHorizontal: invertedHorizontal,
        stepSize: stepSize,
        totalDistance: totalDistance,
        movementHistory: JSON.parse(JSON.stringify(movementHistory)) // T·∫°o deep copy
      });
      
      historyIndex = history.length - 1;
      
      // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t
      updateUndoRedoButtons();
    }
    
    // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t Undo/Redo
    function updateUndoRedoButtons() {
      document.getElementById('undo-button-1').disabled = historyIndex <= 0;
      document.getElementById('redo-button-1').disabled = historyIndex >= history.length - 1;
      document.getElementById('undo-button-2').disabled = historyIndex <= 0;
      document.getElementById('redo-button-2').disabled = historyIndex >= history.length - 1;
    }
    
    // Th·ª±c hi·ªán quay l·∫°i
    function undoAction() {
      if (historyIndex > 0) {
        historyIndex--;
        const state = history[historyIndex];
        ignoreNextUpdate = true;
        
        x = state.x;
        y = state.y;
        realX = state.realX;
        realY = state.realY;
        angle = state.angle;
        robotSize = state.robotSize;
        invertedVertical = state.invertedVertical || false;
        invertedHorizontal = state.invertedHorizontal || false;
        stepSize = state.stepSize || 1.0;
        totalDistance = state.totalDistance || 0;
        movementHistory = JSON.parse(JSON.stringify(state.movementHistory || []));
        
        robot.style.width = `${robotSize}px`;
        document.getElementById('robot-size').value = robotSize;
        document.getElementById('size-display').textContent = `${Math.round(robotSize)}px`;
        document.getElementById('toggle-vertical').classList.toggle('active', invertedVertical);
        document.getElementById('toggle-horizontal').classList.toggle('active', invertedHorizontal);
        document.getElementById('step-size').value = stepSize;
        
        updateRobot();
        updateCoordinateDisplay();
        updateUndoRedoButtons();
        
        if (showingPath) {
          updatePathDisplay();
        }
      }
    }
    
    // Th·ª±c hi·ªán ti·∫øn t·ªõi
    function redoAction() {
      if (historyIndex < history.length - 1) {
        historyIndex++;
        const state = history[historyIndex];
        ignoreNextUpdate = true;
        
        x = state.x;
        y = state.y;
        realX = state.realX;
        realY = state.realY;
        angle = state.angle;
        robotSize = state.robotSize;
        invertedVertical = state.invertedVertical || false;
        invertedHorizontal = state.invertedHorizontal || false;
        stepSize = state.stepSize || 1.0;
        totalDistance = state.totalDistance || 0;
        movementHistory = JSON.parse(JSON.stringify(state.movementHistory || []));
        
        robot.style.width = `${robotSize}px`;
        document.getElementById('robot-size').value = robotSize;
        document.getElementById('size-display').textContent = `${Math.round(robotSize)}px`;
        document.getElementById('toggle-vertical').classList.toggle('active', invertedVertical);
        document.getElementById('toggle-horizontal').classList.toggle('active', invertedHorizontal);
        document.getElementById('step-size').value = stepSize;
        
        updateRobot();
        updateCoordinateDisplay();
        updateUndoRedoButtons();
        
        if (showingPath) {
          updatePathDisplay();
        }
      }
    }
    
    // ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc robot
    function resizeRobot(size) {
      size = parseInt(size);
      robotSize = size;
      robot.style.width = `${robotSize}px`;
      document.getElementById('size-display').textContent = `${size}px`;
      
      // C·∫≠p nh·∫≠t k√≠ch th∆∞·ªõc th·ª±c t·∫ø c·ªßa robot (cm)
      robotRealSize = pixelToCm(robotSize);
      
      positionResizeHandle();
      updateRobot();
      saveToHistory();
    }
    
    // ƒê·∫∑t robot ·ªü gi·ªØa map
    function centerRobot() {
      const mapRect = mapImg.getBoundingClientRect();
      
      // ƒê·∫∑t robot ·ªü gi·ªØa map
      x = mapRect.left + (mapRect.width / 2) - (robotSize / 2);
      y = mapRect.top + (mapRect.height / 2) - (robotSize / 2);
      
      // C·∫≠p nh·∫≠t t·ªça ƒë·ªô th·ª±c t·∫ø
      updateRealCoordinates();
      
      // T·∫°o ƒëi·ªÉm di chuy·ªÉn ƒë·∫ßu ti√™n
      if (movementHistory.length === 0) {
        addMovementPoint(x, y);
      }
      
      updateRobot();
      updateCoordinateDisplay();
      saveToHistory();
      
      showNotification('ƒê√£ ƒë·∫∑t robot v·ªÅ v·ªã tr√≠ trung t√¢m', 'info');
    }
    
    // C·∫≠p nh·∫≠t v·ªã tr√≠ v√† g√≥c quay c·ªßa robot
    function updateRobot() {
      robot.style.left = `${x}px`;
      robot.style.top = `${y}px`;
      robot.style.transform = `rotate(${angle}deg)`;
      positionResizeHandle();
      updateCoordinateDisplay();
    }
    
    // C·∫≠p nh·∫≠t t·ªça ƒë·ªô th·ª±c t·∫ø (cm)
    function updateRealCoordinates() {
      const mapRect = mapImg.getBoundingClientRect();
      
      // T√≠nh to√°n t·ªça ƒë·ªô t∆∞∆°ng ƒë·ªëi c·ªßa robot so v·ªõi map
      const relativeX = x - mapRect.left;
      const relativeY = y - mapRect.top;
      
      // Chuy·ªÉn ƒë·ªïi sang t·ªça ƒë·ªô th·ª±c t·∫ø (cm)
      realX = pixelToCm(relativeX);
      realY = pixelToCm(relativeY);
    }
    
    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã t·ªça ƒë·ªô
    function updateCoordinateDisplay() {
      // C·∫≠p nh·∫≠t hi·ªÉn th·ªã t·ªça ƒë·ªô th·ª±c t·∫ø (cm)
      document.getElementById('current-x').textContent = realX.toFixed(1);
      document.getElementById('current-y').textContent = realY.toFixed(1);
      document.getElementById('current-angle').textContent = Math.round(angle);
      
      // C·∫≠p nh·∫≠t hi·ªÉn th·ªã trong b·∫£ng ƒëi·ªÅu khi·ªÉn
      document.getElementById('display-x').textContent = realX.toFixed(1);
      document.getElementById('display-y').textContent = realY.toFixed(1);
      document.getElementById('display-angle').textContent = Math.round(angle);
      document.getElementById('total-distance').textContent = totalDistance.toFixed(1);
    }
    
    // ƒêi·ªÅu ch·ªânh v·ªã tr√≠ n√∫t resize
    function positionResizeHandle() {
      const robotRect = robot.getBoundingClientRect();
      resizeHandle.style.left = (robotRect.right - 6) + 'px';
      resizeHandle.style.top = (robotRect.bottom - 6) + 'px';
    }
    
    // Th√™m ƒëi·ªÉm v√†o l·ªãch s·ª≠ di chuy·ªÉn
    function addMovementPoint(x, y) {
      movementHistory.push({x: x, y: y});
      
      // Gi·ªõi h·∫°n s·ªë ƒëi·ªÉm di chuy·ªÉn ƒë·ªÉ tr√°nh tr√†n b·ªô nh·ªõ
      if (movementHistory.length > 1000) {
        movementHistory = movementHistory.slice(movementHistory.length - 1000);
      }
      
      // C·∫≠p nh·∫≠t ƒë∆∞·ªùng ƒëi n·∫øu ƒëang hi·ªÉn th·ªã
      if (showingPath) {
        updatePathDisplay();
      }
    }
    
    // T√≠nh kho·∫£ng c√°ch gi·ªØa hai ƒëi·ªÉm (cm)
    function calculateDistance(x1, y1, x2, y2) {
      return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
    }
    
    // Toggle chi·ªÅu d·ªçc
    function toggleVerticalDirection() {
      invertedVertical = !invertedVertical;
      document.getElementById('toggle-vertical').classList.toggle('active', invertedVertical);
      saveToHistory();
      
      showNotification(invertedVertical ? 'ƒê√£ ƒë·∫£o chi·ªÅu tr√™n/d∆∞·ªõi' : 'ƒê√£ b·ªè ƒë·∫£o chi·ªÅu tr√™n/d∆∞·ªõi', 'info');
    }
    
    // Toggle chi·ªÅu ngang
    function toggleHorizontalDirection() {
      invertedHorizontal = !invertedHorizontal;
      document.getElementById('toggle-horizontal').classList.toggle('active', invertedHorizontal);
      saveToHistory();
      
      showNotification(invertedHorizontal ? 'ƒê√£ ƒë·∫£o chi·ªÅu tr√°i/ph·∫£i' : 'ƒê√£ b·ªè ƒë·∫£o chi·ªÅu tr√°i/ph·∫£i', 'info');
    }
    
    // Di chuy·ªÉn theo h∆∞·ªõng
    function moveRobotInDirection(dx, dy) {
      // √Åp d·ª•ng ƒë·∫£o chi·ªÅu n·∫øu c√≥
      if (invertedVertical) dy = -dy;
      if (invertedHorizontal) dx = -dx;
      
      // Chuy·ªÉn ƒë·ªïi cm sang pixel v·ªõi t·ª∑ l·ªá ph√π h·ª£p v√† k√≠ch th∆∞·ªõc b∆∞·ªõc
      const moveAmount = cmToPixel(stepSize);
      
      // L∆∞u v·ªã tr√≠ tr∆∞·ªõc khi di chuy·ªÉn
      const oldX = x;
      const oldY = y;
      const oldRealX = realX;
      const oldRealY = realY;
      
      // √Åp d·ª•ng di chuy·ªÉn
      x += dx * moveAmount;
      y += dy * moveAmount;
      
      // C·∫≠p nh·∫≠t t·ªça ƒë·ªô th·ª±c t·∫ø
      updateRealCoordinates();
      
      // T√≠nh qu√£ng ƒë∆∞·ªùng ƒë√£ di chuy·ªÉn
      const distanceMoved = calculateDistance(oldRealX, oldRealY, realX, realY);
      totalDistance += distanceMoved;
      
      // Th√™m ƒëi·ªÉm v√†o l·ªãch s·ª≠ di chuy·ªÉn
      addMovementPoint(x, y);
      
      updateRobot();
      saveToHistory();
    }
    
    // Di chuy·ªÉn ƒë·∫øn t·ªça ƒë·ªô c·ª• th·ªÉ
    function moveToCoordinates(targetX, targetY) {
      // N·∫øu kh√¥ng truy·ªÅn tham s·ªë, l·∫•y gi√° tr·ªã t·ª´ input
      if (targetX === undefined || targetY === undefined) {
        targetX = parseFloat(document.getElementById('target-x').value);
        targetY = parseFloat(document.getElementById('target-y').value);
      }
      
      // Ki·ªÉm tra gi√° tr·ªã h·ª£p l·ªá
      if (isNaN(targetX) || isNaN(targetY)) {
        showNotification('Vui l√≤ng nh·∫≠p t·ªça ƒë·ªô h·ª£p l·ªá', 'error');
        return;
      }
      
      // L∆∞u v·ªã tr√≠ tr∆∞·ªõc khi di chuy·ªÉn
      const oldX = x;
      const oldY = y;
      const oldRealX = realX;
      const oldRealY = realY;
      
      // T√≠nh to√°n v·ªã tr√≠ pixel d·ª±a tr√™n t·ªça ƒë·ªô cm
      const mapRect = mapImg.getBoundingClientRect();
      const targetPixelX = cmToPixel(targetX) + mapRect.left;
      const targetPixelY = cmToPixel(targetY) + mapRect.top;
      
      // T·∫°o animation di chuy·ªÉn
      const startX = x;
      const startY = y;
      const deltaX = targetPixelX - startX;
      const deltaY = targetPixelY - startY;
      const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
      
      // T·ªëc ƒë·ªô di chuy·ªÉn d·ª±a tr√™n kho·∫£ng c√°ch
      const duration = Math.min(Math.max(distance / 2, 300), 1000); // T·ª´ 300ms ƒë·∫øn 1000ms
      const startTime = performance.now();
      
      function animateMove(currentTime) {
        const elapsedTime = currentTime - startTime;
        const progress = Math.min(elapsedTime / duration, 1);
        
        // H√†m easing ƒë·ªÉ cho chuy·ªÉn ƒë·ªông t·ª± nhi√™n h∆°n
        const easeProgress = 1 - Math.pow(1 - progress, 3); // Cubic easing out
        
        x = startX + deltaX * easeProgress;
        y = startY + deltaY * easeProgress;
        
        updateRealCoordinates();
        updateRobot();
        
        if (progress < 1) {
          requestAnimationFrame(animateMove);
        } else {
          // ƒê√£ di chuy·ªÉn xong
          // T√≠nh qu√£ng ƒë∆∞·ªùng ƒë√£ di chuy·ªÉn
          const distanceMoved = calculateDistance(oldRealX, oldRealY, realX, realY);
          totalDistance += distanceMoved;
          
          // Th√™m ƒëi·ªÉm v√†o l·ªãch s·ª≠ di chuy·ªÉn
          addMovementPoint(x, y);
          
          showNotification(`ƒê√£ di chuy·ªÉn ƒë·∫øn (${targetX.toFixed(1)}, ${targetY.toFixed(1)})`, 'success');
          saveToHistory();
        }
      }
      
      requestAnimationFrame(animateMove);
    }
    
    // Quay robot
    function rotate(degrees) {
      angle += degrees;
      updateRobot();
      saveToHistory();
    }
    
    // Xoay tr√≤n robot
    function spinRobot() {
      // Xoay tr√≤n 2 v√≤ng r·ªìi tr·ªü v·ªÅ g√≥c ban ƒë·∫ßu
      const startAngle = angle;
      let currentRotation = 0;
      
      function animateRotation() {
        currentRotation += 5;
        if (currentRotation <= 720) {
          angle = startAngle + currentRotation;
          updateRobot();
          requestAnimationFrame(animateRotation);
        } else {
          angle = startAngle;
          updateRobot();
          saveToHistory();
        }
      }
      
      requestAnimationFrame(animateRotation);
    }
    
    // ·∫®n/hi·ªán robot
    function toggleRobot() {
      const isVisible = document.getElementById("toggle-robot").checked;
      robot.style.display = isVisible ? 'block' : 'none';
      resizeHandle.style.display = isVisible ? 'block' : 'none';
    }
    
    // Hi·ªÉn th·ªã h·ªôp tho·∫°i l∆∞u
    function showSaveDialog(type) {
      savingType = type;
      
      if (type === 'position') {
        document.getElementById('save-dialog-title').textContent = 'L∆∞u v·ªã tr√≠ hi·ªán t·∫°i';
        document.getElementById('save-name').placeholder = 'Nh·∫≠p t√™n v·ªã tr√≠';
      } else if (type === 'size') {
        document.getElementById('save-dialog-title').textContent = 'L∆∞u k√≠ch th∆∞·ªõc robot';
        document.getElementById('save-name').placeholder = 'Nh·∫≠p t√™n k√≠ch th∆∞·ªõc';
      } else if (type === 'program') {
        document.getElementById('save-dialog-title').textContent = 'L∆∞u ch∆∞∆°ng tr√¨nh';
        document.getElementById('save-name').placeholder = 'Nh·∫≠p t√™n ch∆∞∆°ng tr√¨nh';
        
        // Ki·ªÉm tra xem c√≥ ch∆∞∆°ng tr√¨nh n√†o kh√¥ng
        const blocks = document.querySelectorAll('#program-area .command-block');
        if (blocks.length === 0) {
          showNotification('Kh√¥ng c√≥ l·ªánh n√†o trong ch∆∞∆°ng tr√¨nh ƒë·ªÉ l∆∞u!', 'error');
          return;
        }
      }
      
      document.getElementById('save-name').value = '';
      saveDialogOverlay.classList.add('active');
      document.getElementById('save-name').focus();
    }
    
    // ·∫®n h·ªôp tho·∫°i l∆∞u
    function hideSaveDialog() {
      saveDialogOverlay.classList.remove('active');
    }
    
    // Hi·ªÉn th·ªã h·ªôp tho·∫°i xu·∫•t/nh·∫≠p d·ªØ li·ªáu
    function showExportDialog() {
      // T·∫°o ƒë·ªëi t∆∞·ª£ng d·ªØ li·ªáu ƒë·ªÉ xu·∫•t
      const exportData = {
        positions: savedPositions,
        sizes: savedSizes,
        programs: savedPrograms,
        waypoints: waypoints
      };
      
      document.getElementById('import-export-data').value = JSON.stringify(exportData, null, 2);
      importExportOverlay.classList.add('active');
    }
    
    // ·∫®n h·ªôp tho·∫°i xu·∫•t/nh·∫≠p d·ªØ li·ªáu
    function hideImportExportDialog() {
      importExportOverlay.classList.remove('active');
    }
    
    // Sao ch√©p d·ªØ li·ªáu xu·∫•t v√†o clipboard
    function copyExportData() {
      const textarea = document.getElementById('import-export-data');
      textarea.select();
      document.execCommand('copy');
      showNotification('ƒê√£ sao ch√©p d·ªØ li·ªáu v√†o clipboard', 'success');
    }
    
    // Nh·∫≠p d·ªØ li·ªáu
    function importData() {
      const jsonText = document.getElementById('import-export-data').value.trim();
      
      if (!jsonText) {
        showNotification('Vui l√≤ng nh·∫≠p d·ªØ li·ªáu c·∫ßn nh·∫≠p', 'error');
        return;
      }
      
      try {
        const importedData = JSON.parse(jsonText);
        
        // Ki·ªÉm tra d·ªØ li·ªáu h·ª£p l·ªá
        if (importedData.positions) savedPositions = importedData.positions;
        if (importedData.sizes) savedSizes = importedData.sizes;
        if (importedData.programs) savedPrograms = importedData.programs;
        
        // C·∫≠p nh·∫≠t localStorage
        localStorage.setItem('robotPositions', JSON.stringify(savedPositions));
        localStorage.setItem('robotSizes', JSON.stringify(savedSizes));
        localStorage.setItem('robotPrograms', JSON.stringify(savedPrograms));
        
        // T·∫£i l·∫°i c√°c danh s√°ch
        updateSavedPositionsList();
        updateSavedSizesList();
        updateSavedProgramsList();
        
        // N·∫øu c√≥ waypoints, t·∫£i l·∫°i
        if (importedData.waypoints) {
          // X√≥a c√°c waypoint c≈©
          waypointsContainer.innerHTML = '';
          waypoints = importedData.waypoints;
          
          // T√¨m ID l·ªõn nh·∫•t ƒë·ªÉ c·∫≠p nh·∫≠t nextWaypointId
          nextWaypointId = 1;
          waypoints.forEach(wp => {
            if (wp.id >= nextWaypointId) nextWaypointId = wp.id + 1;
            renderWaypoint(wp);
          });
        }
        
        hideImportExportDialog();
        showNotification('ƒê√£ nh·∫≠p d·ªØ li·ªáu th√†nh c√¥ng', 'success');
      } catch (e) {
        showNotification('L·ªói khi ph√¢n t√≠ch d·ªØ li·ªáu: ' + e.message, 'error');
      }
    }
    
    // L∆∞u v·ªã tr√≠, k√≠ch th∆∞·ªõc ho·∫∑c ch∆∞∆°ng tr√¨nh
    function saveItem() {
      const name = document.getElementById('save-name').value.trim();
      
      if (!name) {
        showNotification('Vui l√≤ng nh·∫≠p t√™n!', 'error');
        return;
      }
      
      if (savingType === 'position') {
        // L∆∞u v·ªã tr√≠ hi·ªán t·∫°i
        const position = {
          name: name,
          x: x,
          y: y,
          realX: realX,
          realY: realY,
          angle: angle,
          invertedVertical: invertedVertical,
          invertedHorizontal: invertedHorizontal,
          stepSize: stepSize
        };
        
        savedPositions.push(position);
        localStorage.setItem('robotPositions', JSON.stringify(savedPositions));
        updateSavedPositionsList();
        showNotification(`ƒê√£ l∆∞u v·ªã tr√≠ "${name}"`, 'success');
      } else if (savingType === 'size') {
        // L∆∞u k√≠ch th∆∞·ªõc hi·ªán t·∫°i
        const size = {
          name: name,
          size: robotSize,
          realSize: robotRealSize
        };
        
        savedSizes.push(size);
        localStorage.setItem('robotSizes', JSON.stringify(savedSizes));
        updateSavedSizesList();
        showNotification(`ƒê√£ l∆∞u k√≠ch th∆∞·ªõc "${name}"`, 'success');
      } else if (savingType === 'program') {
        // L∆∞u ch∆∞∆°ng tr√¨nh hi·ªán t·∫°i
        const blocks = Array.from(document.querySelectorAll('#program-area .command-block')).map(block => {
          return {
            command: block.dataset.command,
            value: parseFloat(block.querySelector('input').value) || 1,
            disabled: block.classList.contains('disabled')
          };
        });
        
        const program = {
          name: name,
          blocks: blocks
        };
        
        savedPrograms.push(program);
        localStorage.setItem('robotPrograms', JSON.stringify(savedPrograms));
        updateSavedProgramsList();
        showNotification(`ƒê√£ l∆∞u ch∆∞∆°ng tr√¨nh "${name}"`, 'success');
      }
      
      hideSaveDialog();
    }
    // C·∫≠p nh·∫≠t danh s√°ch v·ªã tr√≠ ƒë√£ l∆∞u
    function updateSavedPositionsList() {
      const container = document.getElementById('saved-positions');
      container.innerHTML = '';
      
      if (savedPositions.length === 0) {
        container.innerHTML = '<div class="saved-item">Ch∆∞a c√≥ v·ªã tr√≠ n√†o ƒë∆∞·ª£c l∆∞u</div>';
        return;
      }
      
      savedPositions.forEach((position, index) => {
        const item = document.createElement('div');
        item.className = 'saved-item';
        
        const nameSpan = document.createElement('span');
        nameSpan.textContent = position.name;
        nameSpan.title = `X: ${position.realX.toFixed(1)}cm, Y: ${position.realY.toFixed(1)}cm, G√≥c: ${Math.round(position.angle)}¬∞`;
        nameSpan.style.cursor = 'pointer';
        nameSpan.onclick = () => loadPosition(index);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = '‚úï';
        deleteBtn.title = 'X√≥a';
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          deletePosition(index);
        };
        
        item.appendChild(nameSpan);
        item.appendChild(deleteBtn);
        container.appendChild(item);
      });
    }
    
    // C·∫≠p nh·∫≠t danh s√°ch k√≠ch th∆∞·ªõc ƒë√£ l∆∞u
    function updateSavedSizesList() {
      const container = document.getElementById('saved-sizes');
      container.innerHTML = '';
      
      if (savedSizes.length === 0) {
        container.innerHTML = '<div class="saved-item">Ch∆∞a c√≥ k√≠ch th∆∞·ªõc n√†o ƒë∆∞·ª£c l∆∞u</div>';
        return;
      }
      
      savedSizes.forEach((sizeItem, index) => {
        const item = document.createElement('div');
        item.className = 'saved-item';
        
        const nameSpan = document.createElement('span');
        nameSpan.textContent = sizeItem.name;
        nameSpan.title = `K√≠ch th∆∞·ªõc: ${sizeItem.size}px (${sizeItem.realSize ? sizeItem.realSize.toFixed(1) : ''}cm)`;
        nameSpan.style.cursor = 'pointer';
        nameSpan.onclick = () => loadSize(index);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = '‚úï';
        deleteBtn.title = 'X√≥a';
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          deleteSize(index);
        };
        
        item.appendChild(nameSpan);
        item.appendChild(deleteBtn);
        container.appendChild(item);
      });
    }
    
    // C·∫≠p nh·∫≠t danh s√°ch ch∆∞∆°ng tr√¨nh ƒë√£ l∆∞u
    function updateSavedProgramsList() {
      const container = document.getElementById('saved-programs');
      container.innerHTML = '';
      
      if (savedPrograms.length === 0) {
        container.innerHTML = '<div class="saved-item">Ch∆∞a c√≥ ch∆∞∆°ng tr√¨nh n√†o ƒë∆∞·ª£c l∆∞u</div>';
        return;
      }
      
      savedPrograms.forEach((program, index) => {
        const item = document.createElement('div');
        item.className = 'saved-item';
        
        const nameSpan = document.createElement('span');
        nameSpan.textContent = program.name;
        nameSpan.title = `${program.blocks.length} l·ªánh`;
        nameSpan.style.cursor = 'pointer';
        nameSpan.onclick = () => loadProgram(index);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = '‚úï';
        deleteBtn.title = 'X√≥a';
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          deleteProgram(index);
        };
        
        item.appendChild(nameSpan);
        item.appendChild(deleteBtn);
        container.appendChild(item);
      });
    }
    
    // X√≥a t·∫•t c·∫£ c√°c m·ª•c ƒë√£ l∆∞u theo lo·∫°i
    function clearSavedItems(type) {
      if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ ${type === 'position' ? 'v·ªã tr√≠' : type === 'size' ? 'k√≠ch th∆∞·ªõc' : 'ch∆∞∆°ng tr√¨nh'} ƒë√£ l∆∞u?`)) {
        return;
      }
      
      if (type === 'position') {
        savedPositions = [];
        localStorage.setItem('robotPositions', JSON.stringify(savedPositions));
        updateSavedPositionsList();
      } else if (type === 'size') {
        savedSizes = [];
        localStorage.setItem('robotSizes', JSON.stringify(savedSizes));
        updateSavedSizesList();
      } else if (type === 'program') {
        savedPrograms = [];
        localStorage.setItem('robotPrograms', JSON.stringify(savedPrograms));
        updateSavedProgramsList();
      }
      
      showNotification(`ƒê√£ x√≥a t·∫•t c·∫£ ${type === 'position' ? 'v·ªã tr√≠' : type === 'size' ? 'k√≠ch th∆∞·ªõc' : 'ch∆∞∆°ng tr√¨nh'} ƒë√£ l∆∞u`, 'info');
    }
    
    // T·∫£i v·ªã tr√≠ ƒë√£ l∆∞u
    function loadPosition(index) {
      const position = savedPositions[index];
      x = position.x;
      y = position.y;
      realX = position.realX || 0;
      realY = position.realY || 0;
      angle = position.angle;
      invertedVertical = position.invertedVertical || false;
      invertedHorizontal = position.invertedHorizontal || false;
      stepSize = position.stepSize || 1.0;
      
      document.getElementById('toggle-vertical').classList.toggle('active', invertedVertical);
      document.getElementById('toggle-horizontal').classList.toggle('active', invertedHorizontal);
      document.getElementById('step-size').value = stepSize;
      
      updateRobot();
      addMovementPoint(x, y);
      saveToHistory();
      
      showNotification(`ƒê√£ t·∫£i v·ªã tr√≠ "${position.name}"`, 'success');
    }
    
    // T·∫£i k√≠ch th∆∞·ªõc ƒë√£ l∆∞u
    function loadSize(index) {
      const sizeItem = savedSizes[index];
      robotSize = sizeItem.size;
      robotRealSize = sizeItem.realSize || pixelToCm(robotSize);
      
      robot.style.width = `${robotSize}px`;
      document.getElementById('robot-size').value = robotSize;
      document.getElementById('size-display').textContent = `${Math.round(robotSize)}px`;
      
      updateRobot();
      saveToHistory();
      
      showNotification(`ƒê√£ t·∫£i k√≠ch th∆∞·ªõc "${sizeItem.name}"`, 'success');
    }
    
    // T·∫£i ch∆∞∆°ng tr√¨nh ƒë√£ l∆∞u
    function loadProgram(index) {
      const program = savedPrograms[index];
      
      // X√≥a t·∫•t c·∫£ c√°c l·ªánh hi·ªán t·∫°i
      const blocks = document.querySelectorAll('#program-area .command-block');
      blocks.forEach(block => block.remove());
      
      // Th√™m c√°c l·ªánh t·ª´ ch∆∞∆°ng tr√¨nh ƒë√£ l∆∞u
      program.blocks.forEach(block => {
        const originalBlock = document.querySelector(`.block-library .command-block[data-command="${block.command}"]`);
        if (originalBlock) {
          // T·∫°o m·ªôt b·∫£n sao c·ªßa kh·ªëi l·ªánh
          const newBlock = originalBlock.cloneNode(true);
          newBlock.draggable = true;
          
          // Thi·∫øt l·∫≠p gi√° tr·ªã ƒë·∫ßu v√†o
          newBlock.querySelector('input').value = block.value;
          
          // Thi·∫øt l·∫≠p tr·∫°ng th√°i v√¥ hi·ªáu h√≥a n·∫øu c√≥
          if (block.disabled) {
            newBlock.classList.add('disabled');
          }
          
          // Th√™m c√°c n√∫t ƒëi·ªÅu khi·ªÉn kh·ªëi
          addBlockControls(newBlock);
          
          // Thi·∫øt l·∫≠p c√°c s·ª± ki·ªán k√©o th·∫£
          setupDragEvents(newBlock);
          
          // Th√™m v√†o khu v·ª±c ch∆∞∆°ng tr√¨nh
          programArea.appendChild(newBlock);
        }
      });
      
      showNotification(`ƒê√£ t·∫£i ch∆∞∆°ng tr√¨nh "${program.name}"`, 'success');
    }
    
    // X√≥a v·ªã tr√≠ ƒë√£ l∆∞u
    function deletePosition(index) {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a v·ªã tr√≠ n√†y?')) {
        const deletedName = savedPositions[index].name;
        savedPositions.splice(index, 1);
        localStorage.setItem('robotPositions', JSON.stringify(savedPositions));
        updateSavedPositionsList();
        showNotification(`ƒê√£ x√≥a v·ªã tr√≠ "${deletedName}"`, 'info');
      }
    }
    
    // X√≥a k√≠ch th∆∞·ªõc ƒë√£ l∆∞u
    function deleteSize(index) {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a k√≠ch th∆∞·ªõc n√†y?')) {
        const deletedName = savedSizes[index].name;
        savedSizes.splice(index, 1);
        localStorage.setItem('robotSizes', JSON.stringify(savedSizes));
        updateSavedSizesList();
        showNotification(`ƒê√£ x√≥a k√≠ch th∆∞·ªõc "${deletedName}"`, 'info');
      }
    }
    
    // X√≥a ch∆∞∆°ng tr√¨nh ƒë√£ l∆∞u
    function deleteProgram(index) {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ch∆∞∆°ng tr√¨nh n√†y?')) {
        const deletedName = savedPrograms[index].name;
        savedPrograms.splice(index, 1);
        localStorage.setItem('robotPrograms', JSON.stringify(savedPrograms));
        updateSavedProgramsList();
        showNotification(`ƒê√£ x√≥a ch∆∞∆°ng tr√¨nh "${deletedName}"`, 'info');
      }
    }
    
    // Thi·∫øt l·∫≠p s·ª± ki·ªán k√©o th·∫£
    function setupDragDrop() {
      // Thi·∫øt l·∫≠p s·ª± ki·ªán k√©o th·∫£ cho c√°c kh·ªëi trong th∆∞ vi·ªán
      document.querySelectorAll('#block-library .command-block').forEach(block => {
        setupDragEvents(block);
      });
      
      // Thi·∫øt l·∫≠p s·ª± ki·ªán k√©o th·∫£ cho v√πng ch∆∞∆°ng tr√¨nh
      programArea.addEventListener('dragover', handleProgramAreaDragOver);
      programArea.addEventListener('drop', handleProgramAreaDrop);
    }
    
    // X·ª≠ l√Ω dragover tr√™n program area
    function handleProgramAreaDragOver(e) {
      e.preventDefault();
      
      if (!isDragging) return;
      
      // X√°c ƒë·ªãnh v·ªã tr√≠ dropPosition
      const mouseY = e.clientY;
      const blocks = Array.from(programArea.querySelectorAll('.command-block:not(.dragging)'));
      
      // T√¨m v·ªã tr√≠ ƒë·ªÉ ch√®n ch·ªâ b√°o k√©o
      let dropPosition = null;
      
      if (blocks.length === 0) {
        // Kh√¥ng c√≥ kh·ªëi, ƒë·∫∑t v√†o ƒë·∫ßu
        dropPosition = { element: null, before: true };
      } else {
        for (let i = 0; i < blocks.length; i++) {
          const block = blocks[i];
          const rect = block.getBoundingClientRect();
          const blockMiddle = rect.top + rect.height / 2;
          
          if (mouseY < blockMiddle) {
            // Chu·ªôt ·ªü tr√™n n·ª≠a tr√™n c·ªßa kh·ªëi, ch√®n tr∆∞·ªõc
            dropPosition = { element: block, before: true };
            break;
          } else if (i === blocks.length - 1) {
            // ƒê√£ ƒë·∫øn kh·ªëi cu·ªëi c√πng v√† chu·ªôt ·ªü d∆∞·ªõi, ch√®n sau
            dropPosition = { element: block, before: false };
            break;
          }
        }
      }
      
      // Hi·ªÉn th·ªã ch·ªâ b√°o k√©o ·ªü v·ªã tr√≠ th√≠ch h·ª£p
      if (dropPosition) {
        dragIndicator.classList.add('active');
        
        if (dropPosition.element === null) {
          // Kh√¥ng c√≥ kh·ªëi, th√™m ch·ªâ b√°o v√†o ƒë·∫ßu
          programArea.insertBefore(dragIndicator, programArea.firstChild);
        } else if (dropPosition.before) {
          // Ch√®n tr∆∞·ªõc kh·ªëi
          programArea.insertBefore(dragIndicator, dropPosition.element);
        } else {
          // Ch√®n sau kh·ªëi
          const nextElement = dropPosition.element.nextElementSibling;
          if (nextElement) {
            programArea.insertBefore(dragIndicator, nextElement);
          } else {
            programArea.appendChild(dragIndicator);
          }
        }
      }
    }
    
    // X·ª≠ l√Ω khi th·∫£ v√†o program area
    function handleProgramAreaDrop(e) {
      e.preventDefault();
      
      if (!isDragging) return;
      
      // X√°c ƒë·ªãnh v·ªã tr√≠ th·∫£ d·ª±a tr√™n v·ªã tr√≠ ch·ªâ b√°o k√©o
      const dropBeforeElement = dragIndicator.nextElementSibling;
      
      // X·ª≠ l√Ω kh·ªëi ƒë∆∞·ª£c k√©o
      if (currentDragTarget) {
        if (dragSourceParent === blockLibrary) {
          // K√©o t·ª´ th∆∞ vi·ªán, t·∫°o b·∫£n sao m·ªõi
          const newBlock = currentDragTarget.cloneNode(true);
          
          // Th√™m c√°c n√∫t ƒëi·ªÅu khi·ªÉn
          addBlockControls(newBlock);
          
          // Thi·∫øt l·∫≠p c√°c s·ª± ki·ªán k√©o th·∫£
          setupDragEvents(newBlock);
          
          // Th√™m v√†o v·ªã tr√≠ th·∫£
          if (dropBeforeElement) {
            programArea.insertBefore(newBlock, dropBeforeElement);
          } else {
            programArea.appendChild(newBlock);
          }
          
          showNotification('ƒê√£ th√™m l·ªánh m·ªõi v√†o ch∆∞∆°ng tr√¨nh', 'info');
        } else if (dragSourceParent === programArea) {
          // Di chuy·ªÉn trong programArea
          if (dropBeforeElement) {
            programArea.insertBefore(currentDragTarget, dropBeforeElement);
          } else {
            programArea.appendChild(currentDragTarget);
          }
        }
      }
      
      // Reset tr·∫°ng th√°i k√©o th·∫£
      dragIndicator.classList.remove('active');
    }
    
    // Thi·∫øt l·∫≠p c√°c s·ª± ki·ªán k√©o th·∫£ cho m·ªôt kh·ªëi
    function setupDragEvents(block) {
      block.addEventListener('dragstart', handleDragStart);
      block.addEventListener('dragend', handleDragEnd);
    }
    
    // X·ª≠ l√Ω b·∫Øt ƒë·∫ßu k√©o
    function handleDragStart(e) {
      // ƒê·∫∑t d·ªØ li·ªáu ƒë∆∞·ª£c k√©o
      e.dataTransfer.setData('text/plain', this.dataset.command);
      e.dataTransfer.effectAllowed = 'move';
      
      // L∆∞u th√¥ng tin ngu·ªìn k√©o
      currentDragTarget = this;
      dragSourceParent = this.parentElement;
      
      // Th√™m class ƒë·ªÉ ch·ªâ th·ªã tr·∫°ng th√°i k√©o
      this.classList.add('dragging');
      
      // N·∫øu k√©o t·ª´ program area, l∆∞u v·ªã tr√≠ ban ƒë·∫ßu
      if (dragSourceParent === programArea) {
        const blocks = Array.from(programArea.querySelectorAll('.command-block'));
        dragStartIndex = blocks.indexOf(this);
      }
      
      // Tr√¨ ho√£n ƒë·ªÉ tr√°nh c√°c v·∫•n ƒë·ªÅ v·ªõi c√°c s·ª± ki·ªán chu·ªôt
      setTimeout(() => {
        isDragging = true;
      }, 0);
    }
    
    // X·ª≠ l√Ω k·∫øt th√∫c k√©o
    function handleDragEnd(e) {
      this.classList.remove('dragging');
      dragIndicator.classList.remove('active');
      isDragging = false;
      currentDragTarget = null;
      dragSourceParent = null;
      dragStartIndex = -1;
    }
    
    // Th√™m c√°c n√∫t ƒëi·ªÅu khi·ªÉn cho kh·ªëi
    function addBlockControls(block) {
      // X√≥a c√°c n√∫t ƒëi·ªÅu khi·ªÉn c≈© n·∫øu c√≥
      const oldControls = block.querySelector('.block-controls');
      if (oldControls) {
        block.removeChild(oldControls);
      }
      
      // T·∫°o div ch·ª©a c√°c n√∫t ƒëi·ªÅu khi·ªÉn
      const controlsDiv = document.createElement('div');
      controlsDiv.className = 'block-controls';
      
      // Th√™m n√∫t toggle kh·ªëi (t·∫Øt/b·∫≠t)
      const toggleBtn = document.createElement('button');
      toggleBtn.className = 'toggle-block';
      toggleBtn.innerHTML = '‚¶ª';
      toggleBtn.title = 'T·∫Øt/B·∫≠t kh·ªëi';
      toggleBtn.onclick = function(e) {
        e.stopPropagation();
        block.classList.toggle('disabled');
      };
      
      // Th√™m n√∫t x√≥a
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'delete-block';
      deleteBtn.innerHTML = '‚úï';
      deleteBtn.title = 'X√≥a kh·ªëi';
      deleteBtn.onclick = function(e) {
        e.stopPropagation();
        block.parentElement.removeChild(block);
      };
      
      // Th√™m c√°c n√∫t v√†o div ƒëi·ªÅu khi·ªÉn
      controlsDiv.appendChild(toggleBtn);
      controlsDiv.appendChild(deleteBtn);
      
      // Th√™m div ƒëi·ªÅu khi·ªÉn v√†o kh·ªëi
      block.appendChild(controlsDiv);
      
      // Th√™m s·ª± ki·ªán khi nh·∫•p v√†o kh·ªëi
      block.addEventListener('click', function(e) {
        // NgƒÉn s·ª± ki·ªán lan truy·ªÅn khi nh·∫•p v√†o input
        if (e.target.tagName === 'INPUT') {
          return;
        }
        
        if (this.classList.contains('selected-block')) {
          this.classList.remove('selected-block');
          document.removeEventListener('keydown', blockKeyHandler);
        } else {
          // B·ªè ch·ªçn t·∫•t c·∫£ c√°c kh·ªëi kh√°c
          document.querySelectorAll('.command-block.selected-block').forEach(b => {
            b.classList.remove('selected-block');
          });
          
          this.classList.add('selected-block');
          
          // Th√™m h√†m x·ª≠ l√Ω ph√≠m
          document.addEventListener('keydown', blockKeyHandler);
        }
      });
    }
    
    // H√†m x·ª≠ l√Ω ph√≠m khi kh·ªëi ƒë∆∞·ª£c ch·ªçn
    function blockKeyHandler(e) {
      const selectedBlock = document.querySelector('.command-block.selected-block');
      if (!selectedBlock || selectedBlock.parentElement !== programArea) return;
      
      if (e.key === 'ArrowUp') {
        e.preventDefault();
        const prev = selectedBlock.previousElementSibling;
        if (prev && prev.classList && prev.classList.contains('command-block')) {
          programArea.insertBefore(selectedBlock, prev);
        }
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        const next = selectedBlock.nextElementSibling;
        if (next) {
          if (next.nextElementSibling) {
            programArea.insertBefore(selectedBlock, next.nextElementSibling);
          } else {
            programArea.appendChild(selectedBlock);
          }
        }
      } else if (e.key === 'Escape') {
        selectedBlock.classList.remove('selected-block');
        document.removeEventListener('keydown', blockKeyHandler);
      } else if (e.key === 'Delete' || e.key === 'Backspace') {
        e.preventDefault();
        programArea.removeChild(selectedBlock);
        document.removeEventListener('keydown', blockKeyHandler);
      }
    }
    
    // Ch·ª©c nƒÉng ch·∫°y ch∆∞∆°ng tr√¨nh
    function runProgram() {
      if (isProgramRunning) {
        // N·∫øu ƒëang ch·∫°y, d·ª´ng ch∆∞∆°ng tr√¨nh
        stopProgram();
        return;
      }
      
      // Thu th·∫≠p t·∫•t c·∫£ c√°c l·ªánh t·ª´ program area (ch·ªâ l·∫•y c√°c kh·ªëi kh√¥ng b·ªã v√¥ hi·ªáu h√≥a)
      const commands = Array.from(programArea.querySelectorAll('.command-block:not(.disabled)')).map(block => {
        const command = block.dataset.command;
        const value = parseFloat(block.querySelector('input').value) || 1;
        return { command, value };
      });
      
      if (commands.length === 0) {
        showNotification('Kh√¥ng c√≥ l·ªánh n√†o ƒë·ªÉ ch·∫°y!', 'error');
        return;
      }
      
      // ƒê·∫∑t v√†o h√†ng ƒë·ª£i v√† th·ª±c thi
      programQueue = commands;
      isProgramRunning = true;
      
      // C·∫≠p nh·∫≠t giao di·ªán
      runProgramBtn.classList.add('running');
      runProgramBtn.innerHTML = '<i>‚èπ</i> D·ª´ng ch∆∞∆°ng tr√¨nh (Esc)';
      
      // L∆∞u v·ªã tr√≠ hi·ªán t·∫°i ƒë·ªÉ ph·ª•c h·ªìi n·∫øu c·∫ßn
      saveToHistory();
      
      showNotification('ƒêang ch·∫°y ch∆∞∆°ng tr√¨nh...', 'info');
      executeNextCommand();
    }
    
    // D·ª´ng ch∆∞∆°ng tr√¨nh ƒëang ch·∫°y
    function stopProgram() {
      isProgramRunning = false;
      programQueue = [];
      
      runProgramBtn.classList.remove('running');
      runProgramBtn.innerHTML = '<i>‚ñ∂Ô∏è</i> Ch·∫°y ch∆∞∆°ng tr√¨nh (Enter)';
      
      showNotification('ƒê√£ d·ª´ng ch∆∞∆°ng tr√¨nh', 'info');
    }
    
    // Th·ª±c thi l·ªánh ti·∫øp theo trong h√†ng ƒë·ª£i
    function executeNextCommand() {
      if (!isProgramRunning) return;
      
      if (programQueue.length === 0) {
        stopProgram();
        showNotification('Ch∆∞∆°ng tr√¨nh ƒë√£ ch·∫°y xong', 'success');
        return;
      }
      
      const command = programQueue.shift();
      const value = command.value;
      
      switch (command.command) {
        case 'up':
          // Di chuy·ªÉn l√™n v·ªõi kho·∫£ng c√°ch value (cm)
          animateMove(0, -value);
          break;
        case 'down':
          // Di chuy·ªÉn xu·ªëng v·ªõi kho·∫£ng c√°ch value (cm)
          animateMove(0, value);
          break;
        case 'left':
          // Di chuy·ªÉn tr√°i v·ªõi kho·∫£ng c√°ch value (cm)
          animateMove(-value, 0);
          break;
        case 'right':
          // Di chuy·ªÉn ph·∫£i v·ªõi kho·∫£ng c√°ch value (cm)
          animateMove(value, 0);
          break;
        case 'upleft':
          // Di chuy·ªÉn ch√©o tr√°i l√™n v·ªõi kho·∫£ng c√°ch value (cm)
          animateMove(-value, -value);
          break;
        case 'upright':
          // Di chuy·ªÉn ch√©o ph·∫£i l√™n v·ªõi kho·∫£ng c√°ch value (cm)
          animateMove(value, -value);
          break;
        case 'downleft':
          // Di chuy·ªÉn ch√©o tr√°i xu·ªëng v·ªõi kho·∫£ng c√°ch value (cm)
          animateMove(-value, value);
          break;
        case 'downright':
          // Di chuy·ªÉn ch√©o ph·∫£i xu·ªëng v·ªõi kho·∫£ng c√°ch value (cm)
          animateMove(value, value);
          break;
        case 'spin':
          // Xoay tr√≤n value v√≤ng
          animateSpin(value);
          return; // animateSpin s·∫Ω g·ªçi executeNextCommand khi ho√†n th√†nh
        case 'rotateleft':
          // Quay tr√°i value ƒë·ªô
          animateRotation(-value);
          return; // animateRotation s·∫Ω g·ªçi executeNextCommand khi ho√†n th√†nh
        case 'rotateright':
          // Quay ph·∫£i value ƒë·ªô
          animateRotation(value);
          return; // animateRotation s·∫Ω g·ªçi executeNextCommand khi ho√†n th√†nh
      }
    }
    
    // Animate di chuy·ªÉn
    function animateMove(dx, dy) {
      // √Åp d·ª•ng ƒë·∫£o chi·ªÅu n·∫øu c√≥
      if (invertedVertical) dy = -dy;
      if (invertedHorizontal) dx = -dx;
      
      // L∆∞u v·ªã tr√≠ ban ƒë·∫ßu
      const startX = x;
      const startY = y;
      const startRealX = realX;
      const startRealY = realY;
      
      // T√≠nh to√°n v·ªã tr√≠ ƒë√≠ch
      const targetRealX = startRealX + dx;
      const targetRealY = startRealY + dy;
      
      // Chuy·ªÉn ƒë·ªïi sang pixel
      const mapRect = mapImg.getBoundingClientRect();
      const targetX = cmToPixel(targetRealX - realX) + x;
      const targetY = cmToPixel(targetRealY - realY) + y;
      
      // T√≠nh to√°n kho·∫£ng c√°ch v√† th·ªùi gian
      const distance = Math.sqrt(Math.pow(dx, 2) + Math.pow(dy, 2));
      const duration = Math.min(Math.max(distance * 100, 300), 1000); // 300ms ƒë·∫øn 1000ms
      
      // B·∫Øt ƒë·∫ßu animation
      const startTime = performance.now();
      
      function animate(currentTime) {
        if (!isProgramRunning) return; // D·ª´ng n·∫øu ƒë√£ h·ªßy ch∆∞∆°ng tr√¨nh
        
        const elapsedTime = currentTime - startTime;
        const progress = Math.min(elapsedTime / duration, 1);
        
        // √Åp d·ª•ng easing
        const easedProgress = 1 - Math.pow(1 - progress, 3); // Cubic easing out
        
        // C·∫≠p nh·∫≠t v·ªã tr√≠
        x = startX + (targetX - startX) * easedProgress;
        y = startY + (targetY - startY) * easedProgress;
        
        // C·∫≠p nh·∫≠t t·ªça ƒë·ªô th·ª±c
        updateRealCoordinates();
        
        // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
        updateRobot();
        
        if (progress >= 1) {
          // Ho√†n th√†nh di chuy·ªÉn
          // C·∫≠p nh·∫≠t t·ªïng qu√£ng ƒë∆∞·ªùng
          totalDistance += distance;
          
          // Th√™m ƒëi·ªÉm v√†o l·ªãch s·ª≠ di chuy·ªÉn
          addMovementPoint(x, y);
          
          // Ch·∫°y l·ªánh ti·∫øp theo
          setTimeout(executeNextCommand, 100);
        } else {
          requestAnimationFrame(animate);
        }
      }
      
      requestAnimationFrame(animate);
    }
    
    // Animate xoay tr√≤n
    function animateSpin(rounds) {
      const startAngle = angle;
      const totalRotation = rounds * 360;
      const duration = Math.min(Math.max(rounds * 1000, 500), 5000); // 500ms ƒë·∫øn 5000ms
      
      const startTime = performance.now();
      
      function animate(currentTime) {
        if (!isProgramRunning) return; // D·ª´ng n·∫øu ƒë√£ h·ªßy ch∆∞∆°ng tr√¨nh
        
        const elapsedTime = currentTime - startTime;
        const progress = Math.min(elapsedTime / duration, 1);
        
        // Xoay ƒë·ªÅu theo ti·∫øn ƒë·ªô
        angle = startAngle + totalRotation * progress;
        
        // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
        updateRobot();
        
        if (progress >= 1) {
          // Ho√†n th√†nh xoay
          angle = startAngle + Math.round(rounds) * 360; // ƒê·∫£m b·∫£o g√≥c ch√≠nh x√°c
          updateRobot();
          setTimeout(executeNextCommand, 100);
        } else {
          requestAnimationFrame(animate);
        }
      }
      
      requestAnimationFrame(animate);
    }
    
    // Animate quay g√≥c
    function animateRotation(degrees) {
      const startAngle = angle;
      const targetAngle = startAngle + degrees;
      const duration = Math.min(Math.max(Math.abs(degrees) * 5, 300), 1000); // 300ms ƒë·∫øn 1000ms
      
      const startTime = performance.now();
      
      function animate(currentTime) {
        if (!isProgramRunning) return; // D·ª´ng n·∫øu ƒë√£ h·ªßy ch∆∞∆°ng tr√¨nh
        
        const elapsedTime = currentTime - startTime;
        const progress = Math.min(elapsedTime / duration, 1);
        
        // √Åp d·ª•ng easing
        const easedProgress = 1 - Math.pow(1 - progress, 3); // Cubic easing out
        
        // C·∫≠p nh·∫≠t g√≥c
        angle = startAngle + (degrees * easedProgress);
        
        // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
        updateRobot();
        
        if (progress >= 1) {
          // Ho√†n th√†nh quay
          angle = targetAngle; // ƒê·∫£m b·∫£o g√≥c ch√≠nh x√°c
          updateRobot();
          setTimeout(executeNextCommand, 100);
        } else {
          requestAnimationFrame(animate);
        }
      }
      
      requestAnimationFrame(animate);
    }
    
    // Hi·ªÉn th·ªã tooltip
    function showTooltip(text, e) {
      tooltip.textContent = text;
      tooltip.style.left = `${e.clientX + 10}px`;
      tooltip.style.top = `${e.clientY + 10}px`;
      tooltip.style.opacity = '1';
    }
    
    // ·∫®n tooltip
    function hideTooltip() {
      tooltip.style.opacity = '0';
    }
    
    // Thi·∫øt l·∫≠p tooltips cho c√°c ƒëi·ªÅu khi·ªÉn
    function setupTooltips() {
      const elements = [
        { selector: '#undo-button-1', text: 'Ho√†n t√°c thao t√°c cu·ªëi (Ctrl+Z)' },
        { selector: '#redo-button-1', text: 'L√†m l·∫°i thao t√°c ƒë√£ ho√†n t√°c (Ctrl+Y)' },
        { selector: '#undo-button-2', text: 'Ho√†n t√°c thao t√°c cu·ªëi (Ctrl+Z)' },
        { selector: '#redo-button-2', text: 'L√†m l·∫°i thao t√°c ƒë√£ ho√†n t√°c (Ctrl+Y)' },
        { selector: '.move-to-coords-btn', text: 'Di chuy·ªÉn robot ƒë·∫øn t·ªça ƒë·ªô ƒë√£ nh·∫≠p' },
        { selector: '#toggle-grid-btn', text: 'B·∫≠t/t·∫Øt hi·ªÉn th·ªã l∆∞·ªõi t·ªça ƒë·ªô' },
        { selector: '#add-waypoint-btn', text: 'B·∫≠t/t·∫Øt ch·∫ø ƒë·ªô ƒë√°nh d·∫•u ƒëi·ªÉm tr√™n b·∫£n ƒë·ªì' },
        { selector: '#run-program-btn', text: 'Ch·∫°y/d·ª´ng ch∆∞∆°ng tr√¨nh ƒë√£ l·∫≠p' },
        { selector: '.save-position', text: 'L∆∞u v·ªã tr√≠ hi·ªán t·∫°i c·ªßa robot' },
        { selector: '.save-size', text: 'L∆∞u k√≠ch th∆∞·ªõc hi·ªán t·∫°i c·ªßa robot' },
        { selector: '.save-program', text: 'L∆∞u c√°c l·ªánh trong v√πng ch∆∞∆°ng tr√¨nh' },
        { selector: '.export-data', text: 'Xu·∫•t/nh·∫≠p d·ªØ li·ªáu ƒë√£ l∆∞u' },
        { selector: '#clear-positions', text: 'X√≥a t·∫•t c·∫£ v·ªã tr√≠ ƒë√£ l∆∞u' },
        { selector: '#clear-sizes', text: 'X√≥a t·∫•t c·∫£ k√≠ch th∆∞·ªõc ƒë√£ l∆∞u' },
        { selector: '#clear-programs', text: 'X√≥a t·∫•t c·∫£ ch∆∞∆°ng tr√¨nh ƒë√£ l∆∞u' },
      ];
      
      elements.forEach(item => {
        const element = document.querySelector(item.selector);
        if (element) {
          element.addEventListener('mouseenter', (e) => {
            showTooltip(item.text, e);
          });
          
          element.addEventListener('mouseleave', () => {
            hideTooltip();
          });
        }
      });
    }
    
    // Hi·ªÉn th·ªã th√¥ng b√°o
    function showNotification(message, type = 'info') {
      notification.textContent = message;
      notification.className = 'notification';
      
      if (type === 'success') {
        notification.classList.add('success');
      } else if (type === 'error') {
        notification.classList.add('error');
      }
      
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
    
    // Toggle ch·∫ø ƒë·ªô t·ªëi/s√°ng
    function toggleTheme() {
      isDarkMode = !isDarkMode;
      document.body.classList.toggle('dark-mode', isDarkMode);
      document.getElementById('theme-text').textContent = isDarkMode ? 'Ch·∫ø ƒë·ªô s√°ng' : 'Ch·∫ø ƒë·ªô t·ªëi';
      
      // L∆∞u setting
      localStorage.setItem('robotTheme', isDarkMode ? 'dark' : 'light');
      
      // C·∫≠p nh·∫≠t ƒë∆∞·ªùng ƒëi n·∫øu ƒëang hi·ªÉn th·ªã
      if (showingPath) {
        updatePathDisplay();
      }
    }
    
    // X·ª≠ l√Ω k√©o th·∫£ resize robot
    resizeHandle.addEventListener('mousedown', function(e) {
      isResizing = true;
      e.preventDefault();
    });
    
    document.addEventListener('mousemove', function(e) {
      if (!isResizing) return;
      
      const robotRect = robot.getBoundingClientRect();
      
      // T√≠nh to√°n k√≠ch th∆∞·ªõc m·ªõi d·ª±a tr√™n v·ªã tr√≠ chu·ªôt
      const newWidth = e.clientX - robotRect.left;
      const newHeight = e.clientY - robotRect.top;
      
      // Gi·ªØ t·ª∑ l·ªá khung h√¨nh 1:1
      const newSize = Math.max(Math.min(newWidth, newHeight, 150), 20);
      
      // C·∫≠p nh·∫≠t k√≠ch th∆∞·ªõc robot
      robotSize = newSize;
      robot.style.width = `${robotSize}px`;
      
      // C·∫≠p nh·∫≠t gi√° tr·ªã thanh tr∆∞·ª£t
      document.getElementById('robot-size').value = robotSize;
      document.getElementById('size-display').textContent = `${Math.round(robotSize)}px`;
      
      // C·∫≠p nh·∫≠t k√≠ch th∆∞·ªõc th·ª±c t·∫ø
      robotRealSize = pixelToCm(robotSize);
      
      // C·∫≠p nh·∫≠t v·ªã tr√≠ n√∫t resize
      positionResizeHandle();
      
      // C·∫≠p nh·∫≠t v·ªã tr√≠ robot
      updateRobot();
    });
    
    document.addEventListener('mouseup', function() {
      if (isResizing) {
        isResizing = false;
        saveToHistory();
      }
    });
    
    // X·ª≠ l√Ω k√©o th·∫£ ƒë·ªÉ ƒëi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc sidebar
    sidebarResizer.addEventListener('mousedown', function(e) {
      isResizingSidebar = true;
      lastX = e.clientX;
      e.preventDefault();
    });
    
    document.addEventListener('mousemove', function(e) {
      if (!isResizingSidebar) return;
      
      const dx = e.clientX - lastX;
      lastX = e.clientX;
      
      let newWidth = sidebar.offsetWidth + dx;
      if (newWidth < 250) newWidth = 250;
      if (newWidth > 500) newWidth = 500;
      
      sidebar.style.width = `${newWidth}px`;
      sidebarResizer.style.left = `${newWidth}px`;
    });
    
    document.addEventListener('mouseup', function() {
      isResizingSidebar = false;
    });
    
    // X·ª≠ l√Ω ph√≠m
    document.addEventListener("keydown", (e) => {
      // N·∫øu ƒëang focus v√†o input ho·∫∑c textarea, kh√¥ng x·ª≠ l√Ω ph√≠m
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
        return;
      }
      
      // Ph√≠m Escape ƒë·ªÉ d·ª´ng ch∆∞∆°ng tr√¨nh ƒëang ch·∫°y
      if (e.key === 'Escape' && isProgramRunning) {
        stopProgram();
        return;
      }
      
      // N·∫øu ƒëang ch·∫°y ch∆∞∆°ng tr√¨nh, kh√¥ng x·ª≠ l√Ω c√°c ph√≠m kh√°c
      if (isProgramRunning) return;
      
      // N·∫øu c√≥ kh·ªëi ƒë∆∞·ª£c ch·ªçn, ∆∞u ti√™n x·ª≠ l√Ω kh·ªëi
      if (document.querySelector('.command-block.selected-block')) {
        blockKeyHandler(e);
        return;
      }
      
      // Ph√≠m Enter ƒë·ªÉ ch·∫°y ch∆∞∆°ng tr√¨nh
      if (e.key === 'Enter') {
        runProgram();
        return;
      }
      
      // Undo/Redo
      if (e.ctrlKey && e.key.toLowerCase() === 'z') {
        e.preventDefault();
        undoAction();
        return;
      }
      if (e.ctrlKey && e.key.toLowerCase() === 'y') {
        e.preventDefault();
        redoAction();
        return;
      }
      
      // Ph√≠m di chuy·ªÉn v√† quay
      switch (e.key.toLowerCase()) {
        case 'w': moveRobotInDirection(0, -1); break;
        case 's': moveRobotInDirection(0, 1); break;
        case 'a': moveRobotInDirection(-1, 0); break;
        case 'd': moveRobotInDirection(1, 0); break;
        case 'u': moveRobotInDirection(-1, -1); break;
        case 'i': moveRobotInDirection(1, -1); break;
        case 'j': moveRobotInDirection(-1, 1); break;
        case 'k': moveRobotInDirection(1, 1); break;
        case 'q': rotate(-5); break;
        case 'e': rotate(5); break;
        case ' ': spinRobot(); break;
        case 'r': centerRobot(); break;
      }
    });
  </script>
</body>
</html>
