<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Robot Map Interface</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
      font-family: sans-serif;
      overflow: hidden;
    }
    
    #sidebar {
      width: 320px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #ccc;
      background-color: #f5f5f5;
      overflow-y: auto;
    }
    
    #display-area {
      flex: 1;
      position: relative;
      overflow: hidden;
      background-color: #eaeaea;
    }
    
    #map-container {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    #map {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    
    #robot {
      position: absolute;
      width: 50px; /* Kích thước mặc định */
      transform-origin: center center;
      transition: transform 0.1s linear, left 0.1s linear, top 0.1s linear;
    }
    
    /* Phân khu 1: Điều khiển */
    #control-panel {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    
    .controls-title {
      margin: 8px 0;
      color: #333;
    }
    
    .movement-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 5px;
      margin-bottom: 10px;
    }
    
    .movement-grid button {
      padding: 8px 0;
      background-color: #e6e6e6;
      border: 1px solid #ccc;
      cursor: pointer;
      border-radius: 4px;
    }
    
    .movement-grid button:hover {
      background-color: #d9d9d9;
    }
    
    .rotation-controls {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
    }
    
    .rotation-controls button {
      flex: 1;
      padding: 8px 0;
      background-color: #e6e6e6;
      border: 1px solid #ccc;
      cursor: pointer;
      border-radius: 4px;
    }
    
    .toggle-robot {
      margin-top: 8px;
    }
    
    /* Phân khu 2: Lập trình khối */
    #block-programming {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    
    .block-container {
      display: flex;
      margin-bottom: 10px;
      max-height: 250px; /* Giới hạn chiều cao để vừa màn hình */
    }
    
    .block-library {
      flex: 1;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px;
      background-color: white;
      overflow-y: auto;
    }
    
    .program-area {
      flex: 1;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px;
      background-color: white;
      margin-left: 10px;
      overflow-y: auto;
    }
    
    .command-block {
      margin: 3px 0;
      padding: 5px;
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: move;
      display: flex;
      align-items: center;
      font-size: 0.9em;
    }
    
    .command-block input {
      width: 40px;
      margin-left: 5px;
      text-align: center;
    }
    
    .command-block.move-up { background-color: #d1e7dd; }
    .command-block.move-down { background-color: #f8d7da; }
    .command-block.move-left { background-color: #cfe2ff; }
    .command-block.move-right { background-color: #fff3cd; }
    .command-block.move-upleft { background-color: #d8f3dc; }
    .command-block.move-upright { background-color: #e9ecef; }
    .command-block.move-downleft { background-color: #e0e1ff; }
    .command-block.move-downright { background-color: #ffe8d9; }
    .command-block.spin { background-color: #d8d8ff; }
    .command-block.rotate-left { background-color: #ffccd5; }
    .command-block.rotate-right { background-color: #c9f7f5; }
    
    .robot-resize-controls {
      margin: 10px 0;
      display: flex;
      align-items: center;
    }
    
    .robot-resize-controls label {
      margin-right: 10px;
    }
    
    .robot-resize-controls input {
      width: 100%;
    }
    
    .run-program {
      display: block;
      width: 100%;
      padding: 8px;
      margin-top: 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .run-program:hover {
      background-color: #45a049;
    }
    
    /* Điểm resize cho robot */
    .resize-handle {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: #ff5252;
      border-radius: 50%;
      bottom: -5px;
      right: -5px;
      cursor: nwse-resize;
      z-index: 10;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <!-- Phân khu 1: Điều khiển trực tiếp -->
    <div id="control-panel">
      <h4 class="controls-title">Di chuyển</h4>
      
      <div class="movement-grid">
        <button onclick="moveDiagonal(-1, -1)">↖ (U)</button>
        <button onclick="move(0, -1)">↑ (W)</button>
        <button onclick="moveDiagonal(1, -1)">↗ (I)</button>
        <button onclick="move(-1, 0)">← (A)</button>
        <button onclick="spinRobot()">⟳ (Space)</button>
        <button onclick="move(1, 0)">→ (D)</button>
        <button onclick="moveDiagonal(-1, 1)">↙ (J)</button>
        <button onclick="move(0, 1)">↓ (S)</button>
        <button onclick="moveDiagonal(1, 1)">↘ (K)</button>
      </div>
      
      <div class="rotation-controls">
        <button onclick="rotate(-2)">⟲ Quay Trái (Q)</button>
        <button onclick="rotate(2)">⟳ Quay Phải (E)</button>
        <button onclick="centerRobot()">⟴ Reset</button>
      </div>
      
      <div class="toggle-robot">
        <label><input type="checkbox" id="toggle-robot" checked onchange="toggleRobot()"> Ẩn/Hiện Robot</label>
      </div>
      
      <div class="robot-resize-controls">
        <label>Kích thước robot:</label>
        <input type="range" id="robot-size" min="20" max="150" value="50" oninput="resizeRobot(this.value)">
      </div>
    </div>
    
    <!-- Phân khu 2: Lập trình khối -->
    <div id="block-programming">
      <h4 class="controls-title">Lập trình khối</h4>
      
      <div class="block-container">
        <div class="block-library" id="block-library">
          <div class="command-block move-up" draggable="true" data-command="up">
            Lên <input type="number" value="1" min="1">
          </div>
          <div class="command-block move-down" draggable="true" data-command="down">
            Xuống <input type="number" value="1" min="1">
          </div>
          <div class="command-block move-left" draggable="true" data-command="left">
            Trái <input type="number" value="1" min="1">
          </div>
          <div class="command-block move-right" draggable="true" data-command="right">
            Phải <input type="number" value="1" min="1">
          </div>
          <div class="command-block move-upleft" draggable="true" data-command="upleft">
            Chéo trái lên <input type="number" value="1" min="1">
          </div>
          <div class="command-block move-upright" draggable="true" data-command="upright">
            Chéo phải lên <input type="number" value="1" min="1">
          </div>
          <div class="command-block move-downleft" draggable="true" data-command="downleft">
            Chéo trái xuống <input type="number" value="1" min="1">
          </div>
          <div class="command-block move-downright" draggable="true" data-command="downright">
            Chéo phải xuống <input type="number" value="1" min="1">
          </div>
          <div class="command-block spin" draggable="true" data-command="spin">
            Xoay tròn <input type="number" value="1" min="1">
          </div>
          <div class="command-block rotate-left" draggable="true" data-command="rotateleft">
            Quay trái <input type="number" value="2" min="1">
          </div>
          <div class="command-block rotate-right" draggable="true" data-command="rotateright">
            Quay phải <input type="number" value="2" min="1">
          </div>
        </div>
        
        <div class="program-area" id="program-area">
          <!-- Khu vực nhận các khối lệnh -->
        </div>
      </div>
      
      <button class="run-program" onclick="runProgram()">Chạy chương trình</button>
    </div>
  </div>
  
  <!-- Phân khu 3: Hiển thị map và robot -->
  <div id="display-area">
    <div id="map-container">
      <img id="map" src="map.png" alt="Map" />
    </div>
    <div id="robot-container">
      <img id="robot" src="robot.png" alt="Robot" />
      <div class="resize-handle" id="resize-handle"></div>
    </div>
  </div>

  <script>
    const robot = document.getElementById("robot");
    const mapImg = document.getElementById("map");
    const resizeHandle = document.getElementById("resize-handle");
    let x = 100, y = 100, angle = 0;
    let robotSize = 50; // Kích thước mặc định của robot
    let isProgramRunning = false;
    let programQueue = [];
    
    // Đảm bảo map được đặt đúng kích thước khi trang tải xong
    window.addEventListener('load', function() {
      // Xóa dòng tiêu đề thừa ở đầu file
      let title = document.querySelector('title').innerText;
      if (title.includes('CODERNIGHT')) {
        document.querySelector('title').innerText = 'Robot Map Interface';
      }
      
      centerRobot();
      positionResizeHandle();
    });
    
    // Điều chỉnh khi cửa sổ thay đổi
    window.addEventListener('resize', function() {
      centerRobot();
      positionResizeHandle();
    });
    
    function resizeRobot(size) {
      robotSize = size;
      robot.style.width = `${robotSize}px`;
      positionResizeHandle();
      updateRobot();
    }
    
    function centerRobot() {
      const mapRect = mapImg.getBoundingClientRect();
      const displayArea = document.getElementById("display-area");
      const displayRect = displayArea.getBoundingClientRect();
      
      // Đặt robot ở giữa map
      x = mapRect.left + (mapRect.width / 2) - (robotSize / 2);
      y = mapRect.top + (mapRect.height / 2) - (robotSize / 2);
      
      updateRobot();
    }
    
    function updateRobot() {
      robot.style.left = `${x}px`;
      robot.style.top = `${y}px`;
      robot.style.transform = `rotate(${angle}deg)`;
      positionResizeHandle();
    }
    
    function positionResizeHandle() {
      const robotRect = robot.getBoundingClientRect();
      resizeHandle.style.left = (robotRect.right - 5) + 'px';
      resizeHandle.style.top = (robotRect.bottom - 5) + 'px';
    }
    
    function move(dx, dy) {
      const moveAmount = 5; // Tốc độ di chuyển cố định
      if (dx !== 0) {
        x += dx * moveAmount;
      }
      
      if (dy !== 0) {
        y += dy * moveAmount;
      }
      
      updateRobot();
    }
    
    function moveDiagonal(dx, dy) {
      const moveAmount = 3; // Tốc độ di chuyển đường chéo
      x += dx * moveAmount;
      y += dy * moveAmount;
      updateRobot();
    }
    
    function rotate(da) {
      angle += da;
      updateRobot();
    }
    
    function spinRobot() {
      // Xoay tròn 2 vòng rồi trở về góc ban đầu
      const startAngle = angle;
      let currentRotation = 0;
      
      function animateRotation() {
        currentRotation += 5;
        if (currentRotation <= 720) {
          angle = startAngle + currentRotation;
          updateRobot();
          requestAnimationFrame(animateRotation);
        } else {
          angle = startAngle;
          updateRobot();
        }
      }
      
      requestAnimationFrame(animateRotation);
    }
    
    function toggleRobot() {
      robot.style.display = document.getElementById("toggle-robot").checked ? 'block' : 'none';
      resizeHandle.style.display = document.getElementById("toggle-robot").checked ? 'block' : 'none';
    }
    
    // Xử lý kéo thả các khối lệnh
    const blockLibrary = document.getElementById('block-library');
    const programArea = document.getElementById('program-area');
    
    // Thiết lập sự kiện cho các khối lệnh
    document.querySelectorAll('.command-block').forEach(block => {
      block.addEventListener('dragstart', function(e) {
        e.dataTransfer.setData('text/plain', this.dataset.command);
        e.dataTransfer.effectAllowed = 'copy';
      });
    });
    
    // Cho phép thả khối vào program area
    programArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'copy';
    });
    
    programArea.addEventListener('drop', function(e) {
      e.preventDefault();
      const command = e.dataTransfer.getData('text/plain');
      if (command) {
        // Tìm khối lệnh gốc
        const originalBlock = document.querySelector(`.command-block[data-command="${command}"]`);
        if (originalBlock) {
          // Tạo một bản sao của khối lệnh
          const newBlock = originalBlock.cloneNode(true);
          newBlock.draggable = false; // Không cho phép kéo khối này nữa
          
          // Thêm nút xóa khối
          const deleteButton = document.createElement('button');
          deleteButton.innerHTML = '✕';
          deleteButton.style.marginLeft = 'auto';
          deleteButton.style.background = 'none';
          deleteButton.style.border = 'none';
          deleteButton.style.color = 'red';
          deleteButton.style.fontWeight = 'bold';
          deleteButton.style.cursor = 'pointer';
          
          deleteButton.addEventListener('click', function() {
            programArea.removeChild(newBlock);
          });
          
          newBlock.appendChild(deleteButton);
          programArea.appendChild(newBlock);
        }
      }
    });
    
    // Xử lý kéo thả resize robot
    let isResizing = false;
    
    resizeHandle.addEventListener('mousedown', function(e) {
      isResizing = true;
      e.preventDefault();
    });
    
    document.addEventListener('mousemove', function(e) {
      if (!isResizing) return;
      
      const robotRect = robot.getBoundingClientRect();
      const displayRect = document.getElementById('display-area').getBoundingClientRect();
      
      // Tính toán kích thước mới dựa trên vị trí chuột
      const newWidth = e.clientX - robotRect.left;
      const newHeight = e.clientY - robotRect.top;
      
      // Giữ tỷ lệ khung hình 1:1
      const newSize = Math.max(Math.min(newWidth, newHeight), 20);
      
      // Cập nhật kích thước robot
      robotSize = newSize;
      robot.style.width = `${robotSize}px`;
      
      // Cập nhật giá trị thanh trượt
      document.getElementById('robot-size').value = robotSize;
      
      // Cập nhật vị trí nút resize
      positionResizeHandle();
      
      // Cập nhật vị trí robot để giữ nguyên vị trí trung tâm
      updateRobot();
    });
    
    document.addEventListener('mouseup', function() {
      isResizing = false;
    });
    
    function runProgram() {
      if (isProgramRunning) return;
      
      // Thu thập tất cả các lệnh từ program area
      const commands = Array.from(programArea.children).map(block => {
        const command = block.dataset.command;
        const value = parseInt(block.querySelector('input').value) || 1;
        return { command, value };
      });
      
      // Đặt vào hàng đợi và thực thi
      programQueue = commands;
      isProgramRunning = true;
      executeNextCommand();
    }
    
    function executeNextCommand() {
      if (programQueue.length === 0) {
        isProgramRunning = false;
        return;
      }
      
      const command = programQueue.shift();
      const value = command.value;
      
      switch (command.command) {
        case 'up':
          move(0, -value);
          break;
        case 'down':
          move(0, value);
          break;
        case 'left':
          move(-value, 0);
          break;
        case 'right':
          move(value, 0);
          break;
        case 'upleft':
          moveDiagonal(-value, -value);
          break;
        case 'upright':
          moveDiagonal(value, -value);
          break;
        case 'downleft':
          moveDiagonal(-value, value);
          break;
        case 'downright':
          moveDiagonal(value, value);
          break;
        case 'spin':
          // Đối với xoay tròn, tạo hiệu ứng mượt mà hơn
          spinRobot();
          setTimeout(executeNextCommand, 1000); // Chờ 1 giây để xoay xong
          return;
        case 'rotateleft':
          rotate(-value);
          break;
        case 'rotateright':
          rotate(value);
          break;
      }
      
      // Chờ một chút giữa các lệnh để tạo hiệu ứng mượt mà
      setTimeout(executeNextCommand, 300);
    }
    
    // Xử lý phím
    document.addEventListener("keydown", (e) => {
      if (isProgramRunning) return; // Không xử lý phím khi chương trình đang chạy
      
      switch (e.key.toLowerCase()) {
        case 'w': move(0, -1); break;
        case 's': move(0, 1); break;
        case 'a': move(-1, 0); break;
        case 'd': move(1, 0); break;
        case 'u': moveDiagonal(-1, -1); break;
        case 'i': moveDiagonal(1, -1); break;
        case 'j': moveDiagonal(-1, 1); break;
        case 'k': moveDiagonal(1, 1); break;
        case 'q': rotate(-2); break;
        case 'e': rotate(2); break;
        case ' ': spinRobot(); break;
        case 'r': centerRobot(); break;
      }
    });
    
    // Khởi tạo
    updateRobot();
  </script>
</body>
</html>
