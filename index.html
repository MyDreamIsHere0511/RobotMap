<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Robot Map Interface</title>
  <style>
    :root {
      --primary-color: #3498db;
      --secondary-color: #2ecc71;
      --accent-color: #f39c12;
      --danger-color: #e74c3c;
      --light-bg: #f5f5f5;
      --dark-bg: #2c3e50;
      --text-dark: #333;
      --text-light: #f5f5f5;
      --border-color: #ddd;
      --shadow: 0 2px 5px rgba(0,0,0,0.1);
      --theme-transition: background-color 0.3s, color 0.3s;
      
      /* Màu cho các command block */
      --move-up-bg: #d1e7dd;
      --move-down-bg: #f8d7da;
      --move-left-bg: #cfe2ff;
      --move-right-bg: #fff3cd;
      --move-upleft-bg: #d8f3dc;
      --move-upright-bg: #e9ecef;
      --move-downleft-bg: #e0e1ff;
      --move-downright-bg: #ffe8d9;
      --spin-bg: #d8d8ff;
      --rotate-left-bg: #ffccd5;
      --rotate-right-bg: #c9f7f5;
    }
    
    body.dark-mode {
      --light-bg: #1a1a2e;
      --border-color: #444;
      --text-dark: #f5f5f5;
      
      /* Màu tối cho các command block */
      --move-up-bg: #1e4d3d;
      --move-down-bg: #4d2828;
      --move-left-bg: #1e294d;
      --move-right-bg: #4d412e;
      --move-upleft-bg: #1e3e2e;
      --move-upright-bg: #2e2e2e;
      --move-downleft-bg: #252540;
      --move-downright-bg: #40332a;
      --spin-bg: #2e2e4d;
      --rotate-left-bg: #4d2a38;
      --rotate-right-bg: #2a4d49;
    }
    
    body {
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
      background-color: var(--light-bg);
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    #header-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      z-index: 1000;
      box-shadow: var(--shadow);
    }
    
    #header-bar .title {
      font-weight: bold;
      font-size: 1.2em;
    }
    
    #header-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .header-button {
      padding: 5px 10px;
      background-color: rgba(255,255,255,0.2);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .header-button:hover {
      background-color: rgba(255,255,255,0.3);
    }
    
    .theme-toggle {
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    
    .theme-toggle span {
      margin-right: 5px;
    }
    
    .toggle-switch {
      position: relative;
      width: 40px;
      height: 20px;
      background-color: rgba(0,0,0,0.3);
      border-radius: 10px;
      transition: background-color 0.3s;
    }
    
    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: white;
      top: 2px;
      left: 2px;
      transition: transform 0.3s;
    }
    
    .dark-mode .toggle-switch {
      background-color: var(--accent-color);
    }
    
    .dark-mode .toggle-switch::after {
      transform: translateX(20px);
    }
    
    #main-container {
      display: flex;
      width: 100%;
      height: 100%;
      padding-top: 40px; /* Để tránh bị header che */
    }
    
    #control-panel {
      width: 300px;
      height: 100%;
      background-color: var(--light-bg);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      transition: var(--theme-transition);
    }
    
    #display-area {
      flex: 1;
      position: relative;
      overflow: hidden;
      background-color: var(--light-bg);
      transition: var(--theme-transition);
    }
    
    .panel-section {
      border-bottom: 1px solid var(--border-color);
      padding: 10px;
    }
    
    .panel-section-title {
      margin: 0 0 10px 0;
      font-size: 16px;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .panel-content {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .control-row {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .control-row label {
      flex: 1;
      font-size: 14px;
    }
    
    .slider-container {
      display: flex;
      align-items: center;
      width: 100%;
    }
    
    .slider-container input[type="range"] {
      flex: 1;
      margin: 0 10px;
    }
    
    .coordinate-input {
      width: 70px;
      padding: 5px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
    }
    
    .btn {
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      background-color: var(--primary-color);
      color: white;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .btn:hover {
      background-color: #2980b9;
    }
    
    .btn:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }
    
    .btn.secondary {
      background-color: var(--secondary-color);
    }
    
    .btn.secondary:hover {
      background-color: #27ae60;
    }
    
    .btn.accent {
      background-color: var(--accent-color);
    }
    
    .btn.accent:hover {
      background-color: #e67e22;
    }
    
    .btn.danger {
      background-color: var(--danger-color);
    }
    
    .btn.danger:hover {
      background-color: #c0392b;
    }
    
    .btn-group {
      display: flex;
      gap: 5px;
    }
    
    .btn-group button {
      flex: 1;
    }
    
    .direction-controls {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 5px;
      margin: 10px 0;
    }
    
    .direction-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      border: 1px solid var(--border-color);
      background-color: white;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .direction-btn:hover {
      background-color: #f0f0f0;
    }
    
    .direction-btn.center {
      font-size: 14px;
    }
    
    #map-container {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: auto;
    }
    
    #map {
      display: block;
      max-width: 100%;
      height: auto;
      transition: transform 0.3s;
    }
    
    #robot-container {
      position: absolute;
      z-index: 10;
      cursor: default;
    }
    
    #robot {
      position: absolute;
      width: 50px;
      height: auto;
      transform-origin: center;
      transform: translate(-50%, -50%);
      transition: width 0.3s;
    }
    
    .resize-handle {
      position: absolute;
      bottom: -10px;
      right: -10px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: var(--accent-color);
      cursor: nwse-resize;
      z-index: 20;
    }
    
    .dragging {
      opacity: 0.7;
    }
    
    .toggle-btn {
      display: inline-flex;
      align-items: center;
      cursor: pointer;
    }
    
    .toggle-btn input {
      margin-right: 5px;
    }
    
    #grid-overlay {
      position: absolute;
      pointer-events: none;
      z-index: 5;
    }
    
    .grid-line {
      position: absolute;
      background-color: rgba(0, 0, 0, 0.1);
      pointer-events: none;
    }
    
    #coordinates-display {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 100;
      border: 1px solid var(--border-color);
    }
    
    #mini-map-container {
      position: absolute;
      bottom: 10px;
      right: 10px;
      width: 150px;
      height: 100px;
      background-color: rgba(255, 255, 255, 0.8);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      z-index: 100;
      overflow: hidden;
    }
    
    #mini-map {
      position: relative;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.05);
    }
    
    #mini-map-indicator {
      position: absolute;
      border: 2px solid var(--primary-color);
      background-color: rgba(52, 152, 219, 0.2);
      pointer-events: none;
    }
    
    #mini-map-robot {
      position: absolute;
      width: 8px;
      height: 8px;
      background-color: var(--danger-color);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    
    #mouse-position-indicator {
      position: absolute;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: rgba(0, 0, 0, 0.5);
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    
    .waypoint-marker {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: var(--accent-color);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: 15;
      cursor: pointer;
    }
    
    .waypoint-label {
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      background-color: white;
      padding: 2px 5px;
      border-radius: 3px;
      font-size: 10px;
      white-space: nowrap;
      border: 1px solid var(--border-color);
      z-index: 16;
      pointer-events: none;
    }
    
    .block-container {
      display: flex;
      flex-direction: column;
      height: 400px;
      gap: 10px;
    }
    
    .block-library {
      background-color: rgba(0,0,0,0.05);
      padding: 10px;
      border-radius: 4px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      max-height: 150px;
      overflow-y: auto;
    }
    .command-block {
      padding: 8px;
      border-radius: 4px;
      cursor: grab;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      position: relative;
      font-size: 12px;
      transition: box-shadow 0.2s, transform 0.2s;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .command-block:hover {
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      transform: translateY(-1px);
    }
    
    .command-block.move-up {
      background-color: var(--move-up-bg);
      border-left: 4px solid #198754;
    }
    
    .command-block.move-down {
      background-color: var(--move-down-bg);
      border-left: 4px solid #dc3545;
    }
    
    .command-block.move-left {
      background-color: var(--move-left-bg);
      border-left: 4px solid #0d6efd;
    }
    
    .command-block.move-right {
      background-color: var(--move-right-bg);
      border-left: 4px solid #ffc107;
    }
    
    .command-block.move-upleft {
      background-color: var(--move-upleft-bg);
      border-left: 4px solid #20c997;
    }
    
    .command-block.move-upright {
      background-color: var(--move-upright-bg);
      border-left: 4px solid #6c757d;
    }
    
    .command-block.move-downleft {
      background-color: var(--move-downleft-bg);
      border-left: 4px solid #6610f2;
    }
    
    .command-block.move-downright {
      background-color: var(--move-downright-bg);
      border-left: 4px solid #fd7e14;
    }
    
    .command-block.rotate-left {
      background-color: var(--rotate-left-bg);
      border-left: 4px solid #d63384;
    }
    
    .command-block.rotate-right {
      background-color: var(--rotate-right-bg);
      border-left: 4px solid #20c997;
    }
    
    .command-block.spin {
      background-color: var(--spin-bg);
      border-left: 4px solid #6610f2;
    }
    
    .command-block input {
      width: 40px;
      padding: 2px 5px;
      margin: 0 5px;
      border: 1px solid var(--border-color);
      border-radius: 3px;
    }
    
    .command-block .unit-label {
      font-size: 10px;
      color: #666;
    }
    
    .block-controls {
      position: absolute;
      right: 5px;
      top: 5px;
      display: flex;
      gap: 3px;
    }
    
    .block-controls button {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
      padding: 0;
    }
    
    .toggle-block {
      background-color: var(--secondary-color);
      color: white;
    }
    
    .delete-block {
      background-color: var(--danger-color);
      color: white;
    }
    
    .command-block.disabled {
      opacity: 0.5;
      text-decoration: line-through;
    }
    
    .command-block.selected-block {
      box-shadow: 0 0 0 2px var(--primary-color);
    }
    
    .drag-indicator {
      height: 2px;
      background-color: var(--primary-color);
      margin: 0;
      display: none;
      width: 100%;
    }
    
    .drag-indicator.active {
      display: block;
    }
    
    .program-area {
      flex: 1;
      background-color: rgba(255,255,255,0.8);
      border-radius: 4px;
      padding: 10px;
      overflow-y: auto;
      min-height: 200px;
      border: 1px dashed var(--border-color);
    }
    
    .run-program {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
      padding: 10px;
      border: none;
      border-radius: 4px;
      background-color: var(--secondary-color);
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .run-program:hover {
      background-color: #27ae60;
    }
    
    .run-program i {
      margin-right: 5px;
      font-style: normal;
    }
    
    .run-program.running {
      background-color: var(--danger-color);
    }
    
    .run-program.running:hover {
      background-color: #c0392b;
    }
    
    .saved-items {
      max-height: 100px;
      overflow-y: auto;
      margin-top: 5px;
    }
    
    .saved-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 5px 8px;
      background-color: rgba(255,255,255,0.8);
      border-radius: 3px;
      margin-bottom: 3px;
      font-size: 12px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .saved-item:hover {
      background-color: rgba(255,255,255,0.9);
    }
    
    .saved-item button {
      background: none;
      border: none;
      color: var(--danger-color);
      cursor: pointer;
      font-size: 16px;
      padding: 0 5px;
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    
    .modal-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    
    .modal-dialog {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 3px 15px rgba(0,0,0,0.2);
      min-width: 300px;
    }
    
    .modal-dialog h4 {
      margin-top: 0;
      margin-bottom: 15px;
    }
    
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    
    .modal-buttons button {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .modal-buttons .primary {
      background-color: var(--primary-color);
      color: white;
    }
    
    .modal-buttons .secondary {
      background-color: #95a5a6;
      color: white;
    }
    
    .import-export-textarea {
      width: 100%;
      height: 200px;
      font-family: monospace;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
      resize: none;
    }
    
    .tooltip {
      position: absolute;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 5px 10px;
      border-radius: 3px;
      font-size: 12px;
      pointer-events: none;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .notification {
      position: fixed;
      top: 60px;
      right: 20px;
      background-color: rgba(46, 204, 113, 0.9);
      color: white;
      padding: 10px 15px;
      border-radius: 4px;
      font-size: 14px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transform: translateX(120%);
      transition: transform 0.3s;
      z-index: 1000;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.error {
      background-color: rgba(231, 76, 60, 0.9);
    }
    
    .notification.warning {
      background-color: rgba(243, 156, 18, 0.9);
    }
    
    .notification.info {
      background-color: rgba(52, 152, 219, 0.9);
    }
    
    .history-controls {
      display: flex;
      gap: 5px;
    }
    
    .history-controls button {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .history-controls button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .path-trace {
      position: absolute;
      pointer-events: none;
      transition: opacity 0.5s;
    }
    
    #robot-context-menu {
      border-radius: 4px;
      overflow: hidden;
    }
    
    @media (max-width: 768px) {
      #control-panel {
        width: 250px;
      }
      
      .direction-btn {
        width: 36px;
        height: 36px;
      }
    }
  </style>
</head>
<body>
  <div id="header-bar">
    <div class="title">Robot Map Interface</div>
    <div id="header-controls">
      <button class="header-button" onclick="showExportDialog()">Xuất/Nhập</button>
      <div class="theme-toggle" onclick="toggleTheme()">
        <span id="theme-text">Chế độ tối</span>
        <div class="toggle-switch"></div>
      </div>
    </div>
  </div>
  
  <div id="main-container">
    <div id="control-panel">
      <!-- Phân khu 1: Điều khiển và thông tin -->
      <div id="control-section" class="panel-section">
        <h3 class="panel-section-title">
          Điều Khiển Robot
          <div class="history-controls">
            <button id="undo-button-1" onclick="undoAction()" title="Quay lại bước trước (Ctrl+Z)">↩</button>
            <button id="redo-button-1" onclick="redoAction()" title="Tiến lại bước sau (Ctrl+Y)">↪</button>
          </div>
        </h3>
        
        <div class="panel-content">
          <!-- Kích thước robot -->
          <div class="control-row">
            <label>Kích thước robot:</label>
            <div class="slider-container">
              <input type="range" id="robot-size" min="20" max="150" value="50" oninput="resizeRobot(this.value)">
              <span id="size-display">50px</span>
            </div>
          </div>
          
          <!-- Bước di chuyển -->
          <div class="control-row">
            <label>Bước di chuyển:</label>
            <div class="slider-container">
              <input type="number" id="step-size" min="0.1" step="0.1" value="1" onchange="updateStepSize(this.value)" class="coordinate-input">
              <span>cm</span>
            </div>
          </div>
          
          <!-- Kích thước và vị trí map -->
          <div class="control-row">
            <label>Kích thước map:</label>
            <div class="slider-container">
              <input type="range" id="map-size" min="50" max="200" value="100" oninput="resizeMap(this.value)">
              <span id="map-size-display">100%</span>
            </div>
          </div>
          
          <div class="control-row">
            <label>Vị trí map X:</label>
            <div class="slider-container">
              <input type="range" id="map-position-x" min="-50" max="50" value="0" oninput="adjustMapPosition('x', this.value)">
              <span id="map-position-x-display">0</span>
            </div>
          </div>
          
          <div class="control-row" id="map-y-position-control" style="display: none;">
            <label>Vị trí map Y:</label>
            <div class="slider-container">
              <input type="range" id="map-position-y" min="-50" max="50" value="0" oninput="adjustMapPosition('y', this.value)">
              <span id="map-position-y-display">0</span>
            </div>
          </div>
          
          <div class="control-row">
            <label>Cho phép di chuyển map theo chiều dọc:</label>
            <input type="checkbox" id="map-vertical-move" onchange="toggleMapVerticalMovement()">
          </div>
          
          <!-- Thông tin vị trí hiện tại -->
          <div class="control-row">
            <label>Vị trí robot (cm):</label>
            <div>
              X: <span id="current-x">0</span>, 
              Y: <span id="current-y">0</span>, 
              Góc: <span id="current-angle">0</span>°
            </div>
          </div>
          
          <!-- Tỷ lệ cm/pixel -->
          <div class="control-row">
            <label>Tỷ lệ cm/pixel:</label>
            <span id="scale-ratio">1.00</span>
          </div>
          
          <!-- Cài đặt tọa độ cụ thể -->
          <div class="control-row">
            <label>Di chuyển đến:</label>
            <div>
              X: <input type="number" id="target-x" class="coordinate-input" step="0.1"> 
              Y: <input type="number" id="target-y" class="coordinate-input" step="0.1">
              <button class="btn secondary" onclick="moveToCoordinates()">Đi</button>
            </div>
          </div>
          
          <!-- Điều khiển hướng di chuyển -->
          <div class="direction-controls">
            <button class="direction-btn" onclick="moveRobotInDirection(-1, -1)" title="Di chuyển chéo trái lên">↖</button>
            <button class="direction-btn" onclick="moveRobotInDirection(0, -1)" title="Di chuyển lên">↑</button>
            <button class="direction-btn" onclick="moveRobotInDirection(1, -1)" title="Di chuyển chéo phải lên">↗</button>
            <button class="direction-btn" onclick="moveRobotInDirection(-1, 0)" title="Di chuyển trái">←</button>
            <button class="direction-btn center" onclick="centerRobot()" title="Về trung tâm">⌂</button>
            <button class="direction-btn" onclick="moveRobotInDirection(1, 0)" title="Di chuyển phải">→</button>
            <button class="direction-btn" onclick="moveRobotInDirection(-1, 1)" title="Di chuyển chéo trái xuống">↙</button>
            <button class="direction-btn" onclick="moveRobotInDirection(0, 1)" title="Di chuyển xuống">↓</button>
            <button class="direction-btn" onclick="moveRobotInDirection(1, 1)" title="Di chuyển chéo phải xuống">↘</button>
          </div>
                    <!-- Điều khiển góc quay -->
                    <div class="control-row">
                      <label>Điều khiển góc quay:</label>
                      <div class="btn-group">
                        <button class="btn" onclick="rotateRobot(-15)" title="Quay trái 15°">↺ 15°</button>
                        <button class="btn" onclick="rotateRobot(15)" title="Quay phải 15°">15° ↻</button>
                        <button class="btn" onclick="spinRobot()" title="Xoay tròn">🔄</button>
                      </div>
                    </div>
                    
                    <!-- Hiển thị đánh dấu điểm -->
                    <div class="control-row">
                      <label>Hiển thị:</label>
                      <div>
                        <label class="toggle-btn">
                          <input type="checkbox" id="toggle-grid" onchange="toggleGrid()"> Grid
                        </label>
                        <label class="toggle-btn">
                          <input type="checkbox" id="toggle-path" onchange="togglePath()"> Path
                        </label>
                      </div>
                    </div>
                    
                    <!-- Nút đảo chiều -->
                    <div class="control-row">
                      <label>Đảo chiều:</label>
                      <div>
                        <button id="toggle-vertical" class="btn" onclick="toggleInvert('vertical')">↕ Y</button>
                        <button id="toggle-horizontal" class="btn" onclick="toggleInvert('horizontal')">↔ X</button>
                      </div>
                    </div>
                    
                    <!-- Xóa hết waypoints -->
                    <div class="control-row">
                      <button class="btn danger" onclick="clearAllWaypoints()">Xóa tất cả waypoints</button>
                    </div>
                  </div>
                </div>
                
                <!-- Phân khu 2: Lập trình khối lệnh -->
                <div id="coding-section" class="panel-section">
                  <h3 class="panel-section-title">
                    Lập Trình Robot
                    <div class="history-controls">
                      <button id="undo-button-2" onclick="undoAction()" title="Quay lại bước trước (Ctrl+Z)">↩</button>
                      <button id="redo-button-2" onclick="redoAction()" title="Tiến lại bước sau (Ctrl+Y)">↪</button>
                    </div>
                  </h3>
                  <div class="block-container">
                    <div class="block-library">
                      <div class="command-block move-up" draggable="true" ondragstart="dragStart(event)" data-command="moveUp">
                        Di chuyển lên <input type="number" value="1.0" step="0.1" min="0.1"> <span class="unit-label">cm</span>
                      </div>
                      <div class="command-block move-down" draggable="true" ondragstart="dragStart(event)" data-command="moveDown">
                        Di chuyển xuống <input type="number" value="1.0" step="0.1" min="0.1"> <span class="unit-label">cm</span>
                      </div>
                      <div class="command-block move-left" draggable="true" ondragstart="dragStart(event)" data-command="moveLeft">
                        Di chuyển trái <input type="number" value="1.0" step="0.1" min="0.1"> <span class="unit-label">cm</span>
                      </div>
                      <div class="command-block move-right" draggable="true" ondragstart="dragStart(event)" data-command="moveRight">
                        Di chuyển phải <input type="number" value="1.0" step="0.1" min="0.1"> <span class="unit-label">cm</span>
                      </div>
                      <div class="command-block move-upleft" draggable="true" ondragstart="dragStart(event)" data-command="moveUpLeft">
                        Di chuyển chéo trái lên <input type="number" value="1.0" step="0.1" min="0.1"> <span class="unit-label">cm</span>
                      </div>
                      <div class="command-block move-upright" draggable="true" ondragstart="dragStart(event)" data-command="moveUpRight">
                        Di chuyển chéo phải lên <input type="number" value="1.0" step="0.1" min="0.1"> <span class="unit-label">cm</span>
                      </div>
                      <div class="command-block move-downleft" draggable="true" ondragstart="dragStart(event)" data-command="moveDownLeft">
                        Di chuyển chéo trái xuống <input type="number" value="1.0" step="0.1" min="0.1"> <span class="unit-label">cm</span>
                      </div>
                      <div class="command-block move-downright" draggable="true" ondragstart="dragStart(event)" data-command="moveDownRight">
                        Di chuyển chéo phải xuống <input type="number" value="1.0" step="0.1" min="0.1"> <span class="unit-label">cm</span>
                      </div>
                      <div class="command-block rotate-left" draggable="true" ondragstart="dragStart(event)" data-command="rotateLeft">
                        Xoay trái <input type="number" value="15" step="1" min="1"> <span class="unit-label">°</span>
                      </div>
                      <div class="command-block rotate-right" draggable="true" ondragstart="dragStart(event)" data-command="rotateRight">
                        Xoay phải <input type="number" value="15" step="1" min="1"> <span class="unit-label">°</span>
                      </div>
                      <div class="command-block spin" draggable="true" ondragstart="dragStart(event)" data-command="spin">
                        Xoay tròn <input type="number" value="1" step="1" min="1"> <span class="unit-label">vòng</span>
                      </div>
                    </div>
                    
                    <div class="program-area" 
                         ondrop="drop(event)" 
                         ondragover="allowDrop(event)"
                         ondragenter="dragEnter(event)"
                         ondragleave="dragLeave(event)">
                      <div class="drag-indicator"></div>
                      <!-- Block lệnh sẽ được thêm vào đây -->
                    </div>
                    
                    <button class="run-program" onclick="runProgram()">
                      <i>▶</i> Chạy chương trình
                    </button>
                  </div>
                </div>
                
                <!-- Phân khu 3: Lưu và tải -->
                <div id="save-section" class="panel-section">
                  <h3 class="panel-section-title">Lưu/Tải Chương Trình</h3>
                  <div class="panel-content">
                    <div class="control-row">
                      <input type="text" id="program-name" placeholder="Nhập tên chương trình" class="coordinate-input" style="width: 150px;">
                      <button class="btn secondary" onclick="saveProgram()">Lưu</button>
                    </div>
                    
                    <div class="saved-items" id="saved-programs-list">
                      <!-- Danh sách chương trình sẽ được hiển thị ở đây -->
                    </div>
                  </div>
                </div>
              </div>
              
              <div id="display-area">
                <div id="map-container">
                  <img id="map" src="map.png" alt="Map">
                  <div id="robot-container">
                    <img id="robot" src="robot.png" alt="Robot">
                  </div>
                  <div id="mouse-position-indicator"></div>
                  <div id="grid-overlay"></div>
                </div>
                
                <div id="coordinates-display">
                  <div>X: <span id="mouse-x">0</span> cm, Y: <span id="mouse-y">0</span> cm</div>
                </div>
                
                <div id="mini-map-container">
                  <div id="mini-map">
                    <div id="mini-map-indicator"></div>
                    <div id="mini-map-robot"></div>
                  </div>
                </div>
              </div>
            </div>
            
            <script>
              // Biến lưu trạng thái
              let robotX = 0; // Tọa độ X của robot (pixel)
              let robotY = 0; // Tọa độ Y của robot (pixel)
              let robotAngle = 0; // Góc quay của robot (độ)
              let robotSize = 50; // Kích thước robot (pixel)
              let stepSize = 1.0; // Bước di chuyển (cm)
              let cmPerPixel = 1.0; // Tỷ lệ cm/pixel
              let isDragging = false; // Đang kéo robot?
              let isDraggingEnabled = false; // Cho phép kéo thả robot?
              let showGrid = false; // Hiển thị lưới?
              let showPath = false; // Hiển thị path?
              let invertVertical = false; // Đảo chiều dọc?
              let invertHorizontal = false; // Đảo chiều ngang?
              let mapSize = 100; // Kích thước bản đồ (%)
              let mapPositionX = 0; // Vị trí X của bản đồ (%)
              let mapPositionY = 0; // Vị trí Y của bản đồ (%)
              let isRunningProgram = false; // Đang chạy chương trình?
              let isProgramPaused = false; // Đang tạm dừng chương trình?
              let currentProgramStepIndex = -1; // Chỉ số bước hiện tại
              let programRunTimer = null; // Bộ đếm thời gian để chạy chương trình
              let waypoints = []; // Mảng các waypoints
              let waypointCounter = 1; // Bộ đếm waypoint
              let selectedBlockIndex = -1; // Chỉ số của block đang chọn
              let draggedBlock = null; // Block đang được kéo
              let draggedBlockIndex = -1; // Chỉ số của block đang kéo
              let dragIndicator = null; // Dấu hiệu cho vị trí kéo thả
              let history = []; // Lịch sử thao tác
              let historyIndex = -1; // Chỉ số vị trí lịch sử hiện tại
              let lastWaypoint = null; // Waypoint cuối cùng (để xóa khi di chuyển)
              
              // Lấy tham chiếu đến các phần tử DOM
              const robotContainer = document.getElementById('robot-container');
              const robot = document.getElementById('robot');
              const map = document.getElementById('map');
              const mapContainer = document.getElementById('map-container');
              const robotSizeSlider = document.getElementById('robot-size');
              const sizeDisplay = document.getElementById('size-display');
              const currentXDisplay = document.getElementById('current-x');
              const currentYDisplay = document.getElementById('current-y');
              const currentAngleDisplay = document.getElementById('current-angle');
              const targetXInput = document.getElementById('target-x');
              const targetYInput = document.getElementById('target-y');
              const gridToggle = document.getElementById('toggle-grid');
              const pathToggle = document.getElementById('toggle-path');
              const gridOverlay = document.getElementById('grid-overlay');
              const stepSizeInput = document.getElementById('step-size');
              const scaleRatioDisplay = document.getElementById('scale-ratio');
              const programArea = document.querySelector('.program-area');
              const mapSizeSlider = document.getElementById('map-size');
              const mapSizeDisplay = document.getElementById('map-size-display');
              const mapPositionXSlider = document.getElementById('map-position-x');
              const mapPositionYSlider = document.getElementById('map-position-y');
              const mapPositionXDisplay = document.getElementById('map-position-x-display');
              const mapPositionYDisplay = document.getElementById('map-position-y-display');
              const mapYPositionControl = document.getElementById('map-y-position-control');
              const mapVerticalMoveCheckbox = document.getElementById('map-vertical-move');
              const mousePositionIndicator = document.getElementById('mouse-position-indicator');
              const coordinatesDisplay = document.getElementById('coordinates-display');
              const mouseXDisplay = document.getElementById('mouse-x');
              const mouseYDisplay = document.getElementById('mouse-y');
              const miniMapContainer = document.getElementById('mini-map-container');
              const miniMap = document.getElementById('mini-map');
              const miniMapIndicator = document.getElementById('mini-map-indicator');
              const miniMapRobot = document.getElementById('mini-map-robot');
              const undoButton1 = document.getElementById('undo-button-1');
              const redoButton1 = document.getElementById('redo-button-1');
              const undoButton2 = document.getElementById('undo-button-2');
              const redoButton2 = document.getElementById('redo-button-2');
              const runProgramButton = document.querySelector('.run-program');
              
              // Khởi tạo chức năng ban đầu
              initializeFunctions();
              
              function initializeFunctions() {
                // Tính toán vị trí trung tâm ban đầu
                centerRobot();
                
                // Cập nhật hiển thị ban đầu
                updateDisplay();
                
                // Thêm sự kiện cho việc kéo thả robot
                initializeDragging();
                
                // Thêm sự kiện click cho map
                initializeMapClickEvents();
                
                // Khởi tạo lịch sử
                saveToHistory();
                
                // Thêm sự kiện keyboard shortcuts
                setupKeyboardShortcuts();
                
                // Khởi tạo hiển thị tọa độ chuột
                initializeCoordinatesDisplay();
                
                // Khởi tạo mini-map
                initializeMiniMap();
                
                // Kéo thả cho block lệnh
                initializeDragAndDrop();
                
                // Tải chương trình đã lưu
                loadSavedPrograms();
                
                // Khởi tạo thông báo
                createNotificationElement();
                
                // Hiển thị tooltip
                setupTooltips();
              }
              
              // Cập nhật thông tin hiển thị
              function updateDisplay() {
                // Cập nhật các hiển thị vị trí
                currentXDisplay.textContent = (robotX * cmPerPixel).toFixed(1);
                currentYDisplay.textContent = (robotY * cmPerPixel).toFixed(1);
                currentAngleDisplay.textContent = robotAngle.toFixed(1);
                
                // Cập nhật tỷ lệ
                scaleRatioDisplay.textContent = cmPerPixel.toFixed(2);
                
                // Cập nhật trạng thái nút
                const historyAvailable = history.length > 0 && historyIndex > 0;
                const redoAvailable = historyIndex < history.length - 1;
                
                undoButton1.disabled = !historyAvailable;
                redoButton1.disabled = !redoAvailable;
                undoButton2.disabled = !historyAvailable;
                redoButton2.disabled = !redoAvailable;
                
                // Cập nhật mini-map
                updateMiniMap();
              }
              
              // Cập nhật vị trí và góc quay của robot
              function updateRobotPosition() {
                // Giới hạn robot trong phạm vi bản đồ
                const mapRect = map.getBoundingClientRect();
                const maxX = mapRect.width;
                const maxY = mapRect.height;
                
                // Đảm bảo robot không ra khỏi map
                robotX = Math.max(0, Math.min(robotX, maxX));
                robotY = Math.max(0, Math.min(robotY, maxY));
                
                // Cập nhật vị trí và góc quay
                robotContainer.style.left = robotX + 'px';
                robotContainer.style.top = robotY + 'px';
                robot.style.transform = `translate(-50%, -50%) rotate(${robotAngle}deg)`;
                
                // Cập nhật hiển thị
                updateDisplay();
                
                // Cập nhật mini-map
                updateMiniMap();
              }
              
              // Di chuyển robot đến trung tâm map
              function centerRobot() {
                // Lưu trạng thái hiện tại để undo
                saveToHistory();
                
                // Lấy kích thước map
                const mapRect = map.getBoundingClientRect();
                
                // Đặt robot vào trung tâm
                robotX = mapRect.width / 2;
                robotY = mapRect.height / 2;
                
                // Cập nhật vị trí
                updateRobotPosition();
                
                // Thông báo
                showNotification('Đã đặt robot về vị trí trung tâm', 'info');
              }
              
              // Thay đổi kích thước robot
              function resizeRobot(newSize) {
                robotSize = parseInt(newSize);
                robot.style.width = robotSize + 'px';
                sizeDisplay.textContent = robotSize + 'px';
                
                // Lưu kích thước vào localStorage
                localStorage.setItem('robotSize', robotSize);
              }
              
              // Di chuyển theo hướng với bước di chuyển hiện tại
              function moveRobotInDirection(dirX, dirY) {
                // Lưu trạng thái hiện tại để undo
                saveToHistory();
                
                // Tính toán khoảng cách di chuyển theo cm
                const distanceCm = parseFloat(stepSizeInput.value) || 1.0;
                
                // Chuyển đổi về pixel
                const distancePixels = distanceCm / cmPerPixel;
                
                // Xác định hướng tùy thuộc vào trạng thái đảo chiều
                let actualDirX = invertHorizontal ? -dirX : dirX;
                let actualDirY = invertVertical ? -dirY : dirY;
                
                // Vị trí cũ để vẽ path
                const oldX = robotX;
                const oldY = robotY;
                
                // Di chuyển theo hướng
                if (actualDirX !== 0 && actualDirY !== 0) {
                  // Di chuyển chéo (nhân với 0.7071 ~ 1/sqrt(2) để giữ đúng khoảng cách)
                  robotX += actualDirX * distancePixels * 0.7071;
                  robotY += actualDirY * distancePixels * 0.7071;
                } else {
                  // Di chuyển thẳng
                  robotX += actualDirX * distancePixels;
                  robotY += actualDirY * distancePixels;
                }
                
                // Cập nhật vị trí
                updateRobotPosition();
                
                // Vẽ path nếu được bật
                if (showPath) {
                  traceRobotPath(oldX, oldY, robotX, robotY);
                }
              }
    // Quay góc robot theo một góc nhất định
    function rotateRobot(angle) {
      // Lưu trạng thái hiện tại để undo
      saveToHistory();
      
      // Cập nhật góc quay
      robotAngle += angle;
      
      // Giữ góc trong khoảng 0-360 độ
      robotAngle = (robotAngle + 360) % 360;
      
      // Cập nhật hiển thị
      updateRobotPosition();
    }
    
    // Xoay tròn robot
    function spinRobot() {
      // Lưu trạng thái hiện tại để undo
      saveToHistory();
      
      // Quay robot 360 độ
      const targetAngle = robotAngle + 360;
      
      // Tạo hiệu ứng quay mượt
      let startAngle = robotAngle;
      const startTime = Date.now();
      const spinDuration = 1000; // 1 giây cho một vòng quay
      
      function animateSpin() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / spinDuration, 1);
        
        // Tính góc quay hiện tại
        robotAngle = startAngle + progress * 360;
        
        // Cập nhật hiển thị
        robot.style.transform = `translate(-50%, -50%) rotate(${robotAngle}deg)`;
        
        // Tiếp tục quay nếu chưa hoàn thành
        if (progress < 1) {
          requestAnimationFrame(animateSpin);
        } else {
          // Khi hoàn thành, đảm bảo góc nằm trong khoảng 0-360
          robotAngle = (robotAngle + 360) % 360;
          
          // Cập nhật hiển thị
          updateDisplay();
        }
      }
      
      // Bắt đầu quay
      animateSpin();
    }
    
    // Di chuyển đến tọa độ cụ thể
    function moveToCoordinates() {
      // Lấy tọa độ từ input
      const targetX = parseFloat(targetXInput.value);
      const targetY = parseFloat(targetYInput.value);
      
      // Kiểm tra tọa độ hợp lệ
      if (isNaN(targetX) || isNaN(targetY)) {
        showNotification('Vui lòng nhập tọa độ hợp lệ', 'error');
        return;
      }
      
      // Lưu trạng thái hiện tại để undo
      saveToHistory();
      
      // Chuyển đổi từ cm sang pixel
      const targetXPixel = targetX / cmPerPixel;
      const targetYPixel = targetY / cmPerPixel;
      
      // Vị trí cũ để vẽ path
      const oldX = robotX;
      const oldY = robotY;
      
      // Cập nhật vị trí mới
      robotX = invertHorizontal ? -targetXPixel : targetXPixel;
      robotY = invertVertical ? -targetYPixel : targetYPixel;
      
      // Cập nhật hiển thị
      updateRobotPosition();
      
      // Vẽ path nếu được bật
      if (showPath) {
        traceRobotPath(oldX, oldY, robotX, robotY);
      }
      
      // Thông báo
      showNotification(`Đã di chuyển đến (${targetX.toFixed(1)}, ${targetY.toFixed(1)})`, 'info');
    }
    
    // Cập nhật bước di chuyển
    function updateStepSize(value) {
      stepSize = parseFloat(value) || 1.0;
      
      // Lưu vào localStorage
      localStorage.setItem('stepSize', stepSize);
    }
    
    // Thay đổi kích thước bản đồ
    function resizeMap(size) {
      mapSize = parseInt(size);
      map.style.width = mapSize + '%';
      mapSizeDisplay.textContent = mapSize + '%';
      
      // Cập nhật lại vị trí robot khi map thay đổi kích thước
      updateRobotPosition();
      
      // Cập nhật lưới nếu đang hiển thị
      if (showGrid) {
        createGrid();
      }
      
      // Cập nhật mini-map
      updateMiniMap();
      
      // Lưu vào localStorage
      localStorage.setItem('mapSize', mapSize);
    }
    
    // Điều chỉnh vị trí bản đồ
    function adjustMapPosition(axis, value) {
      const adjustValue = parseInt(value);
      
      if (axis === 'x') {
        mapPositionX = adjustValue;
        map.style.marginLeft = mapPositionX + '%';
        mapPositionXDisplay.textContent = mapPositionX;
      } else {
        mapPositionY = adjustValue;
        map.style.marginTop = mapPositionY + '%';
        mapPositionYDisplay.textContent = mapPositionY;
      }
      
      // Cập nhật mini-map
      updateMiniMap();
      
      // Lưu vào localStorage
      localStorage.setItem('mapPositionX', mapPositionX);
      localStorage.setItem('mapPositionY', mapPositionY);
    }
    
    // Bật/tắt chế độ di chuyển map theo chiều dọc
    function toggleMapVerticalMovement() {
      if (mapVerticalMoveCheckbox.checked) {
        mapYPositionControl.style.display = 'flex';
      } else {
        mapYPositionControl.style.display = 'none';
        mapPositionY = 0;
        map.style.marginTop = '0%';
        mapPositionYDisplay.textContent = '0';
      }
      
      // Lưu vào localStorage
      localStorage.setItem('mapVerticalMove', mapVerticalMoveCheckbox.checked);
    }
    
    // Khởi tạo kéo thả robot
    function initializeDragging() {
      robotContainer.addEventListener('mousedown', startDragging);
      document.addEventListener('mousemove', dragRobot);
      document.addEventListener('mouseup', stopDragging);
      
      // Đặt chế độ kéo thả ban đầu
      toggleDragging();
    }
    
    // Bắt đầu kéo robot
    function startDragging(e) {
      if (isDraggingEnabled) {
        isDragging = true;
        robotContainer.classList.add('dragging');
        
        // Lưu trạng thái trước khi kéo
        saveToHistory();
      }
    }
    
    // Kéo robot
    function dragRobot(e) {
      if (isDragging && isDraggingEnabled) {
        // Lấy vị trí cũ để vẽ path
        const oldX = robotX;
        const oldY = robotY;
        
        // Lấy vị trí chuột tương đối với mapContainer
        const rect = mapContainer.getBoundingClientRect();
        robotX = e.clientX - rect.left;
        robotY = e.clientY - rect.top;
        
        // Cập nhật vị trí
        updateRobotPosition();
        
        // Vẽ path nếu được bật
        if (showPath) {
          traceRobotPath(oldX, oldY, robotX, robotY);
        }
      }
    }
    
    // Dừng kéo robot
    function stopDragging() {
      if (isDragging) {
        isDragging = false;
        robotContainer.classList.remove('dragging');
      }
    }
    
    // Bật/tắt chế độ kéo thả
    function toggleDragging() {
      isDraggingEnabled = !isDraggingEnabled;
      
      if (isDraggingEnabled) {
        robotContainer.style.cursor = 'grab';
      } else {
        robotContainer.style.cursor = 'default';
      }
    }
    
    // Khởi tạo sự kiện click cho map
    function initializeMapClickEvents() {
      mapContainer.addEventListener('click', function(e) {
        if (!isDragging) {
          // Kiểm tra xem có đang click vào robot không
          const target = e.target;
          if (target !== robot && target !== robotContainer) {
            // Lưu vị trí cũ để vẽ path
            const oldX = robotX;
            const oldY = robotY;
            
            // Lưu trạng thái hiện tại để undo
            saveToHistory();
            
            // Lấy vị trí click tương đối với mapContainer
            const rect = mapContainer.getBoundingClientRect();
            robotX = e.clientX - rect.left;
            robotY = e.clientY - rect.top;
            
            // Cập nhật vị trí
            updateRobotPosition();
            
            // Vẽ path nếu được bật
            if (showPath) {
              traceRobotPath(oldX, oldY, robotX, robotY);
            }
          }
        }
      });
    }
    
    // Đảo chiều di chuyển
    function toggleInvert(axis) {
      if (axis === 'vertical') {
        invertVertical = !invertVertical;
        document.getElementById('toggle-vertical').classList.toggle('accent');
      } else {
        invertHorizontal = !invertHorizontal;
        document.getElementById('toggle-horizontal').classList.toggle('accent');
      }
      
      // Lưu vào localStorage
      localStorage.setItem('invertVertical', invertVertical);
      localStorage.setItem('invertHorizontal', invertHorizontal);
    }
    
    // Tạo lưới trên map
    function createGrid() {
      // Xóa lưới cũ
      gridOverlay.innerHTML = '';
      
      // Lấy kích thước map
      const mapWidth = map.offsetWidth;
      const mapHeight = map.offsetHeight;
      
      // Đặt kích thước của grid overlay
      gridOverlay.style.width = mapWidth + 'px';
      gridOverlay.style.height = mapHeight + 'px';
      
      // Kích thước ô lưới (cố định 10cm)
      const gridSizePixels = 10 / cmPerPixel; // 10cm
      
      // Số dòng và cột
      const numRows = Math.floor(mapHeight / gridSizePixels);
      const numCols = Math.floor(mapWidth / gridSizePixels);
      
      // Tạo các dòng ngang
      for (let i = 1; i < numRows; i++) {
        const y = i * gridSizePixels;
        const line = document.createElement('div');
        line.className = 'grid-line';
        line.style.left = '0';
        line.style.width = '100%';
        line.style.height = '1px';
        line.style.top = y + 'px';
        gridOverlay.appendChild(line);
      }
      
      // Tạo các cột dọc
      for (let i = 1; i < numCols; i++) {
        const x = i * gridSizePixels;
        const line = document.createElement('div');
        line.className = 'grid-line';
        line.style.top = '0';
        line.style.height = '100%';
        line.style.width = '1px';
        line.style.left = x + 'px';
        gridOverlay.appendChild(line);
      }
    }
    
    // Bật/tắt hiển thị lưới
    function toggleGrid() {
      showGrid = gridToggle.checked;
      
      if (showGrid) {
        createGrid();
        gridOverlay.style.display = 'block';
      } else {
        gridOverlay.style.display = 'none';
      }
      
      // Lưu vào localStorage
      localStorage.setItem('showGrid', showGrid);
    }
    
    // Bật/tắt hiển thị đường đi
    function togglePath() {
      showPath = pathToggle.checked;
      
      const pathElements = document.querySelectorAll('.path-trace');
      
      if (showPath) {
        pathElements.forEach(el => el.style.opacity = '1');
      } else {
        pathElements.forEach(el => el.style.opacity = '0');
      }
      
      // Lưu vào localStorage
      localStorage.setItem('showPath', showPath);
    }
    
    // Vẽ đường đi của robot
    function traceRobotPath(fromX, fromY, toX, toY) {
      // Tính toán độ dài và góc của đường đi
      const dx = toX - fromX;
      const dy = toY - fromY;
      const distance = Math.sqrt(dx * dx + dy * dy);
      const angle = Math.atan2(dy, dx) * 180 / Math.PI;
      
      // Tạo element vẽ đường đi
      const pathTrace = document.createElement('div');
      pathTrace.className = 'path-trace';
      pathTrace.style.position = 'absolute';
      pathTrace.style.width = distance + 'px';
      pathTrace.style.height = '2px';
      pathTrace.style.backgroundColor = '#e74c3c';
      pathTrace.style.opacity = showPath ? '1' : '0';
      pathTrace.style.left = fromX + 'px';
      pathTrace.style.top = fromY + 'px';
      pathTrace.style.transformOrigin = '0 50%';
      pathTrace.style.transform = `rotate(${angle}deg)`;
      pathTrace.style.zIndex = '5';
      
      mapContainer.appendChild(pathTrace);
      
      // Giữ lại không quá 100 đường path để tránh chậm
      const pathElements = document.querySelectorAll('.path-trace');
      if (pathElements.length > 100) {
        pathElements[0].remove();
      }
    }
    
    // Xóa tất cả đường đi
    function clearAllPaths() {
      const pathElements = document.querySelectorAll('.path-trace');
      pathElements.forEach(el => el.remove());
    }
    
    // Thêm waypoint tại vị trí robot hiện tại
    function addWaypoint() {
      waypointCounter++;
      const waypoint = {
        id: Date.now(),
        number: waypointCounter,
        x: robotX,
        y: robotY,
        angle: robotAngle
      };
      
      waypoints.push(waypoint);
      
      // Tạo marker cho waypoint
      createWaypointMarker(waypoint);
    }
    
    // Tạo marker cho waypoint
    function createWaypointMarker(waypoint) {
      const marker = document.createElement('div');
      marker.className = 'waypoint-marker';
      marker.dataset.id = waypoint.id;
      marker.style.left = waypoint.x + 'px';
      marker.style.top = waypoint.y + 'px';
      marker.title = `Waypoint ${waypoint.number}`;
      
      // Thêm nhãn
      const label = document.createElement('div');
      label.className = 'waypoint-label';
      label.textContent = `WP ${waypoint.number} (${(waypoint.x * cmPerPixel).toFixed(1)}, ${(waypoint.y * cmPerPixel).toFixed(1)}, ${waypoint.angle.toFixed(1)}°)`;
      
      marker.appendChild(label);
      mapContainer.appendChild(marker);
      
      // Thêm sự kiện click để di chuyển đến waypoint
      marker.addEventListener('click', function() {
        // Lưu vị trí cũ để vẽ path
        const oldX = robotX;
        const oldY = robotY;
        
        // Lưu trạng thái hiện tại để undo
        saveToHistory();
        
        // Di chuyển đến waypoint
        robotX = waypoint.x;
        robotY = waypoint.y;
        robotAngle = waypoint.angle;
        
        // Cập nhật vị trí
        updateRobotPosition();
        
        // Vẽ path nếu được bật
        if (showPath) {
          traceRobotPath(oldX, oldY, robotX, robotY);
        }
      });
    }
    
    // Xóa tất cả waypoints
    function clearAllWaypoints() {
      // Lưu trạng thái hiện tại để undo
      saveToHistory();
      
      // Xóa tất cả markers
      const markers = document.querySelectorAll('.waypoint-marker');
      markers.forEach(marker => marker.remove());
      
      // Xóa mảng waypoints
      waypoints = [];
      waypointCounter = 1;
      
      // Thông báo
      showNotification('Đã xóa tất cả các waypoints', 'info');
    }
    
    // Khởi tạo hiển thị tọa độ chuột
    function initializeCoordinatesDisplay() {
      mapContainer.addEventListener('mousemove', function(e) {
        const rect = mapContainer.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        // Chuyển đổi sang cm
        const mouseXCm = (mouseX * cmPerPixel).toFixed(1);
        const mouseYCm = (mouseY * cmPerPixel).toFixed(1);
        
        // Cập nhật hiển thị
        mouseXDisplay.textContent = mouseXCm;
        mouseYDisplay.textContent = mouseYCm;
        
        // Cập nhật vị trí con trỏ
        mousePositionIndicator.style.left = mouseX + 'px';
        mousePositionIndicator.style.top = mouseY + 'px';
        mousePositionIndicator.style.display = 'block';
      });
      
      mapContainer.addEventListener('mouseleave', function() {
        mousePositionIndicator.style.display = 'none';
      });
    }
    
    // Khởi tạo mini-map
    function initializeMiniMap() {
      // Cập nhật mini-map khi map thay đổi
      updateMiniMap();
      
      // Thêm sự kiện click cho mini-map để di chuyển viewport
      miniMap.addEventListener('click', function(e) {
        const rect = miniMap.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const clickY = e.clientY - rect.top;
        
        // Tính tỷ lệ
        const mapRect = map.getBoundingClientRect();
        const containerRect = mapContainer.getBoundingClientRect();
        
        const ratioX = mapRect.width / miniMap.offsetWidth;
        const ratioY = mapRect.height / miniMap.offsetHeight;
        
        // Tính vị trí scroll
        const scrollX = clickX * ratioX - containerRect.width / 2;
        const scrollY = clickY * ratioY - containerRect.height / 2;
        
        // Di chuyển viewport
        mapContainer.scrollLeft = scrollX;
        mapContainer.scrollTop = scrollY;
      });
    }
    
    // Cập nhật mini-map
    function updateMiniMap() {
      // Lấy kích thước và vị trí của map và container
      const mapRect = map.getBoundingClientRect();
      const containerRect = mapContainer.getBoundingClientRect();
      
      // Tính tỷ lệ thu nhỏ
      const scaleX = miniMap.offsetWidth / mapRect.width;
      const scaleY = miniMap.offsetHeight / mapRect.height;
      
      // Cập nhật vị trí robot trên mini-map
      const robotMiniX = robotX * scaleX;
      const robotMiniY = robotY * scaleY;
      
      miniMapRobot.style.left = robotMiniX + 'px';
      miniMapRobot.style.top = robotMiniY + 'px';
      
      // Cập nhật indicator cho phần hiển thị
      const indicatorWidth = containerRect.width * scaleX;
      const indicatorHeight = containerRect.height * scaleY;
      const indicatorLeft = mapContainer.scrollLeft * scaleX;
      const indicatorTop = mapContainer.scrollTop * scaleY;
      
      miniMapIndicator.style.width = indicatorWidth + 'px';
      miniMapIndicator.style.height = indicatorHeight + 'px';
      miniMapIndicator.style.left = indicatorLeft + 'px';
      miniMapIndicator.style.top = indicatorTop + 'px';
    }
    
    // Lưu trạng thái hiện tại vào lịch sử
    function saveToHistory() {
      // Xóa các bước sau vị trí hiện tại
      if (historyIndex < history.length - 1) {
        history.splice(historyIndex + 1);
      }
      
      // Lưu trạng thái hiện tại
      const state = {
        robotX: robotX,
        robotY: robotY,
        robotAngle: robotAngle,
        waypoints: JSON.parse(JSON.stringify(waypoints)),
        waypointCounter: waypointCounter
      };
      
      history.push(state);
      historyIndex = history.length - 1;
      
      // Giới hạn lịch sử không quá 50 bước
      if (history.length > 50) {
        history.shift();
        historyIndex--;
      }
      
      // Cập nhật trạng thái nút
      updateDisplay();
    }
    
    // Quay lại bước trước
    function undoAction() {
      if (historyIndex > 0) {
        historyIndex--;
        restoreFromHistory();
      }
    }
    
    // Tiến lại bước sau
    function redoAction() {
      if (historyIndex < history.length - 1) {
        historyIndex++;
        restoreFromHistory();
      }
    }
    
    // Khôi phục trạng thái từ lịch sử
    function restoreFromHistory() {
      const state = history[historyIndex];
      
      // Khôi phục vị trí robot
      robotX = state.robotX;
      robotY = state.robotY;
      robotAngle = state.robotAngle;
      
      // Khôi phục waypoints
      waypoints = JSON.parse(JSON.stringify(state.waypoints));
      waypointCounter = state.waypointCounter;
      
      // Xóa tất cả markers
      const markers = document.querySelectorAll('.waypoint-marker');
      markers.forEach(marker => marker.remove());
      
      // Tạo lại markers
      waypoints.forEach(waypoint => createWaypointMarker(waypoint));
      
      // Cập nhật hiển thị
      updateRobotPosition();
    }
    
    // Khởi tạo kéo thả cho block lệnh
    function initializeDragAndDrop() {
      dragIndicator = document.querySelector('.drag-indicator');
      
      // Thêm sự kiện cho vùng program
      programArea.addEventListener('dragover', function(e) {
        if (isRunningProgram) return;
        
        // Lấy vị trí chuột
        const mouseY = e.clientY;
        
        // Lấy tất cả các block trong program area
        const blocks = Array.from(programArea.querySelectorAll('.command-block'));
        
        // Tìm vị trí drop
        let dropIndex = blocks.length;
        
        for (let i = 0; i < blocks.length; i++) {
          const block = blocks[i];
          const rect = block.getBoundingClientRect();
          
          if (mouseY < rect.top + rect.height / 2) {
            dropIndex = i;
            break;
          }
        }
        
        // Cập nhật vị trí indicator
        if (blocks.length === 0) {
          dragIndicator.style.display = 'block';
          dragIndicator.style.margin = '0';
          dragIndicator.classList.add('active');
        } else if (dropIndex === 0) {
          dragIndicator.style.display = 'block';
          dragIndicator.style.margin = '0 0 5px 0';
          blocks[0].before(dragIndicator);
          dragIndicator.classList.add('active');
        } else if (dropIndex === blocks.length) {
          dragIndicator.style.display = 'block';
          dragIndicator.style.margin = '5px 0 0 0';
          blocks[blocks.length - 1].after(dragIndicator);
          dragIndicator.classList.add('active');
        } else {
          dragIndicator.style.display = 'block';
          dragIndicator.style.margin = '5px 0';
          blocks[dropIndex].before(dragIndicator);
          dragIndicator.classList.add('active');
        }
      });
    }
    
    // Bắt đầu kéo block
    function dragStart(event) {
      if (isRunningProgram) return;
      
      const block = event.target.closest('.command-block');
      
      // Nếu là từ thư viện, sẽ tạo một bản sao
      if (block.parentElement.classList.contains('block-library')) {
        // Tạo block mới để kéo thả
        const clonedBlock = block.cloneNode(true);
        
        // Thêm nút điều khiển
        const controls = document.createElement('div');
        controls.className = 'block-controls';
        
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'toggle-block';
        toggleBtn.innerHTML = '✓';
        toggleBtn.title = 'Bật/tắt lệnh';
        toggleBtn.onclick = function(e) {
          e.stopPropagation();
          toggleCommandBlock(this.parentElement.parentElement);
        };
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-block';
        deleteBtn.innerHTML = '×';
        deleteBtn.title = 'Xóa lệnh';
        deleteBtn.onclick = function(e) {
          e.stopPropagation();
          deleteCommandBlock(this.parentElement.parentElement);
        };
        
        controls.appendChild(toggleBtn);
        controls.appendChild(deleteBtn);
        clonedBlock.appendChild(controls);
        
        // Đặt dữ liệu cho event kéo thả
        event.dataTransfer.setData('text/plain', 'new');
        draggedBlock = clonedBlock;
      } else {
        // Đang kéo block có sẵn trong program area
        event.dataTransfer.setData('text/plain', 'existing');
        draggedBlock = block;
        draggedBlockIndex = Array.from(programArea.querySelectorAll('.command-block')).indexOf(block);
      }
    }
    
    // Cho phép thả
    function allowDrop(event) {
      if (isRunningProgram) return;
      event.preventDefault();
    }
    
    // Khi drag vào vùng program
    function dragEnter(event) {
      if (isRunningProgram) return;
      event.preventDefault();
    }
    
    // Khi drag ra khỏi vùng program
    function dragLeave(event) {
      if (isRunningProgram) return;
      
      // Ẩn indicator khi kéo ra ngoài
      if (event.relatedTarget === null || !programArea.contains(event.relatedTarget)) {
        dragIndicator.classList.remove('active');
      }
    }
    
    // Khi thả block
    function drop(event) {
      if (isRunningProgram) return;
      event.preventDefault();
      
      // Ẩn indicator
      dragIndicator.classList.remove('active');
      
      // Xác định vị trí thả
      const blocks = Array.from(programArea.querySelectorAll('.command-block'));
      const mouseY = event.clientY;
      
      let dropIndex = blocks.length;
      
      for (let i = 0; i < blocks.length; i++) {
        const block = blocks[i];
        const rect = block.getBoundingClientRect();
        
        if (mouseY < rect.top + rect.height / 2) {
          dropIndex = i;
          break;
        }
      }
      
      // Kiểm tra xem có phải là di chuyển block hiện có không
      const dataType = event.dataTransfer.getData('text/plain');
      
      if (dataType === 'existing') {
        // Nếu thả block ở vị trí cũ, không làm gì cả
        if (draggedBlockIndex === dropIndex || draggedBlockIndex + 1 === dropIndex) {
          return;
        }
        
        // Di chuyển block đến vị trí mới
        draggedBlock.remove();
        
        if (dropIndex === blocks.length || draggedBlockIndex < dropIndex) {
          if (dropIndex === blocks.length) {
            programArea.appendChild(draggedBlock);
          } else {
            blocks[dropIndex].before(draggedBlock);
          }
        } else {
          blocks[dropIndex].before(draggedBlock);
        }
        
        // Lưu lịch sử cho hành động sắp xếp lại
        saveToHistory();
      } else {
        // Thêm block mới vào program area
        if (dropIndex === blocks.length) {
          programArea.appendChild(draggedBlock);
        } else {
          blocks[dropIndex].before(draggedBlock);
        }
        
        // Thêm sự kiện cho block mới
        addBlockEvents(draggedBlock);
        
        // Lưu lịch sử cho hành động thêm mới
        saveToHistory();
      }
      
      // Reset
      draggedBlock = null;
      draggedBlockIndex = -1;
    }
    
    // Thêm sự kiện cho block lệnh
    function addBlockEvents(block) {
      block.addEventListener('click', function() {
        // Bỏ chọn block hiện tại
        const selectedBlock = programArea.querySelector('.selected-block');
        if (selectedBlock) {
          selectedBlock.classList.remove('selected-block');
        }
        
        // Chọn block này
        block.classList.add('selected-block');
        selectedBlockIndex = Array.from(programArea.querySelectorAll('.command-block')).indexOf(block);
      });
    }
    
    // Bật/tắt block lệnh
    function toggleCommandBlock(block) {
      block.classList.toggle('disabled');
    }
    
    // Xóa block lệnh
    function deleteCommandBlock(block) {
      // Lưu lịch sử trước khi xóa
      saveToHistory();
      
      // Xóa block
      block.remove();
    }
    
    // Chạy chương trình
    function runProgram() {
      // Nếu đang chạy, dừng lại
      if (isRunningProgram) {
        stopProgram();
        return;
      }
      
      // Lưu trạng thái ban đầu
      saveToHistory();
      
      // Lấy tất cả các block lệnh
      const blocks = Array.from(programArea.querySelectorAll('.command-block')).filter(block => !block.classList.contains('disabled'));
      
      if (blocks.length === 0) {
        showNotification('Không có lệnh nào để chạy', 'warning');
        return;
      }
      
      // Bắt đầu chạy
      isRunningProgram = true;
      isProgramPaused = false;
      currentProgramStepIndex = 0;
      
      // Cập nhật UI
      runProgramButton.innerHTML = '<i>■</i> Dừng chương trình';
      runProgramButton.classList.add('running');
      
      // Lưu vị trí robot ban đầu
      const initialPosition = {
        x: robotX,
        y: robotY,
        angle: robotAngle
      };
      
      // Chạy từng bước một
      runProgramStep(blocks, initialPosition);
    }
    
    // Chạy từng bước của chương trình
    function runProgramStep(blocks, initialPosition) {
      // Kiểm tra nếu đã dừng
      if (!isRunningProgram || isProgramPaused) {
        return;
      }
      
      // Kiểm tra nếu đã chạy hết
      if (currentProgramStepIndex >= blocks.length) {
        stopProgram();
        showNotification('Chương trình đã chạy xong', 'info');
        return;
      }
      
      // Lấy block hiện tại
      const currentBlock = blocks[currentProgramStepIndex];
      
      // Đánh dấu block đang chạy
      const previousSelected = programArea.querySelector('.selected-block');
      if (previousSelected) {
        previousSelected.classList.remove('selected-block');
      }
      currentBlock.classList.add('selected-block');
      
      // Lấy thông tin lệnh
      const command = currentBlock.dataset.command;
      const valueInput = currentBlock.querySelector('input');
      const value = parseFloat(valueInput.value) || 0;
      
      // Lấy vị trí hiện tại
      const oldX = robotX;
      const oldY = robotY;
      
      // Thực hiện lệnh
      executeCommand(command, value);
      
      // Vẽ path nếu được bật
      if (showPath) {
        traceRobotPath(oldX, oldY, robotX, robotY);
      }
      
      // Tiến đến bước tiếp theo sau một khoảng thời gian
      currentProgramStepIndex++;
      programRunTimer = setTimeout(function() {
        runProgramStep(blocks, initialPosition);
      }, 500);
    }
    
    // Thực hiện lệnh cụ thể
    function executeCommand(command, value) {
      switch (command) {
        case 'moveUp':
          moveRobotInDirection(0, -1, value);
          break;
        case 'moveDown':
          moveRobotInDirection(0, 1, value);
          break;
        case 'moveLeft':
          moveRobotInDirection(-1, 0, value);
          break;
        case 'moveRight':
          moveRobotInDirection(1, 0, value);
          break;
        case 'moveUpLeft':
          moveRobotInDirection(-1, -1, value);
          break;
        case 'moveUpRight':
          moveRobotInDirection(1, -1, value);
          break;
        case 'moveDownLeft':
          moveRobotInDirection(-1, 1, value);
          break;
        case 'moveDownRight':
          moveRobotInDirection(1, 1, value);
          break;
        case 'rotateLeft':
          rotateRobot(-value);
          break;
        case 'rotateRight':
          rotateRobot(value);
          break;
        case 'spin':
          // Quay số vòng tương ứng
          for (let i = 0; i < value; i++) {
            rotateRobot(360);
          }
          break;
      }
    }
    
    // Dừng chương trình
    function stopProgram() {
      isRunningProgram = false;
      isProgramPaused = false;
      
      // Hủy timer
      if (programRunTimer) {
        clearTimeout(programRunTimer);
        programRunTimer = null;
      }
      
      // Cập nhật UI
      runProgramButton.innerHTML = '<i>▶</i> Chạy chương trình';
      runProgramButton.classList.remove('running');
      
      // Bỏ chọn block
      const selectedBlock = programArea.querySelector('.selected-block');
      if (selectedBlock) {
        selectedBlock.classList.remove('selected-block');
      }
    }
    
    // Lưu chương trình
    function saveProgram() {
      const programName = document.getElementById('program-name').value.trim();
      
      if (!programName) {
        showNotification('Vui lòng nhập tên chương trình', 'warning');
        return;
      }
      
      // Lấy tất cả các block
      const blocks = Array.from(programArea.querySelectorAll('.command-block'));
      
      // Lưu thông tin từng block
      const programData = blocks.map(block => {
        return {
          command: block.dataset.command,
          value: parseFloat(block.querySelector('input').value) || 0,
          disabled: block.classList.contains('disabled')
        };
      });
      
      // Lấy danh sách chương trình hiện có
      let savedPrograms = JSON.parse(localStorage.getItem('savedPrograms') || '{}');
      
      // Lưu chương trình mới
      savedPrograms[programName] = {
        name: programName,
        timestamp: Date.now(),
        data: programData
      };
      
      // Lưu vào localStorage
      localStorage.setItem('savedPrograms', JSON.stringify(savedPrograms));
      
      // Cập nhật danh sách
      loadSavedPrograms();
      
      // Thông báo
      showNotification(`Đã lưu chương trình "${programName}"`, 'info');
    }
    
    // Tải danh sách chương trình đã lưu
    function loadSavedPrograms() {
      const savedProgramsList = document.getElementById('saved-programs-list');
      savedProgramsList.innerHTML = '';
      
      // Lấy danh sách chương trình
      const savedPrograms = JSON.parse(localStorage.getItem('savedPrograms') || '{}');
      
      // Sắp xếp theo thời gian gần nhất
      const programNames = Object.keys(savedPrograms).sort((a, b) => {
        return savedPrograms[b].timestamp - savedPrograms[a].timestamp;
      });
      
      // Hiển thị từng chương trình
      for (const name of programNames) {
        const program = savedPrograms[name];
        
        const programItem = document.createElement('div');
        programItem.className = 'saved-item';
        programItem.innerHTML = `
          <span>${program.name}</span>
          <button class="delete-program" title="Xóa chương trình">×</button>
        `;
        
        // Thêm sự kiện click để tải chương trình
        programItem.addEventListener('click', function(e) {
          if (e.target.classList.contains('delete-program')) {
            return; // Xử lý ở sự kiện khác
          }
          loadProgram(program.name);
        });
        
        // Thêm sự kiện xóa chương trình
        const deleteButton = programItem.querySelector('.delete-program');
        deleteButton.addEventListener('click', function(e) {
          e.stopPropagation();
          deleteProgram(program.name);
        });
        
        savedProgramsList.appendChild(programItem);
      }
      
      // Hiển thị thông báo nếu không có chương trình nào
      if (programNames.length === 0) {
        const emptyItem = document.createElement('div');
        emptyItem.className = 'saved-item';
        emptyItem.textContent = 'Chưa có chương trình nào được lưu';
        savedProgramsList.appendChild(emptyItem);
      }
    }
    
    // Tải một chương trình cụ thể
    function loadProgram(programName) {
      // Lấy danh sách chương trình
      const savedPrograms = JSON.parse(localStorage.getItem('savedPrograms') || '{}');
      
      if (!savedPrograms[programName]) {
        showNotification('Không tìm thấy chương trình', 'error');
        return;
      }
      
      // Lưu trạng thái hiện tại để undo
      saveToHistory();
      
      // Xóa tất cả block hiện tại
      programArea.querySelectorAll('.command-block').forEach(block => block.remove());
      
      // Tạo các block mới
      const program = savedPrograms[programName];
      
      for (const blockData of program.data) {
        // Tìm block mẫu tương ứng
        const templateBlock = document.querySelector(`.block-library .command-block[data-command="${blockData.command}"]`);
        
        if (templateBlock) {
          // Sao chép block
          const newBlock = templateBlock.cloneNode(true);
          
          // Cập nhật giá trị
          const valueInput = newBlock.querySelector('input');
          valueInput.value = blockData.value;
          
          // Thêm nút điều khiển
          const controls = document.createElement('div');
          controls.className = 'block-controls';
          
          const toggleBtn = document.createElement('button');
          toggleBtn.className = 'toggle-block';
          toggleBtn.innerHTML = '✓';
          toggleBtn.title = 'Bật/tắt lệnh';
          toggleBtn.onclick = function(e) {
            e.stopPropagation();
            toggleCommandBlock(this.parentElement.parentElement);
          };
          
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'delete-block';
          deleteBtn.innerHTML = '×';
          deleteBtn.title = 'Xóa lệnh';
          deleteBtn.onclick = function(e) {
            e.stopPropagation();
            deleteCommandBlock(this.parentElement.parentElement);
          };
          
          controls.appendChild(toggleBtn);
          controls.appendChild(deleteBtn);
          newBlock.appendChild(controls);
          
          // Đặt trạng thái
          if (blockData.disabled) {
            newBlock.classList.add('disabled');
          }
          
          // Thêm vào program area
          programArea.appendChild(newBlock);
          
          // Thêm sự kiện
          addBlockEvents(newBlock);
        }
      }
      
      // Cập nhật tên chương trình
      document.getElementById('program-name').value = programName;
      
      // Thông báo
      showNotification(`Đã tải chương trình "${programName}"`, 'info');
    }
    
    // Xóa một chương trình
    function deleteProgram(programName) {
      // Lấy danh sách chương trình
      let savedPrograms = JSON.parse(localStorage.getItem('savedPrograms') || '{}');
      
      if (!savedPrograms[programName]) {
        showNotification('Không tìm thấy chương trình', 'error');
        return;
      }
      
      // Xóa chương trình
      delete savedPrograms[programName];
      
      // Lưu vào localStorage
      localStorage.setItem('savedPrograms', JSON.stringify(savedPrograms));
      
      // Cập nhật danh sách
      loadSavedPrograms();
      
      // Thông báo
      showNotification(`Đã xóa chương trình "${programName}"`, 'info');
    }
    
    // Hiển thị hộp thoại xuất/nhập
    function showExportDialog() {
      // Lấy danh sách chương trình
      const savedPrograms = JSON.parse(localStorage.getItem('savedPrograms') || '{}');
      
      // Tạo dữ liệu xuất
      const exportData = {
        version: '1.0',
        programs: savedPrograms,
        settings: {
          robotSize,
          stepSize,
          mapSize,
          mapPositionX,
          mapPositionY,
          showGrid,
          showPath,
          invertVertical,
          invertHorizontal
        }
      };
      
      // Chuyển thành chuỗi JSON
      const exportString = JSON.stringify(exportData, null, 2);
      
      // Tạo hộp thoại
      const dialogOverlay = document.createElement('div');
      dialogOverlay.className = 'modal-overlay';
      
      const dialog = document.createElement('div');
      dialog.className = 'modal-dialog';
      dialog.innerHTML = `
        <h4>Xuất/Nhập Cấu Hình</h4>
        <textarea class="import-export-textarea">${exportString}</textarea>
        <div class="modal-buttons">
          <button class="secondary" onclick="importConfiguration(this.parentElement.previousElementSibling.value)">Nhập</button>
          <button class="primary" onclick="closeDialog()">Đóng</button>
        </div>
      `;
      
      dialogOverlay.appendChild(dialog);
      document.body.appendChild(dialogOverlay);
      
      // Hiển thị hộp thoại
      setTimeout(() => {
        dialogOverlay.classList.add('active');
      }, 10);
    }
    
    // Đóng hộp thoại
    function closeDialog() {
      const dialog = document.querySelector('.modal-overlay');
      dialog.classList.remove('active');
      
      // Xóa hộp thoại sau khi ẩn
      setTimeout(() => {
        dialog.remove();
      }, 300);
    }
    
    // Nhập cấu hình
    function importConfiguration(jsonString) {
      try {
        // Phân tích chuỗi JSON
        const importData = JSON.parse(jsonString);
        
        // Kiểm tra phiên bản
        if (!importData.version) {
          throw new Error('Dữ liệu không hợp lệ');
        }
        
        // Nhập chương trình
        if (importData.programs) {
          localStorage.setItem('savedPrograms', JSON.stringify(importData.programs));
          loadSavedPrograms();
        }
        
        // Nhập cài đặt
        if (importData.settings) {
          const settings = importData.settings;
          
          // Cập nhật các cài đặt
          if (settings.robotSize) {
            resizeRobot(settings.robotSize);
            robotSizeSlider.value = settings.robotSize;
          }
          
          if (settings.stepSize) {
            updateStepSize(settings.stepSize);
            stepSizeInput.value = settings.stepSize;
          }
          
          if (settings.mapSize) {
            resizeMap(settings.mapSize);
            mapSizeSlider.value = settings.mapSize;
          }
          
          if (settings.mapPositionX !== undefined) {
            adjustMapPosition('x', settings.mapPositionX);
            mapPositionXSlider.value = settings.mapPositionX;
          }
          
          if (settings.mapPositionY !== undefined) {
            adjustMapPosition('y', settings.mapPositionY);
            mapPositionYSlider.value = settings.mapPositionY;
            mapVerticalMoveCheckbox.checked = true;
            toggleMapVerticalMovement();
          }
          
          if (settings.showGrid !== undefined) {
            gridToggle.checked = settings.showGrid;
            toggleGrid();
          }
          
          if (settings.showPath !== undefined) {
            pathToggle.checked = settings.showPath;
            togglePath();
          }
          
          if (settings.invertVertical !== undefined && settings.invertVertical) {
            if (!invertVertical) toggleInvert('vertical');
          }
          
          if (settings.invertHorizontal !== undefined && settings.invertHorizontal) {
            if (!invertHorizontal) toggleInvert('horizontal');
          }
        }
        
        // Đóng hộp thoại
        closeDialog();
        
        // Thông báo
        showNotification('Đã nhập cấu hình thành công', 'info');
        
      } catch (error) {
        showNotification('Lỗi: ' + error.message, 'error');
      }
    }
    
    // Hiển thị tooltip
    function setupTooltips() {
      // Tạo element cho tooltip
      const tooltip = document.createElement('div');
      tooltip.className = 'tooltip';
      document.body.appendChild(tooltip);
      
      // Thêm sự kiện cho các element có title
      document.querySelectorAll('[title]').forEach(element => {
        element.addEventListener('mouseenter', function(e) {
          const title = this.getAttribute('title');
          
          if (!title) return;
          
          // Lưu title gốc và xóa để tránh tooltip mặc định
          this.dataset.originalTitle = title;
          this.removeAttribute('title');
          
          // Hiển thị tooltip tùy chỉnh
          tooltip.textContent = title;
          tooltip.style.opacity = '1';
          
          // Vị trí tooltip
          updateTooltipPosition(e, tooltip);
        });
        
        element.addEventListener('mouseleave', function() {
          // Khôi phục title gốc
          if (this.dataset.originalTitle) {
            this.setAttribute('title', this.dataset.originalTitle);
            delete this.dataset.originalTitle;
          }
          
          // Ẩn tooltip
          tooltip.style.opacity = '0';
        });
        
        element.addEventListener('mousemove', function(e) {
          // Cập nhật vị trí tooltip khi di chuyển chuột
          updateTooltipPosition(e, tooltip);
        });
      });
    }
    
    // Cập nhật vị trí tooltip
    function updateTooltipPosition(e, tooltip) {
      const offset = 15;
      tooltip.style.left = (e.pageX + offset) + 'px';
      tooltip.style.top = (e.pageY + offset) + 'px';
    }
    
    // Tạo element thông báo
    function createNotificationElement() {
      const notification = document.createElement('div');
      notification.className = 'notification';
      document.body.appendChild(notification);
    }
    
    // Hiển thị thông báo
    function showNotification(message, type = 'success') {
      const notification = document.querySelector('.notification');
      
      // Xóa class cũ
      notification.className = 'notification';
      
      // Thêm class mới
      notification.classList.add(type);
      
      // Đặt nội dung
      notification.textContent = message;
      
      // Hiển thị thông báo
      notification.classList.add('show');
      
      // Tự động ẩn sau 3 giây
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
    
    // Thiết lập keyboard shortcuts
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', function(e) {
        // Ctrl+Z để undo
        if (e.ctrlKey && e.key === 'z') {
          e.preventDefault();
          undoAction();
        }
        
        // Ctrl+Y để redo
        if (e.ctrlKey && e.key === 'y') {
          e.preventDefault();
          redoAction();
        }
        
        // Space để chạy/dừng chương trình
        if (e.key === ' ' && document.activeElement.tagName !== 'INPUT') {
          e.preventDefault();
          runProgram();
        }
        
        // Escape để dừng chương trình
        if (e.key === 'Escape' && isRunningProgram) {
          e.preventDefault();
          stopProgram();
        }
        
        // Delete để xóa block đang chọn
        if (e.key === 'Delete' && selectedBlockIndex !== -1) {
          e.preventDefault();
          const blocks = Array.from(programArea.querySelectorAll('.command-block'));
          if (blocks[selectedBlockIndex]) {
            deleteCommandBlock(blocks[selectedBlockIndex]);
          }
        }
        
        // Các phím mũi tên để di chuyển robot
        if (!isRunningProgram && !e.ctrlKey && document.activeElement.tagName !== 'INPUT') {
          switch (e.key) {
            case 'ArrowUp':
              e.preventDefault();
              moveRobotInDirection(0, -1);
              break;
            case 'ArrowDown':
              e.preventDefault();
              moveRobotInDirection(0, 1);
              break;
            case 'ArrowLeft':
              e.preventDefault();
              moveRobotInDirection(-1, 0);
              break;
            case 'ArrowRight':
              e.preventDefault();
              moveRobotInDirection(1, 0);
              break;
            case 'Home':
              e.preventDefault();
              centerRobot();
              break;
          }
        }
      });
    }
    
    // Chuyển đổi chế độ sáng/tối
    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      
      const isDarkMode = document.body.classList.contains('dark-mode');
      document.getElementById('theme-text').textContent = isDarkMode ? 'Chế độ sáng' : 'Chế độ tối';
      
      // Lưu vào localStorage
      localStorage.setItem('darkMode', isDarkMode);
    }
    
    // Tải chế độ từ localStorage
    function loadThemeFromStorage() {
      const isDarkMode = localStorage.getItem('darkMode') === 'true';
      
      if (isDarkMode) {
        document.body.classList.add('dark-mode');
        document.getElementById('theme-text').textContent = 'Chế độ sáng';
      }
    }
    
    // Tải các cài đặt từ localStorage
    function loadSettingsFromStorage() {
      // Kích thước robot
      const savedRobotSize = localStorage.getItem('robotSize');
      if (savedRobotSize) {
        resizeRobot(savedRobotSize);
        robotSizeSlider.value = savedRobotSize;
      }
      
      // Bước di chuyển
      const savedStepSize = localStorage.getItem('stepSize');
      if (savedStepSize) {
        updateStepSize(savedStepSize);
        stepSizeInput.value = savedStepSize;
      }
      
      // Kích thước map
      const savedMapSize = localStorage.getItem('mapSize');
      if (savedMapSize) {
        resizeMap(savedMapSize);
        mapSizeSlider.value = savedMapSize;
      }
      
      // Vị trí map
      const savedMapPositionX = localStorage.getItem('mapPositionX');
      if (savedMapPositionX) {
        adjustMapPosition('x', savedMapPositionX);
        mapPositionXSlider.value = savedMapPositionX;
      }
      
      const savedMapPositionY = localStorage.getItem('mapPositionY');
      if (savedMapPositionY) {
        adjustMapPosition('y', savedMapPositionY);
        mapPositionYSlider.value = savedMapPositionY;
      }
      
      // Di chuyển map theo chiều dọc
      const savedMapVerticalMove = localStorage.getItem('mapVerticalMove') === 'true';
      if (savedMapVerticalMove) {
        mapVerticalMoveCheckbox.checked = true;
        toggleMapVerticalMovement();
      }
      
      // Hiển thị lưới
      const savedShowGrid = localStorage.getItem('showGrid') === 'true';
      if (savedShowGrid) {
        gridToggle.checked = true;
        toggleGrid();
      }
      
      // Hiển thị path
      const savedShowPath = localStorage.getItem('showPath') === 'true';
      if (savedShowPath) {
        pathToggle.checked = true;
        togglePath();
      }
      
      // Đảo chiều
      const savedInvertVertical = localStorage.getItem('invertVertical') === 'true';
      if (savedInvertVertical) {
        toggleInvert('vertical');
      }
      
      const savedInvertHorizontal = localStorage.getItem('invertHorizontal') === 'true';
      if (savedInvertHorizontal) {
        toggleInvert('horizontal');
      }
      
      // Tải chế độ sáng/tối
      loadThemeFromStorage();
    }
    
    // Tải cài đặt khi trang đã tải xong
    window.addEventListener('load', loadSettingsFromStorage);
  </script>
</body>
</html>
