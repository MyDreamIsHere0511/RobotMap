<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Robot Map Interface</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
      font-family: sans-serif;
      overflow: hidden;
    }
    
    #sidebar {
      width: 320px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #ccc;
      background-color: #f5f5f5;
      overflow-y: auto;
      resize: horizontal;
      min-width: 250px;
      max-width: 500px;
    }
    
    #sidebar-resizer {
      position: absolute;
      width: 8px;
      height: 100%;
      left: 320px;
      top: 0;
      background-color: transparent;
      cursor: ew-resize;
      z-index: 100;
    }
    
    #display-area {
      flex: 1;
      position: relative;
      overflow: hidden;
      background-color: #eaeaea;
    }
    
    #map-container {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    #map {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    
    #robot {
      position: absolute;
      width: 50px; /* K√≠ch th∆∞·ªõc m·∫∑c ƒë·ªãnh */
      transform-origin: center center;
      transition: transform 0.1s linear, left 0.1s linear, top 0.1s linear;
    }
    
    /* Ch·ªâ th·ªã h∆∞·ªõng robot */
    .robot-direction-indicator {
      position: absolute;
      width: 30px;
      height: 30px;
      background-color: rgba(255, 255, 255, 0.7);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      color: #333;
      cursor: pointer;
      border: 2px solid #555;
      z-index: 20;
      display: none;
    }
    
    #direction-w {
      top: -35px;
      left: 50%;
      transform: translateX(-50%);
    }
    
    #direction-a {
      left: -35px;
      top: 50%;
      transform: translateY(-50%);
    }
    
    #direction-s {
      bottom: -35px;
      left: 50%;
      transform: translateX(-50%);
    }
    
    #direction-d {
      right: -35px;
      top: 50%;
      transform: translateY(-50%);
    }
    
    /* Ph√¢n khu 1: ƒêi·ªÅu khi·ªÉn */
    #control-panel {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    
    .controls-title {
      margin: 8px 0;
      color: #333;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .history-controls {
      display: flex;
      gap: 5px;
    }
    
    .history-controls button {
      padding: 4px 8px;
      background-color: #e6e6e6;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .movement-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 5px;
      margin-bottom: 10px;
    }
    
    .movement-grid button {
      padding: 8px 0;
      background-color: #e6e6e6;
      border: 1px solid #ccc;
      cursor: pointer;
      border-radius: 4px;
    }
    
    .movement-grid button:hover {
      background-color: #d9d9d9;
    }
    
    .rotation-controls {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
    }
    
    .rotation-controls button {
      flex: 1;
      padding: 8px 0;
      background-color: #e6e6e6;
      border: 1px solid #ccc;
      cursor: pointer;
      border-radius: 4px;
    }
    
    .toggle-controls {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .direction-controls {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 8px;
    }
    
    .direction-controls button {
      padding: 4px 8px;
      background-color: #e6e6e6;
      border: 1px solid #ccc;
      cursor: pointer;
      border-radius: 4px;
    }
    
    .direction-controls button.set-direction {
      flex: 2;
      background-color: #ffc107;
    }
    
    .save-controls {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .save-controls button {
      padding: 8px 0;
      background-color: #e6e6e6;
      border: 1px solid #ccc;
      cursor: pointer;
      border-radius: 4px;
    }
    
    .save-controls button.save-position {
      background-color: #d1e7dd;
    }
    
    .save-controls button.save-size {
      background-color: #cfe2ff;
    }
    
    .save-controls button.save-program {
      background-color: #fff3cd;
    }
    
    .saved-items {
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      max-height: 120px;
      overflow-y: auto;
      background-color: white;
    }
    
    .saved-item {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .saved-item:hover {
      background-color: #f5f5f5;
    }
    
    .saved-item button {
      background: none;
      border: none;
      color: #dc3545;
      cursor: pointer;
      font-weight: bold;
    }
    
    .unit-display {
      margin-top: 5px;
      padding: 5px;
      background-color: #f8f9fa;
      border-radius: 4px;
      border: 1px solid #d1d1d1;
      font-size: 0.9em;
    }
    
    .unit-display strong {
      color: #0d6efd;
    }
    
    .robot-resize-controls {
      margin: 10px 0;
      display: flex;
      align-items: center;
    }
    
    .robot-resize-controls label {
      margin-right: 10px;
    }
    
    .robot-resize-controls input {
      width: 100%;
    }
    
    /* Ph√¢n khu 2: L·∫≠p tr√¨nh kh·ªëi */
    #block-programming {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    
    .block-container {
      display: flex;
      margin-bottom: 10px;
      max-height: 250px; /* Gi·ªõi h·∫°n chi·ªÅu cao ƒë·ªÉ v·ª´a m√†n h√¨nh */
    }
    
    .block-library {
      flex: 1;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px;
      background-color: white;
      overflow-y: auto;
    }
    
    .program-area {
      flex: 1;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px;
      background-color: white;
      margin-left: 10px;
      overflow-y: auto;
    }
    
    .command-block {
      margin: 3px 0;
      padding: 5px;
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: move;
      display: flex;
      align-items: center;
      font-size: 0.9em;
      position: relative;
    }
    
    .command-block input {
      width: 40px;
      margin-left: 5px;
      text-align: center;
    }
    
    .unit-label {
      font-size: 0.8em;
      margin-left: 2px;
      color: #666;
    }
    
    .command-block .block-controls {
      margin-left: auto;
      display: flex;
      gap: 3px;
    }
    
    .command-block .block-controls button {
      background: none;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    
    .command-block .block-controls .move-up {
      color: #198754;
    }
    
    .command-block .block-controls .move-down {
      color: #0d6efd;
    }
    
    .command-block .block-controls .delete-block {
      color: #dc3545;
    }
    
    .command-block.move-up { background-color: #d1e7dd; }
    .command-block.move-down { background-color: #f8d7da; }
    .command-block.move-left { background-color: #cfe2ff; }
    .command-block.move-right { background-color: #fff3cd; }
    .command-block.move-upleft { background-color: #d8f3dc; }
    .command-block.move-upright { background-color: #e9ecef; }
    .command-block.move-downleft { background-color: #e0e1ff; }
    .command-block.move-downright { background-color: #ffe8d9; }
    .command-block.spin { background-color: #d8d8ff; }
    .command-block.rotate-left { background-color: #ffccd5; }
    .command-block.rotate-right { background-color: #c9f7f5; }
    
    .run-program {
      display: block;
      width: 100%;
      padding: 8px;
      margin-top: 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .run-program:hover {
      background-color: #45a049;
    }
    
    /* ƒêi·ªÉm resize cho robot */
    .resize-handle {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: #ff5252;
      border-radius: 50%;
      bottom: -5px;
      right: -5px;
      cursor: nwse-resize;
      z-index: 10;
    }
    
    /* Input t√™n l∆∞u */
    .save-name-dialog {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 1000;
      display: none;
    }
    
    .save-name-dialog input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .save-name-dialog button {
      padding: 8px;
      margin-right: 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .save-name-dialog button.save {
      background-color: #4CAF50;
      color: white;
    }
    
    .save-name-dialog button.cancel {
      background-color: #f8f9fa;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <!-- Ph√¢n khu 1: ƒêi·ªÅu khi·ªÉn tr·ª±c ti·∫øp -->
    <div id="control-panel">
      <h4 class="controls-title">
        Di chuy·ªÉn
        <div class="history-controls">
          <button id="undo-button-1" onclick="undoAction()" title="Quay l·∫°i b∆∞·ªõc tr∆∞·ªõc (Z)">‚Ü©</button>
          <button id="redo-button-1" onclick="redoAction()" title="Ti·∫øn l·∫°i b∆∞·ªõc sau (Y)">‚Ü™</button>
        </div>
      </h4>
      
      <div class="unit-display">
        T·ª∑ l·ªá hi·ªán t·∫°i: <strong><span id="scale-ratio">1</span> cm/pixel</strong>
      </div>
      
      <div class="movement-grid">
        <button onclick="moveRobotInDirection(-1, -1)">‚Üñ (U)</button>
        <button onclick="moveRobotInDirection(0, -1)">‚Üë (W)</button>
        <button onclick="moveRobotInDirection(1, -1)">‚Üó (I)</button>
        <button onclick="moveRobotInDirection(-1, 0)">‚Üê (A)</button>
        <button onclick="spinRobot()">‚ü≥ (Space)</button>
        <button onclick="moveRobotInDirection(1, 0)">‚Üí (D)</button>
        <button onclick="moveRobotInDirection(-1, 1)">‚Üô (J)</button>
        <button onclick="moveRobotInDirection(0, 1)">‚Üì (S)</button>
        <button onclick="moveRobotInDirection(1, 1)">‚Üò (K)</button>
      </div>
      
      <div class="rotation-controls">
        <button onclick="rotate(-2)">‚ü≤ Quay Tr√°i (Q)</button>
        <button onclick="rotate(2)">‚ü≥ Quay Ph·∫£i (E)</button>
        <button onclick="centerRobot()">‚ü¥ Reset</button>
      </div>
      
      <div class="toggle-controls">
        <div class="toggle-robot">
          <label><input type="checkbox" id="toggle-robot" checked onchange="toggleRobot()"> ·∫®n/Hi·ªán Robot</label>
        </div>
        
        <div class="direction-controls">
          <button class="set-direction" onclick="toggleDirectionIndicators()">Ch·ªçn h∆∞·ªõng robot</button>
        </div>
      </div>
      
      <div class="robot-resize-controls">
        <label>K√≠ch th∆∞·ªõc robot:</label>
        <input type="range" id="robot-size" min="20" max="150" value="50" oninput="resizeRobot(this.value)">
      </div>
      
      <div class="save-controls">
        <button class="save-position" onclick="showSaveDialog('position')">üíæ L∆∞u v·ªã tr√≠ hi·ªán t·∫°i</button>
        <button class="save-size" onclick="showSaveDialog('size')">üìè L∆∞u k√≠ch th∆∞·ªõc robot</button>
        <button class="save-program" onclick="showSaveDialog('program')">üìã L∆∞u ch∆∞∆°ng tr√¨nh</button>
      </div>
      
      <h5 class="controls-title">V·ªã tr√≠ ƒë√£ l∆∞u</h5>
      <div class="saved-items" id="saved-positions">
        <!-- C√°c v·ªã tr√≠ ƒë√£ l∆∞u s·∫Ω ƒë∆∞·ª£c th√™m ·ªü ƒë√¢y -->
      </div>
      
      <h5 class="controls-title">K√≠ch th∆∞·ªõc ƒë√£ l∆∞u</h5>
      <div class="saved-items" id="saved-sizes">
        <!-- C√°c k√≠ch th∆∞·ªõc ƒë√£ l∆∞u s·∫Ω ƒë∆∞·ª£c th√™m ·ªü ƒë√¢y -->
      </div>
      
      <h5 class="controls-title">Ch∆∞∆°ng tr√¨nh ƒë√£ l∆∞u</h5>
      <div class="saved-items" id="saved-programs">
        <!-- C√°c ch∆∞∆°ng tr√¨nh ƒë√£ l∆∞u s·∫Ω ƒë∆∞·ª£c th√™m ·ªü ƒë√¢y -->
      </div>
    </div>
    
    <!-- Ph√¢n khu 2: L·∫≠p tr√¨nh kh·ªëi -->
    <div id="block-programming">
      <h4 class="controls-title">
        L·∫≠p tr√¨nh kh·ªëi
        <div class="history-controls">
          <button id="undo-button-2" onclick="undoAction()" title="Quay l·∫°i b∆∞·ªõc tr∆∞·ªõc (Z)">‚Ü©</button>
          <button id="redo-button-2" onclick="redoAction()" title="Ti·∫øn l·∫°i b∆∞·ªõc sau (Y)">‚Ü™</button>
        </div>
      </h4>
      
      <div class="block-container">
        <div class="block-library" id="block-library">
          <div class="command-block move-up" draggable="true" data-command="up">
            L√™n <input type="number" value="1" min="1"><span class="unit-label">cm</span>
          </div>
          <div class="command-block move-down" draggable="true" data-command="down">
            Xu·ªëng <input type="number" value="1" min="1"><span class="unit-label">cm</span>
          </div>
          <div class="command-block move-left" draggable="true" data-command="left">
            Tr√°i <input type="number" value="1" min="1"><span class="unit-label">cm</span>
          </div>
          <div class="command-block move-right" draggable="true" data-command="right">
            Ph·∫£i <input type="number" value="1" min="1"><span class="unit-label">cm</span>
          </div>
          <div class="command-block move-upleft" draggable="true" data-command="upleft">
            Ch√©o tr√°i l√™n <input type="number" value="1" min="1"><span class="unit-label">cm</span>
          </div>
          <div class="command-block move-upright" draggable="true" data-command="upright">
            Ch√©o ph·∫£i l√™n <input type="number" value="1" min="1"><span class="unit-label">cm</span>
          </div>
          <div class="command-block move-downleft" draggable="true" data-command="downleft">
            Ch√©o tr√°i xu·ªëng <input type="number" value="1" min="1"><span class="unit-label">cm</span>
          </div>
          <div class="command-block move-downright" draggable="true" data-command="downright">
            Ch√©o ph·∫£i xu·ªëng <input type="number" value="1" min="1"><span class="unit-label">cm</span>
          </div>
          <div class="command-block spin" draggable="true" data-command="spin">
            Xoay tr√≤n <input type="number" value="1" min="1"><span class="unit-label">v√≤ng</span>
          </div>
          <div class="command-block rotate-left" draggable="true" data-command="rotateleft">
            Quay tr√°i <input type="number" value="45" min="1"><span class="unit-label">ƒë·ªô</span>
          </div>
          <div class="command-block rotate-right" draggable="true" data-command="rotateright">
            Quay ph·∫£i <input type="number" value="45" min="1"><span class="unit-label">ƒë·ªô</span>
          </div>
        </div>
        
        <div class="program-area" id="program-area">
          <!-- Khu v·ª±c nh·∫≠n c√°c kh·ªëi l·ªánh -->
        </div>
      </div>
      
      <button class="run-program" onclick="runProgram()">Ch·∫°y ch∆∞∆°ng tr√¨nh</button>
    </div>
  </div>
  
  <div id="sidebar-resizer"></div>
  
  <!-- Ph√¢n khu 3: Hi·ªÉn th·ªã map v√† robot -->
  <div id="display-area">
    <div id="map-container">
      <img id="map" src="map.png" alt="Map" />
    </div>
    <div id="robot-container">
      <img id="robot" src="robot.png" alt="Robot" />
      <div class="resize-handle" id="resize-handle"></div>
      
      <!-- Ch·ªâ th·ªã h∆∞·ªõng robot -->
      <div class="robot-direction-indicator" id="direction-w">W</div>
      <div class="robot-direction-indicator" id="direction-a">A</div>
      <div class="robot-direction-indicator" id="direction-s">S</div>
      <div class="robot-direction-indicator" id="direction-d">D</div>
    </div>
  </div>
  
  <!-- H·ªôp tho·∫°i nh·∫≠p t√™n l∆∞u -->
  <div class="save-name-dialog" id="save-dialog">
    <h4 id="save-dialog-title">L∆∞u v·ªã tr√≠</h4>
    <input type="text" id="save-name" placeholder="Nh·∫≠p t√™n">
    <div>
      <button class="save" onclick="saveItem()">L∆∞u</button>
      <button class="cancel" onclick="hideSaveDialog()">H·ªßy</button>
    </div>
  </div>

  <script>
    const robot = document.getElementById("robot");
    const mapImg = document.getElementById("map");
    const resizeHandle = document.getElementById("resize-handle");
    const saveDialog = document.getElementById("save-dialog");
    const sidebar = document.getElementById("sidebar");
    const sidebarResizer = document.getElementById("sidebar-resizer");
    
    // C√°c n√∫t ch·ªâ th·ªã h∆∞·ªõng
    const directionW = document.getElementById("direction-w");
    const directionA = document.getElementById("direction-a");
    const directionS = document.getElementById("direction-s");
    const directionD = document.getElementById("direction-d");
    
    let x = 100, y = 100, angle = 0;
    let robotSize = 50; // K√≠ch th∆∞·ªõc m·∫∑c ƒë·ªãnh c·ªßa robot
    let isProgramRunning = false;
    let programQueue = [];
    let robotDirection = 'w'; // H∆∞·ªõng m·∫∑c ƒë·ªãnh c·ªßa robot (w, a, s, d)
    let directionsVisible = false;
    
    // L·ªãch s·ª≠ thao t√°c cho Undo/Redo
    let history = [];
    let historyIndex = -1;
    let ignoreNextUpdate = false;
    
    // Bi·∫øn cho h·ªôp tho·∫°i l∆∞u
    let savingType = '';
    
    // Th√¥ng s·ªë chuy·ªÉn ƒë·ªïi t·ª∑ l·ªá
    const MAP_REAL_WIDTH = 120; // K√≠ch th∆∞·ªõc th·ª±c t·∫ø c·ªßa map (cm)
    const MAP_REAL_HEIGHT = 120; // K√≠ch th∆∞·ªõc th·ª±c t·∫ø c·ªßa map (cm)
    const ROBOT_REAL_WIDTH = 16; // K√≠ch th∆∞·ªõc th·ª±c t·∫ø c·ªßa robot (cm)
    let pixelToCmRatio = 1; // T·ª∑ l·ªá pixel/cm, s·∫Ω ƒë∆∞·ª£c t√≠nh l·∫°i khi load ·∫£nh
    
    // Kh·ªüi t·∫°o danh s√°ch v·ªã tr√≠, k√≠ch th∆∞·ªõc v√† ch∆∞∆°ng tr√¨nh ƒë√£ l∆∞u
    let savedPositions = JSON.parse(localStorage.getItem('robotPositions')) || [];
    let savedSizes = JSON.parse(localStorage.getItem('robotSizes')) || [];
    let savedPrograms = JSON.parse(localStorage.getItem('robotPrograms')) || [];
    
    // Kh·ªüi t·∫°o khi trang t·∫£i xong
    window.addEventListener('load', function() {
      calculateScale();
      centerRobot();
      positionResizeHandle();
      updateDirectionIndicators();
      updateSavedPositionsList();
      updateSavedSizesList();
      updateSavedProgramsList();
    });
    
    // T√≠nh to√°n t·ª∑ l·ªá khi ·∫£nh ƒë∆∞·ª£c t·∫£i
    mapImg.addEventListener('load', calculateScale);
    
    // T√≠nh l·∫°i t·ª∑ l·ªá khi c·ª≠a s·ªï thay ƒë·ªïi k√≠ch th∆∞·ªõc
    window.addEventListener('resize', function() {
      calculateScale();
      centerRobot();
      positionResizeHandle();
      updateDirectionIndicators();
    });
    
    // T√≠nh to√°n t·ª∑ l·ªá pixel/cm
    function calculateScale() {
      const mapRect = mapImg.getBoundingClientRect();
      pixelToCmRatio = MAP_REAL_WIDTH / mapRect.width;
      
      // C·∫≠p nh·∫≠t hi·ªÉn th·ªã t·ª∑ l·ªá
      document.getElementById('scale-ratio').textContent = pixelToCmRatio.toFixed(3);
      
      // T√≠nh to√°n k√≠ch th∆∞·ªõc robot ph√π h·ª£p v·ªõi t·ª∑ l·ªá m·ªõi
      const idealRobotWidth = ROBOT_REAL_WIDTH / pixelToCmRatio;
      robotSize = Math.max(20, Math.min(150, idealRobotWidth));
      robot.style.width = `${robotSize}px`;
      document.getElementById('robot-size').value = robotSize;
    }
    
    // Chuy·ªÉn ƒë·ªïi t·ª´ cm sang pixel
    function cmToPixel(cm) {
      return cm / pixelToCmRatio;
    }
    
    // L∆∞u m·ªôt tr·∫°ng th√°i v√†o l·ªãch s·ª≠
    function saveToHistory() {
      if (ignoreNextUpdate) {
        ignoreNextUpdate = false;
        return;
      }
      
      // C·∫Øt b·ªè l·ªãch s·ª≠ ph√≠a tr∆∞·ªõc n·∫øu ƒëang ·ªü gi·ªØa
      if (historyIndex < history.length - 1) {
        history = history.slice(0, historyIndex + 1);
      }
      
      // L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i
      history.push({
        x: x,
        y: y,
        angle: angle,
        robotSize: robotSize,
        robotDirection: robotDirection
      });
      
      historyIndex = history.length - 1;
      
      // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t
      updateUndoRedoButtons();
    }
    
    // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t Undo/Redo
    function updateUndoRedoButtons() {
      document.getElementById('undo-button-1').disabled = historyIndex <= 0;
      document.getElementById('redo-button-1').disabled = historyIndex >= history.length - 1;
      document.getElementById('undo-button-2').disabled = historyIndex <= 0;
      document.getElementById('redo-button-2').disabled = historyIndex >= history.length - 1;
    }
    
    // Th·ª±c hi·ªán quay l·∫°i
    function undoAction() {
      if (historyIndex > 0) {
        historyIndex--;
        const state = history[historyIndex];
        ignoreNextUpdate = true;
        
        x = state.x;
        y = state.y;
        angle = state.angle;
        robotSize = state.robotSize;
        robotDirection = state.robotDirection;
        
        robot.style.width = `${robotSize}px`;
        document.getElementById('robot-size').value = robotSize;
        
        updateRobot();
        updateDirectionIndicators();
        updateUndoRedoButtons();
      }
    }
    
    // Th·ª±c hi·ªán ti·∫øn t·ªõi
    function redoAction() {
      if (historyIndex < history.length - 1) {
        historyIndex++;
        const state = history[historyIndex];
        ignoreNextUpdate = true;
        
        x = state.x;
        y = state.y;
        angle = state.angle;
        robotSize = state.robotSize;
        robotDirection = state.robotDirection;
        
        robot.style.width = `${robotSize}px`;
        document.getElementById('robot-size').value = robotSize;
        
        updateRobot();
        updateDirectionIndicators();
        updateUndoRedoButtons();
      }
    }
    
    function resizeRobot(size) {
      robotSize = parseInt(size);
      robot.style.width = `${robotSize}px`;
      positionResizeHandle();
      updateRobot();
      updateDirectionIndicators();
      saveToHistory();
    }
    
    function centerRobot() {
      const mapRect = mapImg.getBoundingClientRect();
      
      // ƒê·∫∑t robot ·ªü gi·ªØa map
      x = mapRect.left + (mapRect.width / 2) - (robotSize / 2);
      y = mapRect.top + (mapRect.height / 2) - (robotSize / 2);
      
      updateRobot();
      updateDirectionIndicators();
      saveToHistory();
    }
    
    function updateRobot() {
      robot.style.left = `${x}px`;
      robot.style.top = `${y}px`;
      robot.style.transform = `rotate(${angle}deg)`;
      positionResizeHandle();
    }
    
    function positionResizeHandle() {
      const robotRect = robot.getBoundingClientRect();
      resizeHandle.style.left = (robotRect.right - 5) + 'px';
      resizeHandle.style.top = (robotRect.bottom - 5) + 'px';
    }
    
    function updateDirectionIndicators() {
      if (!directionsVisible) return;
      
      const robotRect = robot.getBoundingClientRect();
      const centerX = robotRect.left + robotRect.width / 2;
      const centerY = robotRect.top + robotRect.height / 2;
      
      // V·ªã tr√≠ n√∫t W (tr√™n ƒë·∫ßu robot)
      directionW.style.left = `${centerX - 15}px`;
      directionW.style.top = `${robotRect.top - 35}px`;
      
      // V·ªã tr√≠ n√∫t A (b√™n tr√°i robot)
      directionA.style.left = `${robotRect.left - 35}px`;
      directionA.style.top = `${centerY - 15}px`;
      
      // V·ªã tr√≠ n√∫t S (d∆∞·ªõi ch√¢n robot)
      directionS.style.left = `${centerX - 15}px`;
      directionS.style.top = `${robotRect.bottom + 5}px`;
      
      // V·ªã tr√≠ n√∫t D (b√™n ph·∫£i robot)
      directionD.style.left = `${robotRect.right + 5}px`;
      directionD.style.top = `${centerY - 15}px`;
      
      // ƒê√°nh d·∫•u n√∫t ƒë∆∞·ª£c ch·ªçn
      directionW.style.backgroundColor = robotDirection === 'w' ? 'rgba(255, 193, 7, 0.8)' : 'rgba(255, 255, 255, 0.7)';
      directionA.style.backgroundColor = robotDirection === 'a' ? 'rgba(255, 193, 7, 0.8)' : 'rgba(255, 255, 255, 0.7)';
      directionS.style.backgroundColor = robotDirection === 's' ? 'rgba(255, 193, 7, 0.8)' : 'rgba(255, 255, 255, 0.7)';
      directionD.style.backgroundColor = robotDirection === 'd' ? 'rgba(255, 193, 7, 0.8)' : 'rgba(255, 255, 255, 0.7)';
    }
    
    // Hi·ªÉn th·ªã/·∫®n ch·ªâ th·ªã h∆∞·ªõng robot
    function toggleDirectionIndicators() {
      directionsVisible = !directionsVisible;
      
      // Hi·ªÉn th·ªã/·∫®n c√°c ch·ªâ th·ªã h∆∞·ªõng
      directionW.style.display = directionsVisible ? 'flex' : 'none';
      directionA.style.display = directionsVisible ? 'flex' : 'none';
      directionS.style.display = directionsVisible ? 'flex' : 'none';
      directionD.style.display = directionsVisible ? 'flex' : 'none';
      
      if (directionsVisible) {
        updateDirectionIndicators();
      }
    }
    
    // Di chuy·ªÉn theo h∆∞·ªõng c·ªßa robot
    function moveRobotInDirection(dx, dy) {
      // Chuy·ªÉn ƒë·ªïi cm sang pixel v·ªõi t·ª∑ l·ªá ph√π h·ª£p
      const moveAmount = cmToPixel(1); // Di chuy·ªÉn m·∫∑c ƒë·ªãnh 1cm
      
      // ƒêi·ªÅu ch·ªânh h∆∞·ªõng di chuy·ªÉn d·ª±a tr√™n h∆∞·ªõng robot
      let realDx = 0;
      let realDy = 0;
      
      // T√≠nh to√°n vector di chuy·ªÉn d·ª±a tr√™n h∆∞·ªõng robot hi·ªán t·∫°i
      switch (robotDirection) {
        case 'w': // H∆∞·ªõng W l√† h∆∞·ªõng ti·∫øn t·ªõi
          // Di chuy·ªÉn b√¨nh th∆∞·ªùng theo vector
          realDx = dx;
          realDy = dy;
          break;
        case 's': // H∆∞·ªõng S l√† ng∆∞·ª£c l·∫°i v·ªõi W
          // ƒê·∫£o ng∆∞·ª£c h∆∞·ªõng di chuy·ªÉn
          realDx = -dx;
          realDy = -dy;
          break;
        case 'a': // H∆∞·ªõng A l√† b√™n tr√°i
          // Xoay vector 90 ƒë·ªô ng∆∞·ª£c chi·ªÅu kim ƒë·ªìng h·ªì
          realDx = dy;
          realDy = -dx;
          break;
        case 'd': // H∆∞·ªõng D l√† b√™n ph·∫£i
          // Xoay vector 90 ƒë·ªô theo chi·ªÅu kim ƒë·ªìng h·ªì
          realDx = -dy;
          realDy = dx;
          break;
      }
      
      // √Åp d·ª•ng di chuy·ªÉn
      x += realDx * moveAmount;
      y += realDy * moveAmount;
      
      updateRobot();
      updateDirectionIndicators();
      saveToHistory();
    }
    
    function rotate(degrees) {
      angle += degrees;
      updateRobot();
      updateDirectionIndicators();
      saveToHistory();
    }
    
    function spinRobot() {
      // Xoay tr√≤n 2 v√≤ng r·ªìi tr·ªü v·ªÅ g√≥c ban ƒë·∫ßu
      const startAngle = angle;
      let currentRotation = 0;
      
      function animateRotation() {
        currentRotation += 5;
        if (currentRotation <= 720) {
          angle = startAngle + currentRotation;
          updateRobot();
          updateDirectionIndicators();
          requestAnimationFrame(animateRotation);
        } else {
          angle = startAngle;
          updateRobot();
          updateDirectionIndicators();
          saveToHistory();
        }
      }
      
      requestAnimationFrame(animateRotation);
    }
    
    function toggleRobot() {
      robot.style.display = document.getElementById("toggle-robot").checked ? 'block' : 'none';
      resizeHandle.style.display = document.getElementById("toggle-robot").checked ? 'block' : 'none';
      if (!document.getElementById("toggle-robot").checked) {
        // ·∫®n ch·ªâ th·ªã h∆∞·ªõng khi ·∫©n robot
        directionW.style.display = 'none';
        directionA.style.display = 'none';
        directionS.style.display = 'none';
        directionD.style.display = 'none';
        directionsVisible = false;
      } else if (directionsVisible) {
        // Hi·ªán l·∫°i ch·ªâ th·ªã h∆∞·ªõng n·∫øu ƒëang b·∫≠t
        directionW.style.display = 'flex';
        directionA.style.display = 'flex';
        directionS.style.display = 'flex';
        directionD.style.display = 'flex';
      }
    }
    
    // Hi·ªÉn th·ªã h·ªôp tho·∫°i l∆∞u
    function showSaveDialog(type) {
      savingType = type;
      
      if (type === 'position') {
        document.getElementById('save-dialog-title').textContent = 'L∆∞u v·ªã tr√≠ hi·ªán t·∫°i';
        document.getElementById('save-name').placeholder = 'Nh·∫≠p t√™n v·ªã tr√≠';
      } else if (type === 'size') {
        document.getElementById('save-dialog-title').textContent = 'L∆∞u k√≠ch th∆∞·ªõc robot';
        document.getElementById('save-name').placeholder = 'Nh·∫≠p t√™n k√≠ch th∆∞·ªõc';
      } else if (type === 'program') {
        document.getElementById('save-dialog-title').textContent = 'L∆∞u ch∆∞∆°ng tr√¨nh';
        document.getElementById('save-name').placeholder = 'Nh·∫≠p t√™n ch∆∞∆°ng tr√¨nh';
        
        // Ki·ªÉm tra xem c√≥ ch∆∞∆°ng tr√¨nh n√†o kh√¥ng
        const blocks = document.querySelectorAll('#program-area .command-block');
        if (blocks.length === 0) {
          alert('Kh√¥ng c√≥ l·ªánh n√†o trong ch∆∞∆°ng tr√¨nh ƒë·ªÉ l∆∞u!');
          return;
        }
      }
      
      document.getElementById('save-name').value = '';
      saveDialog.style.display = 'block';
    }
    
    // ·∫®n h·ªôp tho·∫°i l∆∞u
    function hideSaveDialog() {
      saveDialog.style.display = 'none';
    }
    
    // L∆∞u v·ªã tr√≠, k√≠ch th∆∞·ªõc ho·∫∑c ch∆∞∆°ng tr√¨nh
    function saveItem() {
      const name = document.getElementById('save-name').value.trim();
      
      if (!name) {
        alert('Vui l√≤ng nh·∫≠p t√™n!');
        return;
      }
      
      if (savingType === 'position') {
        // L∆∞u v·ªã tr√≠ hi·ªán t·∫°i
        const position = {
          name: name,
          x: x,
          y: y,
          angle: angle,
          robotDirection: robotDirection
        };
        
        savedPositions.push(position);
        localStorage.setItem('robotPositions', JSON.stringify(savedPositions));
        updateSavedPositionsList();
      } else if (savingType === 'size') {
        // L∆∞u k√≠ch th∆∞·ªõc hi·ªán t·∫°i
        const size = {
          name: name,
          size: robotSize
        };
        
        savedSizes.push(size);
        localStorage.setItem('robotSizes', JSON.stringify(savedSizes));
        updateSavedSizesList();
      } else if (savingType === 'program') {
        // L∆∞u ch∆∞∆°ng tr√¨nh hi·ªán t·∫°i
        const blocks = Array.from(document.querySelectorAll('#program-area .command-block')).map(block => {
          return {
            command: block.dataset.command,
            value: parseInt(block.querySelector('input').value) || 1
          };
        });
        
        const program = {
          name: name,
          blocks: blocks
        };
        
        savedPrograms.push(program);
        localStorage.setItem('robotPrograms', JSON.stringify(savedPrograms));
        updateSavedProgramsList();
      }
      
      hideSaveDialog();
    }
    
    // C·∫≠p nh·∫≠t danh s√°ch v·ªã tr√≠ ƒë√£ l∆∞u
    function updateSavedPositionsList() {
      const container = document.getElementById('saved-positions');
      container.innerHTML = '';
      
      if (savedPositions.length === 0) {
        container.innerHTML = '<div class="saved-item">Ch∆∞a c√≥ v·ªã tr√≠ n√†o ƒë∆∞·ª£c l∆∞u</div>';
        return;
      }
      
      savedPositions.forEach((position, index) => {
        const item = document.createElement('div');
        item.className = 'saved-item';
        
        const nameSpan = document.createElement('span');
        nameSpan.textContent = position.name;
        nameSpan.title = `X: ${Math.round(position.x)}, Y: ${Math.round(position.y)}, G√≥c: ${Math.round(position.angle)}¬∞`;
        nameSpan.style.cursor = 'pointer';
        nameSpan.onclick = () => loadPosition(index);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = '‚úï';
        deleteBtn.title = 'X√≥a';
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          deletePosition(index);
        };
        
        item.appendChild(nameSpan);
        item.appendChild(deleteBtn);
        container.appendChild(item);
      });
    }
    
    // C·∫≠p nh·∫≠t danh s√°ch k√≠ch th∆∞·ªõc ƒë√£ l∆∞u
    function updateSavedSizesList() {
      const container = document.getElementById('saved-sizes');
      container.innerHTML = '';
      
      if (savedSizes.length === 0) {
        container.innerHTML = '<div class="saved-item">Ch∆∞a c√≥ k√≠ch th∆∞·ªõc n√†o ƒë∆∞·ª£c l∆∞u</div>';
        return;
      }
      
      savedSizes.forEach((sizeItem, index) => {
        const item = document.createElement('div');
        item.className = 'saved-item';
        
        const nameSpan = document.createElement('span');
        nameSpan.textContent = sizeItem.name;
        nameSpan.title = `K√≠ch th∆∞·ªõc: ${sizeItem.size}px`;
        nameSpan.style.cursor = 'pointer';
        nameSpan.onclick = () => loadSize(index);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = '‚úï';
        deleteBtn.title = 'X√≥a';
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          deleteSize(index);
        };
        
        item.appendChild(nameSpan);
        item.appendChild(deleteBtn);
        container.appendChild(item);
      });
    }
    
    // C·∫≠p nh·∫≠t danh s√°ch ch∆∞∆°ng tr√¨nh ƒë√£ l∆∞u
    function updateSavedProgramsList() {
      const container = document.getElementById('saved-programs');
      container.innerHTML = '';
      
      if (savedPrograms.length === 0) {
        container.innerHTML = '<div class="saved-item">Ch∆∞a c√≥ ch∆∞∆°ng tr√¨nh n√†o ƒë∆∞·ª£c l∆∞u</div>';
        return;
      }
      
      savedPrograms.forEach((program, index) => {
        const item = document.createElement('div');
        item.className = 'saved-item';
        
        const nameSpan = document.createElement('span');
        nameSpan.textContent = program.name;
        nameSpan.title = `${program.blocks.length} l·ªánh`;
        nameSpan.style.cursor = 'pointer';
        nameSpan.onclick = () => loadProgram(index);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = '‚úï';
        deleteBtn.title = 'X√≥a';
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          deleteProgram(index);
        };
        
        item.appendChild(nameSpan);
        item.appendChild(deleteBtn);
        container.appendChild(item);
      });
    }
    
    // T·∫£i v·ªã tr√≠ ƒë√£ l∆∞u
    function loadPosition(index) {
      const position = savedPositions[index];
      x = position.x;
      y = position.y;
      angle = position.angle;
      robotDirection = position.robotDirection || 'w';
      updateRobot();
      updateDirectionIndicators();
      saveToHistory();
    }
    
    // T·∫£i k√≠ch th∆∞·ªõc ƒë√£ l∆∞u
    function loadSize(index) {
      const sizeItem = savedSizes[index];
      robotSize = sizeItem.size;
      robot.style.width = `${robotSize}px`;
      document.getElementById('robot-size').value = robotSize;
      updateRobot();
      updateDirectionIndicators();
      saveToHistory();
    }
    
    // T·∫£i ch∆∞∆°ng tr√¨nh ƒë√£ l∆∞u
    function loadProgram(index) {
      const program = savedPrograms[index];
      
      // X√≥a t·∫•t c·∫£ c√°c l·ªánh hi·ªán t·∫°i
      document.getElementById('program-area').innerHTML = '';
      
      // Th√™m c√°c l·ªánh t·ª´ ch∆∞∆°ng tr√¨nh ƒë√£ l∆∞u
      program.blocks.forEach(block => {
        const originalBlock = document.querySelector(`.command-block[data-command="${block.command}"]`);
        if (originalBlock) {
          // T·∫°o m·ªôt b·∫£n sao c·ªßa kh·ªëi l·ªánh
          const newBlock = originalBlock.cloneNode(true);
          newBlock.draggable = false;
          
          // Thi·∫øt l·∫≠p gi√° tr·ªã ƒë·∫ßu v√†o
          newBlock.querySelector('input').value = block.value;
          
          // Th√™m c√°c n√∫t ƒëi·ªÅu khi·ªÉn kh·ªëi
          addBlockControls(newBlock);
          
          // Th√™m v√†o khu v·ª±c ch∆∞∆°ng tr√¨nh
          document.getElementById('program-area').appendChild(newBlock);
        }
      });
    }
    
    // X√≥a v·ªã tr√≠ ƒë√£ l∆∞u
    function deletePosition(index) {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a v·ªã tr√≠ n√†y?')) {
        savedPositions.splice(index, 1);
        localStorage.setItem('robotPositions', JSON.stringify(savedPositions));
        updateSavedPositionsList();
      }
    }
    
    // X√≥a k√≠ch th∆∞·ªõc ƒë√£ l∆∞u
    function deleteSize(index) {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a k√≠ch th∆∞·ªõc n√†y?')) {
        savedSizes.splice(index, 1);
        localStorage.setItem('robotSizes', JSON.stringify(savedSizes));
        updateSavedSizesList();
      }
    }
    
    // X√≥a ch∆∞∆°ng tr√¨nh ƒë√£ l∆∞u
    function deleteProgram(index) {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ch∆∞∆°ng tr√¨nh n√†y?')) {
        savedPrograms.splice(index, 1);
        localStorage.setItem('robotPrograms', JSON.stringify(savedPrograms));
        updateSavedProgramsList();
      }
    }
    
    // Th√™m c√°c n√∫t ƒëi·ªÅu khi·ªÉn cho kh·ªëi
    function addBlockControls(block) {
      // T·∫°o div ch·ª©a c√°c n√∫t ƒëi·ªÅu khi·ªÉn
      const controlsDiv = document.createElement('div');
      controlsDiv.className = 'block-controls';
      
      // N√∫t di chuy·ªÉn l√™n
      const moveUpBtn = document.createElement('button');
      moveUpBtn.className = 'move-up';
      moveUpBtn.innerHTML = '‚Üë';
      moveUpBtn.title = 'Di chuy·ªÉn l√™n';
      moveUpBtn.onclick = function(e) {
        e.stopPropagation();
        moveBlockUp(block);
      };
      
      // N√∫t di chuy·ªÉn xu·ªëng
      const moveDownBtn = document.createElement('button');
      moveDownBtn.className = 'move-down';
      moveDownBtn.innerHTML = '‚Üì';
      moveDownBtn.title = 'Di chuy·ªÉn xu·ªëng';
      moveDownBtn.onclick = function(e) {
        e.stopPropagation();
        moveBlockDown(block);
      };
      
      // N√∫t x√≥a
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'delete-block';
      deleteBtn.innerHTML = '‚úï';
      deleteBtn.title = 'X√≥a kh·ªëi';
      deleteBtn.onclick = function(e) {
        e.stopPropagation();
        document.getElementById('program-area').removeChild(block);
      };
      
      // Th√™m c√°c n√∫t v√†o div ƒëi·ªÅu khi·ªÉn
      controlsDiv.appendChild(moveUpBtn);
      controlsDiv.appendChild(moveDownBtn);
      controlsDiv.appendChild(deleteBtn);
      
      // Th√™m div ƒëi·ªÅu khi·ªÉn v√†o kh·ªëi
      block.appendChild(controlsDiv);
    }
    
    // Di chuy·ªÉn kh·ªëi l√™n
    function moveBlockUp(block) {
      const prev = block.previousElementSibling;
      if (prev) {
        block.parentNode.insertBefore(block, prev);
      }
    }
    
    // Di chuy·ªÉn kh·ªëi xu·ªëng
    function moveBlockDown(block) {
      const next = block.nextElementSibling;
      if (next) {
        block.parentNode.insertBefore(next, block);
      }
    }
    
    // X·ª≠ l√Ω k√©o th·∫£ c√°c kh·ªëi l·ªánh
    const blockLibrary = document.getElementById('block-library');
    const programArea = document.getElementById('program-area');
    
    // Thi·∫øt l·∫≠p s·ª± ki·ªán cho c√°c kh·ªëi l·ªánh
    document.querySelectorAll('.command-block').forEach(block => {
      block.addEventListener('dragstart', function(e) {
        e.dataTransfer.setData('text/plain', this.dataset.command);
        e.dataTransfer.effectAllowed = 'copy';
      });
    });
    
    // Cho ph√©p th·∫£ kh·ªëi v√†o program area
    programArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'copy';
    });
    
    programArea.addEventListener('drop', function(e) {
      e.preventDefault();
      const command = e.dataTransfer.getData('text/plain');
      if (command) {
        // T√¨m kh·ªëi l·ªánh g·ªëc
        const originalBlock = document.querySelector(`.command-block[data-command="${command}"]`);
        if (originalBlock) {
          // T·∫°o m·ªôt b·∫£n sao c·ªßa kh·ªëi l·ªánh
          const newBlock = originalBlock.cloneNode(true);
          newBlock.draggable = false; // Kh√¥ng cho ph√©p k√©o kh·ªëi n√†y n·ªØa
          
          // Th√™m c√°c n√∫t ƒëi·ªÅu khi·ªÉn kh·ªëi
          addBlockControls(newBlock);
          
          // Th√™m v√†o khu v·ª±c ch∆∞∆°ng tr√¨nh
          programArea.appendChild(newBlock);
        }
      }
    });
    
    // X·ª≠ l√Ω k√©o th·∫£ resize robot
    let isResizing = false;
    
    resizeHandle.addEventListener('mousedown', function(e) {
      isResizing = true;
      e.preventDefault();
    });
    
    document.addEventListener('mousemove', function(e) {
      if (!isResizing) return;
      
      const robotRect = robot.getBoundingClientRect();
      
      // T√≠nh to√°n k√≠ch th∆∞·ªõc m·ªõi d·ª±a tr√™n v·ªã tr√≠ chu·ªôt
      const newWidth = e.clientX - robotRect.left;
      const newHeight = e.clientY - robotRect.top;
      
      // Gi·ªØ t·ª∑ l·ªá khung h√¨nh 1:1
      const newSize = Math.max(Math.min(newWidth, newHeight), 20);
      
      // C·∫≠p nh·∫≠t k√≠ch th∆∞·ªõc robot
      robotSize = newSize;
      robot.style.width = `${robotSize}px`;
      
      // C·∫≠p nh·∫≠t gi√° tr·ªã thanh tr∆∞·ª£t
      document.getElementById('robot-size').value = robotSize;
      
      // C·∫≠p nh·∫≠t v·ªã tr√≠ n√∫t resize
      positionResizeHandle();
      
      // C·∫≠p nh·∫≠t v·ªã tr√≠ robot v√† ch·ªâ th·ªã h∆∞·ªõng
      updateRobot();
      updateDirectionIndicators();
    });
    
    document.addEventListener('mouseup', function() {
      if (isResizing) {
        isResizing = false;
        saveToHistory();
      }
    });
    
    // X·ª≠ l√Ω k√©o th·∫£ ƒë·ªÉ ƒëi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc sidebar
    let isResizingSidebar = false;
    let lastX = 0;
    
    sidebarResizer.addEventListener('mousedown', function(e) {
      isResizingSidebar = true;
      lastX = e.clientX;
      e.preventDefault();
    });
    
    document.addEventListener('mousemove', function(e) {
      if (!isResizingSidebar) return;
      
      const dx = e.clientX - lastX;
      lastX = e.clientX;
      
      let newWidth = sidebar.offsetWidth + dx;
      if (newWidth < 250) newWidth = 250;
      if (newWidth > 500) newWidth = 500;
      
      sidebar.style.width = `${newWidth}px`;
      sidebarResizer.style.left = `${newWidth}px`;
    });
    
    document.addEventListener('mouseup', function() {
      isResizingSidebar = false;
    });
    
    // Thi·∫øt l·∫≠p s·ª± ki·ªán cho c√°c n√∫t ch·ªâ th·ªã h∆∞·ªõng
    directionW.addEventListener('click', function() {
      robotDirection = 'w';
      updateDirectionIndicators();
      saveToHistory();
    });
    
    directionA.addEventListener('click', function() {
      robotDirection = 'a';
      updateDirectionIndicators();
      saveToHistory();
    });
    
    directionS.addEventListener('click', function() {
      robotDirection = 's';
      updateDirectionIndicators();
      saveToHistory();
    });
    
    directionD.addEventListener('click', function() {
      robotDirection = 'd';
      updateDirectionIndicators();
      saveToHistory();
    });
    
    function runProgram() {
      if (isProgramRunning) return;
      
      // Thu th·∫≠p t·∫•t c·∫£ c√°c l·ªánh t·ª´ program area
      const commands = Array.from(programArea.children).map(block => {
        const command = block.dataset.command;
        const value = parseInt(block.querySelector('input').value) || 1;
        return { command, value };
      });
      
      // ƒê·∫∑t v√†o h√†ng ƒë·ª£i v√† th·ª±c thi
      programQueue = commands;
      isProgramRunning = true;
      executeNextCommand();
    }
    
    function executeNextCommand() {
      if (programQueue.length === 0) {
        isProgramRunning = false;
        saveToHistory();
        return;
      }
      
      const command = programQueue.shift();
      const value = command.value;
      
      switch (command.command) {
        case 'up':
          // Di chuy·ªÉn l√™n v·ªõi kho·∫£ng c√°ch value (cm)
          moveWithCmValue(0, -value);
          break;
        case 'down':
          // Di chuy·ªÉn xu·ªëng v·ªõi kho·∫£ng c√°ch value (cm)
          moveWithCmValue(0, value);
          break;
        case 'left':
          // Di chuy·ªÉn tr√°i v·ªõi kho·∫£ng c√°ch value (cm)
          moveWithCmValue(-value, 0);
          break;
        case 'right':
          // Di chuy·ªÉn ph·∫£i v·ªõi kho·∫£ng c√°ch value (cm)
          moveWithCmValue(value, 0);
          break;
        case 'upleft':
          // Di chuy·ªÉn ch√©o tr√°i l√™n v·ªõi kho·∫£ng c√°ch value (cm)
          moveWithCmValue(-value, -value);
          break;
        case 'upright':
          // Di chuy·ªÉn ch√©o ph·∫£i l√™n v·ªõi kho·∫£ng c√°ch value (cm)
          moveWithCmValue(value, -value);
          break;
        case 'downleft':
          // Di chuy·ªÉn ch√©o tr√°i xu·ªëng v·ªõi kho·∫£ng c√°ch value (cm)
          moveWithCmValue(-value, value);
          break;
        case 'downright':
          // Di chuy·ªÉn ch√©o ph·∫£i xu·ªëng v·ªõi kho·∫£ng c√°ch value (cm)
          moveWithCmValue(value, value);
          break;
        case 'spin':
          // Xoay tr√≤n value v√≤ng
          spinRobotWithValue(value);
          return; // H√†m spinRobotWithValue s·∫Ω g·ªçi executeNextCommand khi ho√†n th√†nh
        case 'rotateleft':
          // Quay tr√°i value ƒë·ªô
          rotate(-value);
          break;
        case 'rotateright':
          // Quay ph·∫£i value ƒë·ªô
          rotate(value);
          break;
      }
      
      // Ch·ªù m·ªôt ch√∫t gi·ªØa c√°c l·ªánh ƒë·ªÉ t·∫°o hi·ªáu ·ª©ng m∆∞·ª£t m√†
      setTimeout(executeNextCommand, 300);
    }
    
    // Di chuy·ªÉn m·ªôt kho·∫£ng c√°ch t√≠nh b·∫±ng cm
    function moveWithCmValue(dx, dy) {
      // T√≠nh to√°n l∆∞·ª£ng pixel c·∫ßn di chuy·ªÉn
      const pixelDx = cmToPixel(dx);
      const pixelDy = cmToPixel(dy);
      
      // ƒêi·ªÅu ch·ªânh h∆∞·ªõng di chuy·ªÉn d·ª±a tr√™n h∆∞·ªõng robot
      let realDx = 0;
      let realDy = 0;
      
      // T√≠nh to√°n vector di chuy·ªÉn d·ª±a tr√™n h∆∞·ªõng robot hi·ªán t·∫°i
      switch (robotDirection) {
        case 'w': // H∆∞·ªõng W l√† h∆∞·ªõng ti·∫øn t·ªõi
          realDx = pixelDx;
          realDy = pixelDy;
          break;
        case 's': // H∆∞·ªõng S l√† ng∆∞·ª£c l·∫°i v·ªõi W
          realDx = -pixelDx;
          realDy = -pixelDy;
          break;
        case 'a': // H∆∞·ªõng A l√† b√™n tr√°i
          realDx = pixelDy;
          realDy = -pixelDx;
          break;
        case 'd': // H∆∞·ªõng D l√† b√™n ph·∫£i
          realDx = -pixelDy;
          realDy = pixelDx;
          break;
      }
      
      // √Åp d·ª•ng di chuy·ªÉn
      x += realDx;
      y += realDy;
      
      updateRobot();
      updateDirectionIndicators();
    }
    
    // Xoay tr√≤n v·ªõi s·ªë v√≤ng x√°c ƒë·ªãnh
    function spinRobotWithValue(rounds) {
      const startAngle = angle;
      let currentRotation = 0;
      const totalRotation = rounds * 360; // S·ªë ƒë·ªô c·∫ßn xoay
      
      function animateRotation() {
        const step = 5; // S·ªë ƒë·ªô m·ªói b∆∞·ªõc xoay
        currentRotation += step;
        
        if (currentRotation <= totalRotation) {
          angle = startAngle + currentRotation;
          updateRobot();
          updateDirectionIndicators();
          requestAnimationFrame(animateRotation);
        } else {
          angle = startAngle;
          updateRobot();
          updateDirectionIndicators();
          
          // Ti·∫øp t·ª•c v·ªõi l·ªánh ti·∫øp theo
          setTimeout(executeNextCommand, 300);
        }
      }
      
      requestAnimationFrame(animateRotation);
    }
    
    // X·ª≠ l√Ω ph√≠m
    document.addEventListener("keydown", (e) => {
      if (isProgramRunning) return; // Kh√¥ng x·ª≠ l√Ω ph√≠m khi ch∆∞∆°ng tr√¨nh ƒëang ch·∫°y
      
      switch (e.key.toLowerCase()) {
        case 'w': moveRobotInDirection(0, -1); break;
        case 's': moveRobotInDirection(0, 1); break;
        case 'a': moveRobotInDirection(-1, 0); break;
        case 'd': moveRobotInDirection(1, 0); break;
        case 'u': moveRobotInDirection(-1, -1); break;
        case 'i': moveRobotInDirection(1, -1); break;
        case 'j': moveRobotInDirection(-1, 1); break;
        case 'k': moveRobotInDirection(1, 1); break;
        case 'q': rotate(-2); break;
        case 'e': rotate(2); break;
        case ' ': spinRobot(); break;
        case 'r': centerRobot(); break;
        case 'z': 
          if (e.ctrlKey) undoAction();
          break;
        case 'y': 
          if (e.ctrlKey) redoAction();
          break;
      }
    });
    
    // Kh·ªüi t·∫°o
    updateRobot();
    saveToHistory(); // L∆∞u tr·∫°ng th√°i ban ƒë·∫ßu
    updateUndoRedoButtons();
  </script>
</body>
</html>
