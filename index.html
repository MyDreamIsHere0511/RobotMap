<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Robot Map Interface</title>
  <style>
    :root {
      --primary-color: #3498db;
      --secondary-color: #2ecc71;
      --accent-color: #f39c12;
      --danger-color: #e74c3c;
      --light-bg: #f5f5f5;
      --dark-bg: #2c3e50;
      --text-dark: #333;
      --text-light: #f5f5f5;
      --border-color: #ddd;
      --shadow: 0 2px 5px rgba(0,0,0,0.1);
      --theme-transition: background-color 0.3s, color 0.3s;
      
      /* M√†u cho c√°c command block */
      --move-up-bg: #d1e7dd;
      --move-down-bg: #f8d7da;
      --move-left-bg: #cfe2ff;
      --move-right-bg: #fff3cd;
      --move-upleft-bg: #d8f3dc;
      --move-upright-bg: #e9ecef;
      --move-downleft-bg: #e0e1ff;
      --move-downright-bg: #ffe8d9;
      --spin-bg: #d8d8ff;
      --rotate-left-bg: #ffccd5;
      --rotate-right-bg: #c9f7f5;
    }
    
    body.dark-mode {
      --light-bg: #1a1a2e;
      --border-color: #444;
      --text-dark: #f5f5f5;
      
      /* M√†u t·ªëi cho c√°c command block */
      --move-up-bg: #1e4d3d;
      --move-down-bg: #4d2828;
      --move-left-bg: #1e294d;
      --move-right-bg: #4d412e;
      --move-upleft-bg: #1e3e2e;
      --move-upright-bg: #2e2e2e;
      --move-downleft-bg: #252540;
      --move-downright-bg: #40332a;
      --spin-bg: #2e2e4d;
      --rotate-left-bg: #4d2a38;
      --rotate-right-bg: #2a4d49;
    }
    
    body {
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
      background-color: var(--light-bg);
      color: var(--text-dark);
      transition: var(--theme-transition);
    }
    
    #header-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      z-index: 1000;
      box-shadow: var(--shadow);
    }
    
    #header-bar .title {
      font-weight: bold;
      font-size: 1.2em;
    }
    
    #header-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .header-button {
      padding: 5px 10px;
      background-color: rgba(255,255,255,0.2);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .header-button:hover {
      background-color: rgba(255,255,255,0.3);
    }
    
    .theme-toggle {
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    
    .theme-toggle span {
      margin-right: 5px;
    }
    
    .toggle-switch {
      position: relative;
      width: 40px;
      height: 20px;
      background-color: rgba(0,0,0,0.3);
      border-radius: 10px;
      transition: background-color 0.3s;
    }
    
    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: white;
      top: 2px;
      left: 2px;
      transition: transform 0.3s;
    }
    
    .dark-mode .toggle-switch {
      background-color: var(--accent-color);
    }
    
    .dark-mode .toggle-switch::after {
      transform: translateX(20px);
    }
    
    #main-container {
      display: flex;
      width: 100%;
      height: 100%;
      padding-top: 40px; /* ƒê·ªÉ tr√°nh b·ªã header che */
    }
    
    #control-panel {
      width: 300px;
      height: 100%;
      background-color: var(--light-bg);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      transition: var(--theme-transition);
    }
    
    #display-area {
      flex: 1;
      position: relative;
      overflow: hidden;
      background-color: var(--light-bg);
      transition: var(--theme-transition);
    }
    
    .panel-section {
      border-bottom: 1px solid var(--border-color);
      padding: 10px;
    }
    
    .panel-section-title {
      margin: 0 0 10px 0;
      font-size: 16px;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .panel-content {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .control-row {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .control-row label {
      flex: 1;
      font-size: 14px;
    }
    
    .slider-container {
      display: flex;
      align-items: center;
      width: 100%;
    }
    
    .slider-container input[type="range"] {
      flex: 1;
      margin: 0 10px;
    }
    
    .coordinate-input {
      width: 70px;
      padding: 5px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
    }
    
    .btn {
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      background-color: var(--primary-color);
      color: white;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .btn:hover {
      background-color: #2980b9;
    }
    
    .btn:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }
    
    .btn.secondary {
      background-color: var(--secondary-color);
    }
    
    .btn.secondary:hover {
      background-color: #27ae60;
    }
    
    .btn.accent {
      background-color: var(--accent-color);
    }
    
    .btn.accent:hover {
      background-color: #e67e22;
    }
    
    .btn.danger {
      background-color: var(--danger-color);
    }
    
    .btn.danger:hover {
      background-color: #c0392b;
    }
    
    .btn-group {
      display: flex;
      gap: 5px;
    }
    
    .btn-group button {
      flex: 1;
    }
    
    .direction-controls {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 5px;
      margin: 10px 0;
    }
    
    .direction-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      border: 1px solid var(--border-color);
      background-color: white;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .direction-btn:hover {
      background-color: #f0f0f0;
    }
    
    .direction-btn.center {
      font-size: 14px;
    }
    
    #map-container {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: auto;
    }
    
    #map {
      display: block;
      max-width: 100%;
      height: auto;
      transition: transform 0.3s;
    }
    
    #robot-container {
      position: absolute;
      z-index: 10;
      cursor: default;
    }
    
    #robot {
      position: absolute;
      width: 50px;
      height: auto;
      transform-origin: center;
      transform: translate(-50%, -50%);
      transition: width 0.3s;
    }
    
    .resize-handle {
      position: absolute;
      bottom: -10px;
      right: -10px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: var(--accent-color);
      cursor: nwse-resize;
      z-index: 20;
    }
    
    .dragging {
      opacity: 0.7;
    }
    
    .toggle-btn {
      display: inline-flex;
      align-items: center;
      cursor: pointer;
    }
    
    .toggle-btn input {
      margin-right: 5px;
    }
    
    #grid-overlay {
      position: absolute;
      pointer-events: none;
      z-index: 5;
    }
    
    .grid-line {
      position: absolute;
      background-color: rgba(0, 0, 0, 0.1);
      pointer-events: none;
    }
    
    #coordinates-display {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 100;
      border: 1px solid var(--border-color);
    }
    
    #mini-map-container {
      position: absolute;
      bottom: 10px;
      right: 10px;
      width: 150px;
      height: 100px;
      background-color: rgba(255, 255, 255, 0.8);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      z-index: 100;
      overflow: hidden;
    }
    
    #mini-map {
      position: relative;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.05);
    }
    
    #mini-map-indicator {
      position: absolute;
      border: 2px solid var(--primary-color);
      background-color: rgba(52, 152, 219, 0.2);
      pointer-events: none;
    }
    
    #mini-map-robot {
      position: absolute;
      width: 8px;
      height: 8px;
      background-color: var(--danger-color);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    
    #mouse-position-indicator {
      position: absolute;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: rgba(0, 0, 0, 0.5);
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    
    .waypoint-marker {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: var(--accent-color);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: 15;
      cursor: pointer;
    }
    
    .waypoint-label {
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      background-color: white;
      padding: 2px 5px;
      border-radius: 3px;
      font-size: 10px;
      white-space: nowrap;
      border: 1px solid var(--border-color);
      z-index: 16;
      pointer-events: none;
    }
    
    .block-container {
      display: flex;
      flex-direction: column;
      height: 400px;
      gap: 10px;
    }
    
    .block-library {
      background-color: rgba(0,0,0,0.05);
      padding: 10px;
      border-radius: 4px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      max-height: 150px;
      overflow-y: auto;
    }
    .command-block {
      padding: 8px;
      border-radius: 4px;
      cursor: grab;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      position: relative;
      font-size: 12px;
      transition: box-shadow 0.2s, transform 0.2s;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .command-block:hover {
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      transform: translateY(-1px);
    }
    
    .command-block.move-up {
      background-color: var(--move-up-bg);
      border-left: 4px solid #198754;
    }
    
    .command-block.move-down {
      background-color: var(--move-down-bg);
      border-left: 4px solid #dc3545;
    }
    
    .command-block.move-left {
      background-color: var(--move-left-bg);
      border-left: 4px solid #0d6efd;
    }
    
    .command-block.move-right {
      background-color: var(--move-right-bg);
      border-left: 4px solid #ffc107;
    }
    
    .command-block.move-upleft {
      background-color: var(--move-upleft-bg);
      border-left: 4px solid #20c997;
    }
    
    .command-block.move-upright {
      background-color: var(--move-upright-bg);
      border-left: 4px solid #6c757d;
    }
    
    .command-block.move-downleft {
      background-color: var(--move-downleft-bg);
      border-left: 4px solid #6610f2;
    }
    
    .command-block.move-downright {
      background-color: var(--move-downright-bg);
      border-left: 4px solid #fd7e14;
    }
    
    .command-block.rotate-left {
      background-color: var(--rotate-left-bg);
      border-left: 4px solid #d63384;
    }
    
    .command-block.rotate-right {
      background-color: var(--rotate-right-bg);
      border-left: 4px solid #20c997;
    }
    
    .command-block.spin {
      background-color: var(--spin-bg);
      border-left: 4px solid #6610f2;
    }
    
    .command-block input {
      width: 40px;
      padding: 2px 5px;
      margin: 0 5px;
      border: 1px solid var(--border-color);
      border-radius: 3px;
    }
    
    .command-block .unit-label {
      font-size: 10px;
      color: #666;
    }
    
    .block-controls {
      position: absolute;
      right: 5px;
      top: 5px;
      display: flex;
      gap: 3px;
    }
    
    .block-controls button {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
      padding: 0;
    }
    
    .toggle-block {
      background-color: var(--secondary-color);
      color: white;
    }
    
    .delete-block {
      background-color: var(--danger-color);
      color: white;
    }
    
    .command-block.disabled {
      opacity: 0.5;
      text-decoration: line-through;
    }
    
    .command-block.selected-block {
      box-shadow: 0 0 0 2px var(--primary-color);
    }
    
    .drag-indicator {
      height: 2px;
      background-color: var(--primary-color);
      margin: 0;
      display: none;
      width: 100%;
    }
    
    .drag-indicator.active {
      display: block;
    }
    
    .program-area {
      flex: 1;
      background-color: rgba(255,255,255,0.8);
      border-radius: 4px;
      padding: 10px;
      overflow-y: auto;
      min-height: 200px;
      border: 1px dashed var(--border-color);
    }
    
    .run-program {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
      padding: 10px;
      border: none;
      border-radius: 4px;
      background-color: var(--secondary-color);
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .run-program:hover {
      background-color: #27ae60;
    }
    
    .run-program i {
      margin-right: 5px;
      font-style: normal;
    }
    
    .run-program.running {
      background-color: var(--danger-color);
    }
    
    .run-program.running:hover {
      background-color: #c0392b;
    }
    
    .saved-items {
      max-height: 100px;
      overflow-y: auto;
      margin-top: 5px;
    }
    
    .saved-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 5px 8px;
      background-color: rgba(255,255,255,0.8);
      border-radius: 3px;
      margin-bottom: 3px;
      font-size: 12px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .saved-item:hover {
      background-color: rgba(255,255,255,0.9);
    }
    
    .saved-item button {
      background: none;
      border: none;
      color: var(--danger-color);
      cursor: pointer;
      font-size: 16px;
      padding: 0 5px;
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    
    .modal-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    
    .modal-dialog {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 3px 15px rgba(0,0,0,0.2);
      min-width: 300px;
    }
    
    .modal-dialog h4 {
      margin-top: 0;
      margin-bottom: 15px;
    }
    
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    
    .modal-buttons button {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .modal-buttons .primary {
      background-color: var(--primary-color);
      color: white;
    }
    
    .modal-buttons .secondary {
      background-color: #95a5a6;
      color: white;
    }
    
    .import-export-textarea {
      width: 100%;
      height: 200px;
      font-family: monospace;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
      resize: none;
    }
    
    .tooltip {
      position: absolute;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 5px 10px;
      border-radius: 3px;
      font-size: 12px;
      pointer-events: none;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .notification {
      position: fixed;
      top: 60px;
      right: 20px;
      background-color: rgba(46, 204, 113, 0.9);
      color: white;
      padding: 10px 15px;
      border-radius: 4px;
      font-size: 14px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transform: translateX(120%);
      transition: transform 0.3s;
      z-index: 1000;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.error {
      background-color: rgba(231, 76, 60, 0.9);
    }
    
    .notification.warning {
      background-color: rgba(243, 156, 18, 0.9);
    }
    
    .notification.info {
      background-color: rgba(52, 152, 219, 0.9);
    }
    
    .history-controls {
      display: flex;
      gap: 5px;
    }
    
    .history-controls button {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .history-controls button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .path-trace {
      position: absolute;
      pointer-events: none;
      transition: opacity 0.5s;
    }
    
    #robot-context-menu {
      border-radius: 4px;
      overflow: hidden;
    }
    
    @media (max-width: 768px) {
      #control-panel {
        width: 250px;
      }
      
      .direction-btn {
        width: 36px;
        height: 36px;
      }
    }
  </style>
</head>
<body>
  <div id="header-bar">
    <div class="title">Robot Map Interface</div>
    <div id="header-controls">
      <button class="header-button" onclick="showExportDialog()">Xu·∫•t/Nh·∫≠p</button>
      <div class="theme-toggle" onclick="toggleTheme()">
        <span id="theme-text">Ch·∫ø ƒë·ªô t·ªëi</span>
        <div class="toggle-switch"></div>
      </div>
    </div>
  </div>
  
  <div id="main-container">
    <div id="control-panel">
      <!-- Ph√¢n khu 1: ƒêi·ªÅu khi·ªÉn v√† th√¥ng tin -->
      <div id="control-section" class="panel-section">
        <h3 class="panel-section-title">
          ƒêi·ªÅu Khi·ªÉn Robot
          <div class="history-controls">
            <button id="undo-button-1" onclick="undoAction()" title="Quay l·∫°i b∆∞·ªõc tr∆∞·ªõc (Ctrl+Z)">‚Ü©</button>
            <button id="redo-button-1" onclick="redoAction()" title="Ti·∫øn l·∫°i b∆∞·ªõc sau (Ctrl+Y)">‚Ü™</button>
          </div>
        </h3>
        
        <div class="panel-content">
          <!-- K√≠ch th∆∞·ªõc robot -->
          <div class="control-row">
            <label>K√≠ch th∆∞·ªõc robot:</label>
            <div class="slider-container">
              <input type="range" id="robot-size" min="20" max="150" value="50" oninput="resizeRobot(this.value)">
              <span id="size-display">50px</span>
            </div>
          </div>
          
          <!-- B∆∞·ªõc di chuy·ªÉn -->
          <div class="control-row">
            <label>B∆∞·ªõc di chuy·ªÉn:</label>
            <div class="slider-container">
              <input type="number" id="step-size" min="0.1" step="0.1" value="1" onchange="updateStepSize(this.value)" class="coordinate-input">
              <span>cm</span>
            </div>
          </div>
          
          <!-- K√≠ch th∆∞·ªõc v√† v·ªã tr√≠ map -->
          <div class="control-row">
            <label>K√≠ch th∆∞·ªõc map:</label>
            <div class="slider-container">
              <input type="range" id="map-size" min="50" max="200" value="100" oninput="resizeMap(this.value)">
              <span id="map-size-display">100%</span>
            </div>
          </div>
          
          <div class="control-row">
            <label>V·ªã tr√≠ map X:</label>
            <div class="slider-container">
              <input type="range" id="map-position-x" min="-50" max="50" value="0" oninput="adjustMapPosition('x', this.value)">
              <span id="map-position-x-display">0</span>
            </div>
          </div>
          
          <div class="control-row" id="map-y-position-control" style="display: none;">
            <label>V·ªã tr√≠ map Y:</label>
            <div class="slider-container">
              <input type="range" id="map-position-y" min="-50" max="50" value="0" oninput="adjustMapPosition('y', this.value)">
              <span id="map-position-y-display">0</span>
            </div>
          </div>
          
          <div class="control-row">
            <label>Cho ph√©p di chuy·ªÉn map theo chi·ªÅu d·ªçc:</label>
            <input type="checkbox" id="map-vertical-move" onchange="toggleMapVerticalMovement()">
          </div>
          
          <!-- Th√¥ng tin v·ªã tr√≠ hi·ªán t·∫°i -->
          <div class="control-row">
            <label>V·ªã tr√≠ robot (cm):</label>
            <div>
              X: <span id="current-x">0</span>, 
              Y: <span id="current-y">0</span>, 
              G√≥c: <span id="current-angle">0</span>¬∞
            </div>
          </div>
          
          <!-- T·ª∑ l·ªá cm/pixel -->
          <div class="control-row">
            <label>T·ª∑ l·ªá cm/pixel:</label>
            <span id="scale-ratio">1.00</span>
          </div>
          
          <!-- C√†i ƒë·∫∑t t·ªça ƒë·ªô c·ª• th·ªÉ -->
          <div class="control-row">
            <label>Di chuy·ªÉn ƒë·∫øn:</label>
            <div>
              X: <input type="number" id="target-x" class="coordinate-input" step="0.1"> 
              Y: <input type="number" id="target-y" class="coordinate-input" step="0.1">
              <button class="btn secondary" onclick="moveToCoordinates()">ƒêi</button>
            </div>
          </div>
          
          <!-- ƒêi·ªÅu khi·ªÉn h∆∞·ªõng di chuy·ªÉn -->
          <div class="direction-controls">
            <button class="direction-btn" onclick="moveRobotInDirection(-1, -1)" title="Di chuy·ªÉn ch√©o tr√°i l√™n">‚Üñ</button>
            <button class="direction-btn" onclick="moveRobotInDirection(0, -1)" title="Di chuy·ªÉn l√™n">‚Üë</button>
            <button class="direction-btn" onclick="moveRobotInDirection(1, -1)" title="Di chuy·ªÉn ch√©o ph·∫£i l√™n">‚Üó</button>
            <button class="direction-btn" onclick="moveRobotInDirection(-1, 0)" title="Di chuy·ªÉn tr√°i">‚Üê</button>
            <button class="direction-btn center" onclick="centerRobot()" title="V·ªÅ trung t√¢m">‚åÇ</button>
            <button class="direction-btn" onclick="moveRobotInDirection(1, 0)" title="Di chuy·ªÉn ph·∫£i">‚Üí</button>
            <button class="direction-btn" onclick="moveRobotInDirection(-1, 1)" title="Di chuy·ªÉn ch√©o tr√°i xu·ªëng">‚Üô</button>
            <button class="direction-btn" onclick="moveRobotInDirection(0, 1)" title="Di chuy·ªÉn xu·ªëng">‚Üì</button>
            <button class="direction-btn" onclick="moveRobotInDirection(1, 1)" title="Di chuy·ªÉn ch√©o ph·∫£i xu·ªëng">‚Üò</button>
          </div>
                    <!-- ƒêi·ªÅu khi·ªÉn g√≥c quay -->
                    <div class="control-row">
                      <label>ƒêi·ªÅu khi·ªÉn g√≥c quay:</label>
                      <div class="btn-group">
                        <button class="btn" onclick="rotateRobot(-15)" title="Quay tr√°i 15¬∞">‚Ü∫ 15¬∞</button>
                        <button class="btn" onclick="rotateRobot(15)" title="Quay ph·∫£i 15¬∞">15¬∞ ‚Üª</button>
                        <button class="btn" onclick="spinRobot()" title="Xoay tr√≤n">üîÑ</button>
                      </div>
                    </div>
                    
                    <!-- Hi·ªÉn th·ªã ƒë√°nh d·∫•u ƒëi·ªÉm -->
                    <div class="control-row">
                      <label>Hi·ªÉn th·ªã:</label>
                      <div>
                        <label class="toggle-btn">
                          <input type="checkbox" id="toggle-grid" onchange="toggleGrid()"> Grid
                        </label>
                        <label class="toggle-btn">
                          <input type="checkbox" id="toggle-path" onchange="togglePath()"> Path
                        </label>
                      </div>
                    </div>
                    
                    <!-- N√∫t ƒë·∫£o chi·ªÅu -->
                    <div class="control-row">
                      <label>ƒê·∫£o chi·ªÅu:</label>
                      <div>
                        <button id="toggle-vertical" class="btn" onclick="toggleInvert('vertical')">‚Üï Y</button>
                        <button id="toggle-horizontal" class="btn" onclick="toggleInvert('horizontal')">‚Üî X</button>
                      </div>
                    </div>
                    
                    <!-- X√≥a h·∫øt waypoints -->
                    <div class="control-row">
                      <button class="btn danger" onclick="clearAllWaypoints()">X√≥a t·∫•t c·∫£ waypoints</button>
                    </div>
                  </div>
                </div>
                
                <!-- Ph√¢n khu 2: L·∫≠p tr√¨nh kh·ªëi l·ªánh -->
                <div id="coding-section" class="panel-section">
                  <h3 class="panel-section-title">
                    L·∫≠p Tr√¨nh Robot
                    <div class="history-controls">
                      <button id="undo-button-2" onclick="undoAction()" title="Quay l·∫°i b∆∞·ªõc tr∆∞·ªõc (Ctrl+Z)">‚Ü©</button>
                      <button id="redo-button-2" onclick="redoAction()" title="Ti·∫øn l·∫°i b∆∞·ªõc sau (Ctrl+Y)">‚Ü™</button>
                    </div>
                  </h3>
                  <div class="block-container">
                    <div class="block-library">
                      <div class="command-block move-up" draggable="true" ondragstart="dragStart(event)" data-command="moveUp">
                        Di chuy·ªÉn l√™n <input type="number" value="1.0" step="0.1" min="0.1"> <span class="unit-label">cm</span>
                      </div>
                      <div class="command-block move-down" draggable="true" ondragstart="dragStart(event)" data-command="moveDown">
                        Di chuy·ªÉn xu·ªëng <input type="number" value="1.0" step="0.1" min="0.1"> <span class="unit-label">cm</span>
                      </div>
                      <div class="command-block move-left" draggable="true" ondragstart="dragStart(event)" data-command="moveLeft">
                        Di chuy·ªÉn tr√°i <input type="number" value="1.0" step="0.1" min="0.1"> <span class="unit-label">cm</span>
                      </div>
                      <div class="command-block move-right" draggable="true" ondragstart="dragStart(event)" data-command="moveRight">
                        Di chuy·ªÉn ph·∫£i <input type="number" value="1.0" step="0.1" min="0.1"> <span class="unit-label">cm</span>
                      </div>
                      <div class="command-block move-upleft" draggable="true" ondragstart="dragStart(event)" data-command="moveUpLeft">
                        Di chuy·ªÉn ch√©o tr√°i l√™n <input type="number" value="1.0" step="0.1" min="0.1"> <span class="unit-label">cm</span>
                      </div>
                      <div class="command-block move-upright" draggable="true" ondragstart="dragStart(event)" data-command="moveUpRight">
                        Di chuy·ªÉn ch√©o ph·∫£i l√™n <input type="number" value="1.0" step="0.1" min="0.1"> <span class="unit-label">cm</span>
                      </div>
                      <div class="command-block move-downleft" draggable="true" ondragstart="dragStart(event)" data-command="moveDownLeft">
                        Di chuy·ªÉn ch√©o tr√°i xu·ªëng <input type="number" value="1.0" step="0.1" min="0.1"> <span class="unit-label">cm</span>
                      </div>
                      <div class="command-block move-downright" draggable="true" ondragstart="dragStart(event)" data-command="moveDownRight">
                        Di chuy·ªÉn ch√©o ph·∫£i xu·ªëng <input type="number" value="1.0" step="0.1" min="0.1"> <span class="unit-label">cm</span>
                      </div>
                      <div class="command-block rotate-left" draggable="true" ondragstart="dragStart(event)" data-command="rotateLeft">
                        Xoay tr√°i <input type="number" value="15" step="1" min="1"> <span class="unit-label">¬∞</span>
                      </div>
                      <div class="command-block rotate-right" draggable="true" ondragstart="dragStart(event)" data-command="rotateRight">
                        Xoay ph·∫£i <input type="number" value="15" step="1" min="1"> <span class="unit-label">¬∞</span>
                      </div>
                      <div class="command-block spin" draggable="true" ondragstart="dragStart(event)" data-command="spin">
                        Xoay tr√≤n <input type="number" value="1" step="1" min="1"> <span class="unit-label">v√≤ng</span>
                      </div>
                    </div>
                    
                    <div class="program-area" 
                         ondrop="drop(event)" 
                         ondragover="allowDrop(event)"
                         ondragenter="dragEnter(event)"
                         ondragleave="dragLeave(event)">
                      <div class="drag-indicator"></div>
                      <!-- Block l·ªánh s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                    </div>
                    
                    <button class="run-program" onclick="runProgram()">
                      <i>‚ñ∂</i> Ch·∫°y ch∆∞∆°ng tr√¨nh
                    </button>
                  </div>
                </div>
                
                <!-- Ph√¢n khu 3: L∆∞u v√† t·∫£i -->
                <div id="save-section" class="panel-section">
                  <h3 class="panel-section-title">L∆∞u/T·∫£i Ch∆∞∆°ng Tr√¨nh</h3>
                  <div class="panel-content">
                    <div class="control-row">
                      <input type="text" id="program-name" placeholder="Nh·∫≠p t√™n ch∆∞∆°ng tr√¨nh" class="coordinate-input" style="width: 150px;">
                      <button class="btn secondary" onclick="saveProgram()">L∆∞u</button>
                    </div>
                    
                    <div class="saved-items" id="saved-programs-list">
                      <!-- Danh s√°ch ch∆∞∆°ng tr√¨nh s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                    </div>
                  </div>
                </div>
              </div>
              
              <div id="display-area">
                <div id="map-container">
                  <img id="map" src="map.png" alt="Map">
                  <div id="robot-container">
                    <img id="robot" src="robot.png" alt="Robot">
                  </div>
                  <div id="mouse-position-indicator"></div>
                  <div id="grid-overlay"></div>
                </div>
                
                <div id="coordinates-display">
                  <div>X: <span id="mouse-x">0</span> cm, Y: <span id="mouse-y">0</span> cm</div>
                </div>
                
                <div id="mini-map-container">
                  <div id="mini-map">
                    <div id="mini-map-indicator"></div>
                    <div id="mini-map-robot"></div>
                  </div>
                </div>
              </div>
            </div>
            
            <script>
              // Bi·∫øn l∆∞u tr·∫°ng th√°i
              let robotX = 0; // T·ªça ƒë·ªô X c·ªßa robot (pixel)
              let robotY = 0; // T·ªça ƒë·ªô Y c·ªßa robot (pixel)
              let robotAngle = 0; // G√≥c quay c·ªßa robot (ƒë·ªô)
              let robotSize = 50; // K√≠ch th∆∞·ªõc robot (pixel)
              let stepSize = 1.0; // B∆∞·ªõc di chuy·ªÉn (cm)
              let cmPerPixel = 1.0; // T·ª∑ l·ªá cm/pixel
              let isDragging = false; // ƒêang k√©o robot?
              let isDraggingEnabled = false; // Cho ph√©p k√©o th·∫£ robot?
              let showGrid = false; // Hi·ªÉn th·ªã l∆∞·ªõi?
              let showPath = false; // Hi·ªÉn th·ªã path?
              let invertVertical = false; // ƒê·∫£o chi·ªÅu d·ªçc?
              let invertHorizontal = false; // ƒê·∫£o chi·ªÅu ngang?
              let mapSize = 100; // K√≠ch th∆∞·ªõc b·∫£n ƒë·ªì (%)
              let mapPositionX = 0; // V·ªã tr√≠ X c·ªßa b·∫£n ƒë·ªì (%)
              let mapPositionY = 0; // V·ªã tr√≠ Y c·ªßa b·∫£n ƒë·ªì (%)
              let isRunningProgram = false; // ƒêang ch·∫°y ch∆∞∆°ng tr√¨nh?
              let isProgramPaused = false; // ƒêang t·∫°m d·ª´ng ch∆∞∆°ng tr√¨nh?
              let currentProgramStepIndex = -1; // Ch·ªâ s·ªë b∆∞·ªõc hi·ªán t·∫°i
              let programRunTimer = null; // B·ªô ƒë·∫øm th·ªùi gian ƒë·ªÉ ch·∫°y ch∆∞∆°ng tr√¨nh
              let waypoints = []; // M·∫£ng c√°c waypoints
              let waypointCounter = 1; // B·ªô ƒë·∫øm waypoint
              let selectedBlockIndex = -1; // Ch·ªâ s·ªë c·ªßa block ƒëang ch·ªçn
              let draggedBlock = null; // Block ƒëang ƒë∆∞·ª£c k√©o
              let draggedBlockIndex = -1; // Ch·ªâ s·ªë c·ªßa block ƒëang k√©o
              let dragIndicator = null; // D·∫•u hi·ªáu cho v·ªã tr√≠ k√©o th·∫£
              let history = []; // L·ªãch s·ª≠ thao t√°c
              let historyIndex = -1; // Ch·ªâ s·ªë v·ªã tr√≠ l·ªãch s·ª≠ hi·ªán t·∫°i
              let lastWaypoint = null; // Waypoint cu·ªëi c√πng (ƒë·ªÉ x√≥a khi di chuy·ªÉn)
              
              // L·∫•y tham chi·∫øu ƒë·∫øn c√°c ph·∫ßn t·ª≠ DOM
              const robotContainer = document.getElementById('robot-container');
              const robot = document.getElementById('robot');
              const map = document.getElementById('map');
              const mapContainer = document.getElementById('map-container');
              const robotSizeSlider = document.getElementById('robot-size');
              const sizeDisplay = document.getElementById('size-display');
              const currentXDisplay = document.getElementById('current-x');
              const currentYDisplay = document.getElementById('current-y');
              const currentAngleDisplay = document.getElementById('current-angle');
              const targetXInput = document.getElementById('target-x');
              const targetYInput = document.getElementById('target-y');
              const gridToggle = document.getElementById('toggle-grid');
              const pathToggle = document.getElementById('toggle-path');
              const gridOverlay = document.getElementById('grid-overlay');
              const stepSizeInput = document.getElementById('step-size');
              const scaleRatioDisplay = document.getElementById('scale-ratio');
              const programArea = document.querySelector('.program-area');
              const mapSizeSlider = document.getElementById('map-size');
              const mapSizeDisplay = document.getElementById('map-size-display');
              const mapPositionXSlider = document.getElementById('map-position-x');
              const mapPositionYSlider = document.getElementById('map-position-y');
              const mapPositionXDisplay = document.getElementById('map-position-x-display');
              const mapPositionYDisplay = document.getElementById('map-position-y-display');
              const mapYPositionControl = document.getElementById('map-y-position-control');
              const mapVerticalMoveCheckbox = document.getElementById('map-vertical-move');
              const mousePositionIndicator = document.getElementById('mouse-position-indicator');
              const coordinatesDisplay = document.getElementById('coordinates-display');
              const mouseXDisplay = document.getElementById('mouse-x');
              const mouseYDisplay = document.getElementById('mouse-y');
              const miniMapContainer = document.getElementById('mini-map-container');
              const miniMap = document.getElementById('mini-map');
              const miniMapIndicator = document.getElementById('mini-map-indicator');
              const miniMapRobot = document.getElementById('mini-map-robot');
              const undoButton1 = document.getElementById('undo-button-1');
              const redoButton1 = document.getElementById('redo-button-1');
              const undoButton2 = document.getElementById('undo-button-2');
              const redoButton2 = document.getElementById('redo-button-2');
              const runProgramButton = document.querySelector('.run-program');
              
              // Kh·ªüi t·∫°o ch·ª©c nƒÉng ban ƒë·∫ßu
              initializeFunctions();
              
              function initializeFunctions() {
                // T√≠nh to√°n v·ªã tr√≠ trung t√¢m ban ƒë·∫ßu
                centerRobot();
                
                // C·∫≠p nh·∫≠t hi·ªÉn th·ªã ban ƒë·∫ßu
                updateDisplay();
                
                // Th√™m s·ª± ki·ªán cho vi·ªác k√©o th·∫£ robot
                initializeDragging();
                
                // Th√™m s·ª± ki·ªán click cho map
                initializeMapClickEvents();
                
                // Kh·ªüi t·∫°o l·ªãch s·ª≠
                saveToHistory();
                
                // Th√™m s·ª± ki·ªán keyboard shortcuts
                setupKeyboardShortcuts();
                
                // Kh·ªüi t·∫°o hi·ªÉn th·ªã t·ªça ƒë·ªô chu·ªôt
                initializeCoordinatesDisplay();
                
                // Kh·ªüi t·∫°o mini-map
                initializeMiniMap();
                
                // K√©o th·∫£ cho block l·ªánh
                initializeDragAndDrop();
                
                // T·∫£i ch∆∞∆°ng tr√¨nh ƒë√£ l∆∞u
                loadSavedPrograms();
                
                // Kh·ªüi t·∫°o th√¥ng b√°o
                createNotificationElement();
                
                // Hi·ªÉn th·ªã tooltip
                setupTooltips();
              }
              
              // C·∫≠p nh·∫≠t th√¥ng tin hi·ªÉn th·ªã
              function updateDisplay() {
                // C·∫≠p nh·∫≠t c√°c hi·ªÉn th·ªã v·ªã tr√≠
                currentXDisplay.textContent = (robotX * cmPerPixel).toFixed(1);
                currentYDisplay.textContent = (robotY * cmPerPixel).toFixed(1);
                currentAngleDisplay.textContent = robotAngle.toFixed(1);
                
                // C·∫≠p nh·∫≠t t·ª∑ l·ªá
                scaleRatioDisplay.textContent = cmPerPixel.toFixed(2);
                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t
                const historyAvailable = history.length > 0 && historyIndex > 0;
                const redoAvailable = historyIndex < history.length - 1;
                
                undoButton1.disabled = !historyAvailable;
                redoButton1.disabled = !redoAvailable;
                undoButton2.disabled = !historyAvailable;
                redoButton2.disabled = !redoAvailable;
                
                // C·∫≠p nh·∫≠t mini-map
                updateMiniMap();
              }
              
              // C·∫≠p nh·∫≠t v·ªã tr√≠ v√† g√≥c quay c·ªßa robot
              function updateRobotPosition() {
                // Gi·ªõi h·∫°n robot trong ph·∫°m vi b·∫£n ƒë·ªì
                const mapRect = map.getBoundingClientRect();
                const maxX = mapRect.width;
                const maxY = mapRect.height;
                
                // ƒê·∫£m b·∫£o robot kh√¥ng ra kh·ªèi map
                robotX = Math.max(0, Math.min(robotX, maxX));
                robotY = Math.max(0, Math.min(robotY, maxY));
                
                // C·∫≠p nh·∫≠t v·ªã tr√≠ v√† g√≥c quay
                robotContainer.style.left = robotX + 'px';
                robotContainer.style.top = robotY + 'px';
                robot.style.transform = `translate(-50%, -50%) rotate(${robotAngle}deg)`;
                
                // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
                updateDisplay();
                
                // C·∫≠p nh·∫≠t mini-map
                updateMiniMap();
              }
              
              // Di chuy·ªÉn robot ƒë·∫øn trung t√¢m map
              function centerRobot() {
                // L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i ƒë·ªÉ undo
                saveToHistory();
                
                // L·∫•y k√≠ch th∆∞·ªõc map
                const mapRect = map.getBoundingClientRect();
                
                // ƒê·∫∑t robot v√†o trung t√¢m
                robotX = mapRect.width / 2;
                robotY = mapRect.height / 2;
                
                // C·∫≠p nh·∫≠t v·ªã tr√≠
                updateRobotPosition();
                
                // Th√¥ng b√°o
                showNotification('ƒê√£ ƒë·∫∑t robot v·ªÅ v·ªã tr√≠ trung t√¢m', 'info');
              }
              
              // Thay ƒë·ªïi k√≠ch th∆∞·ªõc robot
              function resizeRobot(newSize) {
                robotSize = parseInt(newSize);
                robot.style.width = robotSize + 'px';
                sizeDisplay.textContent = robotSize + 'px';
                
                // L∆∞u k√≠ch th∆∞·ªõc v√†o localStorage
                localStorage.setItem('robotSize', robotSize);
              }
              
              // Di chuy·ªÉn theo h∆∞·ªõng v·ªõi b∆∞·ªõc di chuy·ªÉn hi·ªán t·∫°i
              function moveRobotInDirection(dirX, dirY) {
                // L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i ƒë·ªÉ undo
                saveToHistory();
                
                // T√≠nh to√°n kho·∫£ng c√°ch di chuy·ªÉn theo cm
                const distanceCm = parseFloat(stepSizeInput.value) || 1.0;
                
                // Chuy·ªÉn ƒë·ªïi v·ªÅ pixel
                const distancePixels = distanceCm / cmPerPixel;
                
                // X√°c ƒë·ªãnh h∆∞·ªõng t√πy thu·ªôc v√†o tr·∫°ng th√°i ƒë·∫£o chi·ªÅu
                let actualDirX = invertHorizontal ? -dirX : dirX;
                let actualDirY = invertVertical ? -dirY : dirY;
                
                // V·ªã tr√≠ c≈© ƒë·ªÉ v·∫Ω path
                const oldX = robotX;
                const oldY = robotY;
                
                // Di chuy·ªÉn theo h∆∞·ªõng
                if (actualDirX !== 0 && actualDirY !== 0) {
                  // Di chuy·ªÉn ch√©o (nh√¢n v·ªõi 0.7071 ~ 1/sqrt(2) ƒë·ªÉ gi·ªØ ƒë√∫ng kho·∫£ng c√°ch)
                  robotX += actualDirX * distancePixels * 0.7071;
                  robotY += actualDirY * distancePixels * 0.7071;
                } else {
                  // Di chuy·ªÉn th·∫≥ng
                  robotX += actualDirX * distancePixels;
                  robotY += actualDirY * distancePixels;
                }
                
                // C·∫≠p nh·∫≠t v·ªã tr√≠
                updateRobotPosition();
                
                // V·∫Ω path n·∫øu ƒë∆∞·ª£c b·∫≠t
                if (showPath) {
                  traceRobotPath(oldX, oldY, robotX, robotY);
                }
              }
    // Quay g√≥c robot theo m·ªôt g√≥c nh·∫•t ƒë·ªãnh
    function rotateRobot(angle) {
      // L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i ƒë·ªÉ undo
      saveToHistory();
      
      // C·∫≠p nh·∫≠t g√≥c quay
      robotAngle += angle;
      
      // Gi·ªØ g√≥c trong kho·∫£ng 0-360 ƒë·ªô
      robotAngle = (robotAngle + 360) % 360;
      
      // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
      updateRobotPosition();
    }
    
    // Xoay tr√≤n robot
    function spinRobot() {
      // L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i ƒë·ªÉ undo
      saveToHistory();
      
      // Quay robot 360 ƒë·ªô
      const targetAngle = robotAngle + 360;
      
      // T·∫°o hi·ªáu ·ª©ng quay m∆∞·ª£t
      let startAngle = robotAngle;
      const startTime = Date.now();
      const spinDuration = 1000; // 1 gi√¢y cho m·ªôt v√≤ng quay
      
      function animateSpin() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / spinDuration, 1);
        
        // T√≠nh g√≥c quay hi·ªán t·∫°i
        robotAngle = startAngle + progress * 360;
        
        // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
        robot.style.transform = `translate(-50%, -50%) rotate(${robotAngle}deg)`;
        
        // Ti·∫øp t·ª•c quay n·∫øu ch∆∞a ho√†n th√†nh
        if (progress < 1) {
          requestAnimationFrame(animateSpin);
        } else {
          // Khi ho√†n th√†nh, ƒë·∫£m b·∫£o g√≥c n·∫±m trong kho·∫£ng 0-360
          robotAngle = (robotAngle + 360) % 360;
          
          // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
          updateDisplay();
        }
      }
      
      // B·∫Øt ƒë·∫ßu quay
      animateSpin();
    }
    
    // Di chuy·ªÉn ƒë·∫øn t·ªça ƒë·ªô c·ª• th·ªÉ
    function moveToCoordinates() {
      // L·∫•y t·ªça ƒë·ªô t·ª´ input
      const targetX = parseFloat(targetXInput.value);
      const targetY = parseFloat(targetYInput.value);
      
      // Ki·ªÉm tra t·ªça ƒë·ªô h·ª£p l·ªá
      if (isNaN(targetX) || isNaN(targetY)) {
        showNotification('Vui l√≤ng nh·∫≠p t·ªça ƒë·ªô h·ª£p l·ªá', 'error');
        return;
      }
      
      // L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i ƒë·ªÉ undo
      saveToHistory();
      
      // Chuy·ªÉn ƒë·ªïi t·ª´ cm sang pixel
      const targetXPixel = targetX / cmPerPixel;
      const targetYPixel = targetY / cmPerPixel;
      
      // V·ªã tr√≠ c≈© ƒë·ªÉ v·∫Ω path
      const oldX = robotX;
      const oldY = robotY;
      
      // C·∫≠p nh·∫≠t v·ªã tr√≠ m·ªõi
      robotX = invertHorizontal ? -targetXPixel : targetXPixel;
      robotY = invertVertical ? -targetYPixel : targetYPixel;
      
      // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
      updateRobotPosition();
      
      // V·∫Ω path n·∫øu ƒë∆∞·ª£c b·∫≠t
      if (showPath) {
        traceRobotPath(oldX, oldY, robotX, robotY);
      }
      
      // Th√¥ng b√°o
      showNotification(`ƒê√£ di chuy·ªÉn ƒë·∫øn (${targetX.toFixed(1)}, ${targetY.toFixed(1)})`, 'info');
    }
    
    // C·∫≠p nh·∫≠t b∆∞·ªõc di chuy·ªÉn
    function updateStepSize(value) {
      stepSize = parseFloat(value) || 1.0;
      
      // L∆∞u v√†o localStorage
      localStorage.setItem('stepSize', stepSize);
    }
    
    // Thay ƒë·ªïi k√≠ch th∆∞·ªõc b·∫£n ƒë·ªì
    function resizeMap(size) {
      mapSize = parseInt(size);
      map.style.width = mapSize + '%';
      mapSizeDisplay.textContent = mapSize + '%';
      
      // C·∫≠p nh·∫≠t l·∫°i v·ªã tr√≠ robot khi map thay ƒë·ªïi k√≠ch th∆∞·ªõc
      updateRobotPosition();
      
      // C·∫≠p nh·∫≠t l∆∞·ªõi n·∫øu ƒëang hi·ªÉn th·ªã
      if (showGrid) {
        createGrid();
      }
      
      // C·∫≠p nh·∫≠t mini-map
      updateMiniMap();
      
      // L∆∞u v√†o localStorage
      localStorage.setItem('mapSize', mapSize);
    }
    
    // ƒêi·ªÅu ch·ªânh v·ªã tr√≠ b·∫£n ƒë·ªì
    function adjustMapPosition(axis, value) {
      const adjustValue = parseInt(value);
      
      if (axis === 'x') {
        mapPositionX = adjustValue;
        map.style.marginLeft = mapPositionX + '%';
        mapPositionXDisplay.textContent = mapPositionX;
      } else {
        mapPositionY = adjustValue;
        map.style.marginTop = mapPositionY + '%';
        mapPositionYDisplay.textContent = mapPositionY;
      }
      
      // C·∫≠p nh·∫≠t mini-map
      updateMiniMap();
      
      // L∆∞u v√†o localStorage
      localStorage.setItem('mapPositionX', mapPositionX);
      localStorage.setItem('mapPositionY', mapPositionY);
    }
    
    // B·∫≠t/t·∫Øt ch·∫ø ƒë·ªô di chuy·ªÉn map theo chi·ªÅu d·ªçc
    function toggleMapVerticalMovement() {
      if (mapVerticalMoveCheckbox.checked) {
        mapYPositionControl.style.display = 'flex';
      } else {
        mapYPositionControl.style.display = 'none';
        mapPositionY = 0;
        map.style.marginTop = '0%';
        mapPositionYDisplay.textContent = '0';
      }
      
      // L∆∞u v√†o localStorage
      localStorage.setItem('mapVerticalMove', mapVerticalMoveCheckbox.checked);
    }
    
    // Kh·ªüi t·∫°o k√©o th·∫£ robot
    function initializeDragging() {
      robotContainer.addEventListener('mousedown', startDragging);
      document.addEventListener('mousemove', dragRobot);
      document.addEventListener('mouseup', stopDragging);
      
      // ƒê·∫∑t ch·∫ø ƒë·ªô k√©o th·∫£ ban ƒë·∫ßu
      toggleDragging();
    }
    
    // B·∫Øt ƒë·∫ßu k√©o robot
    function startDragging(e) {
      if (isDraggingEnabled) {
        isDragging = true;
        robotContainer.classList.add('dragging');
        
        // L∆∞u tr·∫°ng th√°i tr∆∞·ªõc khi k√©o
        saveToHistory();
      }
    }
    
    // K√©o robot
    function dragRobot(e) {
      if (isDragging && isDraggingEnabled) {
        // L·∫•y v·ªã tr√≠ c≈© ƒë·ªÉ v·∫Ω path
        const oldX = robotX;
        const oldY = robotY;
        
        // L·∫•y v·ªã tr√≠ chu·ªôt t∆∞∆°ng ƒë·ªëi v·ªõi mapContainer
        const rect = mapContainer.getBoundingClientRect();
        robotX = e.clientX - rect.left;
        robotY = e.clientY - rect.top;
        
        // C·∫≠p nh·∫≠t v·ªã tr√≠
        updateRobotPosition();
        
        // V·∫Ω path n·∫øu ƒë∆∞·ª£c b·∫≠t
        if (showPath) {
          traceRobotPath(oldX, oldY, robotX, robotY);
        }
      }
    }
    
    // D·ª´ng k√©o robot
    function stopDragging() {
      if (isDragging) {
        isDragging = false;
        robotContainer.classList.remove('dragging');
      }
    }
    
    // B·∫≠t/t·∫Øt ch·∫ø ƒë·ªô k√©o th·∫£
    function toggleDragging() {
      isDraggingEnabled = !isDraggingEnabled;
      
      if (isDraggingEnabled) {
        robotContainer.style.cursor = 'grab';
      } else {
        robotContainer.style.cursor = 'default';
      }
    }
    
    // Kh·ªüi t·∫°o s·ª± ki·ªán click cho map
    function initializeMapClickEvents() {
      mapContainer.addEventListener('click', function(e) {
        if (!isDragging) {
          // Ki·ªÉm tra xem c√≥ ƒëang click v√†o robot kh√¥ng
          const target = e.target;
          if (target !== robot && target !== robotContainer) {
            // L∆∞u v·ªã tr√≠ c≈© ƒë·ªÉ v·∫Ω path
            const oldX = robotX;
            const oldY = robotY;
            
            // L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i ƒë·ªÉ undo
            saveToHistory();
            
            // L·∫•y v·ªã tr√≠ click t∆∞∆°ng ƒë·ªëi v·ªõi mapContainer
            const rect = mapContainer.getBoundingClientRect();
            robotX = e.clientX - rect.left;
            robotY = e.clientY - rect.top;
            
            // C·∫≠p nh·∫≠t v·ªã tr√≠
            updateRobotPosition();
            
            // V·∫Ω path n·∫øu ƒë∆∞·ª£c b·∫≠t
            if (showPath) {
              traceRobotPath(oldX, oldY, robotX, robotY);
            }
          }
        }
      });
    }
    
    // ƒê·∫£o chi·ªÅu di chuy·ªÉn
    function toggleInvert(axis) {
      if (axis === 'vertical') {
        invertVertical = !invertVertical;
        document.getElementById('toggle-vertical').classList.toggle('accent');
      } else {
        invertHorizontal = !invertHorizontal;
        document.getElementById('toggle-horizontal').classList.toggle('accent');
      }
      
      // L∆∞u v√†o localStorage
      localStorage.setItem('invertVertical', invertVertical);
      localStorage.setItem('invertHorizontal', invertHorizontal);
    }
    
    // T·∫°o l∆∞·ªõi tr√™n map
    function createGrid() {
      // X√≥a l∆∞·ªõi c≈©
      gridOverlay.innerHTML = '';
      
      // L·∫•y k√≠ch th∆∞·ªõc map
      const mapWidth = map.offsetWidth;
      const mapHeight = map.offsetHeight;
      
      // ƒê·∫∑t k√≠ch th∆∞·ªõc c·ªßa grid overlay
      gridOverlay.style.width = mapWidth + 'px';
      gridOverlay.style.height = mapHeight + 'px';
      
      // K√≠ch th∆∞·ªõc √¥ l∆∞·ªõi (c·ªë ƒë·ªãnh 10cm)
      const gridSizePixels = 10 / cmPerPixel; // 10cm
      
      // S·ªë d√≤ng v√† c·ªôt
      const numRows = Math.floor(mapHeight / gridSizePixels);
      const numCols = Math.floor(mapWidth / gridSizePixels);
      
      // T·∫°o c√°c d√≤ng ngang
      for (let i = 1; i < numRows; i++) {
        const y = i * gridSizePixels;
        const line = document.createElement('div');
        line.className = 'grid-line';
        line.style.left = '0';
        line.style.width = '100%';
        line.style.height = '1px';
        line.style.top = y + 'px';
        gridOverlay.appendChild(line);
      }
      
      // T·∫°o c√°c c·ªôt d·ªçc
      for (let i = 1; i < numCols; i++) {
        const x = i * gridSizePixels;
        const line = document.createElement('div');
        line.className = 'grid-line';
        line.style.top = '0';
        line.style.height = '100%';
        line.style.width = '1px';
        line.style.left = x + 'px';
        gridOverlay.appendChild(line);
      }
    }
    
    // B·∫≠t/t·∫Øt hi·ªÉn th·ªã l∆∞·ªõi
    function toggleGrid() {
      showGrid = gridToggle.checked;
      
      if (showGrid) {
        createGrid();
        gridOverlay.style.display = 'block';
      } else {
        gridOverlay.style.display = 'none';
      }
      
      // L∆∞u v√†o localStorage
      localStorage.setItem('showGrid', showGrid);
    }
    
    // B·∫≠t/t·∫Øt hi·ªÉn th·ªã ƒë∆∞·ªùng ƒëi
    function togglePath() {
      showPath = pathToggle.checked;
      
      const pathElements = document.querySelectorAll('.path-trace');
      
      if (showPath) {
        pathElements.forEach(el => el.style.opacity = '1');
      } else {
        pathElements.forEach(el => el.style.opacity = '0');
      }
      
      // L∆∞u v√†o localStorage
      localStorage.setItem('showPath', showPath);
    }
    
    // V·∫Ω ƒë∆∞·ªùng ƒëi c·ªßa robot
    function traceRobotPath(fromX, fromY, toX, toY) {
      // T√≠nh to√°n ƒë·ªô d√†i v√† g√≥c c·ªßa ƒë∆∞·ªùng ƒëi
      const dx = toX - fromX;
      const dy = toY - fromY;
      const distance = Math.sqrt(dx * dx + dy * dy);
      const angle = Math.atan2(dy, dx) * 180 / Math.PI;
      
      // T·∫°o element v·∫Ω ƒë∆∞·ªùng ƒëi
      const pathTrace = document.createElement('div');
      pathTrace.className = 'path-trace';
      pathTrace.style.position = 'absolute';
      pathTrace.style.width = distance + 'px';
      pathTrace.style.height = '2px';
      pathTrace.style.backgroundColor = '#e74c3c';
      pathTrace.style.opacity = showPath ? '1' : '0';
      pathTrace.style.left = fromX + 'px';
      pathTrace.style.top = fromY + 'px';
      pathTrace.style.transformOrigin = '0 50%';
      pathTrace.style.transform = `rotate(${angle}deg)`;
      pathTrace.style.zIndex = '5';
      
      mapContainer.appendChild(pathTrace);
      
      // Gi·ªØ l·∫°i kh√¥ng qu√° 100 ƒë∆∞·ªùng path ƒë·ªÉ tr√°nh ch·∫≠m
      const pathElements = document.querySelectorAll('.path-trace');
      if (pathElements.length > 100) {
        pathElements[0].remove();
      }
    }
    
    // X√≥a t·∫•t c·∫£ ƒë∆∞·ªùng ƒëi
    function clearAllPaths() {
      const pathElements = document.querySelectorAll('.path-trace');
      pathElements.forEach(el => el.remove());
    }
    
    // Th√™m waypoint t·∫°i v·ªã tr√≠ robot hi·ªán t·∫°i
    function addWaypoint() {
      waypointCounter++;
      const waypoint = {
        id: Date.now(),
        number: waypointCounter,
        x: robotX,
        y: robotY,
        angle: robotAngle
      };
      
      waypoints.push(waypoint);
      
      // T·∫°o marker cho waypoint
      createWaypointMarker(waypoint);
    }
    
    // T·∫°o marker cho waypoint
    function createWaypointMarker(waypoint) {
      const marker = document.createElement('div');
      marker.className = 'waypoint-marker';
      marker.dataset.id = waypoint.id;
      marker.style.left = waypoint.x + 'px';
      marker.style.top = waypoint.y + 'px';
      marker.title = `Waypoint ${waypoint.number}`;
      
      // Th√™m nh√£n
      const label = document.createElement('div');
      label.className = 'waypoint-label';
      label.textContent = `WP ${waypoint.number} (${(waypoint.x * cmPerPixel).toFixed(1)}, ${(waypoint.y * cmPerPixel).toFixed(1)}, ${waypoint.angle.toFixed(1)}¬∞)`;
      
      marker.appendChild(label);
      mapContainer.appendChild(marker);
      
      // Th√™m s·ª± ki·ªán click ƒë·ªÉ di chuy·ªÉn ƒë·∫øn waypoint
      marker.addEventListener('click', function() {
        // L∆∞u v·ªã tr√≠ c≈© ƒë·ªÉ v·∫Ω path
        const oldX = robotX;
        const oldY = robotY;
        
        // L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i ƒë·ªÉ undo
        saveToHistory();
        
        // Di chuy·ªÉn ƒë·∫øn waypoint
        robotX = waypoint.x;
        robotY = waypoint.y;
        robotAngle = waypoint.angle;
        
        // C·∫≠p nh·∫≠t v·ªã tr√≠
        updateRobotPosition();
        
        // V·∫Ω path n·∫øu ƒë∆∞·ª£c b·∫≠t
        if (showPath) {
          traceRobotPath(oldX, oldY, robotX, robotY);
        }
      });
    }
    
    // X√≥a t·∫•t c·∫£ waypoints
    function clearAllWaypoints() {
      // L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i ƒë·ªÉ undo
      saveToHistory();
      
      // X√≥a t·∫•t c·∫£ markers
      const markers = document.querySelectorAll('.waypoint-marker');
      markers.forEach(marker => marker.remove());
      
      // X√≥a m·∫£ng waypoints
      waypoints = [];
      waypointCounter = 1;
      
      // Th√¥ng b√°o
      showNotification('ƒê√£ x√≥a t·∫•t c·∫£ c√°c waypoints', 'info');
    }
    
    // Kh·ªüi t·∫°o hi·ªÉn th·ªã t·ªça ƒë·ªô chu·ªôt
    function initializeCoordinatesDisplay() {
      mapContainer.addEventListener('mousemove', function(e) {
        const rect = mapContainer.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        // Chuy·ªÉn ƒë·ªïi sang cm
        const mouseXCm = (mouseX * cmPerPixel).toFixed(1);
        const mouseYCm = (mouseY * cmPerPixel).toFixed(1);
        
        // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
        mouseXDisplay.textContent = mouseXCm;
        mouseYDisplay.textContent = mouseYCm;
        
        // C·∫≠p nh·∫≠t v·ªã tr√≠ con tr·ªè
        mousePositionIndicator.style.left = mouseX + 'px';
        mousePositionIndicator.style.top = mouseY + 'px';
        mousePositionIndicator.style.display = 'block';
      });
      
      mapContainer.addEventListener('mouseleave', function() {
        mousePositionIndicator.style.display = 'none';
      });
    }
    
    // Kh·ªüi t·∫°o mini-map
    function initializeMiniMap() {
      // C·∫≠p nh·∫≠t mini-map khi map thay ƒë·ªïi
      updateMiniMap();
      
      // Th√™m s·ª± ki·ªán click cho mini-map ƒë·ªÉ di chuy·ªÉn viewport
      miniMap.addEventListener('click', function(e) {
        const rect = miniMap.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const clickY = e.clientY - rect.top;
        
        // T√≠nh t·ª∑ l·ªá
        const mapRect = map.getBoundingClientRect();
        const containerRect = mapContainer.getBoundingClientRect();
        
        const ratioX = mapRect.width / miniMap.offsetWidth;
        const ratioY = mapRect.height / miniMap.offsetHeight;
        
        // T√≠nh v·ªã tr√≠ scroll
        const scrollX = clickX * ratioX - containerRect.width / 2;
        const scrollY = clickY * ratioY - containerRect.height / 2;
        
        // Di chuy·ªÉn viewport
        mapContainer.scrollLeft = scrollX;
        mapContainer.scrollTop = scrollY;
      });
    }
    
    // C·∫≠p nh·∫≠t mini-map
    function updateMiniMap() {
      // L·∫•y k√≠ch th∆∞·ªõc v√† v·ªã tr√≠ c·ªßa map v√† container
      const mapRect = map.getBoundingClientRect();
      const containerRect = mapContainer.getBoundingClientRect();
      
      // T√≠nh t·ª∑ l·ªá thu nh·ªè
      const scaleX = miniMap.offsetWidth / mapRect.width;
      const scaleY = miniMap.offsetHeight / mapRect.height;
      
      // C·∫≠p nh·∫≠t v·ªã tr√≠ robot tr√™n mini-map
      const robotMiniX = robotX * scaleX;
      const robotMiniY = robotY * scaleY;
      
      miniMapRobot.style.left = robotMiniX + 'px';
      miniMapRobot.style.top = robotMiniY + 'px';
      
      // C·∫≠p nh·∫≠t indicator cho ph·∫ßn hi·ªÉn th·ªã
      const indicatorWidth = containerRect.width * scaleX;
      const indicatorHeight = containerRect.height * scaleY;
      const indicatorLeft = mapContainer.scrollLeft * scaleX;
      const indicatorTop = mapContainer.scrollTop * scaleY;
      
      miniMapIndicator.style.width = indicatorWidth + 'px';
      miniMapIndicator.style.height = indicatorHeight + 'px';
      miniMapIndicator.style.left = indicatorLeft + 'px';
      miniMapIndicator.style.top = indicatorTop + 'px';
    }
    
    // L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i v√†o l·ªãch s·ª≠
    function saveToHistory() {
      // X√≥a c√°c b∆∞·ªõc sau v·ªã tr√≠ hi·ªán t·∫°i
      if (historyIndex < history.length - 1) {
        history.splice(historyIndex + 1);
      }
      
      // L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i
      const state = {
        robotX: robotX,
        robotY: robotY,
        robotAngle: robotAngle,
        waypoints: JSON.parse(JSON.stringify(waypoints)),
        waypointCounter: waypointCounter
      };
      
      history.push(state);
      historyIndex = history.length - 1;
      
      // Gi·ªõi h·∫°n l·ªãch s·ª≠ kh√¥ng qu√° 50 b∆∞·ªõc
      if (history.length > 50) {
        history.shift();
        historyIndex--;
      }
      
      // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t
      updateDisplay();
    }
    
    // Quay l·∫°i b∆∞·ªõc tr∆∞·ªõc
    function undoAction() {
      if (historyIndex > 0) {
        historyIndex--;
        restoreFromHistory();
      }
    }
    
    // Ti·∫øn l·∫°i b∆∞·ªõc sau
    function redoAction() {
      if (historyIndex < history.length - 1) {
        historyIndex++;
        restoreFromHistory();
      }
    }
    
    // Kh√¥i ph·ª•c tr·∫°ng th√°i t·ª´ l·ªãch s·ª≠
    function restoreFromHistory() {
      const state = history[historyIndex];
      
      // Kh√¥i ph·ª•c v·ªã tr√≠ robot
      robotX = state.robotX;
      robotY = state.robotY;
      robotAngle = state.robotAngle;
      
      // Kh√¥i ph·ª•c waypoints
      waypoints = JSON.parse(JSON.stringify(state.waypoints));
      waypointCounter = state.waypointCounter;
      
      // X√≥a t·∫•t c·∫£ markers
      const markers = document.querySelectorAll('.waypoint-marker');
      markers.forEach(marker => marker.remove());
      
      // T·∫°o l·∫°i markers
      waypoints.forEach(waypoint => createWaypointMarker(waypoint));
      
      // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
      updateRobotPosition();
    }
    
    // Kh·ªüi t·∫°o k√©o th·∫£ cho block l·ªánh
    function initializeDragAndDrop() {
      dragIndicator = document.querySelector('.drag-indicator');
      
      // Th√™m s·ª± ki·ªán cho v√πng program
      programArea.addEventListener('dragover', function(e) {
        if (isRunningProgram) return;
        
        // L·∫•y v·ªã tr√≠ chu·ªôt
        const mouseY = e.clientY;
        
        // L·∫•y t·∫•t c·∫£ c√°c block trong program area
        const blocks = Array.from(programArea.querySelectorAll('.command-block'));
        
        // T√¨m v·ªã tr√≠ drop
        let dropIndex = blocks.length;
        
        for (let i = 0; i < blocks.length; i++) {
          const block = blocks[i];
          const rect = block.getBoundingClientRect();
          
          if (mouseY < rect.top + rect.height / 2) {
            dropIndex = i;
            break;
          }
        }
        
        // C·∫≠p nh·∫≠t v·ªã tr√≠ indicator
        if (blocks.length === 0) {
          dragIndicator.style.display = 'block';
          dragIndicator.style.margin = '0';
          dragIndicator.classList.add('active');
        } else if (dropIndex === 0) {
          dragIndicator.style.display = 'block';
          dragIndicator.style.margin = '0 0 5px 0';
          blocks[0].before(dragIndicator);
          dragIndicator.classList.add('active');
        } else if (dropIndex === blocks.length) {
          dragIndicator.style.display = 'block';
          dragIndicator.style.margin = '5px 0 0 0';
          blocks[blocks.length - 1].after(dragIndicator);
          dragIndicator.classList.add('active');
        } else {
          dragIndicator.style.display = 'block';
          dragIndicator.style.margin = '5px 0';
          blocks[dropIndex].before(dragIndicator);
          dragIndicator.classList.add('active');
        }
      });
    }
    
    // B·∫Øt ƒë·∫ßu k√©o block
    function dragStart(event) {
      if (isRunningProgram) return;
      
      const block = event.target.closest('.command-block');
      
      // N·∫øu l√† t·ª´ th∆∞ vi·ªán, s·∫Ω t·∫°o m·ªôt b·∫£n sao
      if (block.parentElement.classList.contains('block-library')) {
        // T·∫°o block m·ªõi ƒë·ªÉ k√©o th·∫£
        const clonedBlock = block.cloneNode(true);
        
        // Th√™m n√∫t ƒëi·ªÅu khi·ªÉn
        const controls = document.createElement('div');
        controls.className = 'block-controls';
        
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'toggle-block';
        toggleBtn.innerHTML = '‚úì';
        toggleBtn.title = 'B·∫≠t/t·∫Øt l·ªánh';
        toggleBtn.onclick = function(e) {
          e.stopPropagation();
          toggleCommandBlock(this.parentElement.parentElement);
        };
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-block';
        deleteBtn.innerHTML = '√ó';
        deleteBtn.title = 'X√≥a l·ªánh';
        deleteBtn.onclick = function(e) {
          e.stopPropagation();
          deleteCommandBlock(this.parentElement.parentElement);
        };
        
        controls.appendChild(toggleBtn);
        controls.appendChild(deleteBtn);
        clonedBlock.appendChild(controls);
        
        // ƒê·∫∑t d·ªØ li·ªáu cho event k√©o th·∫£
        event.dataTransfer.setData('text/plain', 'new');
        draggedBlock = clonedBlock;
      } else {
        // ƒêang k√©o block c√≥ s·∫µn trong program area
        event.dataTransfer.setData('text/plain', 'existing');
        draggedBlock = block;
        draggedBlockIndex = Array.from(programArea.querySelectorAll('.command-block')).indexOf(block);
      }
    }
    
    // Cho ph√©p th·∫£
    function allowDrop(event) {
      if (isRunningProgram) return;
      event.preventDefault();
    }
    
    // Khi drag v√†o v√πng program
    function dragEnter(event) {
      if (isRunningProgram) return;
      event.preventDefault();
    }
    
    // Khi drag ra kh·ªèi v√πng program
    function dragLeave(event) {
      if (isRunningProgram) return;
      
      // ·∫®n indicator khi k√©o ra ngo√†i
      if (event.relatedTarget === null || !programArea.contains(event.relatedTarget)) {
        dragIndicator.classList.remove('active');
      }
    }
    
    // Khi th·∫£ block
    function drop(event) {
      if (isRunningProgram) return;
      event.preventDefault();
      
      // ·∫®n indicator
      dragIndicator.classList.remove('active');
      
      // X√°c ƒë·ªãnh v·ªã tr√≠ th·∫£
      const blocks = Array.from(programArea.querySelectorAll('.command-block'));
      const mouseY = event.clientY;
      
      let dropIndex = blocks.length;
      
      for (let i = 0; i < blocks.length; i++) {
        const block = blocks[i];
        const rect = block.getBoundingClientRect();
        
        if (mouseY < rect.top + rect.height / 2) {
          dropIndex = i;
          break;
        }
      }
      
      // Ki·ªÉm tra xem c√≥ ph·∫£i l√† di chuy·ªÉn block hi·ªán c√≥ kh√¥ng
      const dataType = event.dataTransfer.getData('text/plain');
      
      if (dataType === 'existing') {
        // N·∫øu th·∫£ block ·ªü v·ªã tr√≠ c≈©, kh√¥ng l√†m g√¨ c·∫£
        if (draggedBlockIndex === dropIndex || draggedBlockIndex + 1 === dropIndex) {
          return;
        }
        
        // Di chuy·ªÉn block ƒë·∫øn v·ªã tr√≠ m·ªõi
        draggedBlock.remove();
        
        if (dropIndex === blocks.length || draggedBlockIndex < dropIndex) {
          if (dropIndex === blocks.length) {
            programArea.appendChild(draggedBlock);
          } else {
            blocks[dropIndex].before(draggedBlock);
          }
        } else {
          blocks[dropIndex].before(draggedBlock);
        }
        
        // L∆∞u l·ªãch s·ª≠ cho h√†nh ƒë·ªông s·∫Øp x·∫øp l·∫°i
        saveToHistory();
      } else {
        // Th√™m block m·ªõi v√†o program area
        if (dropIndex === blocks.length) {
          programArea.appendChild(draggedBlock);
        } else {
          blocks[dropIndex].before(draggedBlock);
        }
        
        // Th√™m s·ª± ki·ªán cho block m·ªõi
        addBlockEvents(draggedBlock);
        
        // L∆∞u l·ªãch s·ª≠ cho h√†nh ƒë·ªông th√™m m·ªõi
        saveToHistory();
      }
      
      // Reset
      draggedBlock = null;
      draggedBlockIndex = -1;
    }
    
    // Th√™m s·ª± ki·ªán cho block l·ªánh
    function addBlockEvents(block) {
      block.addEventListener('click', function() {
        // B·ªè ch·ªçn block hi·ªán t·∫°i
        const selectedBlock = programArea.querySelector('.selected-block');
        if (selectedBlock) {
          selectedBlock.classList.remove('selected-block');
        }
        
        // Ch·ªçn block n√†y
        block.classList.add('selected-block');
        selectedBlockIndex = Array.from(programArea.querySelectorAll('.command-block')).indexOf(block);
      });
    }
    
    // B·∫≠t/t·∫Øt block l·ªánh
    function toggleCommandBlock(block) {
      block.classList.toggle('disabled');
    }
    
    // X√≥a block l·ªánh
    function deleteCommandBlock(block) {
      // L∆∞u l·ªãch s·ª≠ tr∆∞·ªõc khi x√≥a
      saveToHistory();
      
      // X√≥a block
      block.remove();
    }
    
    // Ch·∫°y ch∆∞∆°ng tr√¨nh
    function runProgram() {
      // N·∫øu ƒëang ch·∫°y, d·ª´ng l·∫°i
      if (isRunningProgram) {
        stopProgram();
        return;
      }
      
      // L∆∞u tr·∫°ng th√°i ban ƒë·∫ßu
      saveToHistory();
      
      // L·∫•y t·∫•t c·∫£ c√°c block l·ªánh
      const blocks = Array.from(programArea.querySelectorAll('.command-block')).filter(block => !block.classList.contains('disabled'));
      
      if (blocks.length === 0) {
        showNotification('Kh√¥ng c√≥ l·ªánh n√†o ƒë·ªÉ ch·∫°y', 'warning');
        return;
      }
      
      // B·∫Øt ƒë·∫ßu ch·∫°y
      isRunningProgram = true;
      isProgramPaused = false;
      currentProgramStepIndex = 0;
      
      // C·∫≠p nh·∫≠t UI
      runProgramButton.innerHTML = '<i>‚ñ†</i> D·ª´ng ch∆∞∆°ng tr√¨nh';
      runProgramButton.classList.add('running');
      
      // L∆∞u v·ªã tr√≠ robot ban ƒë·∫ßu
      const initialPosition = {
        x: robotX,
        y: robotY,
        angle: robotAngle
      };
      
      // Ch·∫°y t·ª´ng b∆∞·ªõc m·ªôt
      runProgramStep(blocks, initialPosition);
    }
    
    // Ch·∫°y t·ª´ng b∆∞·ªõc c·ªßa ch∆∞∆°ng tr√¨nh
    function runProgramStep(blocks, initialPosition) {
      // Ki·ªÉm tra n·∫øu ƒë√£ d·ª´ng
      if (!isRunningProgram || isProgramPaused) {
        return;
      }
      
      // Ki·ªÉm tra n·∫øu ƒë√£ ch·∫°y h·∫øt
      if (currentProgramStepIndex >= blocks.length) {
        stopProgram();
        showNotification('Ch∆∞∆°ng tr√¨nh ƒë√£ ch·∫°y xong', 'info');
        return;
      }
      
      // L·∫•y block hi·ªán t·∫°i
      const currentBlock = blocks[currentProgramStepIndex];
      
      // ƒê√°nh d·∫•u block ƒëang ch·∫°y
      const previousSelected = programArea.querySelector('.selected-block');
      if (previousSelected) {
        previousSelected.classList.remove('selected-block');
      }
      currentBlock.classList.add('selected-block');
      
      // L·∫•y th√¥ng tin l·ªánh
      const command = currentBlock.dataset.command;
      const valueInput = currentBlock.querySelector('input');
      const value = parseFloat(valueInput.value) || 0;
      
      // L·∫•y v·ªã tr√≠ hi·ªán t·∫°i
      const oldX = robotX;
      const oldY = robotY;
      
      // Th·ª±c hi·ªán l·ªánh
      executeCommand(command, value);
      
      // V·∫Ω path n·∫øu ƒë∆∞·ª£c b·∫≠t
      if (showPath) {
        traceRobotPath(oldX, oldY, robotX, robotY);
      }
      
      // Ti·∫øn ƒë·∫øn b∆∞·ªõc ti·∫øp theo sau m·ªôt kho·∫£ng th·ªùi gian
      currentProgramStepIndex++;
      programRunTimer = setTimeout(function() {
        runProgramStep(blocks, initialPosition);
      }, 500);
    }
    
    // Th·ª±c hi·ªán l·ªánh c·ª• th·ªÉ
    function executeCommand(command, value) {
      switch (command) {
        case 'moveUp':
          moveRobotInDirection(0, -1, value);
          break;
        case 'moveDown':
          moveRobotInDirection(0, 1, value);
          break;
        case 'moveLeft':
          moveRobotInDirection(-1, 0, value);
          break;
        case 'moveRight':
          moveRobotInDirection(1, 0, value);
          break;
        case 'moveUpLeft':
          moveRobotInDirection(-1, -1, value);
          break;
        case 'moveUpRight':
          moveRobotInDirection(1, -1, value);
          break;
        case 'moveDownLeft':
          moveRobotInDirection(-1, 1, value);
          break;
        case 'moveDownRight':
          moveRobotInDirection(1, 1, value);
          break;
        case 'rotateLeft':
          rotateRobot(-value);
          break;
        case 'rotateRight':
          rotateRobot(value);
          break;
        case 'spin':
          // Quay s·ªë v√≤ng t∆∞∆°ng ·ª©ng
          for (let i = 0; i < value; i++) {
            rotateRobot(360);
          }
          break;
      }
    }
    
    // D·ª´ng ch∆∞∆°ng tr√¨nh
    function stopProgram() {
      isRunningProgram = false;
      isProgramPaused = false;
      
      // H·ªßy timer
      if (programRunTimer) {
        clearTimeout(programRunTimer);
        programRunTimer = null;
      }
      
      // C·∫≠p nh·∫≠t UI
      runProgramButton.innerHTML = '<i>‚ñ∂</i> Ch·∫°y ch∆∞∆°ng tr√¨nh';
      runProgramButton.classList.remove('running');
      
      // B·ªè ch·ªçn block
      const selectedBlock = programArea.querySelector('.selected-block');
      if (selectedBlock) {
        selectedBlock.classList.remove('selected-block');
      }
    }
    
    // L∆∞u ch∆∞∆°ng tr√¨nh
    function saveProgram() {
      const programName = document.getElementById('program-name').value.trim();
      
      if (!programName) {
        showNotification('Vui l√≤ng nh·∫≠p t√™n ch∆∞∆°ng tr√¨nh', 'warning');
        return;
      }
      
      // L·∫•y t·∫•t c·∫£ c√°c block
      const blocks = Array.from(programArea.querySelectorAll('.command-block'));
      
      // L∆∞u th√¥ng tin t·ª´ng block
      const programData = blocks.map(block => {
        return {
          command: block.dataset.command,
          value: parseFloat(block.querySelector('input').value) || 0,
          disabled: block.classList.contains('disabled')
        };
      });
      
      // L·∫•y danh s√°ch ch∆∞∆°ng tr√¨nh hi·ªán c√≥
      let savedPrograms = JSON.parse(localStorage.getItem('savedPrograms') || '{}');
      
      // L∆∞u ch∆∞∆°ng tr√¨nh m·ªõi
      savedPrograms[programName] = {
        name: programName,
        timestamp: Date.now(),
        data: programData
      };
      
      // L∆∞u v√†o localStorage
      localStorage.setItem('savedPrograms', JSON.stringify(savedPrograms));
      
      // C·∫≠p nh·∫≠t danh s√°ch
      loadSavedPrograms();
      
      // Th√¥ng b√°o
      showNotification(`ƒê√£ l∆∞u ch∆∞∆°ng tr√¨nh "${programName}"`, 'info');
    }
    
    // T·∫£i danh s√°ch ch∆∞∆°ng tr√¨nh ƒë√£ l∆∞u
    function loadSavedPrograms() {
      const savedProgramsList = document.getElementById('saved-programs-list');
      savedProgramsList.innerHTML = '';
      
      // L·∫•y danh s√°ch ch∆∞∆°ng tr√¨nh
      const savedPrograms = JSON.parse(localStorage.getItem('savedPrograms') || '{}');
      
      // S·∫Øp x·∫øp theo th·ªùi gian g·∫ßn nh·∫•t
      const programNames = Object.keys(savedPrograms).sort((a, b) => {
        return savedPrograms[b].timestamp - savedPrograms[a].timestamp;
      });
      
      // Hi·ªÉn th·ªã t·ª´ng ch∆∞∆°ng tr√¨nh
      for (const name of programNames) {
        const program = savedPrograms[name];
        
        const programItem = document.createElement('div');
        programItem.className = 'saved-item';
        programItem.innerHTML = `
          <span>${program.name}</span>
          <button class="delete-program" title="X√≥a ch∆∞∆°ng tr√¨nh">√ó</button>
        `;
        
        // Th√™m s·ª± ki·ªán click ƒë·ªÉ t·∫£i ch∆∞∆°ng tr√¨nh
        programItem.addEventListener('click', function(e) {
          if (e.target.classList.contains('delete-program')) {
            return; // X·ª≠ l√Ω ·ªü s·ª± ki·ªán kh√°c
          }
          loadProgram(program.name);
        });
        
        // Th√™m s·ª± ki·ªán x√≥a ch∆∞∆°ng tr√¨nh
        const deleteButton = programItem.querySelector('.delete-program');
        deleteButton.addEventListener('click', function(e) {
          e.stopPropagation();
          deleteProgram(program.name);
        });
        
        savedProgramsList.appendChild(programItem);
      }
      
      // Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu kh√¥ng c√≥ ch∆∞∆°ng tr√¨nh n√†o
      if (programNames.length === 0) {
        const emptyItem = document.createElement('div');
        emptyItem.className = 'saved-item';
        emptyItem.textContent = 'Ch∆∞a c√≥ ch∆∞∆°ng tr√¨nh n√†o ƒë∆∞·ª£c l∆∞u';
        savedProgramsList.appendChild(emptyItem);
      }
    }
    
    // T·∫£i m·ªôt ch∆∞∆°ng tr√¨nh c·ª• th·ªÉ
    function loadProgram(programName) {
      // L·∫•y danh s√°ch ch∆∞∆°ng tr√¨nh
      const savedPrograms = JSON.parse(localStorage.getItem('savedPrograms') || '{}');
      
      if (!savedPrograms[programName]) {
        showNotification('Kh√¥ng t√¨m th·∫•y ch∆∞∆°ng tr√¨nh', 'error');
        return;
      }
      
      // L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i ƒë·ªÉ undo
      saveToHistory();
      
      // X√≥a t·∫•t c·∫£ block hi·ªán t·∫°i
      programArea.querySelectorAll('.command-block').forEach(block => block.remove());
      
      // T·∫°o c√°c block m·ªõi
      const program = savedPrograms[programName];
      
      for (const blockData of program.data) {
        // T√¨m block m·∫´u t∆∞∆°ng ·ª©ng
        const templateBlock = document.querySelector(`.block-library .command-block[data-command="${blockData.command}"]`);
        
        if (templateBlock) {
          // Sao ch√©p block
          const newBlock = templateBlock.cloneNode(true);
          
          // C·∫≠p nh·∫≠t gi√° tr·ªã
          const valueInput = newBlock.querySelector('input');
          valueInput.value = blockData.value;
          
          // Th√™m n√∫t ƒëi·ªÅu khi·ªÉn
          const controls = document.createElement('div');
          controls.className = 'block-controls';
          
          const toggleBtn = document.createElement('button');
          toggleBtn.className = 'toggle-block';
          toggleBtn.innerHTML = '‚úì';
          toggleBtn.title = 'B·∫≠t/t·∫Øt l·ªánh';
          toggleBtn.onclick = function(e) {
            e.stopPropagation();
            toggleCommandBlock(this.parentElement.parentElement);
          };
          
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'delete-block';
          deleteBtn.innerHTML = '√ó';
          deleteBtn.title = 'X√≥a l·ªánh';
          deleteBtn.onclick = function(e) {
            e.stopPropagation();
            deleteCommandBlock(this.parentElement.parentElement);
          };
          
          controls.appendChild(toggleBtn);
          controls.appendChild(deleteBtn);
          newBlock.appendChild(controls);
          
          // ƒê·∫∑t tr·∫°ng th√°i
          if (blockData.disabled) {
            newBlock.classList.add('disabled');
          }
          
          // Th√™m v√†o program area
          programArea.appendChild(newBlock);
          
          // Th√™m s·ª± ki·ªán
          addBlockEvents(newBlock);
        }
      }
      
      // C·∫≠p nh·∫≠t t√™n ch∆∞∆°ng tr√¨nh
      document.getElementById('program-name').value = programName;
      
      // Th√¥ng b√°o
      showNotification(`ƒê√£ t·∫£i ch∆∞∆°ng tr√¨nh "${programName}"`, 'info');
    }
    
    // X√≥a m·ªôt ch∆∞∆°ng tr√¨nh
    function deleteProgram(programName) {
      // L·∫•y danh s√°ch ch∆∞∆°ng tr√¨nh
      let savedPrograms = JSON.parse(localStorage.getItem('savedPrograms') || '{}');
      
      if (!savedPrograms[programName]) {
        showNotification('Kh√¥ng t√¨m th·∫•y ch∆∞∆°ng tr√¨nh', 'error');
        return;
      }
      
      // X√≥a ch∆∞∆°ng tr√¨nh
      delete savedPrograms[programName];
      
      // L∆∞u v√†o localStorage
      localStorage.setItem('savedPrograms', JSON.stringify(savedPrograms));
      
      // C·∫≠p nh·∫≠t danh s√°ch
      loadSavedPrograms();
      
      // Th√¥ng b√°o
      showNotification(`ƒê√£ x√≥a ch∆∞∆°ng tr√¨nh "${programName}"`, 'info');
    }
    
    // Hi·ªÉn th·ªã h·ªôp tho·∫°i xu·∫•t/nh·∫≠p
    function showExportDialog() {
      // L·∫•y danh s√°ch ch∆∞∆°ng tr√¨nh
      const savedPrograms = JSON.parse(localStorage.getItem('savedPrograms') || '{}');
      
      // T·∫°o d·ªØ li·ªáu xu·∫•t
      const exportData = {
        version: '1.0',
        programs: savedPrograms,
        settings: {
          robotSize,
          stepSize,
          mapSize,
          mapPositionX,
          mapPositionY,
          showGrid,
          showPath,
          invertVertical,
          invertHorizontal
        }
      };
      
      // Chuy·ªÉn th√†nh chu·ªói JSON
      const exportString = JSON.stringify(exportData, null, 2);
      
      // T·∫°o h·ªôp tho·∫°i
      const dialogOverlay = document.createElement('div');
      dialogOverlay.className = 'modal-overlay';
      
      const dialog = document.createElement('div');
      dialog.className = 'modal-dialog';
      dialog.innerHTML = `
        <h4>Xu·∫•t/Nh·∫≠p C·∫•u H√¨nh</h4>
        <textarea class="import-export-textarea">${exportString}</textarea>
        <div class="modal-buttons">
          <button class="secondary" onclick="importConfiguration(this.parentElement.previousElementSibling.value)">Nh·∫≠p</button>
          <button class="primary" onclick="closeDialog()">ƒê√≥ng</button>
        </div>
      `;
      
      dialogOverlay.appendChild(dialog);
      document.body.appendChild(dialogOverlay);
      
      // Hi·ªÉn th·ªã h·ªôp tho·∫°i
      setTimeout(() => {
        dialogOverlay.classList.add('active');
      }, 10);
    }
    
    // ƒê√≥ng h·ªôp tho·∫°i
    function closeDialog() {
      const dialog = document.querySelector('.modal-overlay');
      dialog.classList.remove('active');
      
      // X√≥a h·ªôp tho·∫°i sau khi ·∫©n
      setTimeout(() => {
        dialog.remove();
      }, 300);
    }
    
    // Nh·∫≠p c·∫•u h√¨nh
    function importConfiguration(jsonString) {
      try {
        // Ph√¢n t√≠ch chu·ªói JSON
        const importData = JSON.parse(jsonString);
        
        // Ki·ªÉm tra phi√™n b·∫£n
        if (!importData.version) {
          throw new Error('D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá');
        }
        
        // Nh·∫≠p ch∆∞∆°ng tr√¨nh
        if (importData.programs) {
          localStorage.setItem('savedPrograms', JSON.stringify(importData.programs));
          loadSavedPrograms();
        }
        
        // Nh·∫≠p c√†i ƒë·∫∑t
        if (importData.settings) {
          const settings = importData.settings;
          
          // C·∫≠p nh·∫≠t c√°c c√†i ƒë·∫∑t
          if (settings.robotSize) {
            resizeRobot(settings.robotSize);
            robotSizeSlider.value = settings.robotSize;
          }
          
          if (settings.stepSize) {
            updateStepSize(settings.stepSize);
            stepSizeInput.value = settings.stepSize;
          }
          
          if (settings.mapSize) {
            resizeMap(settings.mapSize);
            mapSizeSlider.value = settings.mapSize;
          }
          
          if (settings.mapPositionX !== undefined) {
            adjustMapPosition('x', settings.mapPositionX);
            mapPositionXSlider.value = settings.mapPositionX;
          }
          
          if (settings.mapPositionY !== undefined) {
            adjustMapPosition('y', settings.mapPositionY);
            mapPositionYSlider.value = settings.mapPositionY;
            mapVerticalMoveCheckbox.checked = true;
            toggleMapVerticalMovement();
          }
          
          if (settings.showGrid !== undefined) {
            gridToggle.checked = settings.showGrid;
            toggleGrid();
          }
          
          if (settings.showPath !== undefined) {
            pathToggle.checked = settings.showPath;
            togglePath();
          }
          
          if (settings.invertVertical !== undefined && settings.invertVertical) {
            if (!invertVertical) toggleInvert('vertical');
          }
          
          if (settings.invertHorizontal !== undefined && settings.invertHorizontal) {
            if (!invertHorizontal) toggleInvert('horizontal');
          }
        }
        
        // ƒê√≥ng h·ªôp tho·∫°i
        closeDialog();
        
        // Th√¥ng b√°o
        showNotification('ƒê√£ nh·∫≠p c·∫•u h√¨nh th√†nh c√¥ng', 'info');
        
      } catch (error) {
        showNotification('L·ªói: ' + error.message, 'error');
      }
    }
    
    // Hi·ªÉn th·ªã tooltip
    function setupTooltips() {
      // T·∫°o element cho tooltip
      const tooltip = document.createElement('div');
      tooltip.className = 'tooltip';
      document.body.appendChild(tooltip);
      
      // Th√™m s·ª± ki·ªán cho c√°c element c√≥ title
      document.querySelectorAll('[title]').forEach(element => {
        element.addEventListener('mouseenter', function(e) {
          const title = this.getAttribute('title');
          
          if (!title) return;
          
          // L∆∞u title g·ªëc v√† x√≥a ƒë·ªÉ tr√°nh tooltip m·∫∑c ƒë·ªãnh
          this.dataset.originalTitle = title;
          this.removeAttribute('title');
          
          // Hi·ªÉn th·ªã tooltip t√πy ch·ªânh
          tooltip.textContent = title;
          tooltip.style.opacity = '1';
          
          // V·ªã tr√≠ tooltip
          updateTooltipPosition(e, tooltip);
        });
        
        element.addEventListener('mouseleave', function() {
          // Kh√¥i ph·ª•c title g·ªëc
          if (this.dataset.originalTitle) {
            this.setAttribute('title', this.dataset.originalTitle);
            delete this.dataset.originalTitle;
          }
          
          // ·∫®n tooltip
          tooltip.style.opacity = '0';
        });
        
        element.addEventListener('mousemove', function(e) {
          // C·∫≠p nh·∫≠t v·ªã tr√≠ tooltip khi di chuy·ªÉn chu·ªôt
          updateTooltipPosition(e, tooltip);
        });
      });
    }
    
    // C·∫≠p nh·∫≠t v·ªã tr√≠ tooltip
    function updateTooltipPosition(e, tooltip) {
      const offset = 15;
      tooltip.style.left = (e.pageX + offset) + 'px';
      tooltip.style.top = (e.pageY + offset) + 'px';
    }
    
    // T·∫°o element th√¥ng b√°o
    function createNotificationElement() {
      const notification = document.createElement('div');
      notification.className = 'notification';
      document.body.appendChild(notification);
    }
    
    // Hi·ªÉn th·ªã th√¥ng b√°o
    function showNotification(message, type = 'success') {
      const notification = document.querySelector('.notification');
      
      // X√≥a class c≈©
      notification.className = 'notification';
      
      // Th√™m class m·ªõi
      notification.classList.add(type);
      
      // ƒê·∫∑t n·ªôi dung
      notification.textContent = message;
      
      // Hi·ªÉn th·ªã th√¥ng b√°o
      notification.classList.add('show');
      
      // T·ª± ƒë·ªông ·∫©n sau 3 gi√¢y
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
    
    // Thi·∫øt l·∫≠p keyboard shortcuts
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', function(e) {
        // Ctrl+Z ƒë·ªÉ undo
        if (e.ctrlKey && e.key === 'z') {
          e.preventDefault();
          undoAction();
        }
        
        // Ctrl+Y ƒë·ªÉ redo
        if (e.ctrlKey && e.key === 'y') {
          e.preventDefault();
          redoAction();
        }
        
        // Space ƒë·ªÉ ch·∫°y/d·ª´ng ch∆∞∆°ng tr√¨nh
        if (e.key === ' ' && document.activeElement.tagName !== 'INPUT') {
          e.preventDefault();
          runProgram();
        }
        
        // Escape ƒë·ªÉ d·ª´ng ch∆∞∆°ng tr√¨nh
        if (e.key === 'Escape' && isRunningProgram) {
          e.preventDefault();
          stopProgram();
        }
        
        // Delete ƒë·ªÉ x√≥a block ƒëang ch·ªçn
        if (e.key === 'Delete' && selectedBlockIndex !== -1) {
          e.preventDefault();
          const blocks = Array.from(programArea.querySelectorAll('.command-block'));
          if (blocks[selectedBlockIndex]) {
            deleteCommandBlock(blocks[selectedBlockIndex]);
          }
        }
        
        // C√°c ph√≠m m≈©i t√™n ƒë·ªÉ di chuy·ªÉn robot
        if (!isRunningProgram && !e.ctrlKey && document.activeElement.tagName !== 'INPUT') {
          switch (e.key) {
            case 'ArrowUp':
              e.preventDefault();
              moveRobotInDirection(0, -1);
              break;
            case 'ArrowDown':
              e.preventDefault();
              moveRobotInDirection(0, 1);
              break;
            case 'ArrowLeft':
              e.preventDefault();
              moveRobotInDirection(-1, 0);
              break;
            case 'ArrowRight':
              e.preventDefault();
              moveRobotInDirection(1, 0);
              break;
            case 'Home':
              e.preventDefault();
              centerRobot();
              break;
          }
        }
      });
    }
    
    // Chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô s√°ng/t·ªëi
    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      
      const isDarkMode = document.body.classList.contains('dark-mode');
      document.getElementById('theme-text').textContent = isDarkMode ? 'Ch·∫ø ƒë·ªô s√°ng' : 'Ch·∫ø ƒë·ªô t·ªëi';
      
      // L∆∞u v√†o localStorage
      localStorage.setItem('darkMode', isDarkMode);
    }
    
    // T·∫£i ch·∫ø ƒë·ªô t·ª´ localStorage
    function loadThemeFromStorage() {
      const isDarkMode = localStorage.getItem('darkMode') === 'true';
      
      if (isDarkMode) {
        document.body.classList.add('dark-mode');
        document.getElementById('theme-text').textContent = 'Ch·∫ø ƒë·ªô s√°ng';
      }
    }
    
    // T·∫£i c√°c c√†i ƒë·∫∑t t·ª´ localStorage
    function loadSettingsFromStorage() {
      // K√≠ch th∆∞·ªõc robot
      const savedRobotSize = localStorage.getItem('robotSize');
      if (savedRobotSize) {
        resizeRobot(savedRobotSize);
        robotSizeSlider.value = savedRobotSize;
      }
      
      // B∆∞·ªõc di chuy·ªÉn
      const savedStepSize = localStorage.getItem('stepSize');
      if (savedStepSize) {
        updateStepSize(savedStepSize);
        stepSizeInput.value = savedStepSize;
      }
      
      // K√≠ch th∆∞·ªõc map
      const savedMapSize = localStorage.getItem('mapSize');
      if (savedMapSize) {
        resizeMap(savedMapSize);
        mapSizeSlider.value = savedMapSize;
      }
      
      // V·ªã tr√≠ map
      const savedMapPositionX = localStorage.getItem('mapPositionX');
      if (savedMapPositionX) {
        adjustMapPosition('x', savedMapPositionX);
        mapPositionXSlider.value = savedMapPositionX;
      }
      
      const savedMapPositionY = localStorage.getItem('mapPositionY');
      if (savedMapPositionY) {
        adjustMapPosition('y', savedMapPositionY);
        mapPositionYSlider.value = savedMapPositionY;
      }
      
      // Di chuy·ªÉn map theo chi·ªÅu d·ªçc
      const savedMapVerticalMove = localStorage.getItem('mapVerticalMove') === 'true';
      if (savedMapVerticalMove) {
        mapVerticalMoveCheckbox.checked = true;
        toggleMapVerticalMovement();
      }
      
      // Hi·ªÉn th·ªã l∆∞·ªõi
      const savedShowGrid = localStorage.getItem('showGrid') === 'true';
      if (savedShowGrid) {
        gridToggle.checked = true;
        toggleGrid();
      }
      
      // Hi·ªÉn th·ªã path
      const savedShowPath = localStorage.getItem('showPath') === 'true';
      if (savedShowPath) {
        pathToggle.checked = true;
        togglePath();
      }
      
      // ƒê·∫£o chi·ªÅu
      const savedInvertVertical = localStorage.getItem('invertVertical') === 'true';
      if (savedInvertVertical) {
        toggleInvert('vertical');
      }
      
      const savedInvertHorizontal = localStorage.getItem('invertHorizontal') === 'true';
      if (savedInvertHorizontal) {
        toggleInvert('horizontal');
      }
      
      // T·∫£i ch·∫ø ƒë·ªô s√°ng/t·ªëi
      loadThemeFromStorage();
    }
    
    // T·∫£i c√†i ƒë·∫∑t khi trang ƒë√£ t·∫£i xong
    window.addEventListener('load', loadSettingsFromStorage);
  </script>
</body>
</html>
